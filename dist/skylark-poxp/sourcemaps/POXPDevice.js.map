{"version":3,"sources":["POXPDevice.js"],"names":["define","poxp","Vector","POXPDevice","VRReady","isPresenting","checkVR","Promise","resolve","reject","navigator","xr","isSessionSupported","optionalFeatures","then","supported","catch","err","console","log","presentVR","requestSession","xrSession","session","updateRenderState","baseLayer","XRWebGLLayer","wwg","gl","framebufferScaleFactor","pixRatio","requestReferenceSpace","xrReferenceSpace","referenceSpace","requestAnimationFrame","loopf","callEvent","addEventListener","ev","closeVR","end","animationFrame","vrframe","vrFrame","isVR","loop","window","submitFrame","getFrameData","pose","getViewerPose","orientation","transform","x","y","z","w","position","frame","webGLLayer","renderState","i","views","length","v","viewport","getViewport","eye","rightViewMatrix","inverse","matrix","rightProjectionMatrix","projectionMatrix","rightViewport","leftViewMatrix","leftProjectionMatrix","leftViewport","can","width","height","setDepth","camDepth","depthNear","camNear","depthFar","camFar","getInput","inputSources","ret","getPose","gripSpace","posetr","convTransform","gamepad","handedness","profiles","hand","ofs","getJointPose","radius","Mat4"],"mappings":"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","file":"../POXPDevice.js","sourcesContent":["define([\n    \"./poxp\",\n    \"./Vector\"\n],function(poxp,Vector){\n\tconst POXPDevice = {\n\t\tVRReady:false,\n\t\tisPresenting:false,\n\t\tcheckVR:function() {\n\t\t\treturn new Promise( (resolve,reject)=>{\n\t\t\t\tif(navigator.xr) {\n\t\t\t\t\tnavigator.xr.isSessionSupported('immersive-vr',\n\t\t\t\t\t\t{optionalFeatures: [ 'hand-tracking' ]}).then((supported) => {\n\t\t\t\t\t\tPOXPDevice.VRReady = supported \n\t\t\t\t\t\tresolve(supported)       \t\n\t\t\t\t\t}).catch((err)=>{\n\t\t\t\t\t\tconsole.log(err)\n\t\t\t\t\t\tresolve(false)\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tresolve(false)\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tpresentVR:function(poxp) {\n\t\t\treturn new Promise( (resolve,reject)=>{\n\t\t\t\t\tnavigator.xr.requestSession(\"immersive-vr\",\n\t\t\t\t\t{optionalFeatures: [ 'hand-tracking' ]}).then((xrSession)=> {\n\t\t\t\t\t\tPOXPDevice.session=xrSession\n\t\t\t\t\t\tPOXPDevice.isPresenting = true\n\t\t\t\t\t\tconsole.log(\"vr start\")\n\t\t\t\t\t\txrSession.updateRenderState({baseLayer: new XRWebGLLayer(xrSession,poxp.wwg.gl,{framebufferScaleFactor:poxp.pixRatio})});\n\t\t\t\t\t\txrSession.requestReferenceSpace(\"local\").then((xrReferenceSpace) => {\n\t\t\t\t\t\t\tPOXPDevice.referenceSpace=xrReferenceSpace\n\t\t\t\t\t\t\tPOXPDevice.session.requestAnimationFrame(POXPDevice.loopf);\n\t\t\t\t\t\t\tpoxp.callEvent(\"vrchange\",1)\n\t\t\t\t\t\t});\n\t\t\t\t\t\txrSession.addEventListener(\"end\", (ev)=>{\n\t\t\t\t\t\t\t\tPOXPDevice.session=null\n\t\t\t\t\t\t\t\tPOXPDevice.isPresenting = false\n\t\t\t\t\t\t\t\tconsole.log(\"VR end\")\n\t//\t\t\t\t\t\t\tpoxp.loop = window.requestAnimationFrame(POXPDevice.loopf) ;\n\t\t\t\t\t\t\t\tpoxp.callEvent(\"vrchange\",0)\n\t\t\t\t\t\t})\n\t\t\t\t\t}); \n\t\t\t})\n\t\t},\n\t\tcloseVR:function() {\n\t\t\tconsole.log(\"vr closing\")\n\t\t\tPOXPDevice.isPresenting = false\n\t\t\tPOXPDevice.session.end()\n\t\t},\n\t\tanimationFrame:function(poxp,loopf,vrframe) {\n\t\t\tPOXPDevice.loopf = loopf \n\t\t\tif(POXPDevice.isPresenting ) {\n\t\t\t\tif(!vrframe) return \n\t\t\t\t\tPOXPDevice.session.requestAnimationFrame(loopf);\n\t\t\t\t\tPOXPDevice.vrFrame = vrframe \n\t\t\t\t\tpoxp.isVR = true \n\t//\t\t\t\tconsole.log(\"vrframe\")\n\n\t\t\t} else {\n\t//\t\t\tconsole.log(\"no vrframe\")\n\t\t\t\tpoxp.loop = window.requestAnimationFrame(loopf) ;\n\t\t\t\tpoxp.isVR = false ;\n\t\t\t}\n\t\t},\n\t\tsubmitFrame:function() {\n\t\t\tif(POXPDevice.VRReady) {\n\t\t\t}\n\t\t},\n\t\tgetFrameData:function() {\n\t\t\tif(POXPDevice.vrFrame) {\n\t//\t\t\tconsole.log(\"getframe\")\n\t\t\t\tlet pose=POXPDevice.vrFrame.getViewerPose(POXPDevice.referenceSpace);\n\t//\t\t\tconsole.log(pose)\n\t\t\t\tpose.orientation = [pose.transform.orientation.x,pose.transform.orientation.y,pose.transform.orientation.z,pose.transform.orientation.w]\n\t\t\t\tpose.position = [pose.transform.position.x,pose.transform.position.y,pose.transform.position.z]\n\t\t\t\tlet frame = {pose:pose}\n\t\t\t\tlet webGLLayer=POXPDevice.session.renderState.baseLayer;\n\t//\t\t\tconsole.log(webGLLayer)\n\t\t\t\tPOXPDevice.webGLLayer = webGLLayer\n\t\t\t\tfor (let i=0;i<=pose.views.length-1;i++) {\n\t\t\t\t\tconst v = pose.views[i] \n\t\t\t\t\tvar viewport=webGLLayer.getViewport(v);\n\t\t\t\t\t\n\t\t\t\t\tpose.views[i].viewport = viewport \n\t\t\t\t\tif(v.eye==\"right\") {\n\t\t\t\t\t\tframe.rightViewMatrix = v.transform.inverse.matrix\n\t\t\t\t\t\tframe.rightProjectionMatrix = v.projectionMatrix\n\t\t\t\t\t\tframe.rightViewport = viewport \n\t\t\t\t\t} else if(v.eye == \"left\" ){\n\t\t\t\t\t\tframe.leftViewMatrix = v.transform.inverse.matrix\n\t\t\t\t\t\tframe.leftProjectionMatrix = v.projectionMatrix\t\n\t\t\t\t\t\tframe.leftViewport = viewport \t\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tPOXPDevice.views = pose.views \n\t\t\t\tPOXPDevice.viewport = {leftViewport:frame.leftViewport,rightViewport:frame.rightViewport}\n\t//\t\t\tconsole.log(frame)\n\t\t\t\treturn frame \n\t\t\t}\n\t\t},\n\t\tgetViewport:function(can) {\n\t\t\tif( POXPDevice.isPresenting)\n\t\t\t\treturn POXPDevice.viewport\n\t\t\telse \n\t\t\t\treturn {leftViewport:{x:0,y:0,width:can.width/2,height:can.height},\n\t\t\t\t\t\t\t\trightViewport:{x:can.width/2,y:0,width:can.width/2,height:can.height}}\n\t\t},\n\t\tsetDepth:function(camDepth) {\n\t\t\tif(!POXPDevice.isPresenting) return\n\t\t\tPOXPDevice.session.updateRenderState({depthNear:camDepth.camNear, depthFar:camDepth.camFar})\n\n\t\t},\n\t\tgetInput:function() {\n\t\t\tif(!POXPDevice.isPresenting) return null\n\t\t\tif(!POXPDevice.session.inputSources) return null\n\t\t\tlet ret = {}\n\t\t\tfor (let i of POXPDevice.session.inputSources) {\n\t\t\t\tif(i==null) continue ;\n\t//\t\t\tconsole.log(i)\n\t\t\t\tlet pose = POXPDevice.vrFrame.getPose(i.gripSpace,POXPDevice.referenceSpace)\n\t\t\t\tlet posetr = pose? POXPDevice.convTransform(pose.transform):null\n\t\t\t\tif(i.gamepad) {\n\t\t\t\t\tif(!ret.gamepad) ret.gamepad = {}\n\t\t\t\t\tret.gamepad[i.handedness] = {\n\t\t\t\t\t\thandedness:i.handedness,\n\t\t\t\t\t\tgamepad:i.gamepad,\n\t\t\t\t\t\tprofiles:i.profiles,\n\t\t\t\t\t\tpose:posetr\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(i.hand) {\n\t\t\t\t\tif(!ret.hand) ret.hand = {}\n\t\t\t\t\tlet hand= []\n\t\t\t\t\tfor(let ofs=0;ofs<25;ofs++) {\n\t\t\t\t\t\tif(i.hand[ofs]!==null) {\n\t\t\t\t\t\t\tlet pose = POXPDevice.vrFrame.getJointPose(i.hand[ofs],POXPDevice.referenceSpace)\n\t\t\t\t\t\t\tif(pose!=null) {\n\t\t\t\t\t\t\t\thand[ofs] = { radius:pose.radius,transform:POXPDevice.convTransform(pose.transform)}\n\t\t\t\t\t\t\t} else hand[ofs] = null \n\t\t\t\t\t\t} else hand[ofs] = null\n\t\t\t\t\t}\n\t\t\t\t\tret.hand[i.handedness] = {\n\t\t\t\t\t\thandedness:i.handedness,\n\t\t\t\t\t\thand:hand,\n\t\t\t\t\t\tprofiles:i.profiles,\t\t\n\t\t\t\t\t\tpose:posetr\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t//\t\tconsole.log(ret)\n\t\t\treturn ret \n\t\t},\n\t\tconvTransform:function(transform) {\n\t\t\tlet ret = {}\n\t\t\tif(transform.position) ret.position = new Vector(transform.position.x,transform.position.y,transform.position.z)\n\t\t\tif(transform.orientation) ret.orientation = new Vector(transform.orientation.x,transform.orientation.y,transform.orientation.z,transform.orientation.w)\n\t\t\tif(transform.matrix) ret.matrix = new Mat4(transform.matrix)\n\t\t\treturn ret \n\t\t}\n\t}\n\n\treturn poxp.POXPDevice = POXPDevice;\n});"]}