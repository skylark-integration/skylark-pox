{"version":3,"sources":["util.js"],"names":["define","poxp","CanvasMatrix4","Json2Canvas","util","Cpanel","[object Object]","render","opt","this","hide","undefined","width","height","font","color","lines","lheight","ry","pos","camFix","pcanvas","document","createElement","j2c","default","textColor","clearColor","ctx","dd","y","i","push","shape","str","x","draw","id","Date","getTime","Math","floor","random","ptex","name","canvas","flevel","repeat","nomipmap","addTex","model","geo","WWModel","primitive","wx","wy","objModel","layer","bm","rotate","translate","blend","vs_uni","uvMatrix","fs_uni","tex1","colmode","shmode","addModel","flag","text","clear","length","updateTex","Beam","len","cofs","vs","slice","ve","bv","mode","vtx_at","vtx","concat","bcolor","cam","vd","getModelData","gp","POX","gPad","pose","ori","orientation","sx","hand","sy","sz","cq","Mat4","v2q","camRY","q2m","qMult","camCX","camCY","camCZ","multVec4","V3norm","V3sub","updateModel","Pool","_use","_free","obj","pop","CreateInstance","InitInstance","splice","num"],"mappings":"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","file":"../util.js","sourcesContent":["define([\n    \"./poxp\",\n    \"./CanvasMatrix4\",\n    \"./Json2Canvas\"\n],function(poxp,CanvasMatrix4,Json2Canvas){\n\t//utils\n\t//console panel\n\n\tclass Cpanel {\n\tconstructor(render,opt) {\n\t\tthis.hide = false \n\t\tif(!opt) opt = {}\n\t\tif(opt.width===undefined) opt.width = 100 \n\t\tif(opt.height===undefined) opt.height = 50 \n\t\tif(opt.font===undefined) opt.font = \"10px monospace\"\n\t\tif(opt.color===undefined) opt.color = \"red\" \n\t\tif(opt.lines===undefined) opt.lines = 5\n\t\tif(opt.lheight===undefined) opt.lheight = 10\n\t\tif(opt.ry===undefined) opt.ry = 40 \n\t\tif(opt.pos===undefined) opt.pos = [-0.2,0.2,-0.8]\n\t\tif(opt.camFix===undefined) opt.camFix = true \n\n\t\tthis.pcanvas = document.createElement('canvas') ;\n\t\tthis.pcanvas.width = opt.width ;\n\t\tthis.pcanvas.height = opt.height ;\t\n\t\tthis.j2c = new Json2Canvas(this.pcanvas)\n\t\tthis.j2c.default.font = opt.font\n\t\tthis.j2c.default.textColor = opt.color\n\t\tthis.clearColor = opt.clearColor \n\t\tthis.ctx = this.j2c.ctx\n\n\t\tthis.dd = []\n\t\tlet y = opt.lheight \n\t\tfor(let i=0;i<opt.lines;i++,y+=opt.lheight) \n\t\t\tthis.dd.push({shape:\"text\",str:\"\",x:0,y:y,width:opt.width})\n\t\tthis.j2c.draw(this.dd)\n\n\t\tthis.id = new Date().getTime()+Math.floor(Math.random()*1000)\n\t\t\t\n\t\tconst ptex = {name:\"cpanel\"+this.id,canvas:this.pcanvas,opt:{flevel:1,repeat:2,nomipmap:true}}\n\t\trender.addTex(ptex) \n\t\tthis.model = \n\t\t\t{name:\"panel\"+this.id,\n\t\t\t\tgeo:new WWModel().primitive(\"plane\",{wx:opt.width/1000,wy:opt.height/1000\n\t\t\t}).objModel(),\n\t\t\t\tcamFix:opt.camFix,layer:opt.layer,\n\t\t\t\tbm:new CanvasMatrix4().rotate(opt.ry,0,1,0).translate(opt.pos),\n\t\t\t\tblend:\"alpha\",\n\t\t\t\tvs_uni:{uvMatrix:[1,0,0, 0,1,0, 0,0,0]},\n\t\t\t\tfs_uni:{tex1:\"cpanel\"+this.id,colmode:2,shmode:1}\n\t\t\t}\n\t\trender.addModel(this.model)\n\t}\n\tshow(flag) {\n\t\tthis.hide = !flag \n\t\tthis.model.hide = this.hide \n\t}\n\tupdate(render,text) {\n\t\tif(this.hide) return \n\t\tthis.j2c.clear(this.clearColor)\n\t\tfor(let i=0;i<text.length;i++) \n\t\t\tif(text[i]!==null) this.dd[i].str = text[i]\n\t\tthis.j2c.draw(this.dd)\n\t\trender.updateTex(\"cpanel\"+this.id,this.pcanvas)\t\n\t}\n\t}\n\n\t// controller beam\n\tclass Beam {\n\tconstructor(render) {\n\t\tthis.len = 200\n\t\tthis.color = [1,1,0,1]\n\t\tthis.cofs = [0.3,-0.5,0.2]\n\t\tthis.vs = this.cofs.slice(0)\n\t\tthis.ve = [this.len/2,this.len/2,-this.len]\n\t\tthis.bv = [0,0,-1]\n\n\t\trender.addModel(\n\t\t\t{name:\"beam\",\n\t\t\tgeo:{mode:\"lines\",\n\t\t\t\tvtx_at:[\"position\"],\n\t\t\t\tvtx:this.vs.concat(this.ve)},\n\t\t\t\tfs_uni:{colmode:0,shmode:1,bcolor:this.color}}\n\t\t)\n\t}\n\tupdate(render,cam) {\n\t\tlet bm = render.getModelData(\"beam\")\n\t\tlet vd = bm.geo.vtx\n\t\tlet gp = POX.poxp.gPad\n\t\tif(gp && gp.pose) {\n\t\t\tthis.ori=gp.pose.orientation\n\t\t\tlet sx = this.cofs[0] * ((gp.hand==\"right\")?1:-1)\n\t\t\tlet sy = this.cofs[1]\n\t\t\tlet sz = this.cofs[2]\n\t\t\tlet cq = Mat4.v2q(-cam.camRY,0,1,0) \n\t\t\tlet bm = new Mat4().q2m(\n\t\t\t\tMat4.qMult(cq,this.ori) )\n\t\t\tbm.translate(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\tthis.vs = bm.multVec4(sx,0,sz,1)\n\t\t\tthis.vs[1] = sy + cam.camCY\n\t\t\tthis.ve = bm.multVec4(0,0,-this.len,1)\n\t\t\tthis.bv = Mat4.V3norm(Mat4.V3sub(this.ve,this.vs))\n\t\t\tvd[0]=this.vs[0],vd[1]=this.vs[1],vd[2]=this.vs[2]\n\t\t\tvd[3]=this.ve[0],vd[4]=this.ve[1],vd[5]=this.ve[2]\n\t\t\trender.updateModel(\"beam\",\"vbo\",vd)\n\t\t}\t\n\t}\n\t}\n\n\tclass Pool  {\n\t\tconstructor() {\n\t\t\tthis._use = [] \n\t\t\tthis._free = [] \n\t\t}\n\t\tCreateInstance() {\n\t\t\treturn {} \n\t\t}\n\t\tInitInstance(obj) {\n\t\t\treturn obj\n\t\t}\n\t\tRent() {\n\t\t\tlet obj \n\t\t\tif(this._free.length>0) {\n\t\t\t\tobj = this._free[this._free.length-1]\n\t\t\t\tthis._free.pop() \n\t\t\t} else {\n\t\t\t\tobj = this.CreateInstance()\n\t\t\t}\n\t\t\tthis.InitInstance(obj)\n\t\t\tthis._use.push(obj)\n\t\t\treturn obj\n\t\t}\n\t\tReturn(obj) {\n\t\t\tfor(let i in this._use) {\n\t\t\t\tif(this._use[i]===obj) {\n\t\t\t\t\tthis._use.splice(i,1)\n\t\t\t\t\tbreak \n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._free.push(obj)\n\t\t}\n\t\tAlloc(num) {\n\t\t\tfor(let i=0;i<num;i++) this._free.push(this.CreateInstance())\n\t\t}\n\t\tGetInstances() {\n\t\t\treturn this._use \n\t\t}\n\t}\n\n\treturn poxp.util = {\n\t\tCpanel,\n\t\tBeam,\n\t\tPool\n\t};\n});"]}