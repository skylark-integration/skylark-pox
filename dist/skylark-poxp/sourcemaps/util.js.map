{"version":3,"sources":["util.js"],"names":["define","pox","CanvasMatrix4","Json2Canvas","Mat4","util","Cpanel","[object Object]","render","opt","this","hide","undefined","width","height","font","color","lines","lheight","ry","pos","camFix","pcanvas","document","createElement","j2c","json2canvas","default","textColor","clearColor","ctx","dd","y","i","push","shape","str","x","draw","id","Date","getTime","Math","floor","random","ptex","name","canvas","flevel","repeat","nomipmap","addTex","model","geo","WWModel","primitive","wx","wy","objModel","layer","bm","rotate","translate","blend","vs_uni","uvMatrix","fs_uni","tex1","colmode","shmode","addModel","flag","text","clear","length","updateTex","Beam","len","cofs","vs","slice","ve","bv","mode","vtx_at","vtx","concat","bcolor","cam","vd","getModelData","gp","POX","poxp","gPad","pose","ori","orientation","sx","hand","sy","sz","cq","v2q","camRY","q2m","qMult","camCX","camCY","camCZ","multVec4","V3norm","V3sub","updateModel","Pool","_use","_free","obj","pop","CreateInstance","InitInstance","splice","num"],"mappings":"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","file":"../util.js","sourcesContent":["define([\n    \"./pox\",\n    \"./CanvasMatrix4\",\n    \"./Json2Canvas\"\n],function(pox,CanvasMatrix4,Json2Canvas){\n\t//utils\n\t//console panel\n\tconst Mat4 = CanvasMatrix4; // alias\n\tclass Cpanel {\n\t\tconstructor(render,opt) {\n\t\t\tthis.hide = false \n\t\t\tif(!opt) opt = {}\n\t\t\tif(opt.width===undefined) opt.width = 100 \n\t\t\tif(opt.height===undefined) opt.height = 50 \n\t\t\tif(opt.font===undefined) opt.font = \"10px monospace\"\n\t\t\tif(opt.color===undefined) opt.color = \"red\" \n\t\t\tif(opt.lines===undefined) opt.lines = 5\n\t\t\tif(opt.lheight===undefined) opt.lheight = 10\n\t\t\tif(opt.ry===undefined) opt.ry = 40 \n\t\t\tif(opt.pos===undefined) opt.pos = [-0.2,0.2,-0.8]\n\t\t\tif(opt.camFix===undefined) opt.camFix = true \n\n\t\t\tthis.pcanvas = document.createElement('canvas') ;\n\t\t\tthis.pcanvas.width = opt.width ;\n\t\t\tthis.pcanvas.height = opt.height ;\t\n\t\t\tthis.j2c = new json2canvas(this.pcanvas)\n\t\t\tthis.j2c.default.font = opt.font\n\t\t\tthis.j2c.default.textColor = opt.color\n\t\t\tthis.clearColor = opt.clearColor \n\t\t\tthis.ctx = this.j2c.ctx\n\n\t\t\tthis.dd = []\n\t\t\tlet y = opt.lheight \n\t\t\tfor(let i=0;i<opt.lines;i++,y+=opt.lheight) \n\t\t\t\tthis.dd.push({shape:\"text\",str:\"\",x:0,y:y,width:opt.width})\n\t\t\tthis.j2c.draw(this.dd)\n\n\t\t\tthis.id = new Date().getTime()+Math.floor(Math.random()*1000)\n\t\t\t\t\n\t\t\tconst ptex = {name:\"cpanel\"+this.id,canvas:this.pcanvas,opt:{flevel:1,repeat:2,nomipmap:true}}\n\t\t\trender.addTex(ptex) \n\t\t\tthis.model = \n\t\t\t\t{geo:new WWModel().primitive(\"plane\",{wx:opt.width/1000,wy:opt.height/1000\n\t\t\t\t}).objModel(),\n\t\t\t\t\tcamFix:opt.camFix,layer:opt.layer,\n\t\t\t\t\tbm:new CanvasMatrix4().rotate(opt.ry,0,1,0).translate(opt.pos),\n\t\t\t\t\tblend:\"alpha\",\n\t\t\t\t\tvs_uni:{uvMatrix:[1,0,0, 0,1,0, 0,0,0]},\n\t\t\t\t\tfs_uni:{tex1:\"cpanel\"+this.id,colmode:2,shmode:1}\n\t\t\t\t}\n\t\t\trender.addModel(this.model)\n\t\t}\n\t\tshow(flag) {\n\t\t\tthis.hide = !flag \n\t\t\tthis.model.hide = this.hide \n\t\t}\n\t\tupdate(render,text) {\n\t\t\tif(this.hide) return \n\t\t\tthis.j2c.clear(this.clearColor)\n\t\t\tfor(let i=0;i<text.length;i++) \n\t\t\t\tif(text[i]!==null) this.dd[i].str = text[i]\n\t\t\tthis.j2c.draw(this.dd)\n\t\t\trender.updateTex(\"cpanel\"+this.id,this.pcanvas)\t\n\t\t}\n\t}\n\n\t// controller beam\n\tclass Beam {\n\t\tconstructor(render) {\n\t\t\tthis.len = 200\n\t\t\tthis.color = [1,1,0,1]\n\t\t\tthis.cofs = [0.3,-0.5,0.2]\n\t\t\tthis.vs = this.cofs.slice(0)\n\t\t\tthis.ve = [this.len/2,this.len/2,-this.len]\n\t\t\tthis.bv = [0,0,-1]\n\n\t\t\trender.addModel(\n\t\t\t\t{name:\"beam\",\n\t\t\t\tgeo:{mode:\"lines\",\n\t\t\t\t\tvtx_at:[\"position\"],\n\t\t\t\t\tvtx:this.vs.concat(this.ve)},\n\t\t\t\t\tfs_uni:{colmode:0,shmode:1,bcolor:this.color}}\n\t\t\t)\n\t\t}\n\t\tupdate(render,cam) {\n\t\t\tlet bm = render.getModelData(\"beam\")\n\t\t\tlet vd = bm.geo.vtx\n\t\t\tlet gp = POX.poxp.gPad\n\t\t\tif(gp && gp.pose) {\n\t\t\t\tthis.ori=gp.pose.orientation\n\t\t\t\tlet sx = this.cofs[0] * ((gp.hand==\"right\")?1:-1)\n\t\t\t\tlet sy = this.cofs[1]\n\t\t\t\tlet sz = this.cofs[2]\n\t\t\t\tlet cq = Mat4.v2q(-cam.camRY,0,1,0) \n\t\t\t\tlet bm = new Mat4().q2m(\n\t\t\t\t\tMat4.qMult(cq,this.ori) )\n\t\t\t\tbm.translate(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\t\tthis.vs = bm.multVec4(sx,0,sz,1)\n\t\t\t\tthis.vs[1] = sy + cam.camCY\n\t\t\t\tthis.ve = bm.multVec4(0,0,-this.len,1)\n\t\t\t\tthis.bv = Mat4.V3norm(Mat4.V3sub(this.ve,this.vs))\n\t\t\t\tvd[0]=this.vs[0],vd[1]=this.vs[1],vd[2]=this.vs[2]\n\t\t\t\tvd[3]=this.ve[0],vd[4]=this.ve[1],vd[5]=this.ve[2]\n\t\t\t\trender.updateModel(\"beam\",\"vbo\",vd)\n\t\t\t}\t\n\t\t}\n\t}\n\n\tclass Pool  {\n\t\tconstructor() {\n\t\t\tthis._use = [] \n\t\t\tthis._free = [] \n\t\t}\n\t\tCreateInstance() {\n\t\t\treturn {} \n\t\t}\n\t\tInitInstance(obj) {\n\t\t\treturn obj\n\t\t}\n\t\tRent() {\n\t\t\tlet obj \n\t\t\tif(this._free.length>0) {\n\t\t\t\tobj = this._free[this._free.length-1]\n\t\t\t\tthis._free.pop() \n\t\t\t} else {\n\t\t\t\tobj = this.CreateInstance()\n\t\t\t}\n\t\t\tthis.InitInstance(obj)\n\t\t\tthis._use.push(obj)\n\t\t\treturn obj\n\t\t}\n\t\tReturn(obj) {\n\t\t\tfor(let i in this._use) {\n\t\t\t\tif(this._use[i]===obj) {\n\t\t\t\t\tthis._use.splice(i,1)\n\t\t\t\t\tbreak \n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._free.push(obj)\n\t\t}\n\t\tAlloc(num) {\n\t\t\tfor(let i=0;i<num;i++) this._free.push(this.CreateInstance())\n\t\t}\n\t\tGetInstances() {\n\t\t\treturn this._use \n\t\t}\n\t}\n\n\n\treturn pox.util = {\n\t\tCpanel,\n\t\tBeam,\n\t\tPool\n\t};\n});"]}