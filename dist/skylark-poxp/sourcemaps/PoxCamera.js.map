{"version":3,"sources":["PoxCamera.js"],"names":["define","poxp","CanvasMatrix4","PoxCamera","[object Object]","cam","this","camCX","camCY","camCZ","camVX","camVY","camVZ","camUPX","camUPY","camUPZ","camRX","camRY","camRZ","camd","camAngle","camWidth","camNear","camFar","camGyro","gPad","sbase","moveSpeed","rotAngle","moveY","padMoveUD","padRot","headVec","i","cama","rotX","rotY","gev","gx","gy","gz","vcx","vcy","vcz","vrx","vry","vrz","keydown","vr","camVP","camP","camV","vrv","vrp","tempM","pvy","pvx","ret","basePos","baseRot","position","Array","from","campos","orientation","headOri","headPos","f","ev","m","mag","pixRatio","can","width","scale","pox","setting","dy","dx","rx","ry","z","keymag","md","altKey","key","cthis","am","dir","Math","sin","RAD","cos","time","ft","ctime","ltime","camMode","acx","acy","acz","ad","av","al","aex","aey","aez","gpad","gpad2","gp","axes","undefined","buttons","pressed","mv","abs","dpad","rot","x","y","opt","cx","cy","cz","velocity","vx","vy","vz","l","hypot","sf","render","wwg","aspect","height","ex","ey","ez","upx","upy","upz","vrFrame","isVR","cmat","Mat4","rotate","multVec4","makeIdentity","lookat","perspective","pallarel","load","multRight","POXPDevice","setDepth","getFrameData","pose","rightViewMatrix","leftViewMatrix","rightProjectionMatrix","leftProjectionMatrix","translate","leftCorrMtx","multLeft","rightCorrMtx","w","invert","slice","ivr","ivl","buf","camX","camY","camZ"],"mappings":"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","file":"../PoxCamera.js","sourcesContent":["define([\n    \"./poxp\",\n    \"./CanvasMatrix4\"\n],function(poxp,CanvasMatrix4){\n\t// poxplayercamera object\n\n\tclass Camera {\n\t\tconstructor(poxp,cam) {\n\t\t\tthis.poxp = poxp ;\n\t\t\t//camera initial\n\t\t\tthis.cam = {\n\t\t\t\tcamCX:0,\n\t\t\t\tcamCY:0,\n\t\t\t\tcamCZ:0,\n\t\t\t\tcamVX:0,\n\t\t\t\tcamVY:0,\n\t\t\t\tcamVZ:1,\n\t\t\t\tcamUPX:0,\n\t\t\t\tcamUPY:1,\n\t\t\t\tcamUPZ:0,\n\t\t\t\tcamRX:30,\n\t\t\t\tcamRY:-30,\n\t\t\t\tcamRZ:0,\n\t\t\t\tcamd:20,\n\t\t\t\tcamAngle:90,\t//cam angle(deg) \n\t\t\t\tcamWidth:1.0,\n\t\t\t\tcamNear:0.01, \t//near\n\t\t\t\tcamFar:1000, \t//far\n\t\t\t\tcamGyro:true, // use gyro\n\t\t\t\tgPad:true, //use gpad\n\t\t\t\tsbase:0.06, \t//streobase \n\t\t\t\tmoveSpeed:1.3,\t\t// m/sec\n\t\t\t\trotAngle:30,\n\t\t\t\tmoveY:false,\n\t\t\t\tpadMoveUD:true,\n\t\t\t\tpadRot:true,\n\t\t\t\theadVec:[0,0,0]\t//head direction\n\t\t\t} ;\n\t\t\tfor(let i in cam) {\n\t\t\t\tthis.cam[i] = cam[i] ;\n\t\t\t}\n\n\t\t\tthis.cama = false ; // on animation\n\t\t\tthis.rotX = 0 ;\n\t\t\tthis.rotY = 0 ;\n\t\t\tthis.gev = null ;\n\t\t\tthis.gx = 0 ; this.gy = 0 ; this.gz = 0 ;\n\t\t\tthis.vcx = 0 ;this.vcy = 0 ; this.vcz=0\n\t\t\tthis.vrx = 0 ;this.vry = 0 ; this.vrz=0\n\t\t\tthis.keydown = false ;\n\t\t\tthis.vr = false ;\n\t\t\tthis.camVP = [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.camP =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.camV =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.vrv =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.vrp =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.tempM =  new CanvasMatrix4()\n\t\t\tthis.pvy = false \n\t\t\tthis.pvx = false \n\t\t//\tif(window.VRFrameData!=undefined) this.vrFrame = new VRFrameData()\n\t\t}\n\t\tsetCam(cam) {\n\t\t\tfor(let i in cam) {\n\t\t\t\tthis.cam[i] = cam[i] ;\n\t\t\t}\n\t\t\tthis.cama = false \n\t\t}\n\t\tgetCam() {\n\t\t\tconst ret = {\n\t\t\t\tbasePos:[this.cam.camCX,this.cam.camCY,this.cam.camCZ],\n\t\t\t\tbaseRot:[this.cam.camRX,this.cam.camRY,this.cam.camRZ],\n\t\t\t\tposition:Array.from(this.cam.campos),\n\t\t\t\theadVec:Array.from(this.cam.headVec),\n\t\t\t}\n\t\t\tif(this.cam.orientation) ret.headOri = Array.from(this.cam.orientation)\n\t\t\telse ret.headOri = [0,0,0,1]\n\t\t\tif(this.cam.position) ret.headPos = Array.from(this.cam.position)\n\t\t\telse ret.headPos = [0,0,0]\n\t\t\treturn ret \n\t\t}\n\t\tvrchange(f) {\n\t\t\tif(f) {\n\t\t\t\tthis.cam.camRX = 0\n\t\t\t\tthis.cam.camRZ = 0\n\t\t\t}\n\t\t}\n\t\tevent(ev,m) {\n\t\t\tconst mag = 300*this.poxp.pixRatio /this.poxp.can.width;\n\t\t\tconst scale = (this.poxp.pox.setting && this.poxp.pox.setting.scale)? this.poxp.pox.setting.scale :1 ;\n\n\t\t//\tconsole.log(\"cam \"+ev+\" key:\"+m.key)\n\t\t\tswitch(ev) {\n\t\t\t\tcase \"down\":\n\t\t\t\t\tthis.rotX = this.cam.camRX\n\t\t\t\t\tthis.rotY = this.cam.camRY\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"move\":\n\t\t\t\t\tthis.cam.camRX = this.rotX+m.dy*mag ;\n\t\t\t\t\tthis.cam.camRY = this.rotY+m.dx*mag ;\n\t\t\t\t\tif(this.cam.camRX>89)this.cam.camRX=89;\n\t\t\t\t\tif(this.cam.camRX<-89)this.cam.camRX=-89;\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"up\":\n\t\t\t\t\tthis.rotX += m.dy*mag ;\n\t\t\t\t\tthis.rotY += m.dx*mag; \n\t\t\t\t\tif(this.gev!==null) {\n\t\t\t\t\t\tthis.gx = this.gev.rx - this.rotX ;\n\t\t\t\t\t\tthis.gy = this.gev.ry - this.rotY ;\n\t\t//\t\t\t\tconsole.log(this.gx+\"/\"+this.gy) ;\n\t\t\t\t\t}\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"out\":\n\t\t\t\t\tthis.rotX += m.dy*mag ;\n\t\t\t\t\tthis.rotY += m.dx*mag; \n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"wheel\":\n\t\t\t\t\tthis.cam.camd += m/100 * scale ;\n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"gesture\":\n\t\t\t\t\tif(m.z==0) {\n\t\t\t\t\t\tthis.gz = this.cam.camd ; \n\t\t\t\t\t\treturn false ;\n\t\t\t\t\t}\n\t\t\t\t\tthis.cam.camd = this.gz / m.z ;\n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"gyro\":\n\t\t//\t\tconsole.log(m)\n\t\t\t\t\tif(this.keydown || !this.cam.camGyro) return true ;\n\t\t\t\t\tif(m.rx===null) return true ;\n\t\t\t\t\tthis.gev = m ;\n\t\t\t\t\tthis.cam.camRX = m.rx - this.gx;\n\t\t\t\t\tthis.cam.camRY = m.ry - this.gy ;\n\t\t//\t\tconsole.log(gx+\"/\"+gy) ;\n\t\t\t\t\tif(this.cam.camRX>89)this.cam.camRX=89 ;\n\t\t\t\t\tif(this.cam.camRX<-89)this.cam.camRX=-89 ;\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"keydown\":\n\t\t\t\t\tconst z = this.cam.camd ;\n\t\t\t\t\tconst keymag= this.cam.moveSpeed ;\n\t\t\t\t\tlet md = \"\" ;\n\t\t\t\t\tthis.keydown = true ;\n\t\t\t\t\tif(m.altKey) {\n\t\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\t\tcase \"ArrowUp\":this.cam.camd = this.cam.camd - keymag; if(this.cam.camd<0) cthis.am.camd = 0 ; break ;\n\t\t\t\t\t\t\tcase \"ArrowDown\":this.cam.camd = this.cam.camd + keymag ; break ;\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\t\tcase \"ArrowLeft\":\n\t\t\t\t\t\t\tcase \"Left\":\n\t\t\t\t\t\t\tcase \"h\":\n\t\t\t\t\t\t\t\tthis.vry = -keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\t\t\tcase \"Up\":\n\t\t\t\t\t\t\tcase \"k\":\n\t\t\t\t\t\t\t\tthis.vrx = -keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowRight\":\n\t\t\t\t\t\t\tcase \"Right\":\n\t\t\t\t\t\t\tcase \"l\":\n\t\t\t\t\t\t\t\tthis.vry = keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowDown\":\n\t\t\t\t\t\t\tcase \"Down\":\n\t\t\t\t\t\t\tcase \"j\":\n\t\t\t\t\t\t\t\tthis.vrx = keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tcase \"w\":\n\t\t\t\t\t\t\t\tmd = \"f\" ; break ;\n\t\t\t\t\t\t\tcase \"s\":\n\t\t\t\t\t\t\t\tmd = \"b\" ;break ;\n\t\t\t\t\t\t\tcase \"a\":\n\t\t\t\t\t\t\t\tmd = \"l\" ;break ;\n\t\t\t\t\t\t\tcase \"d\":\n\t\t\t\t\t\t\t\tmd = \"r\" ;break ;\t\n\t\t\t\t\t\t\tcase \"q\":\n\t\t\t\t\t\t\t\tmd = \"u\" ;break ;\n\t\t\t\t\t\t\tcase \"e\":\n\t\t\t\t\t\t\t\tmd = \"d\" ;break ;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif(md!=\"\") {\n\t\t\t\t\t\tconst dir = ((md==\"b\"||md==\"d\")?-1:1)*keymag*scale \n\t\t\t\t\t\tconst cam = this.cam ;\n\t\t\t\t\t\tif(md==\"u\"||md==\"d\") {\n\t\t\t\t\t\t\tthis.vcy = dir ;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlet ry = cam.camRY ;\n\t\t\t\t\t\t\tif(md==\"l\") ry = ry -90 ;\n\t\t\t\t\t\t\tif(md==\"r\") ry = ry +90 ;\n\t\t\t\t\t\t\tthis.vcx =  Math.sin(ry*RAD) *dir ;\n\t\t\t\t\t\t\tthis.vcz = -Math.cos(ry*RAD)* dir ;\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"keyup\":\n\t\t\t\t\tthis.keydown = false ;\n\t\t\t\t\tif(this.gev!==null) {\n\t\t\t\t\t\tthis.gx = this.gev.rx - this.cam.camRX ;\n\t\t\t\t\t\tthis.gy = this.gev.ry - this.cam.camRY ;\n\t\t//\t\t\t\tconsole.log(this.gx+\"/\"+this.gy) ;\n\t\t\t\t\t}\n\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\tcase \"ArrowLeft\":\n\t\t\t\t\t\tcase \"Left\":\n\t\t\t\t\t\tcase \"h\":\n\t\t\t\t\t\tcase \"ArrowRight\":\n\t\t\t\t\t\tcase \"Right\":\n\t\t\t\t\t\tcase \"l\":\n\t\t\t\t\t\t\tthis.vry = 0 ; break ;\n\t\t\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\t\tcase \"Up\":\n\t\t\t\t\t\tcase \"k\":\n\t\t\t\t\t\tcase \"ArrowDown\":\n\t\t\t\t\t\tcase \"Down\":\n\t\t\t\t\t\tcase \"j\":\n\t\t\t\t\t\t\tthis.vrx = 0  ; break ;\n\t\t\t\t\t\tcase \"w\":\n\t\t\t\t\t\tcase \"d\":\n\t\t\t\t\t\tcase \"a\":\n\t\t\t\t\t\tcase \"s\":\n\t\t\t\t\t\tcase \" \":\n\t\t\t\t\t\t\tthis.vcx = 0 ; this.vcz = 0 ; break ;\n\t\t\t\t\t\tcase \"q\":\n\t\t\t\t\t\tcase \"e\":\n\t\t\t\t\t\t\tthis.vcy = 0 ;break ;\n\t\t\t\t\t\tcase \"Dead\": //mobile safari no keyup key\n\t\t\t\t\t\t\tthis.vrx = 0 ; this.vry = 0 ; this.vcx = 0 ; this.vcz = 0 ; \n\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t}\t\t\t\n\t\t\t\t\tbreak ;\t\n\t\t\t\t}\n\t\t}\n\t\tupdate(time) {\n\t\t\tconst ft = (this.poxp.ctime - this.poxp.ltime)/1000\n\t\t//console.log(ft)\n\t\t\tif(this.cam.camMode!=\"fix\") {\n\t\t\t\tthis.cam.camRX += this.vrx ;\n\t\t\t\tif(this.cam.camRX<-89) this.cam.camRX = -89 ; \n\t\t\t\tif(this.cam.camRX>89) this.cam.camRX = 89 ; \n\t\t\t\tthis.cam.camRY += this.vry ;\n\t\t\t}\n\t\t\tif(this.cam.camMode==\"walk\") {\n\t\t\t\tif(!this.cama) {\n\t\t\t\t\tthis.cam.camCX += this.vcx *ft ;\n\t\t\t\t\tthis.cam.camCY += this.vcy *ft ;\n\t\t\t\t\tthis.cam.camCZ += this.vcz *ft ;\n\t\t\t\t}\n\t\t\t\tthis.cam.camRY += this.vry *ft ;\n\t\t\t}\n\t\t\tif(this.cama) {\n\t\t\t\tthis.cam.camCX += this.acx *ft ;\n\t\t\t\tthis.cam.camCY += this.acy *ft ;\n\t\t\t\tthis.cam.camCZ += this.acz *ft ;\t\n\t\t\t\tthis.ad += this.av * ft \n\t\t\t\tif( this.ad > this.al ) {\n\t\t\t\t\tthis.cam.camCX = this.aex\n\t\t\t\t\tthis.cam.camCY = this.aey\n\t\t\t\t\tthis.cam.camCZ = this.aez\n\t\t\t\t\tthis.cama = false \n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tsetPad(gpad,gpad2) {\n\t\t\tlet gp = gpad?gpad:gpad2\n\t\t\tif(!gp) return \n\t\t\tif(this.cam.camMode==\"walk\") {\n\t\t\t\tlet axes = [gp.axes[0],gp.axes[1]]\n\t\t\t\tif(gp.axes[2]!=undefined && gp.axes[2]!=0) axes[0] = gp.axes[2]\n\t\t\t\tif(gp.axes[3]!=undefined && gp.axes[3]!=0) axes[1] = gp.axes[3]\n\t\t\t\tif(this.cam.padMoveUD && gp.buttons[1] && gp.buttons[1].pressed) {\n\t\t\t\t\tthis.vcy = -axes[1]*this.cam.moveSpeed\n\t\t\t\t\tthis.pvy = true ;\n\t\t\t\t\treturn\n\t\t\t\t} else if(this.pvy) {\n\t\t\t\t\tthis.vcy = 0 \n\t\t\t\t\tthis.pvy = false\n\t\t\t\t}\n\t\t\t\tlet m = gp.buttons[2] && gp.buttons[2].pressed\n\t\t\t\tlet mv = (m)?this.cam.moveSpeed*5:this.cam.moveSpeed\n\t\t\t\tif(Math.abs(axes[0])<Math.abs(axes[1]) && Math.abs(axes[1])>0 ) {\n\t\t\t\t\t\tthis.vcx = -this.cam.headVec[0] * axes[1]*mv\n\t\t\t\t\t\tif(this.cam.moveY) this.vcy = -this.cam.headVec[1] * axes[1]*mv\n\t\t\t\t\t\tthis.vcz = -this.cam.headVec[2] * axes[1]*mv\n\t\t\t\t\t\tthis.pvx = true\n\t\t\t\t\t\treturn \n\t\t\t\t} else if(this.pvx) {\t\t\n\t\t\t\t\t\tthis.vcx = 0 \n\t\t\t\t\t\tthis.vcy = 0\n\t\t\t\t\t\tthis.vcz = 0 \n\t\t\t\t\t\tthis.pvx = false \n\t\t\t\t}\n\t\t\t\tif(this.cam.padRot && gp.dpad[0]>0) {\n\t\t\t\t\tlet rot = ((axes[0]>0)?1:-1) * this.cam.rotAngle\n\t\t\t\t\tthis.cam.camRY += rot\n\t\t\t\t\tif(false && this.cam.position) {\n\t\t\t\t\t\tlet th = rot * RAD \n\t\t\t\t\t\tthis.cam.camCX += Math.cos(th)*this.cam.position[0]+ Math.sin(th)*this.cam.position[2]\n\t\t\t\t\t\tthis.cam.camCZ += -Math.sin(th)*this.cam.position[0]+ Math.cos(th)*this.cam.position[2]\n\t\t\t\t\t\tconsole.log(Math.cos(th)*this.cam.position[0]+ Math.sin(th)*this.cam.position[2]\n\t\t\t\t\t\t,-Math.sin(th)*this.cam.position[0]+ Math.cos(th)*this.cam.position[2])\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tmoveTo(x,y,z,opt) {\n\t\t\tif(this.cama) return \n\t\t\tlet cx = (x!==null)?x:this.cam.camCX\n\t\t\tlet cy = (y!==null)?y:this.cam.camCY\n\t\t\tlet cz = (z!==null)?z:this.cam.camCZ \n\t\t\tif(opt && opt.velocity) {\n\t\t\t\tlet vx = cx - this.cam.camCX \n\t\t\t\tlet vy = cy - this.cam.camCY \n\t\t\t\tlet vz = cz - this.cam.camCZ\n\t\t\t\tlet l = opt.velocity / Math.hypot(vx,vy,vz)\n\t\t\t\tvx *= l , vy *= l, vz *= l\n\t\t\t\tthis.acx = vx \n\t\t\t\tthis.acy = vy\n\t\t\t\tthis.acz = vz\n\t\t\t\tthis.aex = cx \n\t\t\t\tthis.aey = cy \n\t\t\t\tthis.aez = cz\n\t\t\t\tthis.al = opt.velocity/l\n\t\t\t\tthis.ad = 0 \n\t\t\t\tthis.av = opt.velocity \n\t\t\t\tthis.cama = true \n\t\t\t} else {\n\t\t\t\tthis.cam.camCX = cx \n\t\t\t\tthis.cam.camCY = cy \n\t\t\t\tthis.cam.camCZ = cz \n\t\t\t\tthis.cama = false \n\t\t\t}\n\t\t}\n\t\tmoveCancel() {\n\t\t\tthis.cama = false \n\t\t}\n\t\tgetMtx(scale,sf) {\n\t\t\tconst cam = this.cam ;\n\t\t\tconst can = this.poxp.render.wwg.can ;\n\n\t\t\tconst aspect = can.width/(can.height*((sf)?2:1)) ;\n\t\t\tconst cams = [];\n\t\t//console.log(cam);\n\t\t//console.log(cam.camRX+\"/\"+cam.camRY) ;\n\t\t\tlet cx,cy,cz,ex,ey,ez,upx,upy,upz,camd ;\n\t\t\tlet vrFrame = null\n\t\t\tupx = cam.camUPX ;\n\t\t\tupy = cam.camUPY ;\n\t\t\tupz = cam.camUPZ ;\t\n\t\t\tex =[0,0], ey=[0,0],ez=[0,0] ;\n\t\t\tif(!this.poxp.isVR) {\n\t\t\t\tif(cam.camMode==\"fix\") {\n\t\t\t\t\tcx = cam.camVX ;\n\t\t\t\t\tcy = cam.camVY ;\n\t\t\t\t\tcz = cam.camVZ ;\n\t\t\t\t\tthis.cam.headVec = [cx,cy,cz,0]\n\t\t\t\t}\n\t\t\t\telse if(cam.camMode==\"vr\" || cam.camMode==\"walk\") {\n\t\t\t\t\t// self camera mode \n\t\t\t\t\tcx = cam.camCX + Math.sin(cam.camRY*RAD)*1*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcy = cam.camCY + -Math.sin(cam.camRX*RAD)*1 ; \n\t\t\t\t\tcz = cam.camCZ + -Math.cos(cam.camRY*RAD)*1*Math.cos(cam.camRX*RAD)\t\n\t\t\t\t\tlet cmat = new Mat4().rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0).rotate(-this.cam.camRZ,0,0,1)\n\t\t\t\t\tupx = -Math.sin(cam.camRZ*RAD)\n\t\t\t\t\tupy = Math.cos(cam.camRZ*RAD)\n\t\t\t\t\tthis.cam.headVec = cmat.multVec4(0,0,-1,0)\n\t\t\t\t} else  {\n\t\t\t\t// bird camera mode \n\t\t\t\t\tcamd=  cam.camd*scale ;\n\t\t\t\t\tcam.camCX  = -Math.sin(cam.camRY*RAD)*camd*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcam.camCY = Math.sin(cam.camRX*RAD)*camd ; \n\t\t\t\t\tcam.camCZ = Math.cos(cam.camRY*RAD)*camd*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcx = 0 ,cy = 0, cz = 0 ;\n\t\t\t\t\tif(camd<0) {\n\t\t\t\t\t\tcx = cam.camCX*2 ;cy = cam.camCY*2 ;cz = cam.camCZ*2 ;\n\t\t\t\t\t}\n\t\t\t\t\tlet l = Math.hypot(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\t\t\tthis.cam.headVec = [-cam.camCX/l,-cam.camCY/l,-cam.camCZ/l,0] \n\t\t\t\t}\n\t\t\t\tthis.cam.campos = [cam.camCX,cam.camCY,cam.camCZ]\n\n\t\t\t\tthis.camVP[0].makeIdentity()\n\t\t\t\tthis.camVP[1].makeIdentity()\n\t\t\t\tthis.camP[0].makeIdentity()\n\t\t\t\tthis.camP[1].makeIdentity()\n\t\t\t\tthis.camV[0].makeIdentity()\n\t\t\t\tthis.camV[1].makeIdentity()\n\t\t\t\t\t\n\t\t\t\tif(sf) {\t\t// for stereo\n\t\t\t\t\tconst dx = -cam.sbase * scale ;\t// stereo base\n\t\t\t\t\tex[0] =  upy * (cam.camCZ-cz) - upz * (cam.camCY-cy);\n\t\t\t\t\tey[0] = -upx * (cam.camCZ-cz) + upz * (cam.camCX-cx);\n\t\t\t\t\tez[0] =  upx * (cam.camCY-cy) - upy * (cam.camCX-cx);\n\t\t\t\t\tconst mag = Math.hypot(ex[0],ey[0],ez[0]);\n\t\t\t\t\tex[0] *= dx/mag ; ey[0] *=dx/mag ; ez[0] *= dx/mag ;\n\t\t\t\t\tex[1] = -ex[0] ; ey[1] = -ey[0] ; ez[1] = -ez[0] ;\n\t\t\t//\t\t\tconsole.log(dx+\":\"+xx+\"/\"+xy+\"/\"+xz)\n\t\t\t\t\tthis.camV[0].lookat(ex[0]+cam.camCX, ey[0]+cam.camCY, ez[0]+cam.camCZ, cx+ex[0], cy+ey[0], cz+ez[0], upx,upy,upz) ;\n\t\t\t\t\tthis.camV[1].lookat(ex[1]+cam.camCX, ey[1]+cam.camCY, ez[1]+cam.camCZ, cx+ex[1], cy+ey[1], cz+ez[1], upx,upy,upz) ;\n\n\t\t\t\t\tif(cam.camAngle!=0) this.camP[0].perspective(cam.camAngle,aspect, cam.camNear, cam.camFar)\n\t\t\t\t\telse this.camP[0].pallarel(cam.camd,aspect, cam.camNear, cam.camFar) ;\n\t\t\t\t\tthis.camP[1] = this.camP[0]\n\t\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.camP[0])\n\t\t\t\t\tthis.camVP[1].load(this.camV[1]).multRight(this.camP[1])\n\t\t\t\t} else {\n\t\t\t\t\tthis.camV[0].lookat(cam.camCX, cam.camCY, cam.camCZ, cx, cy, cz, upx,upy,upz) ;\n\t\t\t\t\tif(cam.camAngle!=0) this.camP[0].perspective(cam.camAngle,aspect, cam.camNear, cam.camFar)\n\t\t\t\t\telse this.camP[0].pallarel(cam.camd,aspect, cam.camNear, cam.camFar) ;\n\t\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.camP[0])\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(this.poxp.isVR) {\n\t\t\t\t\n\t\t\t\tPOXPDevice.setDepth({camNear:cam.camNear,camFar:cam.camFar})\n\n\t\t\t\tvrFrame = POXPDevice.getFrameData()\n\t\t//\t\tconsole.log(vrFrame)\n\t\t\t\tif(!vrFrame) return \n\t\t\t\tthis.cam.orientation = vrFrame.pose.orientation\n\t\t\t\tthis.cam.position = vrFrame.pose.position\n\t\t\t\tif(!this.cam.position) this.cam.position = [0,0,0]\n\t\t\t\tthis.vrv[1].load(vrFrame.rightViewMatrix)\n\t\t\t\tthis.vrv[0].load(vrFrame.leftViewMatrix)\n\t\t\t\tthis.vrp[1].load(vrFrame.rightProjectionMatrix)\n\t\t\t\tthis.vrp[0].load(vrFrame.leftProjectionMatrix)\n\t\t \n\t\t\t\tthis.tempM.makeIdentity()\n\t\t\t\t\t.translate(-cam.camCX,-cam.camCY,-cam.camCZ)\n\t\t\t\t\t.rotate(cam.camRX,1,0,0)\n\t\t\t\t\t.rotate(cam.camRY,0,1,0)\n\t\t\t\t\t.rotate(cam.camRZ,0,0,1)\n\n\t\t\t\tthis.camV[0].load(this.vrv[0])\n\t\t\t\tif(this.leftCorrMtx) this.camV[0].multRight(this.leftCorrMtx)\n\t\t\t\tthis.camV[0].multLeft( this.tempM )\n\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.vrp[0]) \n\t\t\t\tthis.camP[0].load(this.vrp[0])\n\t\t\t\t\n\t\t\t\tthis.camV[1].load(this.vrv[1])\n\t\t\t\tif(this.rightCorrMtx) this.camV[1].multRight(this.rightCorrMtx)\n\t\t\t\tthis.camV[1].multLeft( this.tempM )\n\t\t\t\tthis.camVP[1].load(this.camV[1]).multRight(this.vrp[1]) \n\t\t\t\tthis.camP[1].load(this.vrp[1])\n\t\t\t\t\n\t\t\t\tlet cx =0,cy =0,cz=1\n\t\t\t\tif(this.cam.orientation ) {\n\t\t\t\t\tlet x = this.cam.orientation[0] ;\n\t\t\t\t\tlet y = this.cam.orientation[1] ;\n\t\t\t\t\tlet z = this.cam.orientation[2] ;\n\t\t\t\t\tlet w = this.cam.orientation[3] ;\n\t\t\t\t\tcx = 2*(-x*z-y*w) \n\t\t\t\t\tcy = 2*(-y*z+x*w)\n\t\t\t\t\tcz = (x*x+y*y-z*z-w*w)\n\t\t\t\t\tlet l = Math.hypot(cx,cy,cz)\n\t\t\t\t\tcx /= l ,cy /=l, cz /= l \n\t\t\t\t}\n\t\t\t\tthis.tempM.invert() \n\t\t//\t\tlet cmat = new Mat4().rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0)\n\t\t//\t\tcmat.translate(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\t\tlet cmat = this.tempM \n\t\t\t\tthis.cam.headVec = cmat.multVec4(cx,cy,cz,0)\n\t\t\t\tthis.cam.campos = cmat.multVec4(this.cam.position[0],this.cam.position[1],this.cam.position[2],1).slice(0,3)\n\n\t\t\t\tlet ivr = new Mat4().load(this.camV[1]).invert() ;\n\t\t\t\tlet ivl = new Mat4().load(this.camV[0]).invert() ;\n\t\t\t\tex[0] = ivl.buf[12] -cam.camCX\n\t\t\t\tey[0] = ivl.buf[13] -cam.camCY\n\t\t\t\tez[0] = ivl.buf[14] -cam.camCZ \n\t\t\t\tex[1] = ivr.buf[12] -cam.camCX\n\t\t\t\tey[1] = ivr.buf[13] -cam.camCY\n\t\t\t\tez[1] = ivr.buf[14] -cam.camCZ\n\t\t\t}\n\t\t//\tconsole.log(camVP)\n\t\t\treturn [{camX:cam.camCX+ex[0],camY:cam.camCY+ey[0],camZ:cam.camCZ+ez[0], \n\t\t\t\tcamV:this.camV[0],camVP:this.camVP[0],camP:this.camP[0], vrFrame:vrFrame},\n\t\t\t{camX:cam.camCX+ex[1],camY:cam.camCY+ey[1],camZ:cam.camCZ+ez[1],\n\t\t\t\tcamV:this.camV[1],camVP:this.camVP[1],camP:this.camP[1],vrFrame:vrFrame}] ;\n\t\t}\n\t} // class Camera\n\n\treturn poxp.PoxCamera = Camera;\n});"]}