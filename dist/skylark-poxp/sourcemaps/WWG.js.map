{"version":3,"sources":["WWG.js"],"names":["define","poxp","WWG","this","version","can","gl","vsize","float","vec2","vec3","vec4","mat2","mat3","mat4","prototype","init","canvas","opt","getContext","window","Promise","ext_vao","getExtension","vao_create","createVertexArrayOES","vao_bind","o","bindVertexArrayOES","ext_inst","inst_divisor","p","d","vertexAttribDivisorANGLE","inst_draw","m","l","s","c","drawElementsInstancedANGLE","inst_drawa","drawArrayInstancedANGLE","ext_anis","ext_ftex","ext_mrt","mrt_att","COLOR_ATTACHMENT0_WEBGL","mrt_draw","b","drawBuffersWEBGL","ext_i32","ext_mv","console","log","dmodes","tri_strip","TRIANGLE_STRIP","tri","TRIANGLES","points","POINTS","lines","LINES","line_strip","LINE_STRIP","init2","createVertexArray","bindVertexArray","vertexAttribDivisor","drawElementsInstanced","drawArraysInstanced","ext_anis_max","getParameter","MAX_TEXTURE_MAX_ANISOTROPY_EXT","MAX_DRAW_BUFFERS","COLOR_ATTACHMENT0","drawBuffers","loadAjax","src","resolve","reject","req","XMLHttpRequest","open","responseType","type","onload","status","response","statusText","onerror","send","loadImageAjax","then","timg","Image","url","URL","createObjectURL","revokeObjectURL","catch","err","createRender","Render","wwg","env","modelCount","modelId","setUnivec","uni","value","pos","ar","dim","Float32Array","i","concat","cache","Array","isArray","length","uniformMatrix2fv","f32Array","uniformMatrix3fv","uniformMatrix4fv","uniform2fv","uniform3fv","uniform4fv","uniform1i","uniform2iv","i16Array","uniform3iv","uniform4iv","uniform1iv","uniform1f","uniform1fv","getTexIndex","activeTexture","TEXTURE0","texunit","bindTexture","TEXTURE_2D","texobj","undefined","data","texture","video","texImage2D","RGBA","UNSIGNED_BYTE","setShader","tu","parse_shader","split","att","def","ln","match","RegExp","$1","trim","$2","u","name","$3","k","substr","parseInt","isNaN","push","vshader","fshader","vss","fss","pr","text","result","all","res","ret","createShader","VERTEX_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","FRAGMENT_SHADER","program","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","useProgram","vr","vs_att","getAttribLocation","vs_uni","getUniformLocation","fr","fs_uni","setUniValues","genTex","img","option","flevel","formatstr","rgb","RGB","gray","LUMINANCE","grayalpha","LUMINANCE_ALPHA","format","tex","createTexture","isarray","RGBA32F","width","height","FLOAT","nomipmap","generateMipmap","texParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","LINEAR","LINEAR_MIPMAP_LINEAR","repeat","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","MIRRORED_REPEAT","REPEAT","anisotropy","TEXTURE_MAX_ANISOTROPY_EXT","loadTex","cors","buffer","mrt","fb","t","array","addTex","texdata","removeTex","frameBuffer","os","ttype","tfilter","fblist","createFramebuffer","bindFramebuffer","FRAMEBUFFER","renderBuffer","createRenderbuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorage","DEPTH_COMPONENT16","framebufferRenderbuffer","DEPTH_ATTACHMENT","fTexture","framebufferTexture2D","ox","offsetX","oy","offsetY","f","setRender","cull","enable","CULL_FACE","disable","face_cw","frontFace","CW","CCW","nodepth","DEPTH_TEST","model","id","obuf","setObj","offscreen","clear","cc","clear_color","clearColor","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","Int16Array","i32Array","Uint32Array","obj","flag","vao","geo","inst","vbo","createBuffer","bindBuffer","ARRAY_BUFFER","tl","ats","vtx_at","ibo","ibuf","ofs","disableVertexAttribArray","enableVertexAttribArray","vertexAttribPointer","idx","ELEMENT_ARRAY_BUFFER","attr","iats","itl","divisor","bufferData","vtx","DYNAMIC_DRAW","STATIC_DRAW","i32","getModels","filter","getModelIdx","addModel","removeModel","mi","updateModel","mode","buf","sub","bufferSubData","dofs","sofs","count","updateModelInstance","getModelData","updateTex","tdat","texSubImage2D","sx","sy","RGBA16F","wx","wy","pushUniValues","update_uni","updateUniValues","draw","update","cls","viewport","models","cmodel","hide","aofs","preFunction","blend","BLEND","blendFuncSeparate","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE","gmode","UNSIGNED_INT","UNSIGNED_SHORT","drawElements","drawArrays","postFunction"],"mappings":"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","file":"../WWG.js","sourcesContent":["define([\n    \"./poxp\"\n],function(poxp){\n\t//WWG Simple WebGL wrapper library\n\t// Version 0.9 \n\t// 2016-2017 wakufactory.jp \n\t// license: MIT \n\t// WWG\n\t//   init(canvas)\n\t//   init2(canvas)\n\t//   loadAjax(src,opt)\n\t//   loadImageAjax(src)\n\t//   createRender()\n\t// Render\n\t//   setRender(scene)\n\t//   draw(update,cls)\n\t//   addModel(model)\n\t//   updateModel(name,mode,buf)\n\t//   addTex(texobj)\n\t//   loadTex(tex)\n\n\tfunction WWG() {\n\t\tthis.version = \"0.9.11\" ;\n\t\tthis.can = null ;\n\t\tthis.gl = null ;\n\t\tthis.vsize = {\"float\":1,\"vec2\":2,\"vec3\":3,\"vec4\":4,\"mat2\":4,\"mat3\":9,\"mat4\":16} ;\n\t}\n\tWWG.prototype.init = function(canvas,opt) {\n\t\tthis.can = canvas ;\n\t\tlet gl \n\t\tif(!((gl = canvas.getContext(\"experimental-webgl\",opt)) || (gl = canvas.getContext(\"webgl\",opt)))) { return false } ;\n\t\tif(!window.Promise) return false ;\n\t\tthis.gl = gl \n\t\tthis.ext_vao = gl.getExtension('OES_vertex_array_object');\n\t\tif(this.ext_vao) {\n\t\t\tthis.vao_create = function(){return this.ext_vao.createVertexArrayOES()} ;\n\t\t\tthis.vao_bind = function(o){this.ext_vao.bindVertexArrayOES(o)} ;\n\t\t}\n\t\tthis.ext_inst = gl.getExtension('ANGLE_instanced_arrays');\n\t\tif(this.ext_inst) {\n\t\t\tthis.inst_divisor = function(p,d){this.ext_inst.vertexAttribDivisorANGLE(p, d)}\n\t\t\tthis.inst_draw = function(m,l,s,o,c){this.ext_inst.drawElementsInstancedANGLE(m,l, s, o, c);}\n\t\t\tthis.inst_drawa = function(m,s,o,c) {this.ext_inst.drawArrayInstancedANGLE(m, s, o, c);}\n\t\t}\n\t\tthis.ext_anis = gl.getExtension(\"EXT_texture_filter_anisotropic\");\n\t\tthis.ext_ftex = gl.getExtension('OES_texture_float');\n\t\tthis.ext_mrt = gl.getExtension('WEBGL_draw_buffers');\n\t\tif(this.ext_mrt) {\n\t\t\tthis.mrt_att = this.ext_mrt.COLOR_ATTACHMENT0_WEBGL ;\n\t\t\tthis.mrt_draw = function(b,d){return this.ext_mrt.drawBuffersWEBGL(b,d)} ;\n\t\t}\n\t\tthis.ext_i32 = gl.getExtension('OES_element_index_uint')\n\t\tthis.ext_mv = gl.getExtension('WEBGL_multiview');\n\t\tif (this.ext_mv) \n\t        console.log(\"MULTIVIEW extension is supported\");\n\t\telse {\n\t\t\tthis.ext_mv = gl.getExtension('OVR_multiview');\n\t\t\tif (this.ext_mv)\n\t\t\t\tconsole.log(\"OVR MULTIVIEW extension is supported\");\n\t\t} \n\t\tthis.dmodes = {\"tri_strip\":gl.TRIANGLE_STRIP,\"tri\":gl.TRIANGLES,\"points\":gl.POINTS,\"lines\":gl.LINES,\"line_strip\":gl.LINE_STRIP }\n\t\tthis.version = 1 ;\n\t\treturn true ;\n\t}\n\tWWG.prototype.init2 = function(canvas,opt) {\n\t\tthis.can = canvas ;\n\t\tlet gl \n\t\tif(!((gl = canvas.getContext(\"experimental-webgl2\",opt)) || (gl = canvas.getContext(\"webgl2\",opt)))) { return false } ;\n\t\tif(!window.Promise) return false ;\n\t\tconsole.log(\"init for webGL2\") ;\n\t\tthis.gl = gl ;\n\t\t\n\t\tthis.ext_vao = true ;\n\t\tthis.vao_create = function(){ return this.gl.createVertexArray()} ;\n\t\tthis.vao_bind = function(o){this.gl.bindVertexArray(o)} ;\n\t\tthis.ext_inst = true ;\n\t\tthis.inst_divisor = function(p,d){this.gl.vertexAttribDivisor(p, d)}\n\t\tthis.inst_draw = function(m,l,s,o,c){this.gl.drawElementsInstanced(m,l, s, o, c);}\n\t\tthis.inst_drawa = function(m,s,o,c) {this.gl.drawArraysInstanced(m, s, o, c);}\n\t\tthis.ext_anis = gl.getExtension(\"EXT_texture_filter_anisotropic\");\n\t\tif(this.ext_anis) this.ext_anis_max = gl.getParameter(this.ext_anis.MAX_TEXTURE_MAX_ANISOTROPY_EXT);\n\t\tthis.ext_ftex = true ;\n\t\tthis.ext_mrt = (gl.getParameter(gl.MAX_DRAW_BUFFERS)>1) ;\n\t\tif(this.ext_mrt) {\n\t\t\tthis.mrt_att = gl.COLOR_ATTACHMENT0 ;\n\t\t\tthis.mrt_draw =  function(b,d){return gl.drawBuffers(b,d)} ;\n\t\t}\n\t\tthis.ext_i32 = true ;\n\t\tthis.ext_mv = gl.getExtension('WEBGL_multiview');\n\t\tif (this.ext_mv) \n\t        console.log(\"MULTIVIEW extension is supported\");\n\t\telse {\n\t\t\tthis.ext_mv = gl.getExtension('OVR_multiview');\n\t\t\tif (this.ext_mv)\n\t\t\t\tconsole.log(\"OVR MULTIVIEW extension is supported\");\n\t\t} \n\t\tthis.dmodes = {\"tri_strip\":gl.TRIANGLE_STRIP,\"tri\":gl.TRIANGLES,\"points\":gl.POINTS,\"lines\":gl.LINES,\"line_strip\":gl.LINE_STRIP }\n\t\tthis.version = 2 ;\n\t\treturn true ;\n\t}\n\tWWG.prototype.loadAjax = function(src,opt) {\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tconst req = new XMLHttpRequest();\n\t\t\treq.open(\"get\",src,true) ;\n\t\t\treq.responseType = (opt && opt.type)?opt.type:\"text\" ;\n\t\t\treq.onload = ()=> {\n\t\t\t\tif(req.status==200) {\n\t\t\t\t\tresolve(req.response) ;\n\t\t\t\t} else {\n\t\t\t\t\treject(\"Ajax error:\"+req.statusText) ;\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\treq.onerror = ()=> {\n\t\t\t\treject(\"Ajax error:\"+req.statusText)\n\t\t\t}\n\t\t\treq.send() ;\n\t\t})\n\t}\n\tWWG.prototype.loadImageAjax = function(src) {\n\t\treturn new Promise((resolve,reject)=>{\n\t\t\tthis.loadAjax(src,{type:\"blob\"}).then((b)=>{\n\t\t\t\tconst timg = new Image ;\n\t\t\t\tconst url = URL.createObjectURL(b);\n\t\t\t\ttimg.onload = ()=> {\n\t\t\t\t\tURL.revokeObjectURL(url)\n\t\t\t\t\tresolve(timg) ;\n\t\t\t\t}\n\t\t\t\ttimg.src = url\n\t\t\t}).catch((err)=>{\n\t\t\t\tconsole.log(err)\n\t\t\t\tresolve(null) ;\n\t\t\t})\n\t\t})\n\t}\n\n\t// Render unit\n\tWWG.prototype.createRender = function() {\n\t\treturn new this.Render(this) ;\n\t}\n\tWWG.prototype.Render = function(wwg) {\n\t\tthis.wwg = wwg ;\n\t\tthis.gl = wwg.gl ;\n\t\tthis.env = {} ;\n\t//\tthis.obuf = [] ;\n\t\tthis.modelCount = 0 ;\n\t\tthis.modelId = 0 \n\t//\tthis.modelHash = {} ;\n\t}\n\tWWG.prototype.Render.prototype.setUnivec = function(uni,value) {\n\t\tif(uni.pos==null) return \n\t//\tconsole.log(\"set \"+uni.type+\"(\"+uni.pos+\") = \"+value) ;\n\t\tlet ar = [] ;\n\t\tif(uni.dim>0 && !(value instanceof Float32Array)) for(let i=0;i<uni.dim;i++) ar = ar.concat(value[i])\n\t\telse ar = value \n\t\tif(uni.cache!=null) {\n\t\t\tif(Array.isArray(ar)) {\n\t\t\t\tfor(let i=0;i<ar.length;i++) if(ar[i]!=uni.cache[i]) break ;\n\t\t\t\tif(i==ar.length) return ;\n\t\t\t} else if(ar == uni.cache) return ;\n\t\t}\n\t//\tconsole.log(\"set uni\")\n\t\tswitch(uni.type) {\n\t\t\tcase \"mat2\":\n\t\t\t\tthis.gl.uniformMatrix2fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"mat3\":\n\t\t\t\tthis.gl.uniformMatrix3fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"mat4\":\n\t\t\t\tthis.gl.uniformMatrix4fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec2\":\n\t\t\t\tthis.gl.uniform2fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec2v\":\n\t\t\t\tthis.gl.uniform2fv(uni.pos, this.f32Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec3\":\n\t\t\t\tthis.gl.uniform3fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec3v\":\n\t\t\t\tthis.gl.uniform3fv(uni.pos, this.f32Array(ar))\n\t\t\t\tbreak ;\n\t\t\tcase \"vec4\":\n\t\t\t\tthis.gl.uniform4fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec4v\":\n\t\t\t\tthis.gl.uniform4fv(uni.pos, this.f32Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"int\":\n\t\t\tcase \"bool\":\n\t\t\t\tthis.gl.uniform1i(uni.pos,value) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec2\":\n\t\t\tcase \"bvec2\":\n\t\t\t\tthis.gl.uniform2iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec2v\":\n\t\t\tcase \"bvec2v\":\n\t\t\t\tthis.gl.uniform2iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec3\":\n\t\t\tcase \"bvec3\":\n\t\t\t\tthis.gl.uniform3iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec3v\":\n\t\t\tcase \"bvec3v\":\n\t\t\t\tthis.gl.uniform3iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec4\":\n\t\t\tcase \"bvec4\":\n\t\t\t\tthis.gl.uniform4iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec4v\":\n\t\t\tcase \"bvec4v\":\n\t\t\t\tthis.gl.uniform4iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"intv\":\n\t\t\tcase \"boolv\":\n\t\t\t\tthis.gl.uniform1iv(uni.pos,this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"float\":\n\t\t\t\tthis.gl.uniform1f(uni.pos,value) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"floatv\":\n\t\t\t\tthis.gl.uniform1fv(uni.pos,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"sampler2D\":\n\t\t\t\tif(typeof value == 'string') value = this.getTexIndex(value)\n\t\t\t\tthis.gl.activeTexture(this.gl.TEXTURE0+uni.texunit);\n\t\t\t\tthis.gl.bindTexture(this.gl.TEXTURE_2D, this.texobj[value]);\n\t\t\t\tif(this.data.texture[value]==undefined) break ;\n\t\t\t\tif(this.data.texture && this.data.texture[value].video) {\n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.data.texture[value].video);\t\n\t\t\t\t}\n\t\t\t\tthis.gl.uniform1i(uni.pos,uni.texunit) ;\n\t\t\t\tbreak ;\n\t\t}\n\t}\n\n\tWWG.prototype.Render.prototype.setShader = function(data) {\n\t\tlet tu = 0 ;\n\t\tfunction parse_shader(src) {\n\t\t\tconst l = src.split(\"\\n\") ;\n\t\t\tconst uni = [] ;\n\t\t\tconst att = [] ;\n\t\t\tconst def = {}\n\n\t\t\tfor(i=0;i<l.length;i++) {\n\t\t\t\tlet ln = l[i] ;\n\t\t\t\tif( ln.match(/^\\s*#define\\s*([^\\s]+)\\s+([^\\s]+)/)) {\n\t\t\t\t\tdef[RegExp.$1.trim()] = RegExp.$2.trim()\n\t\t\t\t}\n\t\t\t\tif( ln.match(/^\\s*uniform\\s*([0-9a-z]+)\\s+([0-9a-z_]+)(\\[[^\\]]+\\])?/i)) {\n\t\t\t\t\tlet u = {type:RegExp.$1,name:RegExp.$2} ;\n\t\t\t\t\tif(RegExp.$3!=\"\") {\n\t\t\t\t\t\tu.type = u.type+\"v\" ;\n\t\t\t\t\t\tlet k = RegExp.$3.substr(1,RegExp.$3.length-2).trim()\n\t\t\t\t\t\tu.dim = parseInt(k) ;\n\t\t\t\t\t\tif(isNaN(u.dim)) u.dim = def[k]\n\t\t\t\t\t}\n\t\t\t\t\tif(u.type==\"sampler2D\") u.texunit = tu++ ;\n\t\t\t\t\tuni.push(u) ;\n\t\t\t\t}\n\t\t\t\tif( ln.match(/^\\s*(?:attribute|in)\\s+([0-9a-z]+)\\s*([0-9a-z_]+)/i)) {\n\t\t\t\t\tatt.push( {type:RegExp.$1,name:RegExp.$2}) ;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {uni:uni,att:att} ;\n\t\t}\n\n\t\tconst gl = this.gl ;\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(!data.vshader) { reject(\"no vshader\") ;return false;}\n\t\t\tif(!data.fshader) { reject(\"no fshader\") ;return false;}\n\t\t\tlet vss ;\n\t\t\tlet fss ;\n\t\t\tlet pr = [] ;\n\t\t\tif(data.vshader.text ) vss = data.vshader.text ;\n\t\t\telse if(data.vshader.src) {\n\t\t\t\tpr.push( this.wwg.loadAjax(data.vshader.src).then((result)=> {\n\t\t\t\t\tvss = result ;\n\t\t\t\t\tresolve() ;\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t}))\n\t\t\t}\n\t\t\tif(data.fshader.text ) fss = data.fshader.text ;\n\t\t\telse if(data.fshader.src) {\n\t\t\t\tpr.push( this.wwg.loadAjax(data.fshader.src).then((result)=> {\n\t\t\t\t\tfss = result ;\n\t\t\t\t\tresolve() ;\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t}))\n\t\t\t}\n\t\t\tPromise.all(pr).then((res)=> {\n\t//\t\t\tconsole.log(vss) ;\n\t//\t\t\tconsole.log(fss) ;\n\t\t\t\tlet ret = {} ;\n\t\t\t\tlet vshader = gl.createShader(gl.VERTEX_SHADER);\n\t\t\t\tgl.shaderSource(vshader, vss);\n\t\t\t\tgl.compileShader(vshader);\n\t\t\t\tif(!gl.getShaderParameter(vshader, gl.COMPILE_STATUS)) {\n\t\t\t\t\treject(\"vs error:\"+gl.getShaderInfoLog(vshader)); return false;\n\t\t\t\t}\n\t\t\t\tret.vshader = vshader ;\n\t\t\t\n\t\t\t\tlet fshader = gl.createShader(gl.FRAGMENT_SHADER);\n\t\t\t\tgl.shaderSource(fshader, fss);\n\t\t\t\tgl.compileShader(fshader);\n\t\t\t\tif(!gl.getShaderParameter(fshader, gl.COMPILE_STATUS)) {\n\t\t\t\t\treject(\"fs error:\"+gl.getShaderInfoLog(fshader)); return false;\n\t\t\t\t}\n\t\t\t\tret.fshader = fshader ;\n\t\t\t\t\n\t\t\t\tlet program = gl.createProgram();\n\t\t\t\tgl.attachShader(program, vshader);\n\t\t\t\tgl.attachShader(program, fshader);\n\t\t\t\tgl.linkProgram(program);\n\t\t\t\tif(!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n\t\t\t\t\treject(\"link error:\"+gl.getProgramInfoLog(program)); return false;\n\t\t\t\t}\n\t\t\t\tret.program = program ;\n\t\t\t\tgl.useProgram(program);\n\t\t\t\n\t\t\t\tlet vr = parse_shader(vss) ;\t\n\t//\t\t\tconsole.log(vr) ;\n\t\t\t\tret.vs_att = {} ;\t\n\t\t\t\tfor(let i in vr.att) {\n\t\t\t\t\tvr.att[i].pos = gl.getAttribLocation(program,vr.att[i].name) ;\n\t\t\t\t\tret.vs_att[vr.att[i].name] = vr.att[i] ;\n\t\t\t\t}\n\t\t\t\tret.vs_uni = {} ;\n\t\t\t\tfor(let i in vr.uni) {\n\t\t\t\t\tvr.uni[i].pos = gl.getUniformLocation(program,vr.uni[i].name) ;\n\t\t\t\t\tvr.uni[i].cache = null \n\t\t\t\t\tret.vs_uni[vr.uni[i].name] = vr.uni[i] ;\n\t\t\t\t}\n\t\t\t\n\t\t\t\tlet fr = parse_shader(fss) ;\t\n\t//\t\t\tconsole.log(fr);\t\n\t\t\t\tret.fs_uni = {} ;\n\t\t\t\tfor(let i in fr.uni) {\n\t\t\t\t\tfr.uni[i].pos = gl.getUniformLocation(program,fr.uni[i].name) ;\n\t\t\t\t\tfr.uni[i].cache = null \n\t\t\t\t\tret.fs_uni[fr.uni[i].name] = fr.uni[i] ;\n\t\t\t\t}\n\t\t\t\tresolve(ret) ;\n\t\t\t}).catch((err)=>{\n\t\t\t\treject(err) ;\n\t\t\t}) ;\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.setUniValues = function(data) {\n\t\tif(data.vs_uni) {\n\t\t\tfor(let i in data.vs_uni) {\n\t\t\t\tif(this.vs_uni[i]) {\n\t\t\t\t\tthis.setUnivec(this.vs_uni[i], data.vs_uni[i]) ;\n\t\t\t\t}  ;\n\t\t\t}\n\t\t}\n\t\tif(data.fs_uni) {\n\t\t\tfor(let i in data.fs_uni) {\n\t\t\t\tif(this.fs_uni[i]) {\n\t\t\t\t\tthis.setUnivec(this.fs_uni[i], data.fs_uni[i]) ;\n\t\t\t\t}  ;\n\t\t\t}\n\t\t}\n\t\treturn true ;\n\t}\n\tWWG.prototype.Render.prototype.genTex = function(img,option) {\n\t\tif(!option) option={flevel:0} ;\n\t\tlet gl = this.gl ;\n\t\tconst formatstr = {\"rgb\":gl.RGB,\"gray\":gl.LUMINANCE,\"grayalpha\":gl.LUMINANCE_ALPHA}\n\t\tlet format = (option.format && formatstr[option.format])?formatstr[option.format]:gl.RGBA\n\n\t\tlet tex = gl.createTexture();\n\t\tgl.bindTexture(gl.TEXTURE_2D, tex);\n\t\tif(option.isarray) {\n\t\t\tif(img instanceof Float32Array ) \n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, option.width,option.height,0,format, gl.FLOAT, img,0);\n\t\t\telse \n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, option.width,option.height,0,format, gl.UNSIGNED_BYTE, img);\n\t\t\t option.flevel = 0 \n\t\t\t option.nomipmap = true\n\t\t} else \tgl.texImage2D(gl.TEXTURE_2D, 0, format, format,gl.UNSIGNED_BYTE, img);\n\n\t\tif(!option.nomipmap) gl.generateMipmap(gl.TEXTURE_2D);\n\t\t//NEAREST LINEAR NEAREST_MIPMAP_NEAREST NEAREST_MIPMAP_LINEAR LINEAR_MIPMAP_NEAREST LINEAR_MIPMAP_LINEAR\n\t\tswitch(option.flevel) {\n\t\tcase 0:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tbreak;\n\t\t}\n\t\tif(option.repeat==2) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\t} else if(option.repeat==1) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.MIRRORED_REPEAT);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.MIRRORED_REPEAT);\t\t\t\t\n\t\t} else {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\n\t\t}\n\t\tif(this.wwg.ext_anis && option.anisotropy) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, this.wwg.ext_anis.TEXTURE_MAX_ANISOTROPY_EXT, option.anisotropy);\n\t\t}\n\t\tgl.bindTexture(gl.TEXTURE_2D, null);\t\n\t\treturn tex ;\t\n\t}\n\tWWG.prototype.Render.prototype.loadTex = function(tex) {\n\t//\tconsole.log( tex);\n\t\tlet gl = this.gl ;\n\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(tex.src) {\n\t\t\t\tif(tex.opt && tex.opt.cors) {\n\t\t\t\t\tthis.wwg.loadImageAjax(tex.src).then((img)=>{\n\t\t\t\t\t\tresolve( this.genTex(img,tex.opt)) ;\n\t\t\t\t\t}).catch((err)=>reject(err));\n\t\t\t\t} else {\n\t\t\t\t\tlet img = new Image() ;\n\t\t\t\t\timg.onload = ()=> {\n\t\t\t\t\t\tresolve( this.genTex(img,tex.opt) ) ;\n\t\t\t\t\t}\n\t\t\t\t\timg.onerror = ()=> {\n\t\t\t\t\t\treject(\"cannot load image\") ;\n\t\t\t\t\t}\n\t\t\t\t\timg.src = tex.src ;\n\t\t\t\t}\n\t\t\t} else if(tex.img instanceof Image) {\n\t\t\t\tresolve( this.genTex(tex.img,tex.opt) ) \n\t\t\t} else if(tex.video ) {\n\t\t\t\tresolve( this.genTex(tex.video,{nomipmap:true,flevel:0,repeat:2}) ) \n\t\t\t} else if(tex.buffer) {\n\t\t\t\tif(tex.mrt!=undefined) {\n\t\t\t\t\tresolve( tex.buffer.fb.t[tex.mrt])\n\t\t\t\t}\n\t\t\t\telse resolve( tex.buffer.fb.t) ;\n\t\t\t} else if(tex.texture) {\n\t\t\t\tresolve( tex.texture) ;\n\t\t\t} else if(tex.canvas) {\n\t\t\t\tresolve( this.genTex(tex.canvas,tex.opt)) ;\n\t\t\t} else if(tex.array) {\n\t\t\t\ttex.opt.isarray = true ;\n\t\t\t\tresolve( this.genTex(tex.array,tex.opt)) ;\n\t\t\t} else {\n\t\t\t\treject(\"no image\")\n\t\t\t}\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.getTexIndex = function(name) {\n\t\tif(!this.data.texture) return null \n\t\tlet i \n\t\tfor(i=0;i<this.data.texture.length;i++) {\n\t\t\tif(this.data.texture[i].name==name) break;\n\t\t}\n\t\treturn (i==this.data.texture.length)?null:i\n\t}\n\tWWG.prototype.Render.prototype.addTex = function(texdata) {\n\t\treturn new Promise((resolve,reject)=>{\n\t\t\tif(!this.data.texture) this.data.texture = []\n\t\t\tthis.data.texture.push(texdata)\n\t\t\tthis.loadTex(texdata).then((tex)=>{\n\t\t\t\tthis.texobj.push(tex) ;\n\t\t\t\tresolve(this.texobj.length-1)\n\t\t\t}).catch((err)=>reject(err));\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.removeTex = function(tex) {\n\t\tif(typeof tex == \"string\") tex = this.getTexIndex(tex) \n\t\tif(tex === null ) return \n\t\tthis.data.texture[tex] = null\n\t\tthis.texobj[tex] = null \n\t}\n\n\tWWG.prototype.Render.prototype.frameBuffer = function(os) {\n\t\tlet gl = this.gl ;\n\t\tconsole.log(\"create framebuffer \"+os.width+\"x\"+os.height) ;\n\t\tlet mrt = os.mrt ;\n\t\tlet ttype = gl.UNSIGNED_BYTE ;\n\t\tlet tfilter = gl.LINEAR ;\n\t\tif(this.wwg.ext_ftex && os.float ) {\n\t\t\tttype = gl.FLOAT ;\n\t\t\ttfilter = gl.NEAREST ;\n\t\t\tconsole.log(\"use float tex\") ;\n\t\t}\n\t\tlet fblist = [] ;\n\t\tlet frameBuffer = gl.createFramebuffer();\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer);\n\t\t//depth\n\t\tlet renderBuffer = gl.createRenderbuffer();\n\t\tgl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\n\t\tgl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, os.width, os.height);\t\n\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderBuffer);\n\t\t//texture\n\t\tif(mrt) {\n\t\t\tlet fTexture = [] ;\n\t\t\tfor(let i=0;i<mrt;i++) {\n\t\t\t\tfTexture[i] = gl.createTexture();\n\t\t\t\tgl.bindTexture(gl.TEXTURE_2D, fTexture[i]);\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, os.width, os.height, 0, gl.RGBA, ttype, null);\n\t\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, tfilter);\n\t\t\t    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, tfilter);\n\t\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, this.wwg.mrt_att + i, gl.TEXTURE_2D, fTexture[i], 0);\t\n\t\t\t\tfblist.push(this.wwg.mrt_att + i)\t\t\n\t\t\t}\n\t\t} else {\n\t\t\tlet fTexture = gl.createTexture()\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, fTexture);\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, os.width, os.height, 0, gl.RGBA, ttype, null);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, tfilter);\n\t\t    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, tfilter);\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, fTexture, 0);\n\t\t}\n\t\tgl.bindTexture(gl.TEXTURE_2D, null);\n\t\tgl.bindRenderbuffer(gl.RENDERBUFFER, null);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\t\n\n\t\tlet ret = {ox:os.offsetX,oy:os.offsetY,width:os.width,height:os.height,f:frameBuffer,d:renderBuffer,t:fTexture}\n\t\tif(mrt) ret.fblist = fblist ;\n\t\treturn ret ;\n\t}\n\tWWG.prototype.Render.prototype.setRender =function(data) {\n\t\tlet gl = this.gl ;\n\t\tthis.env = data.env ;\n\t\tthis.data = data ;\n\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(!gl) { reject(\"no init\") ;return ;}\n\t\t\tlet pr = [] ;\n\t\t\tthis.setShader({fshader:data.fshader,vshader:data.vshader}).then((ret)=> {\n\t\t\t\t//set program\n\t\t\t\tthis.vshader = ret.vshader ;\n\t\t\t\tthis.fshader = ret.fshader ;\n\t\t\t\tthis.program = ret.program ;\n\t\t\t\tthis.vs_uni = ret.vs_uni ;\n\t\t\t\tthis.vs_att = ret.vs_att ;\n\t\t\t\tthis.fs_uni = ret.fs_uni ;\n\t\t\t\t\n\t\t\t\t// load textures\n\t\t\t\tif(data.texture) {\n\t\t\t\t\tfor(let i=0;i<data.texture.length;i++) {\n\t\t\t\t\t\tpr.push(this.loadTex( data.texture[i])) ;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tPromise.all(pr).then((result)=> {\n\t//\t\t\t\tconsole.log(result) ;\n\t\t\t\t\tthis.texobj = result ;\n\t\t\t\t\t// set initial values\n\t\t\t\t\tif(!this.setUniValues(data)) {\n\t\t\t\t\t\treject(\"no uniform name\") ;\n\t\t\t\t\t\treturn ;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(this.env.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t\t\tif(this.env.face_cw) gl.frontFace(gl.CW); else gl.frontFace(gl.CCW);\n\t\t\t\t\tif(!this.env.nodepth) gl.enable(gl.DEPTH_TEST); else gl.disable(gl.DEPTH_TEST);\t\t\n\t\t\t\n\t\t\t\t\t//set model \n\t\t\t\t\tfor(let i =0;i<data.model.length;i++) {\n\t\t\t\t\t\tdata.model[i].id = ++this.modelId \n\t\t\t\t\t\tdata.model[i].obuf = this.setObj( data.model[i],true) ;\n\t//\t\t\t\t\tif(data.model[i].name) this.modelHash[data.model[i].name] = data.model[i] ;\n\t\t\t\t\t}\n\t\t\t\t\tthis.modelCount = data.model.length ;\n\t//\t\t\t\tconsole.log(this.obuf);\n\t\t\t\t\t\n\t\t\t\t\tif(this.env.offscreen) {// renderbuffer \n\t\t\t\t\t\tif(this.env.offscreen.mrt) { //MRT\n\t\t\t\t\t\t\tif(!this.wwg.ext_mrt) reject(\"MRT not support\") ;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.fb = this.frameBuffer(this.env.offscreen) ;\t\n\t\t\t\t\t}\n\t\t\t\t\tresolve(this) ;\n\t\t\t\t\t\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t})\n\t\t\t}).catch((err)=> {reject(err);})\n\t\t});\n\t}\n\n\tWWG.prototype.Render.prototype.clear = function() {\n\t\tlet cc = this.env.clear_color ;\n\t\tthis.gl.clearColor(cc[0],cc[1],cc[2],cc[3]);\n\t\tthis.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);\n\t}\n\n\tWWG.prototype.Render.prototype.f32Array = function(ar) {\n\t\tif(ar instanceof Float32Array) return ar ;\n\t\telse return new Float32Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.i16Array = function(ar) {\n\t\tif(ar instanceof Int16Array) return ar ;\n\t\telse return new Int16Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.i32Array = function(ar) {\n\t\tif(ar instanceof Uint32Array) return ar ;\n\t\telse return new Uint32Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.setObj = function(obj,flag) {\n\t\tlet gl = this.gl\n\t\tlet geo = obj.geo ;\n\t\tlet inst = obj.inst ;\n\t\tlet ret = {} ;\n\t\tlet vao\n\t\tif(this.wwg.ext_vao) {\n\t\t\tvao = this.wwg.vao_create() ;\n\t\t\tthis.wwg.vao_bind(vao);\n\t\t\tret.vao = vao ;\n\t\t}\n\t\t\n\t\tlet vbo = gl.createBuffer() \n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vbo) ;\n\n\t\tlet tl = 0 ;\n\t\tlet ats = [] ;\n\t\tfor(let i=0;i<geo.vtx_at.length;i++) {\n\t\t\tats.push( this.vs_att[geo.vtx_at[i]] ) ;\n\t\t\ttl += this.wwg.vsize[this.vs_att[geo.vtx_at[i]].type] ;\n\t\t}\n\n\t\tret.ats = ats ;\n\t\tret.tl = tl ;\n\t\tlet ofs = 0 ;\n\t\tfor(let i in this.vs_att ) {\n\t\t\tif(this.vs_att[i].pos>=0) gl.disableVertexAttribArray(this.vs_att[i].pos);\n\t\t}\n\t\tfor(let i=0;i<ats.length;i++) {\n\t\t\tlet s = this.wwg.vsize[ats[i].type] ;\n\t\t\tgl.enableVertexAttribArray(this.vs_att[ats[i].name].pos);\n\t\t\tgl.vertexAttribPointer(this.vs_att[ats[i].name].pos, s, gl.FLOAT, false, tl*4, ofs);\n\t\t\tofs += s*4 ;\t\n\t\t} \t\n\t\tret.vbo = vbo ;\n\t\tlet ibo\n\t\tif(geo.idx) {\n\t\t\tibo = gl.createBuffer() ;\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo) ;\n\t\t\tret.ibo = ibo ;\n\t\t}\n\t\tlet ibuf \n\t\tif(inst) {\n\t\t\tibuf = gl.createBuffer() \n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, ibuf) ;\n\t\t\tlet tl = 0 ;\n\t\t\tlet ats = [] ;\n\t\t\tfor(let i=0;i<inst.attr.length;i++) {\n\t\t\t\tats.push( this.vs_att[inst.attr[i]] ) ;\n\t\t\t\ttl += this.wwg.vsize[this.vs_att[inst.attr[i]].type] ;\n\t\t\t}\n\t\t\ttl = tl*4 ;\n\t\t\tret.iats = ats ;\n\t\t\tret.itl = tl ;\n\t\t\tlet ofs = 0 ;\n\t\t\tfor(let i=0;i<ats.length;i++) {\n\t\t\t\tlet divisor = (inst.divisor)?inst.divisor[i]:1 ;\n\t\t\t\tlet s = this.wwg.vsize[ats[i].type] ;\n\t\t\t\tlet pos = this.vs_att[ats[i].name].pos\n\t\t\t\tgl.enableVertexAttribArray(pos);\n\t\t\t\tgl.vertexAttribPointer(pos, s, gl.FLOAT, false, tl, ofs);\n\t\t\t\tofs += s*4 ;\n\t\t\t\tthis.wwg.inst_divisor(pos, divisor)\t\n\t\t\t} \n\t\t\tret.inst = ibuf \n\t\t}\n\t\t\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(vao);\n\t\tif(flag) {\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vbo) ;\n\t\t\tgl.bufferData(gl.ARRAY_BUFFER, \n\t\t\t\tthis.f32Array(geo.vtx), (geo.dynamic)?gl.DYNAMIC_DRAW:gl.STATIC_DRAW) ;\n\t\t}\n\t\tif(flag && geo.idx) {\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo) ;\n\t\t\tif(geo.vtx.length/(ret.tl) > 65536 && this.wwg.ext_i32) {\n\t\t\t\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, \n\t\t\t\t\tthis.i32Array(geo.idx),gl.STATIC_DRAW ) ;\n\t\t\t\tret.i32 = true ;\n\t\t\t} else {\n\t\t\t\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, \n\t\t\t\t\tthis.i16Array(geo.idx),gl.STATIC_DRAW ) ;\n\t\t\t\tret.i32 = false ;\n\t\t\t}\n\t\t}\n\t\tif(flag && inst) {\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, ibuf) ;\n\t\t\tgl.bufferData(gl.ARRAY_BUFFER, \n\t\t\t\tthis.f32Array(inst.data),(inst.dynamic)?gl.DYNAMIC_DRAW:gl.STATIC_DRAW ) ;\n\t\t}\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\t\t\t\n\t\treturn ret ;\n\t}\n\tWWG.prototype.Render.prototype.getModels = function() {\n\t\treturn this.data.model.filter((m)=>(m!==null))\t\n\t}\n\tWWG.prototype.Render.prototype.getModelIdx = function(name) {\n\t\tlet idx = false \n\t\tif(typeof name != 'string') idx = parseInt(name) ;\n\t\telse {\n\t\t\tfor(let i=0;i<this.data.model.length;i++) \t{\n\t\t\t\tif(this.data.model[i]===null) continue \n\t\t\t\tif(name==this.data.model[i].name) {idx = i ;break }\n\t\t\t}\n\t\t}\n\t\treturn idx ;\t\n\t}\n\t// add model\n\tWWG.prototype.Render.prototype.addModel = function(model) {\n\t\tlet idx = false\n\t\tif(model.name) idx = this.getModelIdx(model.name)\n\t\tif(idx!==false ) {\n\t\t\tthis.data.model[idx] = model ;\n\t\t\tthis.data.model[idx].obuf = this.setObj(model,true) ;\n\t\t\treturn \n\t\t}\n\t\tmodel.id = ++this.modelId\n\t\tthis.data.model.push(model) ;\n\t\tthis.data.model[this.data.model.length-1].obuf = this.setObj(model,true) ;\n\t\tthis.modelCount++\n\t//\tif(model.name) this.modelHash[model.name] = this.data.model.length -1 ;\n\t}\n\t// remove model\n\tWWG.prototype.Render.prototype.removeModel = function(model) {\n\t\tlet mi = this.getModelIdx(model) \n\t\tif(mi===false) return false \n\t//\tdelete this.modelHash[this.data.model[mi].name] \n\t\tthis.data.model[mi].obuf = null \n\t\tthis.data.model[mi] = null \n\t\tthis.modelCount--  \n\t\treturn true \n\t}\n\t// update attribute buffer \n\tWWG.prototype.Render.prototype.updateModel = function(name,mode,buf,sub=null) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\tlet obuf = this.data.model[idx].obuf ;\n\t\tswitch(mode) {\n\t\t\tcase \"vbo\":\t\n\t\t\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.vbo) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"inst\":\n\t\t\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.inst) ;\n\t\t\t\tbreak ;\n\t\t}\n\t\tif(sub) \n\t\t\tthis.gl.bufferSubData(this.gl.ARRAY_BUFFER, sub.dofs*4, this.f32Array(buf),sub.sofs,sub.count)\t\n\t\telse \n\t\t\tthis.gl.bufferSubData(this.gl.ARRAY_BUFFER, 0, this.f32Array(buf))\t\n\n\t}\n\tWWG.prototype.Render.prototype.updateModelInstance = function(name,buf,count) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\tlet obuf = this.data.model[idx].obuf ;\n\t\tthis.data.model[idx].inst.count = count ;\n\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.inst) ; \n\t//\t\tthis.gl.bufferSubData(this.gl.ARRAY_BUFFER, 0, this.f32Array(buf))\t\n\t\t\tthis.gl.bufferData(this.gl.ARRAY_BUFFER, this.f32Array(buf),this.gl.DYNAMIC_DRAW ) ;\n\t}\n\tWWG.prototype.Render.prototype.getModelData =function(name) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\treturn this.data.model[idx] ;\n\t}\n\t// update texture \n\tWWG.prototype.Render.prototype.updateTex = function(idx,tex,opt) {\n\t\tif(typeof idx == 'string') idx = this.getTexIndex(idx)\n\t\tvar tdat = this.data.texture[idx]\n\t\tthis.gl.bindTexture(this.gl.TEXTURE_2D, this.texobj[idx]);\n\n\t\tif(tdat.array) {\n\t\t\tif(!opt) \n\t\t\t\tif(tdat.array instanceof Float32Array ) \n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA16F, \n\t\t\t\t\ttdat.opt.width,tdat.opt.height,0,this.gl.RGBA, this.gl.FLOAT, tex);\n\t\t\t\telse\n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, \n\t\t\t\t\ttdat.opt.width,tdat.opt.height,0,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\t\n\t\t\telse \n\t\t\t\tif(tdat.array instanceof Float32Array ) \n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, \n\t\t\t\t\topt.sx,opt.sy,opt.width,opt.height,this.gl.RGBA, this.gl.FLOAT, tex,opt.ofs);\n\t\t\t\telse\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, \n\t\t\t\t\topt.sx,opt.sy,opt.width,opt.height,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex,opt.ofs);\n\t\t} else {\n\t\t\tif(!opt) {\n\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\n\t\t\t} else {\n\t\t\t\tif(opt.wx>0 && opt.wy>0)\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, opt.sx,opt.sy,opt.wx,opt.wy,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\t\n\t\t\t\telse \t\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, opt.sx,opt.sy , this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\n\t\t\t}\n\t\t}\n\t\tif(tdat.opt && !tdat.opt.nomipmap) this.gl.generateMipmap(this.gl.TEXTURE_2D);\n\t}\n\t//update uniform values\n\tWWG.prototype.Render.prototype.pushUniValues = function(u) {\n\t\tif(u.vs_uni) {\n\t\t\tfor(let i in u.vs_uni) {\n\t\t\t\tthis.update_uni.vs_uni[i] = u.vs_uni[i] ;\n\t\t\t}\n\t\t}\n\t\tif(u.fs_uni) {\n\t\t\tfor(let i in u.fs_uni) {\n\t\t\t\tthis.update_uni.fs_uni[i] = u.fs_uni[i] ;\n\t\t\t}\n\t\t}\n\t}\n\tWWG.prototype.Render.prototype.updateUniValues = function(u) {\n\t\tif(!u) {\n\t\t\tthis.update_uni = {vs_uni:{},fs_uni:{}} ;\n\t\t\treturn ;\n\t\t}\n\t//\tconsole.log(\"update uni\");\n\t\tthis.setUniValues(this.update_uni)\n\t}\n\n\t// draw call\n\tWWG.prototype.Render.prototype.draw = function(update,cls) {\n\t//console.log(\"draw\");\n\n\t\tlet gl = this.gl ;\n\t\tgl.useProgram(this.program);\n\t\tif(this.env.offscreen) {// renderbuffer \n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, this.fb.f);\n\t\t\tif(this.env.offscreen.mrt) this.wwg.mrt_draw(this.fb.fblist);\n\t\t\tgl.viewport(fb.offsetX,fb.offsetY,this.fb.width,this.fb.height) ;\n\t\t}\n\t\tif(!cls) this.clear() ;\n\t\tlet models = this.data.model\n\t\tfor(let b=0;b<models.length;b++) {\n\t\t\tif(models[b]===null) continue \n\t\t\tlet cmodel = models[b] ;\n\t\t\tif(cmodel.hide) continue ;\n\t\t\tif(cmodel.obuf==null) continue ;\n\n\t\t\tlet geo = cmodel.geo ;\n\t\t\tthis.updateUniValues(0) ;\n\t\t\tthis.pushUniValues(this.data) ;\n\t\t\tthis.pushUniValues(cmodel);\n\t\t\tif(update) {\n\t\t\t\t// set modified values\n\t\t\t\tif(!Array.isArray(update)) update = [update ]\n\t\t\t\tfor(let i=0;i<update.length;i++) {\n\t\t\t\t\tthis.pushUniValues(update[i]) ;\n\t\t\t\t\tif(update[i].model) {\n\t\t\t\t\t\tlet model =update[i].model[b] ;\n\t\t\t\t\t\tif(model) this.pushUniValues(model) ;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.updateUniValues(1)\n\n\t\t\tlet obuf = cmodel.obuf ;\n\t\t\tlet ofs = (geo.ofs>0)?geo.ofs:0 ;\n\t\t\tif(this.wwg.ext_vao)  this.wwg.vao_bind(obuf.vao);\n\t\t\telse {\n\t\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, obuf.vbo) ;\n\t\t\t\tlet aofs = 0 ;\n\t\t\t\tfor(let i in this.vs_att ) {\n\t\t\t\t\tgl.disableVertexAttribArray(this.vs_att[i].pos);\n\t\t\t\t}\n\t\t\t\tfor(let i=0;i<obuf.ats.length;i++) {\n\t\t\t\t\tlet s = this.wwg.vsize[obuf.ats[i].type] ;\n\t\t\t\t\tgl.enableVertexAttribArray(this.vs_att[obuf.ats[i].name].pos);\n\t\t\t\t\tgl.vertexAttribPointer(this.vs_att[obuf.ats[i].name].pos, s, gl.FLOAT, false, obuf.tl*4, aofs);\n\t\t\t\t\taofs += s*4 ;\t\n\t\t\t\t}\n\t\t\t\tif(obuf.ibo) gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obuf.ibo) ;\n\t\t\t\tif(obuf.inst) {\n\t\t\t\t\tlet inst = cmodel.inst ;\n\t\t\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, obuf.inst) ;\n\t\t\t\t\tlet aofs = 0 ;\n\t\t\t\t\tfor(let i=0;i<obuf.iats.length;i++) {\n\t\t\t\t\t\tlet divisor = (inst.divisor)?inst.divisor[i]:1 ;\n\t\t\t\t\t\tlet s = this.wwg.vsize[obuf.iats[i].type] ;\n\t\t\t\t\t\tlet pos = this.vs_att[obuf.iats[i].name].pos\n\t\t\t\t\t\tgl.enableVertexAttribArray(pos);\n\t\t\t\t\t\tgl.vertexAttribPointer(pos, s, gl.FLOAT, false, obuf.itl, aofs);\n\t\t\t\t\t\taofs += s*4 ;\n\t\t\t\t\t\tthis.wwg.inst_divisor(pos, divisor)\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(cmodel.preFunction) {\n\t\t\t\t\n\t\t\t\tcmodel.preFunction(gl,cmodel,obuf) ;\n\t\t\t}\n\t\t\tif(cmodel.blend!==undefined) {\n\t\t\t\tgl.enable(gl.BLEND) ;\n\t\t\t\tif(cmodel.blend==\"alpha\") gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);\n\t\t\t}\n\t\t\tif(cmodel.cull!==undefined) {\n\t\t\t\tif(cmodel.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t}\n\t\t\tlet gmode = this.wwg.dmodes[geo.mode]\n\t\t\tif(gmode==undefined) {\n\t\t\t\t\tconsole.log(\"Error: illigal draw mode\") ;\n\t\t\t\t\treturn false ;\n\t\t\t}\n\t\t\tif(cmodel.inst) {\n\t\t\t\tif(geo.idx) this.wwg.inst_draw(gmode, geo.idx.length, (obuf.i32)?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT, ofs, cmodel.inst.count);\n\t\t\t\telse this.wwg.inst_drawa(gmode, ofs,(geo.count>0)?geo.count:geo.vtx.length/obuf.tl, cmodel.inst.count);\n\t\t\t} else {\n\t\t\t\tif(geo.idx) gl.drawElements(gmode, geo.idx.length, (obuf.i32)?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT, ofs);\n\t\t\t\telse gl.drawArrays(gmode, ofs,\n\t\t\t\t\t(geo.count>0)?geo.count:geo.vtx.length/obuf.tl);\n\t\t\t}\n\t\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\t\t\telse {\n\t\t\t\t\n\t\t\t}\n\t\t\tif(cmodel.blend!==undefined) {\n\t\t\t\tgl.disable(gl.BLEND) ;\n\t\t\t}\n\t\t\tif(cmodel.cull!==undefined) {\n\t\t\t\tif(this.env.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t}\n\t\t\tif(cmodel.postFunction) {\n\t\t\t\tcmodel.postFunction(gl,cmodel) ;\n\t\t\t}\n\t\t}\n\t\tif(this.env.offscreen) {// unbind renderbuffer \n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tgl.viewport(0,0,this.wwg.can.width,this.wwg.can.height) ;\n\t\t}\n\t\treturn true ;\n\t}\n\n\treturn poxp.WWG = WWG;\n});"]}