{"version":3,"sources":["WWG.js"],"names":["define","pox","WWG","this","version","can","gl","vsize","float","vec2","vec3","vec4","mat2","mat3","mat4","prototype","init","canvas","opt","getContext","window","Promise","ext_vao","getExtension","vao_create","createVertexArrayOES","vao_bind","o","bindVertexArrayOES","ext_inst","inst_divisor","p","d","vertexAttribDivisorANGLE","inst_draw","m","l","s","c","drawElementsInstancedANGLE","inst_drawa","drawArrayInstancedANGLE","ext_anis","ext_ftex","ext_mrt","mrt_att","COLOR_ATTACHMENT0_WEBGL","mrt_draw","b","drawBuffersWEBGL","ext_i32","ext_mv","console","log","dmodes","tri_strip","TRIANGLE_STRIP","tri","TRIANGLES","points","POINTS","lines","LINES","line_strip","LINE_STRIP","init2","createVertexArray","bindVertexArray","vertexAttribDivisor","drawElementsInstanced","drawArraysInstanced","ext_anis_max","getParameter","MAX_TEXTURE_MAX_ANISOTROPY_EXT","MAX_DRAW_BUFFERS","COLOR_ATTACHMENT0","drawBuffers","loadAjax","src","resolve","reject","req","XMLHttpRequest","open","responseType","type","onload","status","response","statusText","onerror","send","loadImageAjax","then","timg","Image","url","URL","createObjectURL","revokeObjectURL","catch","err","createRender","Render","wwg","env","modelCount","setUnivec","uni","value","pos","ar","dim","Float32Array","i","concat","cache","Array","isArray","length","uniformMatrix2fv","f32Array","uniformMatrix3fv","uniformMatrix4fv","uniform2fv","uniform3fv","uniform4fv","uniform1i","uniform2iv","i16Array","uniform3iv","uniform4iv","uniform1iv","uniform1f","uniform1fv","getTexIndex","activeTexture","TEXTURE0","texunit","bindTexture","TEXTURE_2D","texobj","undefined","data","texture","video","texImage2D","RGBA","UNSIGNED_BYTE","setShader","tu","parse_shader","split","att","def","ln","match","RegExp","$1","trim","$2","u","name","$3","k","substr","parseInt","isNaN","push","vshader","fshader","vss","fss","pr","text","result","all","res","ret","createShader","VERTEX_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","FRAGMENT_SHADER","program","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","useProgram","vr","vs_att","getAttribLocation","vs_uni","getUniformLocation","fr","fs_uni","setUniValues","genTex","img","option","flevel","formatstr","rgb","RGB","gray","LUMINANCE","grayalpha","LUMINANCE_ALPHA","format","tex","createTexture","isarray","RGBA32F","width","height","FLOAT","nomipmap","generateMipmap","texParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","LINEAR","LINEAR_MIPMAP_LINEAR","repeat","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","MIRRORED_REPEAT","REPEAT","anisotropy","TEXTURE_MAX_ANISOTROPY_EXT","loadTex","cors","buffer","mrt","fb","t","array","addTex","texdata","removeTex","frameBuffer","os","ttype","tfilter","fblist","createFramebuffer","bindFramebuffer","FRAMEBUFFER","renderBuffer","createRenderbuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorage","DEPTH_COMPONENT16","framebufferRenderbuffer","DEPTH_ATTACHMENT","fTexture","framebufferTexture2D","ox","offsetX","oy","offsetY","f","setRender","cull","enable","CULL_FACE","disable","face_cw","frontFace","CW","CCW","nodepth","DEPTH_TEST","model","obuf","setObj","offscreen","clear","cc","clear_color","clearColor","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","Int16Array","i32Array","Uint32Array","obj","flag","vao","geo","inst","vbo","createBuffer","bindBuffer","ARRAY_BUFFER","tl","ats","vtx_at","ibo","ibuf","ofs","disableVertexAttribArray","enableVertexAttribArray","vertexAttribPointer","idx","ELEMENT_ARRAY_BUFFER","attr","iats","itl","divisor","bufferData","vtx","DYNAMIC_DRAW","STATIC_DRAW","i32","getModels","filter","getModelIdx","addModel","removeModel","mi","updateModel","mode","buf","subflag","bufferSubData","updateModelInstance","count","getModelData","updateTex","tdat","texSubImage2D","sx","sy","RGBA16F","wx","wy","pushUniValues","update_uni","updateUniValues","draw","update","cls","viewport","models","cmodel","hide","aofs","preFunction","blend","BLEND","blendFuncSeparate","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE","gmode","UNSIGNED_INT","UNSIGNED_SHORT","drawElements","drawArrays","postFunction"],"mappings":"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","file":"../WWG.js","sourcesContent":["define([\n    \"./pox\"\n],function(pox){\n\t//WWG Simple WebGL wrapper library\n\t// Version 0.9 \n\t// 2016-2017 wakufactory.jp \n\t// license: MIT \n\t// WWG\n\t//   init(canvas)\n\t//   init2(canvas)\n\t//   loadAjax(src,opt)\n\t//   loadImageAjax(src)\n\t//   createRender()\n\t// Render\n\t//   setRender(scene)\n\t//   draw(update,cls)\n\t//   addModel(model)\n\t//   updateModel(name,mode,buf)\n\t//   addTex(texobj)\n\t//   loadTex(tex)\n\n\tfunction WWG() {\n\t\tthis.version = \"0.9.11\" ;\n\t\tthis.can = null ;\n\t\tthis.gl = null ;\n\t\tthis.vsize = {\"float\":1,\"vec2\":2,\"vec3\":3,\"vec4\":4,\"mat2\":4,\"mat3\":9,\"mat4\":16} ;\n\t}\n\tWWG.prototype.init = function(canvas,opt) {\n\t\tthis.can = canvas ;\n\t\tlet gl \n\t\tif(!((gl = canvas.getContext(\"experimental-webgl\",opt)) || (gl = canvas.getContext(\"webgl\",opt)))) { return false } ;\n\t\tif(!window.Promise) return false ;\n\t\tthis.gl = gl \n\t\tthis.ext_vao = gl.getExtension('OES_vertex_array_object');\n\t\tif(this.ext_vao) {\n\t\t\tthis.vao_create = function(){return this.ext_vao.createVertexArrayOES()} ;\n\t\t\tthis.vao_bind = function(o){this.ext_vao.bindVertexArrayOES(o)} ;\n\t\t}\n\t\tthis.ext_inst = gl.getExtension('ANGLE_instanced_arrays');\n\t\tif(this.ext_inst) {\n\t\t\tthis.inst_divisor = function(p,d){this.ext_inst.vertexAttribDivisorANGLE(p, d)}\n\t\t\tthis.inst_draw = function(m,l,s,o,c){this.ext_inst.drawElementsInstancedANGLE(m,l, s, o, c);}\n\t\t\tthis.inst_drawa = function(m,s,o,c) {this.ext_inst.drawArrayInstancedANGLE(m, s, o, c);}\n\t\t}\n\t\tthis.ext_anis = gl.getExtension(\"EXT_texture_filter_anisotropic\");\n\t\tthis.ext_ftex = gl.getExtension('OES_texture_float');\n\t\tthis.ext_mrt = gl.getExtension('WEBGL_draw_buffers');\n\t\tif(this.ext_mrt) {\n\t\t\tthis.mrt_att = this.ext_mrt.COLOR_ATTACHMENT0_WEBGL ;\n\t\t\tthis.mrt_draw = function(b,d){return this.ext_mrt.drawBuffersWEBGL(b,d)} ;\n\t\t}\n\t\tthis.ext_i32 = gl.getExtension('OES_element_index_uint')\n\t\tthis.ext_mv = gl.getExtension('WEBGL_multiview');\n\t\tif (this.ext_mv) \n\t        console.log(\"MULTIVIEW extension is supported\");\n\t\telse {\n\t\t\tthis.ext_mv = gl.getExtension('OVR_multiview');\n\t\t\tif (this.ext_mv)\n\t\t\t\tconsole.log(\"OVR MULTIVIEW extension is supported\");\n\t\t} \n\t\tthis.dmodes = {\"tri_strip\":gl.TRIANGLE_STRIP,\"tri\":gl.TRIANGLES,\"points\":gl.POINTS,\"lines\":gl.LINES,\"line_strip\":gl.LINE_STRIP }\n\t\tthis.version = 1 ;\n\t\treturn true ;\n\t}\n\tWWG.prototype.init2 = function(canvas,opt) {\n\t\tthis.can = canvas ;\n\t\tlet gl \n\t\tif(!((gl = canvas.getContext(\"experimental-webgl2\",opt)) || (gl = canvas.getContext(\"webgl2\",opt)))) { return false } ;\n\t\tif(!window.Promise) return false ;\n\t\tconsole.log(\"init for webGL2\") ;\n\t\tthis.gl = gl ;\n\t\t\n\t\tthis.ext_vao = true ;\n\t\tthis.vao_create = function(){ return this.gl.createVertexArray()} ;\n\t\tthis.vao_bind = function(o){this.gl.bindVertexArray(o)} ;\n\t\tthis.ext_inst = true ;\n\t\tthis.inst_divisor = function(p,d){this.gl.vertexAttribDivisor(p, d)}\n\t\tthis.inst_draw = function(m,l,s,o,c){this.gl.drawElementsInstanced(m,l, s, o, c);}\n\t\tthis.inst_drawa = function(m,s,o,c) {this.gl.drawArraysInstanced(m, s, o, c);}\n\t\tthis.ext_anis = gl.getExtension(\"EXT_texture_filter_anisotropic\");\n\t\tif(this.ext_anis) this.ext_anis_max = gl.getParameter(this.ext_anis.MAX_TEXTURE_MAX_ANISOTROPY_EXT);\n\t\tthis.ext_ftex = true ;\n\t\tthis.ext_mrt = (gl.getParameter(gl.MAX_DRAW_BUFFERS)>1) ;\n\t\tif(this.ext_mrt) {\n\t\t\tthis.mrt_att = gl.COLOR_ATTACHMENT0 ;\n\t\t\tthis.mrt_draw =  function(b,d){return gl.drawBuffers(b,d)} ;\n\t\t}\n\t\tthis.ext_i32 = true ;\n\t\tthis.ext_mv = gl.getExtension('WEBGL_multiview');\n\t\tif (this.ext_mv) \n\t        console.log(\"MULTIVIEW extension is supported\");\n\t\telse {\n\t\t\tthis.ext_mv = gl.getExtension('OVR_multiview');\n\t\t\tif (this.ext_mv)\n\t\t\t\tconsole.log(\"OVR MULTIVIEW extension is supported\");\n\t\t} \n\t\tthis.dmodes = {\"tri_strip\":gl.TRIANGLE_STRIP,\"tri\":gl.TRIANGLES,\"points\":gl.POINTS,\"lines\":gl.LINES,\"line_strip\":gl.LINE_STRIP }\n\t\tthis.version = 2 ;\n\t\treturn true ;\n\t}\n\tWWG.prototype.loadAjax = function(src,opt) {\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tconst req = new XMLHttpRequest();\n\t\t\treq.open(\"get\",src,true) ;\n\t\t\treq.responseType = (opt && opt.type)?opt.type:\"text\" ;\n\t\t\treq.onload = ()=> {\n\t\t\t\tif(req.status==200) {\n\t\t\t\t\tresolve(req.response) ;\n\t\t\t\t} else {\n\t\t\t\t\treject(\"Ajax error:\"+req.statusText) ;\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\treq.onerror = ()=> {\n\t\t\t\treject(\"Ajax error:\"+req.statusText)\n\t\t\t}\n\t\t\treq.send() ;\n\t\t})\n\t}\n\tWWG.prototype.loadImageAjax = function(src) {\n\t\treturn new Promise((resolve,reject)=>{\n\t\t\tthis.loadAjax(src,{type:\"blob\"}).then((b)=>{\n\t\t\t\tconst timg = new Image ;\n\t\t\t\tconst url = URL.createObjectURL(b);\n\t\t\t\ttimg.onload = ()=> {\n\t\t\t\t\tURL.revokeObjectURL(url)\n\t\t\t\t\tresolve(timg) ;\n\t\t\t\t}\n\t\t\t\ttimg.src = url\n\t\t\t}).catch((err)=>{\n\t\t\t\tconsole.log(err)\n\t\t\t\tresolve(null) ;\n\t\t\t})\n\t\t})\n\t}\n\n\t// Render unit\n\tWWG.prototype.createRender = function() {\n\t\treturn new this.Render(this) ;\n\t}\n\tWWG.prototype.Render = function(wwg) {\n\t\tthis.wwg = wwg ;\n\t\tthis.gl = wwg.gl ;\n\t\tthis.env = {} ;\n\t//\tthis.obuf = [] ;\n\t\tthis.modelCount = 0 ;\n\t//\tthis.modelHash = {} ;\n\t}\n\tWWG.prototype.Render.prototype.setUnivec = function(uni,value) {\n\t\tif(uni.pos==null) return \n\t//\tconsole.log(\"set \"+uni.type+\"(\"+uni.pos+\") = \"+value) ;\n\t\tlet ar = [] ;\n\t\tif(uni.dim>0 && !(value instanceof Float32Array)) for(let i=0;i<uni.dim;i++) ar = ar.concat(value[i])\n\t\telse ar = value \n\t\tif(uni.cache!=null) {\n\t\t\tif(Array.isArray(ar)) {\n\t\t\t\tfor(let i=0;i<ar.length;i++) if(ar[i]!=uni.cache[i]) break ;\n\t\t\t\tif(i==ar.length) return ;\n\t\t\t} else if(ar == uni.cache) return ;\n\t\t}\n\t//\tconsole.log(\"set uni\")\n\t\tswitch(uni.type) {\n\t\t\tcase \"mat2\":\n\t\t\t\tthis.gl.uniformMatrix2fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"mat3\":\n\t\t\t\tthis.gl.uniformMatrix3fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"mat4\":\n\t\t\t\tthis.gl.uniformMatrix4fv(uni.pos,false,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec2\":\n\t\t\t\tthis.gl.uniform2fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec2v\":\n\t\t\t\tthis.gl.uniform2fv(uni.pos, this.f32Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec3\":\n\t\t\t\tthis.gl.uniform3fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec3v\":\n\t\t\t\tthis.gl.uniform3fv(uni.pos, this.f32Array(ar))\n\t\t\t\tbreak ;\n\t\t\tcase \"vec4\":\n\t\t\t\tthis.gl.uniform4fv(uni.pos, this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"vec4v\":\n\t\t\t\tthis.gl.uniform4fv(uni.pos, this.f32Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"int\":\n\t\t\tcase \"bool\":\n\t\t\t\tthis.gl.uniform1i(uni.pos,value) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec2\":\n\t\t\tcase \"bvec2\":\n\t\t\t\tthis.gl.uniform2iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec2v\":\n\t\t\tcase \"bvec2v\":\n\t\t\t\tthis.gl.uniform2iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec3\":\n\t\t\tcase \"bvec3\":\n\t\t\t\tthis.gl.uniform3iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec3v\":\n\t\t\tcase \"bvec3v\":\n\t\t\t\tthis.gl.uniform3iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec4\":\n\t\t\tcase \"bvec4\":\n\t\t\t\tthis.gl.uniform4iv(uni.pos, this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"ivec4v\":\n\t\t\tcase \"bvec4v\":\n\t\t\t\tthis.gl.uniform4iv(uni.pos, this.i16Array(ar)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"intv\":\n\t\t\tcase \"boolv\":\n\t\t\t\tthis.gl.uniform1iv(uni.pos,this.i16Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"float\":\n\t\t\t\tthis.gl.uniform1f(uni.pos,value) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"floatv\":\n\t\t\t\tthis.gl.uniform1fv(uni.pos,this.f32Array(value)) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"sampler2D\":\n\t\t\t\tif(typeof value == 'string') value = this.getTexIndex(value)\n\t\t\t\tthis.gl.activeTexture(this.gl.TEXTURE0+uni.texunit);\n\t\t\t\tthis.gl.bindTexture(this.gl.TEXTURE_2D, this.texobj[value]);\n\t\t\t\tif(this.data.texture[value]==undefined) break ;\n\t\t\t\tif(this.data.texture && this.data.texture[value].video) {\n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.data.texture[value].video);\t\n\t\t\t\t}\n\t\t\t\tthis.gl.uniform1i(uni.pos,uni.texunit) ;\n\t\t\t\tbreak ;\n\t\t}\n\t}\n\n\tWWG.prototype.Render.prototype.setShader = function(data) {\n\t\tlet tu = 0 ;\n\t\tfunction parse_shader(src) {\n\t\t\tconst l = src.split(\"\\n\") ;\n\t\t\tconst uni = [] ;\n\t\t\tconst att = [] ;\n\t\t\tconst def = {}\n\n\t\t\tfor(i=0;i<l.length;i++) {\n\t\t\t\tlet ln = l[i] ;\n\t\t\t\tif( ln.match(/^\\s*#define\\s*([^\\s]+)\\s+([^\\s]+)/)) {\n\t\t\t\t\tdef[RegExp.$1.trim()] = RegExp.$2.trim()\n\t\t\t\t}\n\t\t\t\tif( ln.match(/^\\s*uniform\\s*([0-9a-z]+)\\s+([0-9a-z_]+)(\\[[^\\]]+\\])?/i)) {\n\t\t\t\t\tlet u = {type:RegExp.$1,name:RegExp.$2} ;\n\t\t\t\t\tif(RegExp.$3!=\"\") {\n\t\t\t\t\t\tu.type = u.type+\"v\" ;\n\t\t\t\t\t\tlet k = RegExp.$3.substr(1,RegExp.$3.length-2).trim()\n\t\t\t\t\t\tu.dim = parseInt(k) ;\n\t\t\t\t\t\tif(isNaN(u.dim)) u.dim = def[k]\n\t\t\t\t\t}\n\t\t\t\t\tif(u.type==\"sampler2D\") u.texunit = tu++ ;\n\t\t\t\t\tuni.push(u) ;\n\t\t\t\t}\n\t\t\t\tif( ln.match(/^\\s*(?:attribute|in)\\s+([0-9a-z]+)\\s*([0-9a-z_]+)/i)) {\n\t\t\t\t\tatt.push( {type:RegExp.$1,name:RegExp.$2}) ;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {uni:uni,att:att} ;\n\t\t}\n\n\t\tconst gl = this.gl ;\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(!data.vshader) { reject(\"no vshader\") ;return false;}\n\t\t\tif(!data.fshader) { reject(\"no fshader\") ;return false;}\n\t\t\tlet vss ;\n\t\t\tlet fss ;\n\t\t\tlet pr = [] ;\n\t\t\tif(data.vshader.text ) vss = data.vshader.text ;\n\t\t\telse if(data.vshader.src) {\n\t\t\t\tpr.push( this.wwg.loadAjax(data.vshader.src).then((result)=> {\n\t\t\t\t\tvss = result ;\n\t\t\t\t\tresolve() ;\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t}))\n\t\t\t}\n\t\t\tif(data.fshader.text ) fss = data.fshader.text ;\n\t\t\telse if(data.fshader.src) {\n\t\t\t\tpr.push( this.wwg.loadAjax(data.fshader.src).then((result)=> {\n\t\t\t\t\tfss = result ;\n\t\t\t\t\tresolve() ;\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t}))\n\t\t\t}\n\t\t\tPromise.all(pr).then((res)=> {\n\t//\t\t\tconsole.log(vss) ;\n\t//\t\t\tconsole.log(fss) ;\n\t\t\t\tlet ret = {} ;\n\t\t\t\tlet vshader = gl.createShader(gl.VERTEX_SHADER);\n\t\t\t\tgl.shaderSource(vshader, vss);\n\t\t\t\tgl.compileShader(vshader);\n\t\t\t\tif(!gl.getShaderParameter(vshader, gl.COMPILE_STATUS)) {\n\t\t\t\t\treject(\"vs error:\"+gl.getShaderInfoLog(vshader)); return false;\n\t\t\t\t}\n\t\t\t\tret.vshader = vshader ;\n\t\t\t\n\t\t\t\tlet fshader = gl.createShader(gl.FRAGMENT_SHADER);\n\t\t\t\tgl.shaderSource(fshader, fss);\n\t\t\t\tgl.compileShader(fshader);\n\t\t\t\tif(!gl.getShaderParameter(fshader, gl.COMPILE_STATUS)) {\n\t\t\t\t\treject(\"fs error:\"+gl.getShaderInfoLog(fshader)); return false;\n\t\t\t\t}\n\t\t\t\tret.fshader = fshader ;\n\t\t\t\t\n\t\t\t\tlet program = gl.createProgram();\n\t\t\t\tgl.attachShader(program, vshader);\n\t\t\t\tgl.attachShader(program, fshader);\n\t\t\t\tgl.linkProgram(program);\n\t\t\t\tif(!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n\t\t\t\t\treject(\"link error:\"+gl.getProgramInfoLog(program)); return false;\n\t\t\t\t}\n\t\t\t\tret.program = program ;\n\t\t\t\tgl.useProgram(program);\n\t\t\t\n\t\t\t\tlet vr = parse_shader(vss) ;\t\n\t//\t\t\tconsole.log(vr) ;\n\t\t\t\tret.vs_att = {} ;\t\n\t\t\t\tfor(let i in vr.att) {\n\t\t\t\t\tvr.att[i].pos = gl.getAttribLocation(program,vr.att[i].name) ;\n\t\t\t\t\tret.vs_att[vr.att[i].name] = vr.att[i] ;\n\t\t\t\t}\n\t\t\t\tret.vs_uni = {} ;\n\t\t\t\tfor(let i in vr.uni) {\n\t\t\t\t\tvr.uni[i].pos = gl.getUniformLocation(program,vr.uni[i].name) ;\n\t\t\t\t\tvr.uni[i].cache = null \n\t\t\t\t\tret.vs_uni[vr.uni[i].name] = vr.uni[i] ;\n\t\t\t\t}\n\t\t\t\n\t\t\t\tlet fr = parse_shader(fss) ;\t\n\t//\t\t\tconsole.log(fr);\t\n\t\t\t\tret.fs_uni = {} ;\n\t\t\t\tfor(let i in fr.uni) {\n\t\t\t\t\tfr.uni[i].pos = gl.getUniformLocation(program,fr.uni[i].name) ;\n\t\t\t\t\tfr.uni[i].cache = null \n\t\t\t\t\tret.fs_uni[fr.uni[i].name] = fr.uni[i] ;\n\t\t\t\t}\n\t\t\t\tresolve(ret) ;\n\t\t\t}).catch((err)=>{\n\t\t\t\treject(err) ;\n\t\t\t}) ;\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.setUniValues = function(data) {\n\t\tif(data.vs_uni) {\n\t\t\tfor(let i in data.vs_uni) {\n\t\t\t\tif(this.vs_uni[i]) {\n\t\t\t\t\tthis.setUnivec(this.vs_uni[i], data.vs_uni[i]) ;\n\t\t\t\t}  ;\n\t\t\t}\n\t\t}\n\t\tif(data.fs_uni) {\n\t\t\tfor(let i in data.fs_uni) {\n\t\t\t\tif(this.fs_uni[i]) {\n\t\t\t\t\tthis.setUnivec(this.fs_uni[i], data.fs_uni[i]) ;\n\t\t\t\t}  ;\n\t\t\t}\n\t\t}\n\t\treturn true ;\n\t}\n\tWWG.prototype.Render.prototype.genTex = function(img,option) {\n\t\tif(!option) option={flevel:0} ;\n\t\tlet gl = this.gl ;\n\t\tconst formatstr = {\"rgb\":gl.RGB,\"gray\":gl.LUMINANCE,\"grayalpha\":gl.LUMINANCE_ALPHA}\n\t\tlet format = (option.format && formatstr[option.format])?formatstr[option.format]:gl.RGBA\n\n\t\tlet tex = gl.createTexture();\n\t\tgl.bindTexture(gl.TEXTURE_2D, tex);\n\t\tif(option.isarray) {\n\t\t\tif(img instanceof Float32Array ) \n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, option.width,option.height,0,format, gl.FLOAT, img,0);\n\t\t\telse \n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, option.width,option.height,0,format, gl.UNSIGNED_BYTE, img);\n\t\t\t option.flevel = 0 \n\t\t\t option.nomipmap = true\n\t\t} else \tgl.texImage2D(gl.TEXTURE_2D, 0, format, format,gl.UNSIGNED_BYTE, img);\n\n\t\tif(!option.nomipmap) gl.generateMipmap(gl.TEXTURE_2D);\n\t\t//NEAREST LINEAR NEAREST_MIPMAP_NEAREST NEAREST_MIPMAP_LINEAR LINEAR_MIPMAP_NEAREST LINEAR_MIPMAP_LINEAR\n\t\tswitch(option.flevel) {\n\t\tcase 0:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tbreak;\n\t\t}\n\t\tif(option.repeat==2) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\t} else if(option.repeat==1) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.MIRRORED_REPEAT);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.MIRRORED_REPEAT);\t\t\t\t\n\t\t} else {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\n\t\t}\n\t\tif(this.wwg.ext_anis && option.anisotropy) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, this.wwg.ext_anis.TEXTURE_MAX_ANISOTROPY_EXT, option.anisotropy);\n\t\t}\n\t\tgl.bindTexture(gl.TEXTURE_2D, null);\t\n\t\treturn tex ;\t\n\t}\n\tWWG.prototype.Render.prototype.loadTex = function(tex) {\n\t//\tconsole.log( tex);\n\t\tlet gl = this.gl ;\n\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(tex.src) {\n\t\t\t\tif(tex.opt && tex.opt.cors) {\n\t\t\t\t\tthis.wwg.loadImageAjax(tex.src).then((img)=>{\n\t\t\t\t\t\tresolve( this.genTex(img,tex.opt)) ;\n\t\t\t\t\t}).catch((err)=>reject(err));\n\t\t\t\t} else {\n\t\t\t\t\tlet img = new Image() ;\n\t\t\t\t\timg.onload = ()=> {\n\t\t\t\t\t\tresolve( this.genTex(img,tex.opt) ) ;\n\t\t\t\t\t}\n\t\t\t\t\timg.onerror = ()=> {\n\t\t\t\t\t\treject(\"cannot load image\") ;\n\t\t\t\t\t}\n\t\t\t\t\timg.src = tex.src ;\n\t\t\t\t}\n\t\t\t} else if(tex.img instanceof Image) {\n\t\t\t\tresolve( this.genTex(tex.img,tex.opt) ) \n\t\t\t} else if(tex.video ) {\n\t\t\t\tresolve( this.genTex(tex.video,{nomipmap:true,flevel:0,repeat:2}) ) \n\t\t\t} else if(tex.buffer) {\n\t\t\t\tif(tex.mrt!=undefined) {\n\t\t\t\t\tresolve( tex.buffer.fb.t[tex.mrt])\n\t\t\t\t}\n\t\t\t\telse resolve( tex.buffer.fb.t) ;\n\t\t\t} else if(tex.texture) {\n\t\t\t\tresolve( tex.texture) ;\n\t\t\t} else if(tex.canvas) {\n\t\t\t\tresolve( this.genTex(tex.canvas,tex.opt)) ;\n\t\t\t} else if(tex.array) {\n\t\t\t\ttex.opt.isarray = true ;\n\t\t\t\tresolve( this.genTex(tex.array,tex.opt)) ;\n\t\t\t} else {\n\t\t\t\treject(\"no image\")\n\t\t\t}\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.getTexIndex = function(name) {\n\t\tif(!this.data.texture) return null \n\t\tlet i \n\t\tfor(i=0;i<this.data.texture.length;i++) {\n\t\t\tif(this.data.texture[i].name==name) break;\n\t\t}\n\t\treturn (i==this.data.texture.length)?null:i\n\t}\n\tWWG.prototype.Render.prototype.addTex = function(texdata) {\n\t\treturn new Promise((resolve,reject)=>{\n\t\t\tif(!this.data.texture) this.data.texture = []\n\t\t\tthis.data.texture.push(texdata)\n\t\t\tthis.loadTex(texdata).then((tex)=>{\n\t\t\t\tthis.texobj.push(tex) ;\n\t\t\t\tresolve(this.texobj.length-1)\n\t\t\t}).catch((err)=>reject(err));\n\t\t})\n\t}\n\tWWG.prototype.Render.prototype.removeTex = function(tex) {\n\t\tif(typeof tex == \"string\") tex = this.getTexIndex(tex) \n\t\tif(tex === null ) return \n\t\tthis.data.texture[tex] = null\n\t\tthis.texobj[tex] = null \n\t}\n\n\tWWG.prototype.Render.prototype.frameBuffer = function(os) {\n\t\tlet gl = this.gl ;\n\t\tconsole.log(\"create framebuffer \"+os.width+\"x\"+os.height) ;\n\t\tlet mrt = os.mrt ;\n\t\tlet ttype = gl.UNSIGNED_BYTE ;\n\t\tlet tfilter = gl.LINEAR ;\n\t\tif(this.wwg.ext_ftex && os.float ) {\n\t\t\tttype = gl.FLOAT ;\n\t\t\ttfilter = gl.NEAREST ;\n\t\t\tconsole.log(\"use float tex\") ;\n\t\t}\n\t\tlet fblist = [] ;\n\t\tlet frameBuffer = gl.createFramebuffer();\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer);\n\t\t//depth\n\t\tlet renderBuffer = gl.createRenderbuffer();\n\t\tgl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\n\t\tgl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, os.width, os.height);\t\n\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderBuffer);\n\t\t//texture\n\t\tif(mrt) {\n\t\t\tlet fTexture = [] ;\n\t\t\tfor(let i=0;i<mrt;i++) {\n\t\t\t\tfTexture[i] = gl.createTexture();\n\t\t\t\tgl.bindTexture(gl.TEXTURE_2D, fTexture[i]);\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, os.width, os.height, 0, gl.RGBA, ttype, null);\n\t\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, tfilter);\n\t\t\t    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, tfilter);\n\t\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, this.wwg.mrt_att + i, gl.TEXTURE_2D, fTexture[i], 0);\t\n\t\t\t\tfblist.push(this.wwg.mrt_att + i)\t\t\n\t\t\t}\n\t\t} else {\n\t\t\tlet fTexture = gl.createTexture()\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, fTexture);\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, os.width, os.height, 0, gl.RGBA, ttype, null);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, tfilter);\n\t\t    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, tfilter);\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, fTexture, 0);\n\t\t}\n\t\tgl.bindTexture(gl.TEXTURE_2D, null);\n\t\tgl.bindRenderbuffer(gl.RENDERBUFFER, null);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\t\n\n\t\tlet ret = {ox:os.offsetX,oy:os.offsetY,width:os.width,height:os.height,f:frameBuffer,d:renderBuffer,t:fTexture}\n\t\tif(mrt) ret.fblist = fblist ;\n\t\treturn ret ;\n\t}\n\tWWG.prototype.Render.prototype.setRender =function(data) {\n\t\tlet gl = this.gl ;\n\t\tthis.env = data.env ;\n\t\tthis.data = data ;\n\n\t\treturn new Promise((resolve,reject)=> {\n\t\t\tif(!gl) { reject(\"no init\") ;return ;}\n\t\t\tlet pr = [] ;\n\t\t\tthis.setShader({fshader:data.fshader,vshader:data.vshader}).then((ret)=> {\n\t\t\t\t//set program\n\t\t\t\tthis.vshader = ret.vshader ;\n\t\t\t\tthis.fshader = ret.fshader ;\n\t\t\t\tthis.program = ret.program ;\n\t\t\t\tthis.vs_uni = ret.vs_uni ;\n\t\t\t\tthis.vs_att = ret.vs_att ;\n\t\t\t\tthis.fs_uni = ret.fs_uni ;\n\t\t\t\t\n\t\t\t\t// load textures\n\t\t\t\tif(data.texture) {\n\t\t\t\t\tfor(let i=0;i<data.texture.length;i++) {\n\t\t\t\t\t\tpr.push(this.loadTex( data.texture[i])) ;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tPromise.all(pr).then((result)=> {\n\t//\t\t\t\tconsole.log(result) ;\n\t\t\t\t\tthis.texobj = result ;\n\t\t\t\t\t// set initial values\n\t\t\t\t\tif(!this.setUniValues(data)) {\n\t\t\t\t\t\treject(\"no uniform name\") ;\n\t\t\t\t\t\treturn ;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(this.env.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t\t\tif(this.env.face_cw) gl.frontFace(gl.CW); else gl.frontFace(gl.CCW);\n\t\t\t\t\tif(!this.env.nodepth) gl.enable(gl.DEPTH_TEST); else gl.disable(gl.DEPTH_TEST);\t\t\n\t\t\t\n\t\t\t\t\t//set model \n\t\t\t\t\tfor(let i =0;i<data.model.length;i++) {\n\t\t\t\t\t\tdata.model[i].obuf = this.setObj( data.model[i],true) ;\n\t//\t\t\t\t\tif(data.model[i].name) this.modelHash[data.model[i].name] = data.model[i] ;\n\t\t\t\t\t}\n\t\t\t\t\tthis.modelCount = data.model.length ;\n\t//\t\t\t\tconsole.log(this.obuf);\n\t\t\t\t\t\n\t\t\t\t\tif(this.env.offscreen) {// renderbuffer \n\t\t\t\t\t\tif(this.env.offscreen.mrt) { //MRT\n\t\t\t\t\t\t\tif(!this.wwg.ext_mrt) reject(\"MRT not support\") ;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.fb = this.frameBuffer(this.env.offscreen) ;\t\n\t\t\t\t\t}\n\t\t\t\t\tresolve(this) ;\n\t\t\t\t\t\n\t\t\t\t}).catch((err)=> {\n\t\t\t\t\treject(err) ;\n\t\t\t\t})\n\t\t\t}).catch((err)=> {reject(err);})\n\t\t});\n\t}\n\n\tWWG.prototype.Render.prototype.clear = function() {\n\t\tlet cc = this.env.clear_color ;\n\t\tthis.gl.clearColor(cc[0],cc[1],cc[2],cc[3]);\n\t\tthis.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);\n\t}\n\n\tWWG.prototype.Render.prototype.f32Array = function(ar) {\n\t\tif(ar instanceof Float32Array) return ar ;\n\t\telse return new Float32Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.i16Array = function(ar) {\n\t\tif(ar instanceof Int16Array) return ar ;\n\t\telse return new Int16Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.i32Array = function(ar) {\n\t\tif(ar instanceof Uint32Array) return ar ;\n\t\telse return new Uint32Array(ar) ;\n\t}\n\tWWG.prototype.Render.prototype.setObj = function(obj,flag) {\n\t\tlet gl = this.gl\n\t\tlet geo = obj.geo ;\n\t\tlet inst = obj.inst ;\n\t\tret = {} ;\n\t\tlet vao\n\t\tif(this.wwg.ext_vao) {\n\t\t\tvao = this.wwg.vao_create() ;\n\t\t\tthis.wwg.vao_bind(vao);\n\t\t\tret.vao = vao ;\n\t\t}\n\t\t\n\t\tlet vbo = gl.createBuffer() \n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vbo) ;\n\n\t\tlet tl = 0 ;\n\t\tlet ats = [] ;\n\t\tfor(let i=0;i<geo.vtx_at.length;i++) {\n\t\t\tats.push( this.vs_att[geo.vtx_at[i]] ) ;\n\t\t\ttl += this.wwg.vsize[this.vs_att[geo.vtx_at[i]].type] ;\n\t\t}\n\n\t\tret.ats = ats ;\n\t\tret.tl = tl ;\n\t\tlet ofs = 0 ;\n\t\tfor(let i in this.vs_att ) {\n\t\t\tif(this.vs_att[i].pos>=0) gl.disableVertexAttribArray(this.vs_att[i].pos);\n\t\t}\n\t\tfor(let i=0;i<ats.length;i++) {\n\t\t\tlet s = this.wwg.vsize[ats[i].type] ;\n\t\t\tgl.enableVertexAttribArray(this.vs_att[ats[i].name].pos);\n\t\t\tgl.vertexAttribPointer(this.vs_att[ats[i].name].pos, s, gl.FLOAT, false, tl*4, ofs);\n\t\t\tofs += s*4 ;\t\n\t\t} \t\n\t\tret.vbo = vbo ;\n\t\tlet ibo\n\t\tif(geo.idx) {\n\t\t\tibo = gl.createBuffer() ;\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo) ;\n\t\t\tret.ibo = ibo ;\n\t\t}\n\t\tlet ibuf \n\t\tif(inst) {\n\t\t\tibuf = gl.createBuffer() \n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, ibuf) ;\n\t\t\tlet tl = 0 ;\n\t\t\tlet ats = [] ;\n\t\t\tfor(let i=0;i<inst.attr.length;i++) {\n\t\t\t\tats.push( this.vs_att[inst.attr[i]] ) ;\n\t\t\t\ttl += this.wwg.vsize[this.vs_att[inst.attr[i]].type] ;\n\t\t\t}\n\t\t\ttl = tl*4 ;\n\t\t\tret.iats = ats ;\n\t\t\tret.itl = tl ;\n\t\t\tlet ofs = 0 ;\n\t\t\tfor(let i=0;i<ats.length;i++) {\n\t\t\t\tlet divisor = (inst.divisor)?inst.divisor[i]:1 ;\n\t\t\t\tlet s = this.wwg.vsize[ats[i].type] ;\n\t\t\t\tlet pos = this.vs_att[ats[i].name].pos\n\t\t\t\tgl.enableVertexAttribArray(pos);\n\t\t\t\tgl.vertexAttribPointer(pos, s, gl.FLOAT, false, tl, ofs);\n\t\t\t\tofs += s*4 ;\n\t\t\t\tthis.wwg.inst_divisor(pos, divisor)\t\n\t\t\t} \n\t\t\tret.inst = ibuf \n\t\t}\n\t\t\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(vao);\n\t\tif(flag) {\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vbo) ;\n\t\t\tgl.bufferData(gl.ARRAY_BUFFER, \n\t\t\t\tthis.f32Array(geo.vtx), (geo.dynamic)?gl.DYNAMIC_DRAW:gl.STATIC_DRAW) ;\n\t\t}\n\t\tif(flag && geo.idx) {\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo) ;\n\t\t\tif(geo.vtx.length/(ret.tl) > 65536 && this.wwg.ext_i32) {\n\t\t\t\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, \n\t\t\t\t\tthis.i32Array(geo.idx),gl.STATIC_DRAW ) ;\n\t\t\t\tret.i32 = true ;\n\t\t\t} else {\n\t\t\t\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, \n\t\t\t\t\tthis.i16Array(geo.idx),gl.STATIC_DRAW ) ;\n\t\t\t\tret.i32 = false ;\n\t\t\t}\n\t\t}\n\t\tif(flag && inst) {\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, ibuf) ;\n\t\t\tgl.bufferData(gl.ARRAY_BUFFER, \n\t\t\t\tthis.f32Array(inst.data),(inst.dynamic)?gl.DYNAMIC_DRAW:gl.STATIC_DRAW ) ;\n\t\t}\n\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\t\t\t\n\t\treturn ret ;\n\t}\n\tWWG.prototype.Render.prototype.getModels = function() {\n\t\treturn this.data.model.filter((m)=>(m!==null))\t\n\t}\n\tWWG.prototype.Render.prototype.getModelIdx = function(name) {\n\t\tlet idx = false \n\t\tif(typeof name != 'string') idx = parseInt(name) ;\n\t\telse {\n\t\t\tfor(let i=0;i<this.data.model.length;i++) \t{\n\t\t\t\tif(this.data.model[i]===null) continue \n\t\t\t\tif(name==this.data.model[i].name) {idx = i ;break }\n\t\t\t}\n\t\t}\n\t\treturn idx ;\t\n\t}\n\t// add model\n\tWWG.prototype.Render.prototype.addModel = function(model) {\n\t\tlet idx = false\n\t\tif(model.name) idx = this.getModelIdx(model.name)\n\t\tif(idx!==false ) {\n\t\t\tthis.data.model[idx] = model ;\n\t\t\tthis.data.model[idx].obuf = this.setObj(model,true) ;\n\t\t\treturn \n\t\t}\n\t\tthis.data.model.push(model) ;\n\t\tthis.data.model[this.data.model.length-1].obuf = this.setObj(model,true) ;\n\t\tthis.modelCount++\n\t//\tif(model.name) this.modelHash[model.name] = this.data.model.length -1 ;\n\t}\n\t// remove model\n\tWWG.prototype.Render.prototype.removeModel = function(model) {\n\t\tlet mi = this.getModelIdx(model) \n\t\tif(mi===false) return false \n\t//\tdelete this.modelHash[this.data.model[mi].name] \n\t\tthis.data.model[mi].obuf = null \n\t\tthis.data.model[mi] = null \n\t\tthis.modelCount--  \n\t\treturn true \n\t}\n\t// update attribute buffer \n\tWWG.prototype.Render.prototype.updateModel = function(name,mode,buf,subflag=true) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\tlet obuf = this.data.model[idx].obuf ;\n\t\tswitch(mode) {\n\t\t\tcase \"vbo\":\t\n\t\t\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.vbo) ;\n\t\t\t\tbreak ;\n\t\t\tcase \"inst\":\n\t\t\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.inst) ;\n\t\t\t\tbreak ;\n\t\t}\n\t\tif(subflag) \n\t\t\tthis.gl.bufferSubData(this.gl.ARRAY_BUFFER, 0, this.f32Array(buf))\t\n\t\telse\n\t\t\tthis.gl.bufferData(this.gl.ARRAY_BUFFER, this.f32Array(buf),this.gl.DYNAMIC_DRAW ) ;\n\t}\n\tWWG.prototype.Render.prototype.updateModelInstance = function(name,buf,count) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\tlet obuf = this.data.model[idx].obuf ;\n\t\tthis.data.model[idx].inst.count = count ;\n\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, obuf.inst) ; \n\t//\t\tthis.gl.bufferSubData(this.gl.ARRAY_BUFFER, 0, this.f32Array(buf))\t\n\t\t\tthis.gl.bufferData(this.gl.ARRAY_BUFFER, this.f32Array(buf),this.gl.DYNAMIC_DRAW ) ;\n\t}\n\tWWG.prototype.Render.prototype.getModelData =function(name) {\n\t\tlet idx = this.getModelIdx(name) ;\n\t\treturn this.data.model[idx] ;\n\t}\n\t// update texture \n\tWWG.prototype.Render.prototype.updateTex = function(idx,tex,opt) {\n\t\tif(typeof idx == 'string') idx = this.getTexIndex(idx)\n\t\tvar tdat = this.data.texture[idx]\n\t\tthis.gl.bindTexture(this.gl.TEXTURE_2D, this.texobj[idx]);\n\n\t\tif(tdat.array) {\n\t\t\tif(!opt) \n\t\t\t\tif(tdat.array instanceof Float32Array ) \n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA16F, \n\t\t\t\t\ttdat.opt.width,tdat.opt.height,0,this.gl.RGBA, this.gl.FLOAT, tex);\n\t\t\t\telse\n\t\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, \n\t\t\t\t\ttdat.opt.width,tdat.opt.height,0,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\t\n\t\t\telse \n\t\t\t\tif(tdat.array instanceof Float32Array ) \n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, \n\t\t\t\t\topt.sx,opt.sy,opt.width,opt.height,this.gl.RGBA, this.gl.FLOAT, tex,opt.ofs);\n\t\t\t\telse\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, \n\t\t\t\t\topt.sx,opt.sy,opt.width,opt.height,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex,opt.ofs);\n\t\t} else {\n\t\t\tif(!opt) {\n\t\t\t\tthis.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\n\t\t\t} else {\n\t\t\t\tif(opt.wx>0 && opt.wy>0)\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, opt.sx,opt.sy,opt.wx,opt.wy,this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\t\n\t\t\t\telse \t\n\t\t\t\t\tthis.gl.texSubImage2D(this.gl.TEXTURE_2D, 0, opt.sx,opt.sy , this.gl.RGBA, this.gl.UNSIGNED_BYTE, tex);\n\t\t\t}\n\t\t}\n\t\tif(tdat.opt && !tdat.opt.nomipmap) this.gl.generateMipmap(this.gl.TEXTURE_2D);\n\t}\n\t//update uniform values\n\tWWG.prototype.Render.prototype.pushUniValues = function(u) {\n\t\tif(u.vs_uni) {\n\t\t\tfor(let i in u.vs_uni) {\n\t\t\t\tthis.update_uni.vs_uni[i] = u.vs_uni[i] ;\n\t\t\t}\n\t\t}\n\t\tif(u.fs_uni) {\n\t\t\tfor(let i in u.fs_uni) {\n\t\t\t\tthis.update_uni.fs_uni[i] = u.fs_uni[i] ;\n\t\t\t}\n\t\t}\n\t}\n\tWWG.prototype.Render.prototype.updateUniValues = function(u) {\n\t\tif(!u) {\n\t\t\tthis.update_uni = {vs_uni:{},fs_uni:{}} ;\n\t\t\treturn ;\n\t\t}\n\t//\tconsole.log(\"update uni\");\n\t\tthis.setUniValues(this.update_uni)\n\t}\n\n\t// draw call\n\tWWG.prototype.Render.prototype.draw = function(update,cls) {\n\t//console.log(\"draw\");\n\n\t\tlet gl = this.gl ;\n\t\tgl.useProgram(this.program);\n\t\tif(this.env.offscreen) {// renderbuffer \n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, this.fb.f);\n\t\t\tif(this.env.offscreen.mrt) this.wwg.mrt_draw(this.fb.fblist);\n\t\t\tgl.viewport(fb.offsetX,fb.offsetY,this.fb.width,this.fb.height) ;\n\t\t}\n\t\tif(!cls) this.clear() ;\n\t\tlet models = this.data.model\n\t\tfor(let b=0;b<models.length;b++) {\n\t\t\tif(models[b]===null) continue \n\t\t\tlet cmodel = models[b] ;\n\t\t\tif(cmodel.hide) continue ;\n\t\t\tif(cmodel.obuf==null) continue ;\n\n\t\t\tlet geo = cmodel.geo ;\n\t\t\tthis.updateUniValues(0) ;\n\t\t\tthis.pushUniValues(this.data) ;\n\t\t\tthis.pushUniValues(cmodel);\n\t\t\tif(update) {\n\t\t\t\t// set modified values\n\t\t\t\tif(!Array.isArray(update)) update = [update ]\n\t\t\t\tfor(let i=0;i<update.length;i++) {\n\t\t\t\t\tthis.pushUniValues(update[i]) ;\n\t\t\t\t\tif(update[i].model) {\n\t\t\t\t\t\tlet model =update[i].model[b] ;\n\t\t\t\t\t\tif(model) this.pushUniValues(model) ;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.updateUniValues(1)\n\n\t\t\tlet obuf = cmodel.obuf ;\n\t\t\tlet ofs = (geo.ofs>0)?geo.ofs:0 ;\n\t\t\tif(this.wwg.ext_vao)  this.wwg.vao_bind(obuf.vao);\n\t\t\telse {\n\t\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, obuf.vbo) ;\n\t\t\t\tlet aofs = 0 ;\n\t\t\t\tfor(let i in this.vs_att ) {\n\t\t\t\t\tgl.disableVertexAttribArray(this.vs_att[i].pos);\n\t\t\t\t}\n\t\t\t\tfor(let i=0;i<obuf.ats.length;i++) {\n\t\t\t\t\tlet s = this.wwg.vsize[obuf.ats[i].type] ;\n\t\t\t\t\tgl.enableVertexAttribArray(this.vs_att[obuf.ats[i].name].pos);\n\t\t\t\t\tgl.vertexAttribPointer(this.vs_att[obuf.ats[i].name].pos, s, gl.FLOAT, false, obuf.tl*4, aofs);\n\t\t\t\t\taofs += s*4 ;\t\n\t\t\t\t}\n\t\t\t\tif(obuf.ibo) gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obuf.ibo) ;\n\t\t\t\tif(obuf.inst) {\n\t\t\t\t\tlet inst = cmodel.inst ;\n\t\t\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, obuf.inst) ;\n\t\t\t\t\tlet aofs = 0 ;\n\t\t\t\t\tfor(let i=0;i<obuf.iats.length;i++) {\n\t\t\t\t\t\tlet divisor = (inst.divisor)?inst.divisor[i]:1 ;\n\t\t\t\t\t\tlet s = this.wwg.vsize[obuf.iats[i].type] ;\n\t\t\t\t\t\tlet pos = this.vs_att[obuf.iats[i].name].pos\n\t\t\t\t\t\tgl.enableVertexAttribArray(pos);\n\t\t\t\t\t\tgl.vertexAttribPointer(pos, s, gl.FLOAT, false, obuf.itl, aofs);\n\t\t\t\t\t\taofs += s*4 ;\n\t\t\t\t\t\tthis.wwg.inst_divisor(pos, divisor)\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(cmodel.preFunction) {\n\t\t\t\t\n\t\t\t\tcmodel.preFunction(gl,cmodel,obuf) ;\n\t\t\t}\n\t\t\tif(cmodel.blend!==undefined) {\n\t\t\t\tgl.enable(gl.BLEND) ;\n\t\t\t\tif(cmodel.blend==\"alpha\") gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);\n\t\t\t}\n\t\t\tif(cmodel.cull!==undefined) {\n\t\t\t\tif(cmodel.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t}\n\t\t\tlet gmode = this.wwg.dmodes[geo.mode]\n\t\t\tif(gmode==undefined) {\n\t\t\t\t\tconsole.log(\"Error: illigal draw mode\") ;\n\t\t\t\t\treturn false ;\n\t\t\t}\n\t\t\tif(cmodel.inst) {\n\t\t\t\tif(geo.idx) this.wwg.inst_draw(gmode, geo.idx.length, (obuf.i32)?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT, ofs, cmodel.inst.count);\n\t\t\t\telse this.wwg.inst_drawa(gmode, ofs,(geo.count>0)?geo.count:geo.vtx.length/obuf.tl, cmodel.inst.count);\n\t\t\t} else {\n\t\t\t\tif(geo.idx) gl.drawElements(gmode, geo.idx.length, (obuf.i32)?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT, ofs);\n\t\t\t\telse gl.drawArrays(gmode, ofs,\n\t\t\t\t\t(geo.count>0)?geo.count:geo.vtx.length/obuf.tl);\n\t\t\t}\n\t\t\tif(this.wwg.ext_vao) this.wwg.vao_bind(null);\n\t\t\telse {\n\t\t\t\t\n\t\t\t}\n\t\t\tif(cmodel.blend!==undefined) {\n\t\t\t\tgl.disable(gl.BLEND) ;\n\t\t\t}\n\t\t\tif(cmodel.cull!==undefined) {\n\t\t\t\tif(this.env.cull) gl.enable(gl.CULL_FACE); else gl.disable(gl.CULL_FACE);\n\t\t\t}\n\t\t\tif(cmodel.postFunction) {\n\t\t\t\tcmodel.postFunction(gl,cmodel) ;\n\t\t\t}\n\t\t}\n\t\tif(this.env.offscreen) {// unbind renderbuffer \n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tgl.viewport(0,0,this.wwg.can.width,this.wwg.can.height) ;\n\t\t}\n\t\treturn true ;\n\t}\n\treturn pox.WWG = WWG;\n});"]}