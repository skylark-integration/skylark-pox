{"version":3,"sources":["Camera.js"],"names":["define","pox","CanvasMatrix4","RAD","Mat4","Camera","[object Object]","poxp","cam","this","camCX","camCY","camCZ","camVX","camVY","camVZ","camUPX","camUPY","camUPZ","camRX","camRY","camRZ","camd","camAngle","camWidth","camNear","camFar","camGyro","gPad","sbase","moveSpeed","rotAngle","moveY","padMoveUD","padRot","headVec","i","cama","rotX","rotY","gev","gx","gy","gz","vcx","vcy","vcz","vrx","vry","vrz","keydown","vr","camVP","camP","camV","vrv","vrp","tempM","pvy","pvx","ret","basePos","baseRot","position","Array","from","campos","orientation","headOri","headPos","f","ev","m","mag","pixRatio","can","width","scale","setting","dy","dx","rx","ry","z","keymag","md","altKey","key","cthis","am","dir","Math","sin","cos","time","ft","ctime","ltime","camMode","acx","acy","acz","ad","av","al","aex","aey","aez","gpad","gpad2","gp","axes","undefined","buttons","pressed","mv","abs","dpad","rot","x","y","opt","cx","cy","cz","velocity","vx","vy","vz","l","hypot","sf","render","wwg","aspect","height","ex","ey","ez","upx","upy","upz","vrFrame","isVR","cmat","rotate","multVec4","makeIdentity","lookat","perspective","pallarel","load","multRight","POXPDevice","setDepth","getFrameData","pose","rightViewMatrix","leftViewMatrix","rightProjectionMatrix","leftProjectionMatrix","translate","leftCorrMtx","multLeft","rightCorrMtx","w","invert","slice","ivr","ivl","buf","camX","camY","camZ"],"mappings":"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","file":"../Camera.js","sourcesContent":["define([\n    \"./pox\",\n    \"./CanvasMatrix4\"\n],function(pox,CanvasMatrix4){\n\t// poxplayercamera object\n\tconst RAD = pox.RAD;\n\tconst Mat4 = CanvasMatrix4; // alias\n\n\tclass Camera {\n\t\tconstructor(poxp,cam) {\n\t\t\tthis.poxp = poxp ;\n\t\t\t//camera initial\n\t\t\tthis.cam = {\n\t\t\t\tcamCX:0,\n\t\t\t\tcamCY:0,\n\t\t\t\tcamCZ:0,\n\t\t\t\tcamVX:0,\n\t\t\t\tcamVY:0,\n\t\t\t\tcamVZ:1,\n\t\t\t\tcamUPX:0,\n\t\t\t\tcamUPY:1,\n\t\t\t\tcamUPZ:0,\n\t\t\t\tcamRX:30,\n\t\t\t\tcamRY:-30,\n\t\t\t\tcamRZ:0,\n\t\t\t\tcamd:20,\n\t\t\t\tcamAngle:90,\t//cam angle(deg) \n\t\t\t\tcamWidth:1.0,\n\t\t\t\tcamNear:0.01, \t//near\n\t\t\t\tcamFar:1000, \t//far\n\t\t\t\tcamGyro:true, // use gyro\n\t\t\t\tgPad:true, //use gpad\n\t\t\t\tsbase:0.06, \t//streobase \n\t\t\t\tmoveSpeed:1.3,\t\t// m/sec\n\t\t\t\trotAngle:30,\n\t\t\t\tmoveY:false,\n\t\t\t\tpadMoveUD:true,\n\t\t\t\tpadRot:true,\n\t\t\t\theadVec:[0,0,0]\t//head direction\n\t\t\t} ;\n\t\t\tfor(let i in cam) {\n\t\t\t\tthis.cam[i] = cam[i] ;\n\t\t\t}\n\n\t\t\tthis.cama = false ; // on animation\n\t\t\tthis.rotX = 0 ;\n\t\t\tthis.rotY = 0 ;\n\t\t\tthis.gev = null ;\n\t\t\tthis.gx = 0 ; this.gy = 0 ; this.gz = 0 ;\n\t\t\tthis.vcx = 0 ;this.vcy = 0 ; this.vcz=0\n\t\t\tthis.vrx = 0 ;this.vry = 0 ; this.vrz=0\n\t\t\tthis.keydown = false ;\n\t\t\tthis.vr = false ;\n\t\t\tthis.camVP = [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.camP =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.camV =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.vrv =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.vrp =  [new CanvasMatrix4(),new CanvasMatrix4()]\n\t\t\tthis.tempM =  new CanvasMatrix4()\n\t\t\tthis.pvy = false \n\t\t\tthis.pvx = false \n\t\t//\tif(window.VRFrameData!=undefined) this.vrFrame = new VRFrameData()\n\t\t}\n\t\tsetCam(cam) {\n\t\t\tfor(let i in cam) {\n\t\t\t\tthis.cam[i] = cam[i] ;\n\t\t\t}\n\t\t\tthis.cama = false \n\t\t}\n\t\tgetCam() {\n\t\t\tconst ret = {\n\t\t\t\tbasePos:[this.cam.camCX,this.cam.camCY,this.cam.camCZ],\n\t\t\t\tbaseRot:[this.cam.camRX,this.cam.camRY,this.cam.camRZ],\n\t\t\t\tposition:Array.from(this.cam.campos),\n\t\t\t\theadVec:Array.from(this.cam.headVec),\n\t\t\t}\n\t\t\tif(this.cam.orientation) ret.headOri = Array.from(this.cam.orientation)\n\t\t\telse ret.headOri = [0,0,0,1]\n\t\t\tif(this.cam.position) ret.headPos = Array.from(this.cam.position)\n\t\t\telse ret.headPos = [0,0,0]\n\t\t\treturn ret \n\t\t}\n\t\tvrchange(f) {\n\t\t\tif(f) {\n\t\t\t\tthis.cam.camRX = 0\n\t\t\t\tthis.cam.camRZ = 0\n\t\t\t}\n\t\t}\n\t\tevent(ev,m) {\n\t\t\tconst mag = 300*this.poxp.pixRatio /this.poxp.can.width;\n\t\t\tconst scale = (this.poxp.pox.setting && this.poxp.pox.setting.scale)? this.poxp.pox.setting.scale :1 ;\n\n\t\t//\tconsole.log(\"cam \"+ev+\" key:\"+m.key)\n\t\t\tswitch(ev) {\n\t\t\t\tcase \"down\":\n\t\t\t\t\tthis.rotX = this.cam.camRX\n\t\t\t\t\tthis.rotY = this.cam.camRY\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"move\":\n\t\t\t\t\tthis.cam.camRX = this.rotX+m.dy*mag ;\n\t\t\t\t\tthis.cam.camRY = this.rotY+m.dx*mag ;\n\t\t\t\t\tif(this.cam.camRX>89)this.cam.camRX=89;\n\t\t\t\t\tif(this.cam.camRX<-89)this.cam.camRX=-89;\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"up\":\n\t\t\t\t\tthis.rotX += m.dy*mag ;\n\t\t\t\t\tthis.rotY += m.dx*mag; \n\t\t\t\t\tif(this.gev!==null) {\n\t\t\t\t\t\tthis.gx = this.gev.rx - this.rotX ;\n\t\t\t\t\t\tthis.gy = this.gev.ry - this.rotY ;\n\t\t//\t\t\t\tconsole.log(this.gx+\"/\"+this.gy) ;\n\t\t\t\t\t}\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"out\":\n\t\t\t\t\tthis.rotX += m.dy*mag ;\n\t\t\t\t\tthis.rotY += m.dx*mag; \n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"wheel\":\n\t\t\t\t\tthis.cam.camd += m/100 * scale ;\n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"gesture\":\n\t\t\t\t\tif(m.z==0) {\n\t\t\t\t\t\tthis.gz = this.cam.camd ; \n\t\t\t\t\t\treturn false ;\n\t\t\t\t\t}\n\t\t\t\t\tthis.cam.camd = this.gz / m.z ;\n\t\t\t\t\tbreak ;\t\n\t\t\t\tcase \"gyro\":\n\t\t//\t\tconsole.log(m)\n\t\t\t\t\tif(this.keydown || !this.cam.camGyro) return true ;\n\t\t\t\t\tif(m.rx===null) return true ;\n\t\t\t\t\tthis.gev = m ;\n\t\t\t\t\tthis.cam.camRX = m.rx - this.gx;\n\t\t\t\t\tthis.cam.camRY = m.ry - this.gy ;\n\t\t//\t\tconsole.log(gx+\"/\"+gy) ;\n\t\t\t\t\tif(this.cam.camRX>89)this.cam.camRX=89 ;\n\t\t\t\t\tif(this.cam.camRX<-89)this.cam.camRX=-89 ;\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"keydown\":\n\t\t\t\t\tconst z = this.cam.camd ;\n\t\t\t\t\tconst keymag= this.cam.moveSpeed ;\n\t\t\t\t\tlet md = \"\" ;\n\t\t\t\t\tthis.keydown = true ;\n\t\t\t\t\tif(m.altKey) {\n\t\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\t\tcase \"ArrowUp\":this.cam.camd = this.cam.camd - keymag; if(this.cam.camd<0) cthis.am.camd = 0 ; break ;\n\t\t\t\t\t\t\tcase \"ArrowDown\":this.cam.camd = this.cam.camd + keymag ; break ;\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\t\tcase \"ArrowLeft\":\n\t\t\t\t\t\t\tcase \"Left\":\n\t\t\t\t\t\t\tcase \"h\":\n\t\t\t\t\t\t\t\tthis.vry = -keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\t\t\tcase \"Up\":\n\t\t\t\t\t\t\tcase \"k\":\n\t\t\t\t\t\t\t\tthis.vrx = -keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowRight\":\n\t\t\t\t\t\t\tcase \"Right\":\n\t\t\t\t\t\t\tcase \"l\":\n\t\t\t\t\t\t\t\tthis.vry = keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\tcase \"ArrowDown\":\n\t\t\t\t\t\t\tcase \"Down\":\n\t\t\t\t\t\t\tcase \"j\":\n\t\t\t\t\t\t\t\tthis.vrx = keymag ;\n\t\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tcase \"w\":\n\t\t\t\t\t\t\t\tmd = \"f\" ; break ;\n\t\t\t\t\t\t\tcase \"s\":\n\t\t\t\t\t\t\t\tmd = \"b\" ;break ;\n\t\t\t\t\t\t\tcase \"a\":\n\t\t\t\t\t\t\t\tmd = \"l\" ;break ;\n\t\t\t\t\t\t\tcase \"d\":\n\t\t\t\t\t\t\t\tmd = \"r\" ;break ;\t\n\t\t\t\t\t\t\tcase \"q\":\n\t\t\t\t\t\t\t\tmd = \"u\" ;break ;\n\t\t\t\t\t\t\tcase \"e\":\n\t\t\t\t\t\t\t\tmd = \"d\" ;break ;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif(md!=\"\") {\n\t\t\t\t\t\tconst dir = ((md==\"b\"||md==\"d\")?-1:1)*keymag*scale \n\t\t\t\t\t\tconst cam = this.cam ;\n\t\t\t\t\t\tif(md==\"u\"||md==\"d\") {\n\t\t\t\t\t\t\tthis.vcy = dir ;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlet ry = cam.camRY ;\n\t\t\t\t\t\t\tif(md==\"l\") ry = ry -90 ;\n\t\t\t\t\t\t\tif(md==\"r\") ry = ry +90 ;\n\t\t\t\t\t\t\tthis.vcx =  Math.sin(ry*RAD) *dir ;\n\t\t\t\t\t\t\tthis.vcz = -Math.cos(ry*RAD)* dir ;\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak ;\n\t\t\t\tcase \"keyup\":\n\t\t\t\t\tthis.keydown = false ;\n\t\t\t\t\tif(this.gev!==null) {\n\t\t\t\t\t\tthis.gx = this.gev.rx - this.cam.camRX ;\n\t\t\t\t\t\tthis.gy = this.gev.ry - this.cam.camRY ;\n\t\t//\t\t\t\tconsole.log(this.gx+\"/\"+this.gy) ;\n\t\t\t\t\t}\n\t\t\t\t\tswitch(m.key) {\n\t\t\t\t\t\tcase \"ArrowLeft\":\n\t\t\t\t\t\tcase \"Left\":\n\t\t\t\t\t\tcase \"h\":\n\t\t\t\t\t\tcase \"ArrowRight\":\n\t\t\t\t\t\tcase \"Right\":\n\t\t\t\t\t\tcase \"l\":\n\t\t\t\t\t\t\tthis.vry = 0 ; break ;\n\t\t\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\t\tcase \"Up\":\n\t\t\t\t\t\tcase \"k\":\n\t\t\t\t\t\tcase \"ArrowDown\":\n\t\t\t\t\t\tcase \"Down\":\n\t\t\t\t\t\tcase \"j\":\n\t\t\t\t\t\t\tthis.vrx = 0  ; break ;\n\t\t\t\t\t\tcase \"w\":\n\t\t\t\t\t\tcase \"d\":\n\t\t\t\t\t\tcase \"a\":\n\t\t\t\t\t\tcase \"s\":\n\t\t\t\t\t\tcase \" \":\n\t\t\t\t\t\t\tthis.vcx = 0 ; this.vcz = 0 ; break ;\n\t\t\t\t\t\tcase \"q\":\n\t\t\t\t\t\tcase \"e\":\n\t\t\t\t\t\t\tthis.vcy = 0 ;break ;\n\t\t\t\t\t\tcase \"Dead\": //mobile safari no keyup key\n\t\t\t\t\t\t\tthis.vrx = 0 ; this.vry = 0 ; this.vcx = 0 ; this.vcz = 0 ; \n\t\t\t\t\t\t\tbreak ;\n\t\t\t\t\t}\t\t\t\n\t\t\t\t\tbreak ;\t\n\t\t\t\t}\n\t\t}\n\t\tupdate(time) {\n\t\t\tconst ft = (this.poxp.ctime - this.poxp.ltime)/1000\n\t\t//console.log(ft)\n\t\t\tif(this.cam.camMode!=\"fix\") {\n\t\t\t\tthis.cam.camRX += this.vrx ;\n\t\t\t\tif(this.cam.camRX<-89) this.cam.camRX = -89 ; \n\t\t\t\tif(this.cam.camRX>89) this.cam.camRX = 89 ; \n\t\t\t\tthis.cam.camRY += this.vry ;\n\t\t\t}\n\t\t\tif(this.cam.camMode==\"walk\") {\n\t\t\t\tif(!this.cama) {\n\t\t\t\t\tthis.cam.camCX += this.vcx *ft ;\n\t\t\t\t\tthis.cam.camCY += this.vcy *ft ;\n\t\t\t\t\tthis.cam.camCZ += this.vcz *ft ;\n\t\t\t\t}\n\t\t\t\tthis.cam.camRY += this.vry *ft ;\n\t\t\t}\n\t\t\tif(this.cama) {\n\t\t\t\tthis.cam.camCX += this.acx *ft ;\n\t\t\t\tthis.cam.camCY += this.acy *ft ;\n\t\t\t\tthis.cam.camCZ += this.acz *ft ;\t\n\t\t\t\tthis.ad += this.av * ft \n\t\t\t\tif( this.ad > this.al ) {\n\t\t\t\t\tthis.cam.camCX = this.aex\n\t\t\t\t\tthis.cam.camCY = this.aey\n\t\t\t\t\tthis.cam.camCZ = this.aez\n\t\t\t\t\tthis.cama = false \n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tsetPad(gpad,gpad2) {\n\t\t\tlet gp = gpad?gpad:gpad2\n\t\t\tif(!gp) return \n\t\t\tif(this.cam.camMode==\"walk\") {\n\t\t\t\tlet axes = [gp.axes[0],gp.axes[1]]\n\t\t\t\tif(gp.axes[2]!=undefined && gp.axes[2]!=0) axes[0] = gp.axes[2]\n\t\t\t\tif(gp.axes[3]!=undefined && gp.axes[3]!=0) axes[1] = gp.axes[3]\n\t\t\t\tif(this.cam.padMoveUD && gp.buttons[1] && gp.buttons[1].pressed) {\n\t\t\t\t\tthis.vcy = -axes[1]*this.cam.moveSpeed\n\t\t\t\t\tthis.pvy = true ;\n\t\t\t\t\treturn\n\t\t\t\t} else if(this.pvy) {\n\t\t\t\t\tthis.vcy = 0 \n\t\t\t\t\tthis.pvy = false\n\t\t\t\t}\n\t\t\t\tlet m = gp.buttons[2] && gp.buttons[2].pressed\n\t\t\t\tlet mv = (m)?this.cam.moveSpeed*5:this.cam.moveSpeed\n\t\t\t\tif(Math.abs(axes[0])<Math.abs(axes[1]) && Math.abs(axes[1])>0 ) {\n\t\t\t\t\t\tthis.vcx = -this.cam.headVec[0] * axes[1]*mv\n\t\t\t\t\t\tif(this.cam.moveY) this.vcy = -this.cam.headVec[1] * axes[1]*mv\n\t\t\t\t\t\tthis.vcz = -this.cam.headVec[2] * axes[1]*mv\n\t\t\t\t\t\tthis.pvx = true\n\t\t\t\t\t\treturn \n\t\t\t\t} else if(this.pvx) {\t\t\n\t\t\t\t\t\tthis.vcx = 0 \n\t\t\t\t\t\tthis.vcy = 0\n\t\t\t\t\t\tthis.vcz = 0 \n\t\t\t\t\t\tthis.pvx = false \n\t\t\t\t}\n\t\t\t\tif(this.cam.padRot && gp.dpad[0]>0) {\n\t\t\t\t\tlet rot = ((axes[0]>0)?1:-1) * this.cam.rotAngle\n\t\t\t\t\tthis.cam.camRY += rot\n\t\t\t\t\tif(false && this.cam.position) {\n\t\t\t\t\t\tlet th = rot * RAD \n\t\t\t\t\t\tthis.cam.camCX += Math.cos(th)*this.cam.position[0]+ Math.sin(th)*this.cam.position[2]\n\t\t\t\t\t\tthis.cam.camCZ += -Math.sin(th)*this.cam.position[0]+ Math.cos(th)*this.cam.position[2]\n\t\t\t\t\t\tconsole.log(Math.cos(th)*this.cam.position[0]+ Math.sin(th)*this.cam.position[2]\n\t\t\t\t\t\t,-Math.sin(th)*this.cam.position[0]+ Math.cos(th)*this.cam.position[2])\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tmoveTo(x,y,z,opt) {\n\t\t\tif(this.cama) return \n\t\t\tlet cx = (x!==null)?x:this.cam.camCX\n\t\t\tlet cy = (y!==null)?y:this.cam.camCY\n\t\t\tlet cz = (z!==null)?z:this.cam.camCZ \n\t\t\tif(opt && opt.velocity) {\n\t\t\t\tlet vx = cx - this.cam.camCX \n\t\t\t\tlet vy = cy - this.cam.camCY \n\t\t\t\tlet vz = cz - this.cam.camCZ\n\t\t\t\tlet l = opt.velocity / Math.hypot(vx,vy,vz)\n\t\t\t\tvx *= l , vy *= l, vz *= l\n\t\t\t\tthis.acx = vx \n\t\t\t\tthis.acy = vy\n\t\t\t\tthis.acz = vz\n\t\t\t\tthis.aex = cx \n\t\t\t\tthis.aey = cy \n\t\t\t\tthis.aez = cz\n\t\t\t\tthis.al = opt.velocity/l\n\t\t\t\tthis.ad = 0 \n\t\t\t\tthis.av = opt.velocity \n\t\t\t\tthis.cama = true \n\t\t\t} else {\n\t\t\t\tthis.cam.camCX = cx \n\t\t\t\tthis.cam.camCY = cy \n\t\t\t\tthis.cam.camCZ = cz \n\t\t\t\tthis.cama = false \n\t\t\t}\n\t\t}\n\t\tmoveCancel() {\n\t\t\tthis.cama = false \n\t\t}\n\t\tgetMtx(scale,sf) {\n\t\t\tconst cam = this.cam ;\n\t\t\tconst can = this.poxp.render.wwg.can ;\n\n\t\t\tconst aspect = can.width/(can.height*((sf)?2:1)) ;\n\t\t\tconst cams = [];\n\t\t//console.log(cam);\n\t\t//console.log(cam.camRX+\"/\"+cam.camRY) ;\n\t\t\tlet cx,cy,cz,ex,ey,ez,upx,upy,upz,camd ;\n\t\t\tlet vrFrame = null\n\t\t\tupx = cam.camUPX ;\n\t\t\tupy = cam.camUPY ;\n\t\t\tupz = cam.camUPZ ;\t\n\t\t\tex =[0,0], ey=[0,0],ez=[0,0] ;\n\t\t\tif(!this.poxp.isVR) {\n\t\t\t\tif(cam.camMode==\"fix\") {\n\t\t\t\t\tcx = cam.camVX ;\n\t\t\t\t\tcy = cam.camVY ;\n\t\t\t\t\tcz = cam.camVZ ;\n\t\t\t\t\tthis.cam.headVec = [cx,cy,cz,0]\n\t\t\t\t}\n\t\t\t\telse if(cam.camMode==\"vr\" || cam.camMode==\"walk\") {\n\t\t\t\t\t// self camera mode \n\t\t\t\t\tcx = cam.camCX + Math.sin(cam.camRY*RAD)*1*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcy = cam.camCY + -Math.sin(cam.camRX*RAD)*1 ; \n\t\t\t\t\tcz = cam.camCZ + -Math.cos(cam.camRY*RAD)*1*Math.cos(cam.camRX*RAD)\t\n\t\t\t\t\tlet cmat = new Mat4().rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0).rotate(-this.cam.camRZ,0,0,1)\n\t\t\t\t\tupx = -Math.sin(cam.camRZ*RAD)\n\t\t\t\t\tupy = Math.cos(cam.camRZ*RAD)\n\t\t\t\t\tthis.cam.headVec = cmat.multVec4(0,0,-1,0)\n\t\t\t\t} else  {\n\t\t\t\t// bird camera mode \n\t\t\t\t\tcamd=  cam.camd*scale ;\n\t\t\t\t\tcam.camCX  = -Math.sin(cam.camRY*RAD)*camd*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcam.camCY = Math.sin(cam.camRX*RAD)*camd ; \n\t\t\t\t\tcam.camCZ = Math.cos(cam.camRY*RAD)*camd*Math.cos(cam.camRX*RAD)\n\t\t\t\t\tcx = 0 ,cy = 0, cz = 0 ;\n\t\t\t\t\tif(camd<0) {\n\t\t\t\t\t\tcx = cam.camCX*2 ;cy = cam.camCY*2 ;cz = cam.camCZ*2 ;\n\t\t\t\t\t}\n\t\t\t\t\tlet l = Math.hypot(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\t\t\tthis.cam.headVec = [-cam.camCX/l,-cam.camCY/l,-cam.camCZ/l,0] \n\t\t\t\t}\n\t\t\t\tthis.cam.campos = [cam.camCX,cam.camCY,cam.camCZ]\n\n\t\t\t\tthis.camVP[0].makeIdentity()\n\t\t\t\tthis.camVP[1].makeIdentity()\n\t\t\t\tthis.camP[0].makeIdentity()\n\t\t\t\tthis.camP[1].makeIdentity()\n\t\t\t\tthis.camV[0].makeIdentity()\n\t\t\t\tthis.camV[1].makeIdentity()\n\t\t\t\t\t\n\t\t\t\tif(sf) {\t\t// for stereo\n\t\t\t\t\tconst dx = -cam.sbase * scale ;\t// stereo base\n\t\t\t\t\tex[0] =  upy * (cam.camCZ-cz) - upz * (cam.camCY-cy);\n\t\t\t\t\tey[0] = -upx * (cam.camCZ-cz) + upz * (cam.camCX-cx);\n\t\t\t\t\tez[0] =  upx * (cam.camCY-cy) - upy * (cam.camCX-cx);\n\t\t\t\t\tconst mag = Math.hypot(ex[0],ey[0],ez[0]);\n\t\t\t\t\tex[0] *= dx/mag ; ey[0] *=dx/mag ; ez[0] *= dx/mag ;\n\t\t\t\t\tex[1] = -ex[0] ; ey[1] = -ey[0] ; ez[1] = -ez[0] ;\n\t\t\t//\t\t\tconsole.log(dx+\":\"+xx+\"/\"+xy+\"/\"+xz)\n\t\t\t\t\tthis.camV[0].lookat(ex[0]+cam.camCX, ey[0]+cam.camCY, ez[0]+cam.camCZ, cx+ex[0], cy+ey[0], cz+ez[0], upx,upy,upz) ;\n\t\t\t\t\tthis.camV[1].lookat(ex[1]+cam.camCX, ey[1]+cam.camCY, ez[1]+cam.camCZ, cx+ex[1], cy+ey[1], cz+ez[1], upx,upy,upz) ;\n\n\t\t\t\t\tif(cam.camAngle!=0) this.camP[0].perspective(cam.camAngle,aspect, cam.camNear, cam.camFar)\n\t\t\t\t\telse this.camP[0].pallarel(cam.camd,aspect, cam.camNear, cam.camFar) ;\n\t\t\t\t\tthis.camP[1] = this.camP[0]\n\t\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.camP[0])\n\t\t\t\t\tthis.camVP[1].load(this.camV[1]).multRight(this.camP[1])\n\t\t\t\t} else {\n\t\t\t\t\tthis.camV[0].lookat(cam.camCX, cam.camCY, cam.camCZ, cx, cy, cz, upx,upy,upz) ;\n\t\t\t\t\tif(cam.camAngle!=0) this.camP[0].perspective(cam.camAngle,aspect, cam.camNear, cam.camFar)\n\t\t\t\t\telse this.camP[0].pallarel(cam.camd,aspect, cam.camNear, cam.camFar) ;\n\t\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.camP[0])\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(this.poxp.isVR) {\n\t\t\t\t\n\t\t\t\tPOXPDevice.setDepth({camNear:cam.camNear,camFar:cam.camFar})\n\n\t\t\t\tvrFrame = POXPDevice.getFrameData()\n\t\t//\t\tconsole.log(vrFrame)\n\t\t\t\tif(!vrFrame) return \n\t\t\t\tthis.cam.orientation = vrFrame.pose.orientation\n\t\t\t\tthis.cam.position = vrFrame.pose.position\n\t\t\t\tif(!this.cam.position) this.cam.position = [0,0,0]\n\t\t\t\tthis.vrv[1].load(vrFrame.rightViewMatrix)\n\t\t\t\tthis.vrv[0].load(vrFrame.leftViewMatrix)\n\t\t\t\tthis.vrp[1].load(vrFrame.rightProjectionMatrix)\n\t\t\t\tthis.vrp[0].load(vrFrame.leftProjectionMatrix)\n\t\t \n\t\t\t\tthis.tempM.makeIdentity()\n\t\t\t\t\t.translate(-cam.camCX,-cam.camCY,-cam.camCZ)\n\t\t\t\t\t.rotate(cam.camRX,1,0,0)\n\t\t\t\t\t.rotate(cam.camRY,0,1,0)\n\t\t\t\t\t.rotate(cam.camRZ,0,0,1)\n\n\t\t\t\tthis.camV[0].load(this.vrv[0])\n\t\t\t\tif(this.leftCorrMtx) this.camV[0].multRight(this.leftCorrMtx)\n\t\t\t\tthis.camV[0].multLeft( this.tempM )\n\t\t\t\tthis.camVP[0].load(this.camV[0]).multRight(this.vrp[0]) \n\t\t\t\tthis.camP[0].load(this.vrp[0])\n\t\t\t\t\n\t\t\t\tthis.camV[1].load(this.vrv[1])\n\t\t\t\tif(this.rightCorrMtx) this.camV[1].multRight(this.rightCorrMtx)\n\t\t\t\tthis.camV[1].multLeft( this.tempM )\n\t\t\t\tthis.camVP[1].load(this.camV[1]).multRight(this.vrp[1]) \n\t\t\t\tthis.camP[1].load(this.vrp[1])\n\t\t\t\t\n\t\t\t\tlet cx =0,cy =0,cz=1\n\t\t\t\tif(this.cam.orientation ) {\n\t\t\t\t\tlet x = this.cam.orientation[0] ;\n\t\t\t\t\tlet y = this.cam.orientation[1] ;\n\t\t\t\t\tlet z = this.cam.orientation[2] ;\n\t\t\t\t\tlet w = this.cam.orientation[3] ;\n\t\t\t\t\tcx = 2*(-x*z-y*w) \n\t\t\t\t\tcy = 2*(-y*z+x*w)\n\t\t\t\t\tcz = (x*x+y*y-z*z-w*w)\n\t\t\t\t\tlet l = Math.hypot(cx,cy,cz)\n\t\t\t\t\tcx /= l ,cy /=l, cz /= l \n\t\t\t\t}\n\t\t\t\tthis.tempM.invert() \n\t\t//\t\tlet cmat = new Mat4().rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0)\n\t\t//\t\tcmat.translate(cam.camCX,cam.camCY,cam.camCZ)\n\t\t\t\tlet cmat = this.tempM \n\t\t\t\tthis.cam.headVec = cmat.multVec4(cx,cy,cz,0)\n\t\t\t\tthis.cam.campos = cmat.multVec4(this.cam.position[0],this.cam.position[1],this.cam.position[2],1).slice(0,3)\n\n\t\t\t\tlet ivr = new Mat4().load(this.camV[1]).invert() ;\n\t\t\t\tlet ivl = new Mat4().load(this.camV[0]).invert() ;\n\t\t\t\tex[0] = ivl.buf[12] -cam.camCX\n\t\t\t\tey[0] = ivl.buf[13] -cam.camCY\n\t\t\t\tez[0] = ivl.buf[14] -cam.camCZ \n\t\t\t\tex[1] = ivr.buf[12] -cam.camCX\n\t\t\t\tey[1] = ivr.buf[13] -cam.camCY\n\t\t\t\tez[1] = ivr.buf[14] -cam.camCZ\n\t\t\t}\n\t\t//\tconsole.log(camVP)\n\t\t\treturn [{camX:cam.camCX+ex[0],camY:cam.camCY+ey[0],camZ:cam.camCZ+ez[0], \n\t\t\t\tcamV:this.camV[0],camVP:this.camVP[0],camP:this.camP[0], vrFrame:vrFrame},\n\t\t\t{camX:cam.camCX+ex[1],camY:cam.camCY+ey[1],camZ:cam.camCZ+ez[1],\n\t\t\t\tcamV:this.camV[1],camVP:this.camVP[1],camP:this.camP[1],vrFrame:vrFrame}] ;\n\t\t}\n\t} // class Camera\n\n\n\treturn pox.Camera = Camera;\n});"]}