/**
 * skylark-poxp - A version of poxp that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-poxp/
 * @license MIT
 */
define(["./poxp","./CanvasMatrix4","./GPad","./Pointer","./PoxCamera","./POXPDevice","./PoxProfile","./WBind","./WWG"],function(e,t,i,s,n,a,r,o,l){"use strict";var c=e.$;const d=t;Math.PI;class h{constructor(e,t){if(this.version="3.0.0",!Promise)throw"This browser is not supported!!";t||(t={}),this.can=e instanceof HTMLElement?e:document.querySelector(e);const s=new l,n={preserveDrawingBuffer:t.capture,antialias:!0,xrCompatible:!0};if(!(!t.noWebGL2&&s.init2(this.can,n)||s.init(this.can,n)))throw"wgl not supported!";if(t.needWebGL2&&2!=s.version)throw"needs wgl2";this.wwg=s;const r=o.create();this.param=r,r.bindInput("isStereo",t.ui&&t.ui.isStereo?t.ui.isStereo:"#isstereo"),r.bindInput("autorot",t.ui&&t.ui.autorot?t.ui.autorot:"#autorot"),r.bindInput("pause",t.ui&&t.ui.pause?t.ui.pause:"#pause"),r.bindHtml("fps",t.ui&&t.ui.fps?t.ui.fps:"#fps"),r.bindInput("camselect",t.ui&&t.ui.camselect?t.ui.camselect:"#camselect"),this.pixRatio=1,this.pox={can:this.can,wwg:this.wwg,synth:this.synth,poxp:this},this.setpox(this.pox),this.eventListener={},this.clearEvent(),i&&(this.pox.gPad=new i,this.pox.gPad.name="1",this.pox.gPad2=new i,this.pox.gPad2.name="2",this.pox.gPad.init(0,(e,t)=>{t&&this.pox.log("set 1"+e.gp.hand)})||this.pox.gPad2.init(1,(e,t)=>{t&&this.pox.log("set 2"+e.gp.hand)})||(this.pox.gPad.ev=(e=>{this.callEvent("gpad",e)})),this.pox.gPad2.ev=((e,t,i)=>{this.callEvent("gpad",e)})),this.resize(),window.addEventListener("resize",()=>{this.resize()}),this.pause=!0,this.setMouseEvent(),a.checkVR(this).then(e=>{e&&console.log("WebXR supported"),this.vrReady=e}),this.scenes=[],this.cam0=this.createCamera(),this.cam1=this.createCamera(),this.ccam=this.cam1}addEvent(e,t){let i=null;switch(e){case"frame":i={cb:t,active:!0},this.eventListener.frame.push(i);break;case"gpad":i={cb:t,active:!0},this.eventListener.gpad.push(i);break;case"vrchange":i={cb:t,active:!0},this.eventListener.vrchange.push(i);break;case"param":i={cb:t,active:!0},this.eventListener.param.push(i)}return i}removeEvent(e){this.eventListener.frame=this.eventListener.frame.filter(t=>t!==e),this.eventListener.gpad=this.eventListener.gpad.filter(t=>t!==e),this.eventListener.vrchange=this.eventListener.vrchange.filter(t=>t!==e),this.eventListener.param=this.eventListener.param.filter(t=>t!==e)}clearEvent(){this.eventListener.frame=[],this.eventListener.gpad=[],this.eventListener.vrchange=[],this.eventListener.param=[]}async load(e){return new Promise((t,i)=>{if("string"==typeof e){const s=new XMLHttpRequest;s.open("get",e,!0),s.responseType="json",s.onload=(()=>{200==s.status?t(s.response):i("Ajax error:"+s.statusText)}),s.onerror=(()=>{i("Ajax error:"+s.statusText)}),s.send()}else t(e)})}loadImage(e){return e.match(/^https?:/)?this.wwg.loadImageAjax(e):new Promise((t,i)=>{const s=new Image;s.onload=(()=>{t(s)}),s.onerror=(()=>{i("cannot load image")}),s.src=e})}setpox(e){e.log=(e=>{this.errCb&&this.errCb(e)}),e.loadImage=this.loadImage,e.loadAjax=this.wwg.loadAjax,e.addEvent=((e,t)=>this.addEvent(e,t)),e.exitVR=this.exitVR;try{e.profile=new r(this)}catch(t){e.profile=null}e.setScene=(async e=>new Promise((t,i)=>{this.setScene(e).then(()=>{t()}).catch(e=>{console.log("render err"+e.stack)})})),e.getModule=(e=>this.m1),e.getWorker=(e=>this.w1),e.loadModule=(e=>this.loadModule(e)),e.initModule=(e=>this.initModule(e)),e.addModel=(e=>{if(this.render)return this.render.addModel(e)}),e.removeModel=(e=>{if(this.render)return this.render.removeModel(e)}),e.getModelData=(e=>{if(this.render)return this.render.getModelData(e)}),e.setModelData=((e,t)=>{const i=this.render.getModelData(e);if(t.matrix&&(i.mm=t.matrix),t.fs_uni)for(let e in t.fs_uni)i.fs_uni[e]=t.fs_uni[e];if(t.vs_uni)for(let e in t.vs_uni)i.vs_uni[e]=t.vs_uni[e];for(let e of["hide","parent","blend","cull"])void 0!==t[e]&&(i[e]=t[e]);t.geo&&this.render.updateModel(e,"vbo",t.geo.vtx,t.geo.subdata),t.inst&&this.render.updateModel(e,"inst",t.inst.data,t.inst.subdata)}),e.setSceneData=(e=>{if(e.fs_uni)for(let t in e.fs_uni)this.render.data.fs_uni[t]=e.fs_uni[t];if(e.vs_uni)for(let t in e.vs_uni)this.render.data.vs_uni[t]=e.vs_uni[t];if(e.env)for(let t in e.env)this.render.data.env[t]=e.env[t]}),e.addTex=(e=>this.render.addTex(e)),e.updateTex=((e,t)=>this.render.updateTex(e,t)),e.removeTex=(e=>this.render.removeTex(e)),e.loading=(e=>{c("loading")&&(c("loading").style.display=e?"block":"none")})}async loadScene(e){}async setsrc(e,t){this.pox.src=e,this.pox.setting=t,this.loadModuleSrc(e.js).then(e=>{this.initModule(e)})}loadModuleSrc(e,t){return this.loadModule("data:text/javascript;base64,"+btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})),t)}async loadModule(e,t){return new Promise((t,i)=>{import(e).then(module=>{t(module)}).catch(e=>{this.pox.log("module "+e.stack),i(["module",e.stack])})})}initModule(module){return new Promise(async(e,t)=>{if(module.init)try{await module.init(this.pox)}catch(e){this.pox.log("init "+e.stack),t(["init",e.stack])}module.frame&&this.addEvent("frame",module.frame),e(module)})}stop(){window.cancelAnimationFrame(this.loop),this.pox.unload&&this.pox.unload()}cls(){this.render&&this.render.clear()}setError(e){this.errCb=e}callEvent(e,t,i){"object"==typeof t&&(t.rtime=this.rtime);let s=!0;if(this.pox.event)try{s=this.pox.event(e,t,i)}catch(e){this.errCb(e.stack)}if("vrchange"==e){this.cam1.vrchange(t);for(let e=0;e<this.eventListener.vrchange.length;e++){const i=this.eventListener.vrchange[e];i.active&&i.cb({vrmode:t})}}if("gpad"==e){-1==t.dbtn[5]&&a.closeVR();for(let e=0;e<this.eventListener.gpad.length;e++){const i=this.eventListener.gpad[e];if(i.active){let e={gpad:t};"left"==t.hand&&(e.leftPad=t),"right"==t.hand&&(e.rightPad=t),this.pox.setting.primaryPad==t.hand?e.primaryPad=t:e.secondaryPad=t,i.cb(e)}}}if("param"==e)for(let e=0;e<this.eventListener.param.length;e++){const i=this.eventListener.param[e];i.active&&i.cb(t)}return s}setParam(e,t){if(void 0===e)return;this.uparam=o.create();const i=[];for(let t in e){const s=e[t],n=s.name?s.name:t;let a="";s.type||(s.type="range"),s.step||(s.step=100),s.size&&(a="size="+s.size);let r=`<div class=b><div class=t>${n}</div> <input type=${s.type} id="_p_${t}" ${a} min=0 max=${s.step} style="${"disp"==s.type?"display:none":""}"  /><div class=v id=${"_p_d_"+t}></div></div>`;i.push(r)}function s(e){let t=(255*e).toString(16);return 1==t.length&&(t="0"+t),t}function n(t,i){void 0!==i&&"file"!=e[t].type&&"text"!=e[t].type&&"button"!=e[t].type&&("color"==e[t].type&&i?document.getElementById("_p_d_"+t).innerHTML=i.map(e=>e.toString().substr(0,5)):"range"==e[t].type?e[t].enum?document.getElementById("_p_d_"+t).innerHTML=e[t].enum[Math.floor(i)]:document.getElementById("_p_d_"+t).innerHTML=i.toString().substr(0,5):document.getElementById("_p_d_"+t).innerHTML=i)}t.innerHTML=i.join("");for(let t in e){let i=e[t];this.uparam.bindInput(t,"#_p_"+t),this.uparam.setFunc(t,{set:e=>{let a=e;return"color"==i.type?a="#"+s(e[0])+s(e[1])+s(e[2]):"range"==i.type&&(a="log10"==i.scale?Math.log10(e/i.min)/Math.log10(i.max/i.min)*i.step:(e-i.min)*i.step/(i.max-i.min)),n(t,a),a},get:e=>{let t=e;return"color"==i.type?t="string"==typeof e&&e.match(/#[0-9A-F]+/i)?[parseInt(e.substr(1,2),16)/255,parseInt(e.substr(3,2),16)/255,parseInt(e.substr(5,2),16)/255]:e:"range"==i.type&&(t="log10"==i.scale?Math.pow(10,Math.log10(i.min)+Math.log10(i.max/i.min)*e/i.step):e*(i.max-i.min)/i.step+i.min),t},input:e=>{n(t,this.uparam[t]),this.callEvent("param",{key:t,value:e})}}),this.uparam[t]=i.value}this.pox.param=this.uparam}setScene(e){const i=this.wwg,s=this.pox,n=this.can,r=(this.pixRatio,this.param),o=s.setting||{};o.scale||(o.scale=1),o.primaryPad||(o.primaryPad="right"),e.cam&&(s.setting.cam=e.cam),e.param&&(s.param=e.param),e.vshader={text:s.src.vs},e.fshader={text:s.src.fs},s.scene=e;const l=i.createRender();this.render=l,s.render=l;let c=this.ccam;this.isVR=!1;const h=this,u=new t,p=[],m=[],v=[],g=[],f=[];return new Promise((i,d)=>{l.setRender(e).then(()=>{this.errCb&&this.errCb("scene set ok"),this.renderStart&&this.renderStart(),s.setting&&s.setting.pixRatio?this.pixRatio=s.setting.pixRatio:this.pixRatio=1,this.resize(),s.setting.cam&&(this.cam0.setCam(s.setting.cam),this.cam0.setCam({camMode:"bird"}),this.cam1.setCam(s.setting.cam)),this.keyElelment.value="",this.clearEvent(),i();let e=(new Date).getTime();this.ctime=e,this.ltime=e;let d=0,y=0,w=e,b=0;const _=(i,E)=>{a.animationFrame(this,_,E);const P=(new Date).getTime();if(this.ctime=P,r.pause)return r.fps=0,d=y,void(e=P);y=d+P-e,b++,P-w>=500&&(r.fps=Math.floor(1e3*b/(P-w)+.5),b=0,w=P),this.ccam=r.camselect&&!this.isVR?this.cam0:this.cam1,c=this.ccam,s.cam=c.cam,r.autorot&&c.setCam({camRY:y/100%360});let M=null,L=null,R=null,k=null;const A=a.getInput();if(s.gPad){let e=s.gPad.get(),t=s.gPad2.get();this.isVR?(e.emu||"right"!=e.hand||(M=e),e.emu||"left"!=e.hand||(L=e),t.emu||"right"!=t.hand||(M=t),t.emu||"left"!=t.hand||(L=t)):("right"==e.hand&&(M=e),"right"==t.hand&&(M=t),"left"==e.hand&&(L=e),"left"==t.hand&&(L=t))}"left"==o.primaryPad?(R=L,k=M):(R=M,k=L),R&&R.conn||(R=k,k=null),c.cam.gPad&&c.setPad(R,k),c.update();let F=c.getMtx(o.scale,r.isStereo||h.isVR?1:0);for(let e=0;e<this.eventListener.frame.length;e++){const t=this.eventListener.frame[e];if(t.active)try{t.cb({render:l,pox:s,ccam:c,cam:c.cam,rtime:y/1e3,xrinput:A,rightPad:M,leftPad:L,primaryPad:R,secondaryPad:k})}catch(e){this.pox.log(e.stack),r.pause=!0}}let V={};s.update&&(V=s.update(l,c.cam,y,-1)),r.updateTimer(),function(e,i,s,o,l){e.data.model.sort((e,t)=>{if(null===e)return-1;if(null===t)return 1;let i=e.layer,s=t.layer;return void 0===i&&(i=0),void 0===s&&(s=0),i-s});let c=function(e,i){const s=[[],[]],a=e.data.model;for(let n=0;n<a.length;n++){let r=a[n];if(!r)continue;if(u.load(r.bm),r.mm&&u.multRight(r.mm),void 0!==r.parent&&u.multRight(x(e,r.parent)),e.data.group){let t=e.data.group;for(let i=0;i<t.length;i++){let s=t[i];if(s.bm)for(let t=0;t<s.model.length;t++)e.getModelIdx(s.model[t])==n&&u.multRight(s.bm)}}p[n]||(p[n]=new t),g[n]||(g[n]=new t),f[n]||(f[n]=new t),m[n]||(m[n]=[new t,new t]),v[n]||(v[n]=[new t,new t]),r.modelMtx=p[n];const o={vs_uni:{modelMatrix:p[n].load(u).getAsWebGLFloatArray(),vpMatrix:v[n][0].load(r.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][0].load(u).multRight(r.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),invMatrix:g[n].load(u).invert().transpose().getAsWebGLFloatArray(),minvMatrix:f[n].load(u).invert().getAsWebGLFloatArray()}},l={vs_uni:{modelMatrix:p[n].load(u).getAsWebGLFloatArray(),vpMatrix:v[n][1].load(r.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][1].load(u).multRight(r.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),invMatrix:g[n].load(u).invert().transpose().getAsWebGLFloatArray(),minvMatrix:f[n].load(u).invert().getAsWebGLFloatArray()}};o.fs_uni=o.vs_uni,l.fs_uni=l.vs_uni,o.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,o.fs_uni.vpMatrix_r=l.fs_uni.vpMatrix,l.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,l.fs_uni.vpMatrix_r=l.fs_uni.vpMatrix,s[0][n]=o,s[1][n]=l,r.modelMtx=p[n]}let r=[{model:s[0],fs_uni:{},vs_uni:{}},{model:s[1],fs_uni:{},vs_uni:{}}];return r[0].fs_uni.stereo=1,r[0].fs_uni.resolution=[n.width,n.height],r[0].fs_uni.camMatirx=i[0].camV.getAsWebGLFloatArray(),r[0].fs_uni.eyevec=[i[0].camX,i[0].camY,i[0].camZ],r[0].vs_uni.stereo=1,r[0].vs_uni.camMatirx=r[0].fs_uni.camMatirx,r[0].vs_uni.eyevec=r[0].fs_uni.eyevec,r[1].fs_uni.stereo=2,r[1].fs_uni.resolution=r[0].fs_uni.resolution,r[1].fs_uni.camMatirx=i[1].camV.getAsWebGLFloatArray(),r[1].fs_uni.eyevec=[i[1].camX,i[1].camY,i[1].camZ],r[1].vs_uni.stereo=2,r[1].vs_uni.camMatirx=r[1].fs_uni.camMatirx,r[1].vs_uni.eyevec=r[1].fs_uni.eyevec,r}(e,s);if(r.isStereo||h.isVR){let t=a.getViewport(n);e.viewport=t,a.isPresenting&&e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,a.webGLLayer.framebuffer),void 0===l.vs_uni&&(l.vs_uni={}),void 0===l.fs_uni&&(l.fs_uni={}),l.fs_uni.rtime=o/1e3,l.fs_uni.time=l.fs_uni.rtime,l.vs_uni.rtime=o/1e3,l.vs_uni.time=l.vs_uni.rtime,e.gl.viewport(t.leftViewport.x,t.leftViewport.y,t.leftViewport.width,t.leftViewport.height),e.draw([l,c[0]],!1),e.gl.viewport(t.rightViewport.x,t.rightViewport.y,t.rightViewport.width,t.rightViewport.height),e.draw([l,c[1]],!0),a.isPresenting&&e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)}else void 0===l.vs_uni&&(l.vs_uni={}),void 0===l.fs_uni&&(l.fs_uni={}),c[0].vs_uni.stereo=0,l.fs_uni.rtime=o/1e3,l.fs_uni.time=l.fs_uni.rtime,l.vs_uni.rtime=o/1e3,l.vs_uni.time=l.vs_uni.rtime,e.gl.viewport(0,0,n.width,n.height),e.draw([l,c[0]],!1)}(l,0,F,y,V),a.submitFrame(this),this.ltime=P,this.rtime=y};_()}).catch(e=>{console.log(e),this.errCb&&this.errCb(e.stack?e.stack:e),d(e)})});function x(e,t){let i=e.getModelData(t);if(!i)return new d;let s=new d(i.bm);return s||(s=new d),i.mm&&s.multRight(i.mm),void 0!==i.parent&&s.multRight(x(e,i.parent)),s}}enterVR(){let e=!0;if(a.VRReady)console.log("enter VR"),a.presentVR(this);else if(document.body.webkitRequestFullscreen){console.log("fullscreen");const e=this.can.parentNode;this.ssize={width:e.offsetWidth,height:e.offsetHeight},document.addEventListener("webkitfullscreenchange",t=>{document.webkitFullscreenElement?(e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px"):(e.style.width=this.ssize.width+"px",e.style.height=this.ssize.height+"px")}),e.webkitRequestFullscreen()}else e=!1;return e}exitVR(){a.VRReady&&a.closeVR(this)}setMouseEvent(){const e=document.createElement("input");e.setAttribute("type","checkbox"),e.style.position="absolute",e.style.zIndex=-100,e.style.top=0,e.style.left="-20px",e.style.width="10px",e.style.height="10px",e.style.padding=0,e.style.border="none",e.style.opacity=0,this.can.parentNode.appendChild(e),this.keyElelment=e,this.keyElelment.focus();let t=!1;const i=this.param,n=this.can;new s(n,{down:e=>{if(!this.ccam||i.pause)return!0;let s=!0;return(s=this.callEvent("down",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,sx:e.sx*this.pixRatio,sy:e.sy*this.pixRatio}))&&this.ccam.event("down",e),t=!0,"walk"==this.ccam.cam.camMode&&this.keyElelment.focus(),!1},move:e=>{if(!this.ccam||i.pause)return!0;let t=!0;return(t=this.callEvent("move",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,ox:e.ox*this.pixRatio,oy:e.oy*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio}))&&this.ccam.event("move",e),!1},up:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("up",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio,ex:e.ex*this.pixRatio,ey:e.ey*this.pixRatio}))&&this.ccam.event("up",e),!1},out:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("out",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio}))&&this.ccam.event("out",e),!1},wheel:e=>{if(!this.ccam||i.pause)return!0;let t=!0;return(t=this.callEvent("wheel",e))&&this.ccam.event("wheel",e),!1},gesture:(e,t)=>{if(!this.ccam||i.pause)return!0;let s=!0;return(s=this.callEvent("gesture",{z:e,r:t}))&&this.ccam.event("gesture",{z:e,r:t}),!1},gyro:e=>{if(!this.ccam||i.pause||a.VRReady)return!0;if(t)return!0;let s=!0;return(s=this.callEvent("gyro",e))&&this.ccam.event("gyro",e),!1}});o.addev(this.keyElelment,"keydown",e=>!!i.pause||(!(!this.pox.event||this.callEvent("keydown",e))||(this.ccam&&this.ccam.event("keydown",e),!1))),o.addev(this.keyElelment,"keyup",e=>!!i.pause||(!(!this.pox.event||this.callEvent("keyup",e))||(this.ccam&&this.ccam.event("keyup",e),!1))),document.querySelectorAll("#bc button").forEach(e=>{e.addEventListener("mousedown",e=>{this.callEvent("btndown",e.target.id),this.ccam.event("keydown",{key:e.target.getAttribute("data-key")}),e.preventDefault()}),e.addEventListener("touchstart",e=>{this.callEvent("touchstart",e.target.id),this.ccam.event("keydown",{key:e.target.getAttribute("data-key")}),e.preventDefault()}),e.addEventListener("mouseup",e=>{this.callEvent("btnup",e.target.id),this.ccam.event("keyup",{key:e.target.getAttribute("data-key")}),this.keyElelment.focus(),e.preventDefault()}),e.addEventListener("touchend",e=>{let t=!0;(t=this.callEvent("touchend",e.target.id))&&this.ccam.event("keyup",{key:e.target.getAttribute("data-key")}),e.preventDefault()})})}resize(){this.can.offsetWidth<300||a.isPresenting||(this.can.width=this.can.offsetWidth*this.pixRatio*window.devicePixelRatio,this.can.height=this.can.offsetHeight*this.pixRatio*window.devicePixelRatio)}}return h.prototype.createCamera=function(e){return new this.Camera(this,e)},h.prototype.Camera=n,e.init=function(t=null){let i;try{i=new h(t||"#screen1",{capture:!0,noWebGL2:!1})}catch(e){return console.log(e),void alert(e)}console.log(i),e.player=i,i.setError(e.msg),c("vrbtn").addEventListener("click",e=>{window.DeviceOrientationEvent&&DeviceOrientationEvent.requestPermission&&"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission(),window.addEventListener("deviceorientation",function(e){var t=window.orientation,s=90==t||-90==t;i.param.isStereo=s,c("cc").style.opacity=s?0:.4,c("footer").style.display=s?"none":"block",c("vrbtn").style.display=s?"none":"block",c("padl").style.opacity=s?0:.4,c("padr").style.opacity=s?0:.4,window.scrollTo(0,1e3)}),i.enterVR()}),c("screen1").addEventListener("mousedown",e=>{i.keyElelment.focus()});let s={},n={};function a(e,t){e.buttons=[{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1}],e.axes=[0,0],e.hand=t?"left":"right"}function r(e,t,i){const s=i.target.getAttribute("data-key");if(2==s){const t=i.target.getAttribute("data-dir");e.axes[2]=0,e.axes[3]=0,e.axes[2&t?1:0]=1&t?.8:-.8,e.axes[2&t?3:2]=1&t?.8:-.8}e.buttons[s].touched=!0,t&&t.set(e),i.preventDefault()}function o(e,t,i){const s=i.target.getAttribute("data-key");if(2==s){const t=i.target.getAttribute("data-dir");e.axes[2]=0,e.axes[3]=0,e.axes[2&t?1:0]=1&t?.8:-.8,e.axes[2&t?3:2]=1&t?.8:-.8}e.buttons[s].touched=!0,e.buttons[s].pressed=!0,t&&t.set(e),i.preventDefault()}function l(e,t,i){const s=i.target.getAttribute("data-key");e.buttons[s].pressed=!0,t&&t.set(e),i.preventDefault()}function d(e,t,i){const s=i.target.getAttribute("data-key");e.buttons[s].pressed=!1,t&&t.set(e),i.preventDefault()}function u(e,t,i,s){const n=s.target.getAttribute("data-key");e.buttons[n].touched=!1,e.buttons[n].pressed=!1,a(e,i),t&&t.set(e),s.preventDefault()}function p(e,t,i,s){a(e,i),t&&t.set(e),s.preventDefault()}a(s,!0),i.pox.gPad.set(s),a(n,!1),i.pox.gPad2.set(n),document.querySelectorAll("#padl button").forEach(e=>{e.addEventListener("mouseover",e=>{r(s,i.pox.leftPad,e)}),e.addEventListener("touchstart",e=>{o(s,i.pox.leftPad,e)}),e.addEventListener("mousedown",e=>{l(s,i.pox.leftPad,e)}),e.addEventListener("mouseup",e=>{d(s,i.pox.leftPad,e)}),e.addEventListener("touchend",e=>{u(s,i.pox.leftPad,!0,e)}),e.addEventListener("mouseout",e=>{p(s,i.pox.leftPad,!0,e)}),e.addEventListener("touchcancel",e=>{p(s,i.pox.leftPad,!0,e)})}),document.querySelectorAll("#padr button").forEach(e=>{e.addEventListener("mouseover",e=>{r(n,i.pox.rightPad,e)}),e.addEventListener("touchstart",e=>{o(n,i.pox.rightPad,e)}),e.addEventListener("mousedown",e=>{l(n,i.pox.rightPad,e)}),e.addEventListener("mouseup",e=>{d(n,i.pox.rightPad,e)}),e.addEventListener("touchend",e=>{u(n,i.pox.rightPad,!1,e)}),e.addEventListener("mouseout",e=>{p(n,i.pox.rightPad,!1,e)}),e.addEventListener("touchcancel",e=>{p(n,i.pox.rightPad,!1,e)})})},e.load=function(e,t=null){const i=this.player;return new Promise(async(s,n)=>{if(null==t&&(t=location.search.substr(1).split("&")),t[0].match(/.+\.json/))i.load(t[0]+"?"+Math.random()).then(e=>{t.shift(),s({src:e,query:t})});else if("string"==typeof e)i.load(e+"?"+Math.random()).then(e=>{s({src:e,query:t})});else if(null!==e)s({src:e,query:t});else{var a,r=localStorage.getItem("poxe_save");r&&(a=JSON.parse(r)),i.load(a).then(e=>{s({src:e,query:t})}).catch(e=>{n("cannot load source")})}})},e.set=function(t,i){return new Promise(async(i,s)=>{if(t.modules)try{const i=await e.player.loadModuleSrc(t.modules[0]);for(k in e.player.m1=i,i)console.log(k)}catch(e){}if(t.workers)try{const i=new Blob([t.workers[0]]);e.player.w1=new Worker(window.URL.createObjectURL(i))}catch(e){}e.setting=t.settings,""==document.title&&(document.title=`PoExE:${e.setting.name}`),t.settings.copyright&&(c("footer").innerHTML=e.setting.copyright),t.settings.gui&&e.player.setParam(t.settings.gui,c("pui")),e.player.setsrc(t.renders[0],t.settings).then(t=>{e.msg("init ok")}).catch(t=>{console.log(t),console.log("catch"),e.msg(e.player.emsg),s()})})},e.PoxPlayer=h});
//# sourceMappingURL=sourcemaps/PoxPlayer.js.map
