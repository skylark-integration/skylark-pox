/**
 * skylark-poxp - A version of poxp that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-poxp/
 * @license MIT
 */
define(["./poxp"],function(t){class i{constructor(t){this.canvas=t,this.data=null,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.bx=0,this.by=0,this.default={font:"20px sans-serif",borderColor:"black",textColor:"black"},this.class={},this.km=/[。、\.\-,)\]｝、〕〉》」』】〙〗〟’”｠»ゝゞーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇷ゚ㇺㇻㇼㇽㇾㇿ々〻‐゠–〜～?!‼⁇⁈⁉・:;\/]/,this.tm=/[(\[｛〔〈《「『【〘〖〝‘“｟«]/,this.am=/[a-zA-Z—―]/}clear(t){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),t&&(this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}_ax(t){return t+this.bx}_ay(t){return t+this.by}_aw(t){return t}_ah(t){return t}async draw(t){this.data=t,this.ctx.font=this.default.font;for(let s=0;s<t.length;s++){const e=t[s];if(e.classdef){this.class[e.classdef]=e.style;continue}let h={lineWidth:1,boder:this.default.borderColor};if(e.class)for(let t in this.class[e.class])h[t]=this.class[e.class][t];if(e.style)for(let t in e.style)h[t]=e.style[t];let a=0,r=0,c=10,l=10;switch(e.rect&&(h.rect=e.rect),void 0!=e.x&&(h.x=e.x),void 0!=e.y&&(h.y=e.y),void 0!=e.width&&(h.width=e.width),void 0!=e.height&&(h.height=e.height),h.rect&&(a=h.rect[0],r=h.rect[1],c=h.rect[2],l=h.rect[3]),void 0!=h.x&&(a=h.x),void 0!=h.y&&(r=h.y),void 0!=h.width&&(c=h.width),void 0!=h.height&&(l=h.height),this.ctx.save(),e.shape){case"box":h.lineWidth&&(this.ctx.lineWidth=h.lineWidth),h.background&&(this.ctx.fillStyle=h.background,this.ctx.fillRect(this._ax(a),this._ay(r),this._aw(c),this._ah(l))),h.border&&(this.ctx.strokeStyle=h.border,this.ctx.strokeRect(this._ax(a),this._ay(r),this._aw(c),this._ah(l)));break;case"roundbox":const o=h.radius?h.radius:20;this.ctx.beginPath(),this.ctx.moveTo(this._ax(a+o),this._ay(r)),this.ctx.lineTo(this._ax(a+c-o),this._ay(r)),this.ctx.arcTo(this._ax(a+c),this._ay(r),this._ax(a+c),this._ay(r+o),o),this.ctx.lineTo(this._ax(a+c),this._ay(r+l-o)),this.ctx.arcTo(this._ax(a+c),this._ay(r)+l,this._ax(a+c-o),this._ay(r+l),o),this.ctx.lineTo(this._ax(a+o),this._ay(r+l)),this.ctx.arcTo(this._ax(a),this._ay(r+l),this._ax(a),this._ay(r+l-o),o),this.ctx.lineTo(this._ax(a),this._ay(r+o)),this.ctx.arcTo(this._ax(a),this._ay(r),this._ax(a+o),this._ay(r),o),h.lineWidth&&(this.ctx.lineWidth=h.lineWidth),h.background&&(this.ctx.fillStyle=h.background,this.ctx.fill()),h.border&&(this.ctx.strokeStyle=h.border,this.ctx.stroke());break;case"line":break;case"text":h.color?this.ctx.fillStyle=h.color:this.ctx.fillStyle=this.default.textColor,h.font&&(this.ctx.font=h.font),h.align?this.ctx.textAlign=h.align:this.ctx.textAlign="left",h.width?("right"==h.align&&(a+=c),"center"==h.align&&(a+=c/2)):c=void 0,this.ctx.fillText(e.str,this._ax(a),this._ay(r),c);break;case"textbox":let n;e.str?(n=this.boxscan(e,h),t[s].lines=n):e.lines&&(n=e.lines);let x=void 0!=h.lineHeight?h.lineHeight:20;h.color?this.ctx.fillStyle=h.color:this.ctx.fillStyle=this.default.textColor,h.font&&(this.ctx.font=h.font),h.align?this.ctx.textAlign=h.align:this.ctx.textAlign="left","right"==h.align&&(a+=c),"center"==h.align&&(a+=c/2);const d=void 0!=h.offsetx?h.offsetx:0,f=void 0!=h.offsety?h.offsety:0;let u=-d,g=x-f;this.ctx.rect(this._ax(a),this._ay(r),c,l),this.ctx.clip();for(let t=0;t<n.length&&(g>0&&this.ctx.fillText(n[t],this._ax(u+a),this._ay(g+r),c),!(g>l+x));t++)g+=x;break;case"img":let y=await i.loadImageAjax(e.src);void 0!=h.width&&void 0==h.height?(c=h.width,l=h.width*y.height/y.width):void 0==h.width&&void 0!=h.height?(l=h.height,c=h.height*y.width/y.height):void 0!=h.width&&void 0!=h.height?(c=h.width,l=h.height):(c=y.width,l=y.height),this.ctx.drawImage(y,a,r,c,l)}if(e.children){const t=this.bx,i=this.by;this.bx=a,this.by=r,this.draw(e.children),this.bx=t,this.by=i}this.ctx.restore()}}getElementById(t,i){i||(i=this.data);for(let e=0;e<i.length;e++){if(i[e].id==t)return i[e];if(i[e].children){var s=this.getElementById(t,i[e].children);if(s)return s}}return null}boxscan(t,i){t.rect[0],t.rect[1];let s=t.rect[2],e=(t.rect[3],new class{constructor(t){this._str=t.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^\uD800-\uDFFF]/g)||[]}get length(){return this._str.length}get char(){return this._str}substr(t,i){return this._str.slice(t,void 0==i?void 0:t+i).join("")}}(t.str));this.ctx.save(),i.font&&(this.ctx.font=i.font);let h=0,a=[];for(let t=1;t<e.length;t++)if("\n"==e.char[t])a.push(e.substr(h,t-h)),h=++t;else if(this.ctx.measureText(e.substr(h,t-h+1)).width>s){let i=t;for(;t>i-4&&e.char[t-1].match(this.tm);)t--;for(;t<i+4&&e.char[t].match(this.km);)t++;for(;e.char[t-1].match(this.am)&&e.char[t].match(this.am);)if(--t==h){t=i;break}a.push(e.substr(h,t-h)),h=t}return h<e.length&&a.push(e.substr(h)),this.ctx.restore(),a}static async loadImageAjax(t){return new Promise((s,e)=>{i.loadAjax(t,{type:"blob"}).then(t=>{const i=new Image,e=URL.createObjectURL(t);i.onload=(()=>{URL.revokeObjectURL(e),s(i)}),i.src=e}).catch(t=>{s(null)})})}static loadAjax(t,i){return new Promise((s,e)=>{const h=new XMLHttpRequest;h.open("get",t,!0),h.responseType=i&&i.type?i.type:"text",h.onload=(()=>{200==h.status?s(h.response):e("Ajax error:"+h.statusText)}),h.onerror=(()=>{e("Ajax error:"+h.statusText)}),h.send()})}static loadFont(t,i){return new Promise((s,e)=>{if(!document.fonts)return void s(null);let h=new FontFace(t,`url(${i})`,{});h?h.load().then(t=>{document.fonts.add(t),s(t)}).catch(t=>{e(t)}):s(null)})}}return t.Json2Canvas=i});
//# sourceMappingURL=sourcemaps/Json2Canvas.js.map
