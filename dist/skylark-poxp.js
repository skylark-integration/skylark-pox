/**
 * skylark-poxp - A version of poxp that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-poxp/
 * @license MIT
 */
!function(t,e){var r=e.define,require=e.require,a="function"==typeof r&&r.amd,n=!a&&"undefined"!=typeof exports;if(!a&&!r){var o={};r=e.define=function(t,e,i){"function"==typeof i?(o[t]={factory:i,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var i=e.split("/"),s=t.split("/");i.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?i.pop():i.push(s[r]));return i.join("/")}(e,t)}),resolved:!1,exports:null},require(t)):o[t]={factory:null,resolved:!0,exports:i}},require=e.require=function(t){if(!o.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var module=o[t];if(!module.resolved){var i=[];module.deps.forEach(function(t){i.push(require(t))}),module.exports=module.factory.apply(e,i)||null,module.resolved=!0}return module.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,require){t("skylark-poxp/poxp",["skylark-langx/skylark"],function(t){const e={};function i(t){return document.getElementById(t)}return e.$=i,e.msg=(t=>{let e=new Date;if("string"==typeof t){let e=location.protocol+"//"+location.host;t=t.replace(new RegExp(e,"g"),"").replace(/data:[^:]+/,"module")}if(i("msglog")&&(i("msglog").value+=e.toTimeString().substr(0,8)+"."+("000"+e.getMilliseconds()).substr(-3)+" "+t+"\n",i("msglog").scrollTop=i("msglog").scrollHeight),!i("msgc"))return void console.log(t);const s=document.createElement("div");s.innerHTML=t,i("msgc").appendChild(s),i("msg").scrollTop=i("msgc").offsetHeight}),t.attach("intg.poxp",e)}),t("skylark-poxp/CanvasMatrix4",["./poxp"],function(t){var e=function(t){if(void 0!=t&&"Float32Array"==t.name)return this.buf=t,this;if(this.buf=new Float32Array(16),this.matrix=null,"object"==typeof t){if("length"in t&&t.length>=16)return this.load(t),this;if(t instanceof e)return this.load(t),this}return this.makeIdentity(),this};return e.RAD=Math.PI/180,e.prototype.load=function(){if(1==arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];if("length"in t&&16==t.length)return this.buf[0]=t[0],this.buf[1]=t[1],this.buf[2]=t[2],this.buf[3]=t[3],this.buf[4]=t[4],this.buf[5]=t[5],this.buf[6]=t[6],this.buf[7]=t[7],this.buf[8]=t[8],this.buf[9]=t[9],this.buf[10]=t[10],this.buf[11]=t[11],this.buf[12]=t[12],this.buf[13]=t[13],this.buf[14]=t[14],this.buf[15]=t[15],this;if(arguments[0]instanceof e)return this.buf[0]=t.buf[0],this.buf[1]=t.buf[1],this.buf[2]=t.buf[2],this.buf[3]=t.buf[3],this.buf[4]=t.buf[4],this.buf[5]=t.buf[5],this.buf[6]=t.buf[6],this.buf[7]=t.buf[7],this.buf[8]=t.buf[8],this.buf[9]=t.buf[9],this.buf[10]=t.buf[10],this.buf[11]=t.buf[11],this.buf[12]=t.buf[12],this.buf[13]=t.buf[13],this.buf[14]=t.buf[14],this.buf[15]=t.buf[15],this}return this.makeIdentity(),this},e.prototype.getAsArray=function(){return[this.buf[0],this.buf[1],this.buf[2],this.buf[3],this.buf[4],this.buf[5],this.buf[6],this.buf[7],this.buf[8],this.buf[9],this.buf[10],this.buf[11],this.buf[12],this.buf[13],this.buf[14],this.buf[15]]},e.prototype.getAsWebGLFloatArray=function(){return this.buf},e.prototype.initmatrix=function(){return this.matrix||(this.matrix=new e),this.matrix.makeIdentity(),this},e.prototype.makeIdentity=function(){return this.buf[0]=1,this.buf[1]=0,this.buf[2]=0,this.buf[3]=0,this.buf[4]=0,this.buf[5]=1,this.buf[6]=0,this.buf[7]=0,this.buf[8]=0,this.buf[9]=0,this.buf[10]=1,this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.prototype.transpose=function(){var t=this.buf[1];return this.buf[1]=this.buf[4],this.buf[4]=t,t=this.buf[2],this.buf[2]=this.buf[8],this.buf[8]=t,t=this.buf[3],this.buf[3]=this.buf[12],this.buf[12]=t,t=this.buf[6],this.buf[6]=this.buf[9],this.buf[9]=t,t=this.buf[7],this.buf[7]=this.buf[13],this.buf[13]=t,t=this.buf[11],this.buf[11]=this.buf[14],this.buf[14]=t,this},e.prototype.invert=function(){var t=this._determinant4x4();return Math.abs(t)<1e-32?null:(this._makeAdjoint(),this.buf[0]/=t,this.buf[1]/=t,this.buf[2]/=t,this.buf[3]/=t,this.buf[4]/=t,this.buf[5]/=t,this.buf[6]/=t,this.buf[7]/=t,this.buf[8]/=t,this.buf[9]/=t,this.buf[10]/=t,this.buf[11]/=t,this.buf[12]/=t,this.buf[13]/=t,this.buf[14]/=t,this.buf[15]/=t,this)},e.prototype.translate=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=0),void 0==e&&(e=0),void 0==i&&(i=0),this.buf[12]+=t,this.buf[13]+=e,this.buf[14]+=i,this},e.prototype.scale=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=1),void 0==i?void 0==e?(e=t,i=t):i=1:void 0==e&&(e=t),this.buf[0]*=t,this.buf[1]*=t,this.buf[2]*=t,this.buf[4]*=e,this.buf[5]*=e,this.buf[6]*=e,this.buf[8]*=i,this.buf[9]*=i,this.buf[10]*=i,this},e.prototype.rotate=function(t,i,s,r){if(0==t)return this;(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],r=i[2],i=i[0]),t*=e.RAD,t/=2;var a=Math.sin(t),n=Math.cos(t),o=a*a;if(this.initmatrix(),1==i&&0==s&&0==r)this.matrix.buf[5]=1-2*o,this.matrix.buf[6]=2*a*n,this.matrix.buf[9]=-2*a*n,this.matrix.buf[10]=1-2*o;else if(0==i&&1==s&&0==r)this.matrix.buf[0]=1-2*o,this.matrix.buf[2]=-2*a*n,this.matrix.buf[8]=2*a*n,this.matrix.buf[10]=1-2*o;else if(0==i&&0==s&&1==r)this.matrix.buf[0]=1-2*o,this.matrix.buf[1]=2*a*n,this.matrix.buf[4]=-2*a*n,this.matrix.buf[5]=1-2*o;else{var h=Math.hypot(i,s,r);0==h?(i=0,s=0,r=1):1!=h&&(i/=h,s/=h,r/=h);var u=i*i,c=s*s,f=r*r;this.matrix.buf[0]=1-2*(c+f)*o,this.matrix.buf[1]=2*(i*s*o+r*a*n),this.matrix.buf[2]=2*(i*r*o-s*a*n),this.matrix.buf[4]=2*(s*i*o-r*a*n),this.matrix.buf[5]=1-2*(f+u)*o,this.matrix.buf[6]=2*(s*r*o+i*a*n),this.matrix.buf[8]=2*(r*i*o+s*a*n),this.matrix.buf[9]=2*(r*s*o-i*a*n),this.matrix.buf[10]=1-2*(u+c)*o}return this.multRight(this.matrix),this},e.prototype.multRight=function(t){var e=this.buf[0]*t.buf[0]+this.buf[1]*t.buf[4]+this.buf[2]*t.buf[8]+this.buf[3]*t.buf[12],i=this.buf[0]*t.buf[1]+this.buf[1]*t.buf[5]+this.buf[2]*t.buf[9]+this.buf[3]*t.buf[13],s=this.buf[0]*t.buf[2]+this.buf[1]*t.buf[6]+this.buf[2]*t.buf[10]+this.buf[3]*t.buf[14],r=this.buf[0]*t.buf[3]+this.buf[1]*t.buf[7]+this.buf[2]*t.buf[11]+this.buf[3]*t.buf[15],a=this.buf[4]*t.buf[0]+this.buf[5]*t.buf[4]+this.buf[6]*t.buf[8]+this.buf[7]*t.buf[12],n=this.buf[4]*t.buf[1]+this.buf[5]*t.buf[5]+this.buf[6]*t.buf[9]+this.buf[7]*t.buf[13],o=this.buf[4]*t.buf[2]+this.buf[5]*t.buf[6]+this.buf[6]*t.buf[10]+this.buf[7]*t.buf[14],h=this.buf[4]*t.buf[3]+this.buf[5]*t.buf[7]+this.buf[6]*t.buf[11]+this.buf[7]*t.buf[15],u=this.buf[8]*t.buf[0]+this.buf[9]*t.buf[4]+this.buf[10]*t.buf[8]+this.buf[11]*t.buf[12],c=this.buf[8]*t.buf[1]+this.buf[9]*t.buf[5]+this.buf[10]*t.buf[9]+this.buf[11]*t.buf[13],f=this.buf[8]*t.buf[2]+this.buf[9]*t.buf[6]+this.buf[10]*t.buf[10]+this.buf[11]*t.buf[14],l=this.buf[8]*t.buf[3]+this.buf[9]*t.buf[7]+this.buf[10]*t.buf[11]+this.buf[11]*t.buf[15],d=this.buf[12]*t.buf[0]+this.buf[13]*t.buf[4]+this.buf[14]*t.buf[8]+this.buf[15]*t.buf[12],m=this.buf[12]*t.buf[1]+this.buf[13]*t.buf[5]+this.buf[14]*t.buf[9]+this.buf[15]*t.buf[13],p=this.buf[12]*t.buf[2]+this.buf[13]*t.buf[6]+this.buf[14]*t.buf[10]+this.buf[15]*t.buf[14],b=this.buf[12]*t.buf[3]+this.buf[13]*t.buf[7]+this.buf[14]*t.buf[11]+this.buf[15]*t.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=r,this.buf[4]=a,this.buf[5]=n,this.buf[6]=o,this.buf[7]=h,this.buf[8]=u,this.buf[9]=c,this.buf[10]=f,this.buf[11]=l,this.buf[12]=d,this.buf[13]=m,this.buf[14]=p,this.buf[15]=b,this},e.prototype.multLeft=function(t){var e=t.buf[0]*this.buf[0]+t.buf[1]*this.buf[4]+t.buf[2]*this.buf[8]+t.buf[3]*this.buf[12],i=t.buf[0]*this.buf[1]+t.buf[1]*this.buf[5]+t.buf[2]*this.buf[9]+t.buf[3]*this.buf[13],s=t.buf[0]*this.buf[2]+t.buf[1]*this.buf[6]+t.buf[2]*this.buf[10]+t.buf[3]*this.buf[14],r=t.buf[0]*this.buf[3]+t.buf[1]*this.buf[7]+t.buf[2]*this.buf[11]+t.buf[3]*this.buf[15],a=t.buf[4]*this.buf[0]+t.buf[5]*this.buf[4]+t.buf[6]*this.buf[8]+t.buf[7]*this.buf[12],n=t.buf[4]*this.buf[1]+t.buf[5]*this.buf[5]+t.buf[6]*this.buf[9]+t.buf[7]*this.buf[13],o=t.buf[4]*this.buf[2]+t.buf[5]*this.buf[6]+t.buf[6]*this.buf[10]+t.buf[7]*this.buf[14],h=t.buf[4]*this.buf[3]+t.buf[5]*this.buf[7]+t.buf[6]*this.buf[11]+t.buf[7]*this.buf[15],u=t.buf[8]*this.buf[0]+t.buf[9]*this.buf[4]+t.buf[10]*this.buf[8]+t.buf[11]*this.buf[12],c=t.buf[8]*this.buf[1]+t.buf[9]*this.buf[5]+t.buf[10]*this.buf[9]+t.buf[11]*this.buf[13],f=t.buf[8]*this.buf[2]+t.buf[9]*this.buf[6]+t.buf[10]*this.buf[10]+t.buf[11]*this.buf[14],l=t.buf[8]*this.buf[3]+t.buf[9]*this.buf[7]+t.buf[10]*this.buf[11]+t.buf[11]*this.buf[15],d=t.buf[12]*this.buf[0]+t.buf[13]*this.buf[4]+t.buf[14]*this.buf[8]+t.buf[15]*this.buf[12],m=t.buf[12]*this.buf[1]+t.buf[13]*this.buf[5]+t.buf[14]*this.buf[9]+t.buf[15]*this.buf[13],p=t.buf[12]*this.buf[2]+t.buf[13]*this.buf[6]+t.buf[14]*this.buf[10]+t.buf[15]*this.buf[14],b=t.buf[12]*this.buf[3]+t.buf[13]*this.buf[7]+t.buf[14]*this.buf[11]+t.buf[15]*this.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=r,this.buf[4]=a,this.buf[5]=n,this.buf[6]=o,this.buf[7]=h,this.buf[8]=u,this.buf[9]=c,this.buf[10]=f,this.buf[11]=l,this.buf[12]=d,this.buf[13]=m,this.buf[14]=p,this.buf[15]=b,this},e.prototype.ortho=function(t,e,i,s,r,a){var n=(t+e)/(e-t),o=(s+i)/(s-i),h=(a+r)/(a-r);return this.initmatrix(),this.matrix.buf[0]=2/(e-t),this.matrix.buf[5]=2/(s-i),this.matrix.buf[10]=-2/(a-r),this.matrix.buf[12]=n,this.matrix.buf[13]=o,this.matrix.buf[14]=-h,this.multRight(this.matrix),this},e.prototype.frustum=function(t,e,i,s,r,a){this.initmatrix();var n=(e+t)/(e-t),o=(s+i)/(s-i),h=-(a+r)/(a-r),u=-2*a*r/(a-r);return this.matrix.buf[0]=2*r/(e-t),this.matrix.buf[5]=2*r/(s-i),this.matrix.buf[8]=n,this.matrix.buf[9]=o,this.matrix.buf[10]=h,this.matrix.buf[11]=-1,this.matrix.buf[14]=u,this.matrix.buf[15]=0,this.multRight(this.matrix),this},e.prototype.perspective=function(t,e,i,s){var r=Math.tan(t*Math.PI/360)*i,a=-r,n=e*a,o=e*r;return this.frustum(n,o,a,r,i,s),this},e.prototype.pallarel=function(t,e,i,s){var r=t/2,a=-r,n=r/e,o=-n;return this.ortho(a,r,o,n,i,s),this},e.prototype.lookat=function(t,e,i,s,r,a,n,o,h){this.initmatrix();var u=t-s,c=e-r,f=i-a,l=Math.hypot(u,c,f);l&&(u/=l,c/=l,f/=l);var d=o*f-h*c,m=-n*f+h*u,p=n*c-o*u,b=c*p-f*m,g=-u*p+f*d,v=u*m-c*d;return(l=Math.hypot(d,m,p))&&(d/=l,m/=l,p/=l),(l=Math.hypot(b,g,v))&&(b/=l,g/=l,v/=l),this.matrix.buf[0]=d,this.matrix.buf[1]=b,this.matrix.buf[2]=u,this.matrix.buf[4]=m,this.matrix.buf[5]=g,this.matrix.buf[6]=c,this.matrix.buf[8]=p,this.matrix.buf[9]=v,this.matrix.buf[10]=f,this.matrix.buf[12]=-(d*t+m*e+p*i),this.matrix.buf[13]=-(b*t+g*e+v*i),this.matrix.buf[14]=-(u*t+c*e+f*i),this.multRight(this.matrix),this},e.prototype._determinant2x2=function(t,e,i,s){return t*s-e*i},e.prototype._determinant3x3=function(t,e,i,s,r,a,n,o,h){return t*this._determinant2x2(r,a,o,h)-s*this._determinant2x2(e,i,o,h)+n*this._determinant2x2(e,i,r,a)},e.prototype._determinant4x4=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],r=this.buf[4],a=this.buf[5],n=this.buf[6],o=this.buf[7],h=this.buf[8],u=this.buf[9],c=this.buf[10],f=this.buf[11],l=this.buf[12],d=this.buf[13],m=this.buf[14],p=this.buf[15];return t*this._determinant3x3(a,u,d,n,c,m,o,f,p)-e*this._determinant3x3(r,h,l,n,c,m,o,f,p)+i*this._determinant3x3(r,h,l,a,u,d,o,f,p)-s*this._determinant3x3(r,h,l,a,u,d,n,c,m)},e.prototype._makeAdjoint=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],r=this.buf[4],a=this.buf[5],n=this.buf[6],o=this.buf[7],h=this.buf[8],u=this.buf[9],c=this.buf[10],f=this.buf[11],l=this.buf[12],d=this.buf[13],m=this.buf[14],p=this.buf[15];this.buf[0]=this._determinant3x3(a,u,d,n,c,m,o,f,p),this.buf[4]=-this._determinant3x3(r,h,l,n,c,m,o,f,p),this.buf[8]=this._determinant3x3(r,h,l,a,u,d,o,f,p),this.buf[12]=-this._determinant3x3(r,h,l,a,u,d,n,c,m),this.buf[1]=-this._determinant3x3(e,u,d,i,c,m,s,f,p),this.buf[5]=this._determinant3x3(t,h,l,i,c,m,s,f,p),this.buf[9]=-this._determinant3x3(t,h,l,e,u,d,s,f,p),this.buf[13]=this._determinant3x3(t,h,l,e,u,d,i,c,m),this.buf[2]=this._determinant3x3(e,a,d,i,n,m,s,o,p),this.buf[6]=-this._determinant3x3(t,r,l,i,n,m,s,o,p),this.buf[10]=this._determinant3x3(t,r,l,e,a,d,s,o,p),this.buf[14]=-this._determinant3x3(t,r,l,e,a,d,i,n,m),this.buf[3]=-this._determinant3x3(e,a,u,i,n,c,s,o,f),this.buf[7]=this._determinant3x3(t,r,h,i,n,c,s,o,f),this.buf[11]=-this._determinant3x3(t,r,h,e,a,u,s,o,f),this.buf[15]=this._determinant3x3(t,r,h,e,a,u,i,n,c)},e.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},e.V3sub=function(){let t=arguments[0][0],e=arguments[0][1],i=arguments[0][2];for(let s=1;s<arguments.length;s++)t-=arguments[s][0],e-=arguments[s][1],i-=arguments[s][2];return[t,e,i]},e.V3inv=function(t){return[-t[0],-t[1],-t[2]]},e.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},e.V3norm=function(t,i){const s=e.V3len(t);return void 0===i&&(i=1),0==s?[0,0,0]:[t[0]*i/s,t[1]*i/s,t[2]*i/s]},e.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},e.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},e.V3cross=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},e.prototype.multVec4=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var r=this.buf[0]*t+this.buf[4]*e+this.buf[8]*i+this.buf[12]*s,a=this.buf[1]*t+this.buf[5]*e+this.buf[9]*i+this.buf[13]*s,n=this.buf[2]*t+this.buf[6]*e+this.buf[10]*i+this.buf[14]*s,o=this.buf[3]*t+this.buf[7]*e+this.buf[11]*i+this.buf[15]*s;return[r,a,n,o]},e.rotAndTrans=function(t,i,s,r,a,n){var o=new e;return 0!=t&&o.rotate(t,1,0,0),0!=i&&o.rotate(i,0,1,0),0!=s&&o.rotate(s,0,0,1),o.translate(r,a,n),o},e.prototype.q2m=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var r=t*t,a=e*e,n=i*i;return this.buf[0]=1-2*(a+n),this.buf[1]=2*(t*e+s*i),this.buf[2]=2*(t*i-s*e),this.buf[3]=0,this.buf[4]=2*(t*e-s*i),this.buf[5]=1-2*(r+n),this.buf[6]=2*(e*i+s*t),this.buf[7]=0,this.buf[8]=2*(t*i+s*e),this.buf[9]=2*(e*i-s*t),this.buf[10]=1-2*(r+a),this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.v2q=function(t,i,s,r){(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],r=i[2],i=i[0]);let a=i*i+s*s+r*r;if(0==a)return[0,0,0,1];1!=a&&(a=Math.sqrt(a),i/=a,s/=a,r/=a),t=t*e.RAD/2;let n=Math.sin(t);return[i*n,s*n,r*n,Math.cos(t)]},e.e2q=function(t,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(i=t[1],s=t[2],t=t[0]),t*=.5*e.RAD,i*=.5*e.RAD,s*=.5*e.RAD;let r=Math.cos(t),a=Math.cos(i),n=Math.cos(s),o=Math.sin(t),h=Math.sin(i),u=Math.sin(s),c=o*a*n+r*h*u,f=r*h*n-o*a*u,l=r*a*u-o*h*n,d=r*a*n+o*h*u;return[c,f,l,d]},e.qMult=function(t,e){let i=t[3]*e[3]-(t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),s=t[1]*e[2]-t[2]*e[1]+t[3]*e[0]+e[3]*t[0],r=t[2]*e[0]-t[0]*e[2]+t[3]*e[1]+e[3]*t[1],a=t[0]*e[1]-t[1]*e[0]+t[3]*e[2]+e[3]*t[2];return[s,r,a,i]},e}),t("skylark-poxp/GPad",["./poxp"],function(t){var e=function(){return this.idx=0,this.conn=!1,this.gpadcount=0,!!navigator.getGamepads&&(gamepads=navigator.getGamepads(),this.gpadcount=gamepads.length,this.gpadcount>0)};return e.prototype.init=function(t,e){if(void 0==t&&(t=0),this.idx=t,!navigator.getGamepads)return!1;let i=!0;return gamepads=navigator.getGamepads(),gamepads[this.idx]?(console.log("gpad init "+this.idx),this.axes=gamepads[this.idx].axes,this.conn=!1,this.egp=null):(this.conn=!1,i=!1),addEventListener("gamepadconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad reconnected "+t.gamepad.index),this.axes=t.gamepad.axes,this.conn=!0,this.get(),e&&e(this,!0))}),addEventListener("gamepaddisconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad disconnected "+t.gamepad.index),this.conn=!1,e&&e(this,!1))}),this.lastGp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0,0,0]},this.egp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0,0,0]},i},e.prototype.get=function(t){var e;if(POXPDevice)if(this.emu=!1,POXPDevice.isPresenting&&POXPDevice.session.inputSources){const t=POXPDevice.session.inputSources;for(let i=0;i<=t.length-1;i++)if(t[i].gamepad&&"xr-standard"==t[i].gamepad.mapping){if(t[i].gamepad.hand=t[i].handedness,"left"==t[i].handedness&&1==this.idx&&(e=t[i].gamepad),"right"==t[i].handedness&&0==this.idx&&(e=t[i].gamepad),e){this.conn=!0;break}this.conn=!1}}else this.conn=!1;if(!e){if(null==this.egp)return null;this.conn=!0,e=this.egp,this.emu=!0}var i=this.lastGp;e.conn=this.conn,e.emu=this.emu,e.bf=!1,e.pf=!1,e.tf=!1,e.dbtn=[],e.dpad=[],e.dtouch=[];for(var s=0;s<e.buttons.length;s++)e.dbtn[s]=0,e.dtouch[s]=0,i&&i.buttons[s]&&(!i.buttons[s].pressed&&e.buttons[s].pressed&&(e.dbtn[s]=1,e.bf=!0),i.buttons[s].pressed&&!e.buttons[s].pressed&&(e.dbtn[s]=-1,e.bf=!0),!i.buttons[s].touched&&e.buttons[s].touched&&(e.dtouch[s]=1,e.tf=!0),i.buttons[s].touched&&!e.buttons[s].touched&&(e.dtouch[s]=-1,e.tf=!0)),i.buttons[s]={pressed:e.buttons[s].pressed,touched:e.buttons[s].touched};let r=[e.axes[0],e.axes[1],e.axes[2],e.axes[3]];void 0!==e.axes[2]&&void 0!==e.axes[3]?(r[0]=e.axes[2],r[1]=e.axes[3],e.stick=!0):e.stick=!1,e.eaxes=r;for(var s=0;s<r.length;s++)Math.abs(r[s])<.001&&(e.axes[s]=0),e.dpad[s]=0,i&&(Math.abs(i.axes[s])<.5&&Math.abs(r[s])>=.5&&(e.dpad[s]=1,e.pf=!0),Math.abs(i.axes[s])>=.5&&Math.abs(r[s])<.5&&(e.dpad[s]=-1,e.pf=!0)),i.axes[s]=r[s];return this.gp=e,this.ev&&(e.bf||e.pf||e.tf)&&this.ev(e),e},e.prototype.set=function(t){this.egp=t},e.prototype.clear=function(t){void 0==t&&(t={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0,0,0]}),this.egp=t,this.cf=!0},t.GPad=e}),t("skylark-poxp/Pointer",["./poxp"],function(t){return t.Pointer=function(t,e){var i,s,r,a,n,o=this;function h(t){var e,s;return i&&t.touches&&t.touches.length>0?(e=t.touches[0].pageX-t.target.offsetLeft,s=t.touches[0].pageY-t.target.offsetTop):(e=t.offsetX,s=t.offsetY),{x:e,y:s}}function u(u){s||(r||(i="touchstart"==u.type,function(){i?(r="touchstart",a="touchend",EV_O="touchcancel",n="touchmove"):(r="mousedown",a="mouseup",EV_O="mouseout",n="mousemove");t.addEventListener(a,function(t){var i=h(t),s="touchend"==t.type?o.lastd:h(t);o.mf=!1,e.up&&(e.up({x:i.x,y:i.y,ex:s.x,ey:s.y,dx:o.dx,dy:o.dy})||t.preventDefault())},!1),t.addEventListener(EV_O,function(t){o.mf=!1;var i=h(t);e.out&&(e.out({x:i.x,y:i.y,dx:o.dx,dy:o.dy})||t.preventDefault())},!1),t.addEventListener(n,function(t){if(!s){var i=h(t);o.lastd=i,o.mf&&(o.dx=i.x-o.s.x,o.dy=i.y-o.s.y,e.move&&(e.move({x:i.x,y:i.y,ox:i.x,oy:i.y,dx:o.dx,dy:o.dy})||t.preventDefault()))}},!1)}(),first=!1),o.mf=!0,o.dx=o.dy=0,o.s=h(u),o.lastd=o.s,e.down&&(e.down({x:o.s.x,y:o.s.y,sx:o.s.x,sy:o.s.y})||u.preventDefault()))}t.addEventListener("mousedown",u,!1),t.addEventListener("touchstart",u,!1),e.contextmenu&&t.addEventListener("contextmenu",function(t){e.contextmenu({px:t.offsetX,py:t.offsetY})||t.preventDefault()},!1);e.wheel&&t.addEventListener("wheel",function(t){e.wheel(t.deltaY)||t.preventDefault()},!1);e.gesture&&(t.addEventListener("gesturestart",function(t){s=!0,e.gesture(0,0)||t.preventDefault()}),t.addEventListener("gesturechange",function(t){e.gesture(t.scale,t.rotation)||t.preventDefault()}),t.addEventListener("gestureend",function(t){s=!1}));e.gyro&&window.addEventListener("deviceorientation",function(t){var i,s,r,a=window.orientation;switch(i=null,s=null,r=null,a){case 90:t.gamma<0?(i=t.gamma+90,s=180-t.alpha,r=t.beta+180):(i=t.gamma-90,s=360-t.alpha,r=t.beta);break;case-90:t.gamma<0?(i=-t.gamma-90,s=180-t.alpha,r=180-t.beta):(i=90-t.gamma,s=360-t.alpha,r=-t.beta)}e.gyro({rx:i,ry:s,rz:r,orientation:a})})}}),t("skylark-poxp/PoxCamera",["./poxp","./CanvasMatrix4"],function(t,e){return t.PoxCamera=class{constructor(t,i){this.poxp=t,this.cam={camCX:0,camCY:0,camCZ:0,camVX:0,camVY:0,camVZ:1,camUPX:0,camUPY:1,camUPZ:0,camRX:30,camRY:-30,camRZ:0,camd:20,camAngle:90,camWidth:1,camNear:.01,camFar:1e3,camGyro:!0,gPad:!0,sbase:.06,moveSpeed:1.3,rotAngle:30,moveY:!1,padMoveUD:!0,padRot:!0,headVec:[0,0,0]};for(let t in i)this.cam[t]=i[t];this.cama=!1,this.rotX=0,this.rotY=0,this.gev=null,this.gx=0,this.gy=0,this.gz=0,this.vcx=0,this.vcy=0,this.vcz=0,this.vrx=0,this.vry=0,this.vrz=0,this.keydown=!1,this.vr=!1,this.camVP=[new e,new e],this.camP=[new e,new e],this.camV=[new e,new e],this.vrv=[new e,new e],this.vrp=[new e,new e],this.tempM=new e,this.pvy=!1,this.pvx=!1}setCam(t){for(let e in t)this.cam[e]=t[e];this.cama=!1}getCam(){const t={basePos:[this.cam.camCX,this.cam.camCY,this.cam.camCZ],baseRot:[this.cam.camRX,this.cam.camRY,this.cam.camRZ],position:Array.from(this.cam.campos),headVec:Array.from(this.cam.headVec)};return this.cam.orientation?t.headOri=Array.from(this.cam.orientation):t.headOri=[0,0,0,1],this.cam.position?t.headPos=Array.from(this.cam.position):t.headPos=[0,0,0],t}vrchange(t){t&&(this.cam.camRX=0,this.cam.camRZ=0)}event(t,e){const i=300*this.poxp.pixRatio/this.poxp.can.width,s=this.poxp.pox.setting&&this.poxp.pox.setting.scale?this.poxp.pox.setting.scale:1;switch(t){case"down":this.rotX=this.cam.camRX,this.rotY=this.cam.camRY;break;case"move":this.cam.camRX=this.rotX+e.dy*i,this.cam.camRY=this.rotY+e.dx*i,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"up":this.rotX+=e.dy*i,this.rotY+=e.dx*i,null!==this.gev&&(this.gx=this.gev.rx-this.rotX,this.gy=this.gev.ry-this.rotY);break;case"out":this.rotX+=e.dy*i,this.rotY+=e.dx*i;break;case"wheel":this.cam.camd+=e/100*s;break;case"gesture":if(0==e.z)return this.gz=this.cam.camd,!1;this.cam.camd=this.gz/e.z;break;case"gyro":if(this.keydown||!this.cam.camGyro)return!0;if(null===e.rx)return!0;this.gev=e,this.cam.camRX=e.rx-this.gx,this.cam.camRY=e.ry-this.gy,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"keydown":this.cam.camd;const r=this.cam.moveSpeed;let a="";if(this.keydown=!0,e.altKey)switch(e.key){case"ArrowUp":this.cam.camd=this.cam.camd-r,this.cam.camd<0&&(cthis.am.camd=0);break;case"ArrowDown":this.cam.camd=this.cam.camd+r}else switch(e.key){case"ArrowLeft":case"Left":case"h":this.vry=-r;break;case"ArrowUp":case"Up":case"k":this.vrx=-r;break;case"ArrowRight":case"Right":case"l":this.vry=r;break;case"ArrowDown":case"Down":case"j":this.vrx=r;break;case"w":a="f";break;case"s":a="b";break;case"a":a="l";break;case"d":a="r";break;case"q":a="u";break;case"e":a="d"}if(""!=a){const t=("b"==a||"d"==a?-1:1)*r*s,e=this.cam;if("u"==a||"d"==a)this.vcy=t;else{let i=e.camRY;"l"==a&&(i-=90),"r"==a&&(i+=90),this.vcx=Math.sin(i*RAD)*t,this.vcz=-Math.cos(i*RAD)*t}}break;case"keyup":switch(this.keydown=!1,null!==this.gev&&(this.gx=this.gev.rx-this.cam.camRX,this.gy=this.gev.ry-this.cam.camRY),e.key){case"ArrowLeft":case"Left":case"h":case"ArrowRight":case"Right":case"l":this.vry=0;break;case"ArrowUp":case"Up":case"k":case"ArrowDown":case"Down":case"j":this.vrx=0;break;case"w":case"d":case"a":case"s":case" ":this.vcx=0,this.vcz=0;break;case"q":case"e":this.vcy=0;break;case"Dead":this.vrx=0,this.vry=0,this.vcx=0,this.vcz=0}}}update(t){const e=(this.poxp.ctime-this.poxp.ltime)/1e3;"fix"!=this.cam.camMode&&(this.cam.camRX+=this.vrx,this.cam.camRX<-89&&(this.cam.camRX=-89),this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRY+=this.vry),"walk"==this.cam.camMode&&(this.cama||(this.cam.camCX+=this.vcx*e,this.cam.camCY+=this.vcy*e,this.cam.camCZ+=this.vcz*e),this.cam.camRY+=this.vry*e),this.cama&&(this.cam.camCX+=this.acx*e,this.cam.camCY+=this.acy*e,this.cam.camCZ+=this.acz*e,this.ad+=this.av*e,this.ad>this.al&&(this.cam.camCX=this.aex,this.cam.camCY=this.aey,this.cam.camCZ=this.aez,this.cama=!1))}setPad(t,e){let i=t||e;if(i&&"walk"==this.cam.camMode){let t=[i.axes[0],i.axes[1]];if(void 0!=i.axes[2]&&0!=i.axes[2]&&(t[0]=i.axes[2]),void 0!=i.axes[3]&&0!=i.axes[3]&&(t[1]=i.axes[3]),this.cam.padMoveUD&&i.buttons[1]&&i.buttons[1].pressed)return this.vcy=-t[1]*this.cam.moveSpeed,void(this.pvy=!0);this.pvy&&(this.vcy=0,this.pvy=!1);let e=i.buttons[2]&&i.buttons[2].pressed,s=e?5*this.cam.moveSpeed:this.cam.moveSpeed;if(Math.abs(t[0])<Math.abs(t[1])&&Math.abs(t[1])>0)return this.vcx=-this.cam.headVec[0]*t[1]*s,this.cam.moveY&&(this.vcy=-this.cam.headVec[1]*t[1]*s),this.vcz=-this.cam.headVec[2]*t[1]*s,void(this.pvx=!0);if(this.pvx&&(this.vcx=0,this.vcy=0,this.vcz=0,this.pvx=!1),this.cam.padRot&&i.dpad[0]>0){let e=(t[0]>0?1:-1)*this.cam.rotAngle;this.cam.camRY+=e}}}moveTo(t,e,i,s){if(this.cama)return;let r=null!==t?t:this.cam.camCX,a=null!==e?e:this.cam.camCY,n=null!==i?i:this.cam.camCZ;if(s&&s.velocity){let t=r-this.cam.camCX,e=a-this.cam.camCY,i=n-this.cam.camCZ,o=s.velocity/Math.hypot(t,e,i);t*=o,e*=o,i*=o,this.acx=t,this.acy=e,this.acz=i,this.aex=r,this.aey=a,this.aez=n,this.al=s.velocity/o,this.ad=0,this.av=s.velocity,this.cama=!0}else this.cam.camCX=r,this.cam.camCY=a,this.cam.camCZ=n,this.cama=!1}moveCancel(){this.cama=!1}getMtx(t,e){const i=this.cam,s=this.poxp.render.wwg.can,r=s.width/(s.height*(e?2:1));let a,n,o,h,u,c,f,l,d,m,p=null;if(f=i.camUPX,l=i.camUPY,d=i.camUPZ,h=[0,0],u=[0,0],c=[0,0],!this.poxp.isVR){if("fix"==i.camMode)a=i.camVX,n=i.camVY,o=i.camVZ,this.cam.headVec=[a,n,o,0];else if("vr"==i.camMode||"walk"==i.camMode){a=i.camCX+1*Math.sin(i.camRY*RAD)*Math.cos(i.camRX*RAD),n=i.camCY+1*-Math.sin(i.camRX*RAD),o=i.camCZ+1*-Math.cos(i.camRY*RAD)*Math.cos(i.camRX*RAD);let t=(new Mat4).rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0).rotate(-this.cam.camRZ,0,0,1);f=-Math.sin(i.camRZ*RAD),l=Math.cos(i.camRZ*RAD),this.cam.headVec=t.multVec4(0,0,-1,0)}else{m=i.camd*t,i.camCX=-Math.sin(i.camRY*RAD)*m*Math.cos(i.camRX*RAD),i.camCY=Math.sin(i.camRX*RAD)*m,i.camCZ=Math.cos(i.camRY*RAD)*m*Math.cos(i.camRX*RAD),a=0,n=0,o=0,m<0&&(a=2*i.camCX,n=2*i.camCY,o=2*i.camCZ);let e=Math.hypot(i.camCX,i.camCY,i.camCZ);this.cam.headVec=[-i.camCX/e,-i.camCY/e,-i.camCZ/e,0]}if(this.cam.campos=[i.camCX,i.camCY,i.camCZ],this.camVP[0].makeIdentity(),this.camVP[1].makeIdentity(),this.camP[0].makeIdentity(),this.camP[1].makeIdentity(),this.camV[0].makeIdentity(),this.camV[1].makeIdentity(),e){const e=-i.sbase*t;h[0]=l*(i.camCZ-o)-d*(i.camCY-n),u[0]=-f*(i.camCZ-o)+d*(i.camCX-a),c[0]=f*(i.camCY-n)-l*(i.camCX-a);const s=Math.hypot(h[0],u[0],c[0]);h[0]*=e/s,u[0]*=e/s,c[0]*=e/s,h[1]=-h[0],u[1]=-u[0],c[1]=-c[0],this.camV[0].lookat(h[0]+i.camCX,u[0]+i.camCY,c[0]+i.camCZ,a+h[0],n+u[0],o+c[0],f,l,d),this.camV[1].lookat(h[1]+i.camCX,u[1]+i.camCY,c[1]+i.camCZ,a+h[1],n+u[1],o+c[1],f,l,d),0!=i.camAngle?this.camP[0].perspective(i.camAngle,r,i.camNear,i.camFar):this.camP[0].pallarel(i.camd,r,i.camNear,i.camFar),this.camP[1]=this.camP[0],this.camVP[0].load(this.camV[0]).multRight(this.camP[0]),this.camVP[1].load(this.camV[1]).multRight(this.camP[1])}else this.camV[0].lookat(i.camCX,i.camCY,i.camCZ,a,n,o,f,l,d),0!=i.camAngle?this.camP[0].perspective(i.camAngle,r,i.camNear,i.camFar):this.camP[0].pallarel(i.camd,r,i.camNear,i.camFar),this.camVP[0].load(this.camV[0]).multRight(this.camP[0])}if(this.poxp.isVR){if(POXPDevice.setDepth({camNear:i.camNear,camFar:i.camFar}),!(p=POXPDevice.getFrameData()))return;this.cam.orientation=p.pose.orientation,this.cam.position=p.pose.position,this.cam.position||(this.cam.position=[0,0,0]),this.vrv[1].load(p.rightViewMatrix),this.vrv[0].load(p.leftViewMatrix),this.vrp[1].load(p.rightProjectionMatrix),this.vrp[0].load(p.leftProjectionMatrix),this.tempM.makeIdentity().translate(-i.camCX,-i.camCY,-i.camCZ).rotate(i.camRX,1,0,0).rotate(i.camRY,0,1,0).rotate(i.camRZ,0,0,1),this.camV[0].load(this.vrv[0]),this.leftCorrMtx&&this.camV[0].multRight(this.leftCorrMtx),this.camV[0].multLeft(this.tempM),this.camVP[0].load(this.camV[0]).multRight(this.vrp[0]),this.camP[0].load(this.vrp[0]),this.camV[1].load(this.vrv[1]),this.rightCorrMtx&&this.camV[1].multRight(this.rightCorrMtx),this.camV[1].multLeft(this.tempM),this.camVP[1].load(this.camV[1]).multRight(this.vrp[1]),this.camP[1].load(this.vrp[1]);let t=0,e=0,s=1;if(this.cam.orientation){let i=this.cam.orientation[0],r=this.cam.orientation[1],a=this.cam.orientation[2],n=this.cam.orientation[3];t=2*(-i*a-r*n),e=2*(-r*a+i*n),s=i*i+r*r-a*a-n*n;let o=Math.hypot(t,e,s);t/=o,e/=o,s/=o}this.tempM.invert();let r=this.tempM;this.cam.headVec=r.multVec4(t,e,s,0),this.cam.campos=r.multVec4(this.cam.position[0],this.cam.position[1],this.cam.position[2],1).slice(0,3);let a=(new Mat4).load(this.camV[1]).invert(),n=(new Mat4).load(this.camV[0]).invert();h[0]=n.buf[12]-i.camCX,u[0]=n.buf[13]-i.camCY,c[0]=n.buf[14]-i.camCZ,h[1]=a.buf[12]-i.camCX,u[1]=a.buf[13]-i.camCY,c[1]=a.buf[14]-i.camCZ}return[{camX:i.camCX+h[0],camY:i.camCY+u[0],camZ:i.camCZ+c[0],camV:this.camV[0],camVP:this.camVP[0],camP:this.camP[0],vrFrame:p},{camX:i.camCX+h[1],camY:i.camCY+u[1],camZ:i.camCZ+c[1],camV:this.camV[1],camVP:this.camVP[1],camP:this.camP[1],vrFrame:p}]}}}),t("skylark-poxp/Vector",["./poxp"],function(t){class e extends Array{constructor(...t){let e=t;Array.isArray(t[0])&&(e=t[0]),super(...e)}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set w(t){this[3]=t}set r(t){this[0]=t}set g(t){this[1]=t}set b(t){this[2]=t}set a(t){this[3]=t}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}get r(){return this[0]}get g(){return this[1]}get b(){return this[2]}get a(){return this[3]}get xy(){return new e(this[0],this[1])}get yx(){return new e(this[1],this[0])}get xz(){return new e(this[0],this[2])}get zx(){return new e(this[2],this[0])}get yz(){return new e(this[1],this[2])}get zy(){return new e(this[2],this[1])}get xyz(){return new e(this[0],this[1],this[2])}get xzy(){return new e(this[0],this[2],this[1])}get yxz(){return new e(this[1],this[0],this[2])}get yzx(){return new e(this[1],this[2],this[0])}get zxy(){return new e(this[2],this[0],this[1])}get zyx(){return new e(this[2],this[1],this[0])}get rgb(){return new e(this[0],this[1],this[2])}cross(t){if(3!=this.length||3!=t.length)throw-1;let i=[this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0]];return new e(i)}mix(t,i){return new e(this.map((e,s)=>e*(1-i)+t[s]*i))}invert(){return new e(this.map(t=>-t))}add(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e+t[i]))}sub(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e-t[i]))}mult(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e*t[i]))}normalize(){let t=this.hypot();return new e(this.map((e,i)=>0!=t?e/t:0))}floor(){return new e(this.map((t,e)=>Math.floor(t)))}ceil(){return new e(this.map((t,e)=>Math.ceil(t)))}fract(){return new e(this.map((t,e)=>t-Math.floor(t)))}min(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e<t[i]?e:t[i]))}max(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e>t[i]?e:t[i]))}clamp(t,i){return new e(this.map((e,s)=>e<t?t:e>i?i:e))}step(t){return new e(this.map((e,i)=>e<t?0:1))}mod(t){return new e(this.map((e,i)=>e%t))}dot(t){return this.reduce((e,i,s)=>e+=i*t[s],0)}distance(t){let i=new e(...this);return i.sub(t).hypot()}hypot(){return Math.hypot(...this)}equal(t){return this.reduce((e,i,s)=>e&&i===t[s],!0)}}return t.Vector=e}),t("skylark-poxp/POXPDevice",["./poxp","./Vector"],function(t,e){const i={VRReady:!1,isPresenting:!1,checkVR:function(){return new Promise((t,e)=>{navigator.xr?navigator.xr.isSessionSupported("immersive-vr",{optionalFeatures:["hand-tracking"]}).then(e=>{i.VRReady=e,t(e)}).catch(e=>{console.log(e),t(!1)}):t(!1)})},presentVR:function(t){return new Promise((e,s)=>{navigator.xr.requestSession("immersive-vr",{optionalFeatures:["hand-tracking"]}).then(e=>{i.session=e,i.isPresenting=!0,console.log("vr start"),e.updateRenderState({baseLayer:new XRWebGLLayer(e,t.wwg.gl,{framebufferScaleFactor:t.pixRatio})}),e.requestReferenceSpace("local").then(e=>{i.referenceSpace=e,i.session.requestAnimationFrame(i.loopf),t.callEvent("vrchange",1)}),e.addEventListener("end",e=>{i.session=null,i.isPresenting=!1,console.log("VR end"),t.callEvent("vrchange",0)})})})},closeVR:function(){console.log("vr closing"),i.isPresenting=!1,i.session.end()},animationFrame:function(t,e,s){if(i.loopf=e,i.isPresenting){if(!s)return;i.session.requestAnimationFrame(e),i.vrFrame=s,t.isVR=!0}else t.loop=window.requestAnimationFrame(e),t.isVR=!1},submitFrame:function(){i.VRReady},getFrameData:function(){if(i.vrFrame){let e=i.vrFrame.getViewerPose(i.referenceSpace);e.orientation=[e.transform.orientation.x,e.transform.orientation.y,e.transform.orientation.z,e.transform.orientation.w],e.position=[e.transform.position.x,e.transform.position.y,e.transform.position.z];let s={pose:e},r=i.session.renderState.baseLayer;i.webGLLayer=r;for(let i=0;i<=e.views.length-1;i++){const a=e.views[i];var t=r.getViewport(a);e.views[i].viewport=t,"right"==a.eye?(s.rightViewMatrix=a.transform.inverse.matrix,s.rightProjectionMatrix=a.projectionMatrix,s.rightViewport=t):"left"==a.eye&&(s.leftViewMatrix=a.transform.inverse.matrix,s.leftProjectionMatrix=a.projectionMatrix,s.leftViewport=t)}return i.views=e.views,i.viewport={leftViewport:s.leftViewport,rightViewport:s.rightViewport},s}},getViewport:function(t){return i.isPresenting?i.viewport:{leftViewport:{x:0,y:0,width:t.width/2,height:t.height},rightViewport:{x:t.width/2,y:0,width:t.width/2,height:t.height}}},setDepth:function(t){i.isPresenting&&i.session.updateRenderState({depthNear:t.camNear,depthFar:t.camFar})},getInput:function(){if(!i.isPresenting)return null;if(!i.session.inputSources)return null;let t={};for(let e of i.session.inputSources){if(null==e)continue;let s=i.vrFrame.getPose(e.gripSpace,i.referenceSpace),r=s?i.convTransform(s.transform):null;if(e.gamepad&&(t.gamepad||(t.gamepad={}),t.gamepad[e.handedness]={handedness:e.handedness,gamepad:e.gamepad,profiles:e.profiles,pose:r}),e.hand){t.hand||(t.hand={});let s=[];for(let t=0;t<25;t++)if(null!==e.hand[t]){let r=i.vrFrame.getJointPose(e.hand[t],i.referenceSpace);s[t]=null!=r?{radius:r.radius,transform:i.convTransform(r.transform)}:null}else s[t]=null;t.hand[e.handedness]={handedness:e.handedness,hand:s,profiles:e.profiles,pose:r}}}return t},convTransform:function(t){let i={};return t.position&&(i.position=new e(t.position.x,t.position.y,t.position.z)),t.orientation&&(i.orientation=new e(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w)),t.matrix&&(i.matrix=new Mat4(t.matrix)),i}};return t.POXPDevice=i}),t("skylark-poxp/PoxProfile",["./poxp"],function(t){return t.PoxProfile=class{constructor(t){this.poxp=t}log(...t){for(let e of t)this.poxp.pox.log(e)}lognow(){let t=new Date;this.poxp.pox.log("["+t.toLocaleTimeString()+"."+("00"+t.getUTCMilliseconds().toString()).substr(-3)+"]")}dumpobj(t,e=1){let i=t;if(0==e)return i;if(Array.isArray(t))i="["+t.join(",")+"]";else if("object"==typeof t){i="{";for(let s in t)i+=s+":"+this.dumpobj(t[s],e-1)+",";i+="}"}return i}logobj(t,e=1){this.log(this.dumpobj(t,e))}dumpModels(){this.lognow();const t=this.poxp.render.data.model;for(let e of t)this.log("id:"+e.id,"  name:"+e.name,"  mode:"+e.geo.mode,"  vtx:"+e.geo.vtx.length/e.obuf.tl),e.geo.idx&&this.log("  idx:"+e.geo.idx&&e.geo.idx.length),e.inst&&this.log("  inst:"+e.inst.count)}dumpModelUni(t){const e=this.poxp.pox.getModelData(t);if(e){this.lognow(),this.log("vs_uni");for(let t in e.vs_uni)this.log("  "+t+" = "+e.vs_uni[t]);this.log("fs_uni");for(let t in e.fs_uni)this.log("  "+t+" = "+e.fs_uni[t])}}}}),t("skylark-poxp/WBind",["./poxp"],function(t){var e={create:function(t){var i=new e.obj;if(void 0!==t)for(var s in t)i[s]=t[s];return i},obj:function(){this.prop={},this._elem={},this._check={},this._func={},this._tobjs={}},_getobj:function(t,e){var i;return e||(e=document),"string"==typeof t?(1==(i=e.querySelectorAll(t)).length&&(i=i[0]),0==i.length&&(i=null)):i=t,i},_getval:function(t){var e=t.value;if("checkbox"==t.type&&(e=t.checked),"select-multiple"==t.type){var i=t.querySelectorAll("option");e=[];for(var s=0;s<i.length;s++)i[s].selected&&e.push(i[s].value)}return"range"==t.type&&(e=parseFloat(e)),"file"==t.type&&(e=t.files),e}};return e.obj.prototype.bindHtml=function(t,i,s){var r=e._getobj(i);return r?(this._elem[t]=r,s||(s={}),this._func[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){return r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].innerHTML:this.prop[t]=r.innerHTML,this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,r instanceof NodeList||Array.isArray(r))for(var i=0;i<r.length;i++)this._elem[t][i].innerHTML=e;else this._elem[t].innerHTML=e}}),r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].innerHTML:this.prop[t]=r.innerHTML,this):this},e.obj.prototype.bindStyle=function(t,i,s,r){var a=e._getobj(i);return a?(this._elem[t]=a,r||(r={}),this._func[t]=r,Object.defineProperty(this,t,{configurable:!0,get:function(){return a instanceof NodeList||Array.isArray(a)?this.prop[t]=a[0].style[s]:this.prop[t]=a.style[s],this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,a instanceof NodeList||Array.isArray(a))for(var i=0;i<a.length;i++)this._elem[t][i].style[s]=e;else this._elem[t].style[s]=e}}),a instanceof NodeList||Array.isArray(a)?this.prop[t]=a[0].style[s]:this.prop[t]=a.style[s],this):this},e.obj.prototype.bindAttr=function(t,i,s,r){var a=e._getobj(i);return a?(this._elem[t]=a,r||(r={}),this._func[t]=r,Object.defineProperty(this,t,{configurable:!0,get:function(){return a instanceof NodeList||Array.isArray(a)?this.prop[t]=a[0].getAttribute(s):this.prop[t]=a.getAttribute(s),this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,a instanceof NodeList||Array.isArray(a))for(var i=0;i<a.length;i++)this._elem[t][i].setAttribute(s,e);else this._elem[t].setAttribute(s,e)}}),a instanceof NodeList||Array.isArray(a)?this.prop[t]=a[0].getAttribute(s):this.prop[t]=a.getAttribute(s),this):this},e.obj.prototype.bindInput=function(t,i,s){var r=e._getobj(i);if(!r)return this;s||(s={}),this._func[t]=s,(r instanceof NodeList||Array.isArray(r))&&"checkbox"!=r[0].type&&"radio"!=r[0].type&&(r=r[0]);var a=void 0!=this.prop[t];this._elem[t]=r,Object.defineProperty(this,t,{configurable:!0,get:function(){var e=u(t);return this._func[t].get&&(e=this._func[t].get(e)),e},set:function(e){this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,function(t,e){var i=n._elem[t];if(i instanceof NodeList||Array.isArray(i)){if("radio"==i[0].type)for(var s=0;s<i.length;s++)i[s].value==e&&(i[s].checked=!0);else if("checkbox"==i[0].type){for(var r={},s=0;s<e.length;s++)r[e[s]]=!0;for(var s=0;s<i.length;s++)i[s].checked=r[i[s].value];n._check[t]=r}}else if("checkbox"==i.type)i.checked=e;else if("select-multiple"==i.type)for(var a=i.querySelectorAll("option"),s=0;s<a.length;s++){a[s].selected=!1;for(var o=0;o<e.length;o++)a[s].value==e[o]&&(a[s].selected=!0)}else"file"==i.type||(i.value=e)}(t,e),this._func[t].change&&this._func[t].change(u(t)),this._func[t].input&&this._func[t].input(u(t))}});var n=this,o=null;if(r instanceof NodeList||Array.isArray(r)){"checkbox"==r[0].type&&(n._check[t]={});for(var h=0;h<r.length;h++)"object"==typeof r[h]&&(a||r[h].addEventListener("change",function(i){var s;"checkbox"==this.type?(n._check[t][this.value]=this.checked,s=u(t)):s=this.value,n.prop[t]=s,n._func[t].get&&(s=n._func[t].get(s)),e.log("get "+t+"="+s),n._func[t].change&&n._func[t].change(s)}),"radio"==r[h].type&&r[h].checked?o=r[h].value:"checkbox"==r[h].type&&(n._check[t][r[h].value]=r[h].checked));"checkbox"==r[0].type&&(o=u(t))}else o=e._getval(r),a||r.addEventListener("change",function(i){var s=e._getval(this);n.prop[t]=s,n._func[t].get&&(s=n._func[t].get(s)),n._func[t].change&&n._func[t].change(s)}),a||r.addEventListener("input",function(i){var s=e._getval(this);n.prop[t]=s,n._func[t].get&&(s=n._func[t].get(s)),n._func[t].input&&n._func[t].input(s)});function u(t){var e;if(n._check[t]){for(var i in e=[],n._check[t])n._check[t][i]&&e.push(i);n.prop[t]=e}else e=n.prop[t];return e}return this._func[t].get&&(o=this._func[t].get(o)),this.prop[t]=o,n._func[t].input&&this._func[t].input(o),n._func[t].change&&this._func[t].change(o),this},e.obj.prototype.getCheck=function(t){return this._check[t]},e.obj.prototype.setFunc=function(t,i){for(var s in i)this._func[t][s]=i[s];var r=e._getval(this._elem[t]);return this._func[t].get&&(r=this._func[t].get(r)),this.prop[t]=r,this._func[t]},e.obj.prototype.bindAllInput=function(t){t||(t=document);for(var e=t.querySelectorAll("input,select,textarea"),i={},s=0;s<e.length;s++){var r=e[s].name;i[r]?Array.isArray(i[r])?i[r].push(e[s]):i[r]=[i[r],e[s]]:i[r]=e[s]}for(var s in i)this.bindInput(s,i[s]);return i},e.obj.prototype.bindAll=function(t,e){null==e&&(e=document);for(var i=e.querySelectorAll(t),s=0;s<i.length;s++){var r=i[s].getAttribute("data-bind");"INPUT"==i[s].tagName||"SELECT"==i[s].tagName?this.bindInput(r,i[s]):this.bindHtml(r,i[s])}},e.obj.prototype.setTimer=function(t,e,i,s){if(Array.isArray(e))return this.setTimerM(t,e);var r;s||(s={});if(r=s.from?s.from:this[t],isNaN(r)&&(r.match(/^([0-9\-\.]+)(.*)$/)?(r=parseFloat(RegExp.$1),s.sfx=RegExp.$2):r=0),r==e)return this;var a=0;s.delay&&(a=s.delay);var n=(new Date).getTime(),o={from:r,to:e,st:n+a,et:n+a+i,opt:s};return this._tobjs[t]={tl:[o],tc:0},this},e.obj.prototype.setTimerM=function(t,e){for(var i=[],s=(new Date).getTime(),r=this[t],a=0;a<e.length;a++){var n=e[a].to,o=e[a].time,h=e[a].opt;h||(h={});isNaN(r)&&(r.match(/^([0-9\-\.]+)(.*)$/)?(r=parseFloat(RegExp.$1),h.sfx=RegExp.$2):r=0);var u=0;h.delay&&(u=h.delay),i.push({from:r,to:n,st:s+u,et:s+u+o,opt:h}),r=n}return this._tobjs[t]={tl:i,tc:0},console.log(i),this},e.obj.prototype.clearTimer=function(t){delete this._tobjs[t]},e.obj.prototype.updateTimer=function(){var t=(new Date).getTime();for(var e in this._tobjs){var i=this._tobjs[e],s=i.tl[i.tc];if(void 0!==s&&!(s.st>t))if(s.et<=t){var r=s.to;s.opt.sfx&&(r+=s.opt.sfx),this[e]=r,i.tc++,this._tobjs[e].tl.length<i.tc&&delete this._tobjs[e],s.opt.efunc&&s.opt.efunc(s.to)}else{var a=(t-s.st)/(s.et-s.st);if(s.opt.tfunc)if("string"==typeof s.opt.tfunc)switch(s.opt.tfunc){case"ease-in":a*=a;break;case"ease-out":a*=2-a;break;case"ease-inout":a=a*a*(3-2*a)}else a=s.opt.tfunc(a);var r=s.from+(s.to-s.from)*a;s.opt.sfx&&(r+=s.opt.sfx),this[e]=r}}},e.log=function(t){console.log(t)},e.addev=function(t,i,s,r){var a=e._getobj(t,r);if(a){a instanceof NodeList||Array.isArray(a)||(a=[a]);for(var n=0;n<a.length;n++)a[n].addEventListener(i,function(t){s(t)||t.preventDefault()})}},e.set=function(t,i){i||(i=document),t instanceof Array||(t=[t]);for(var r=0;r<t.length;r++){var a,n=t[r];if(n.obj&&(a=e._getobj(n.obj,i)),n.id&&(a=i.getElementById(n.id)),n.sel&&(a=i.querySelectorAll(n.sel)),a){a instanceof NodeList||Array.isArray(a)||(a=[a]);for(var o=0;o<a.length;o++)if(void 0!=n.html&&(a[o].innerHTML=n.html),void 0!=n.value&&(a[o].value=n.value),void 0!=n.attr&&a[o].setAttribute(n.attr,n.value),void 0!=n.style)for(s in n.style)a[o].style[s]=n.style[s]}}},t.WBind=e}),t("skylark-poxp/WWG",["./poxp"],function(t){function e(){this.version="0.9.11",this.can=null,this.gl=null,this.vsize={float:1,vec2:2,vec3:3,vec4:4,mat2:4,mat3:9,mat4:16}}return e.prototype.init=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl",e))&&!(i=t.getContext("webgl",e)))&&(!!window.Promise&&(this.gl=i,this.ext_vao=i.getExtension("OES_vertex_array_object"),this.ext_vao&&(this.vao_create=function(){return this.ext_vao.createVertexArrayOES()},this.vao_bind=function(t){this.ext_vao.bindVertexArrayOES(t)}),this.ext_inst=i.getExtension("ANGLE_instanced_arrays"),this.ext_inst&&(this.inst_divisor=function(t,e){this.ext_inst.vertexAttribDivisorANGLE(t,e)},this.inst_draw=function(t,e,i,s,r){this.ext_inst.drawElementsInstancedANGLE(t,e,i,s,r)},this.inst_drawa=function(t,e,i,s){this.ext_inst.drawArrayInstancedANGLE(t,e,i,s)}),this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_ftex=i.getExtension("OES_texture_float"),this.ext_mrt=i.getExtension("WEBGL_draw_buffers"),this.ext_mrt&&(this.mrt_att=this.ext_mrt.COLOR_ATTACHMENT0_WEBGL,this.mrt_draw=function(t,e){return this.ext_mrt.drawBuffersWEBGL(t,e)}),this.ext_i32=i.getExtension("OES_element_index_uint"),this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=1,!0))},e.prototype.init2=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl2",e))&&!(i=t.getContext("webgl2",e)))&&(!!window.Promise&&(console.log("init for webGL2"),this.gl=i,this.ext_vao=!0,this.vao_create=function(){return this.gl.createVertexArray()},this.vao_bind=function(t){this.gl.bindVertexArray(t)},this.ext_inst=!0,this.inst_divisor=function(t,e){this.gl.vertexAttribDivisor(t,e)},this.inst_draw=function(t,e,i,s,r){this.gl.drawElementsInstanced(t,e,i,s,r)},this.inst_drawa=function(t,e,i,s){this.gl.drawArraysInstanced(t,e,i,s)},this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_anis&&(this.ext_anis_max=i.getParameter(this.ext_anis.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.ext_ftex=!0,this.ext_mrt=i.getParameter(i.MAX_DRAW_BUFFERS)>1,this.ext_mrt&&(this.mrt_att=i.COLOR_ATTACHMENT0,this.mrt_draw=function(t,e){return i.drawBuffers(t,e)}),this.ext_i32=!0,this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=2,!0))},e.prototype.loadAjax=function(t,e){return new Promise((i,s)=>{const r=new XMLHttpRequest;r.open("get",t,!0),r.responseType=e&&e.type?e.type:"text",r.onload=(()=>{200==r.status?i(r.response):s("Ajax error:"+r.statusText)}),r.onerror=(()=>{s("Ajax error:"+r.statusText)}),r.send()})},e.prototype.loadImageAjax=function(t){return new Promise((e,i)=>{this.loadAjax(t,{type:"blob"}).then(t=>{const i=new Image,s=URL.createObjectURL(t);i.onload=(()=>{URL.revokeObjectURL(s),e(i)}),i.src=s}).catch(t=>{console.log(t),e(null)})})},e.prototype.createRender=function(){return new this.Render(this)},e.prototype.Render=function(t){this.wwg=t,this.gl=t.gl,this.env={},this.modelCount=0,this.modelId=0},e.prototype.Render.prototype.setUnivec=function(t,e){if(null==t.pos)return;let s=[];if(t.dim>0&&!(e instanceof Float32Array))for(let i=0;i<t.dim;i++)s=s.concat(e[i]);else s=e;if(null!=t.cache)if(Array.isArray(s)){for(let e=0;e<s.length&&s[e]==t.cache[e];e++);if(i==s.length)return}else if(s==t.cache)return;switch(t.type){case"mat2":this.gl.uniformMatrix2fv(t.pos,!1,this.f32Array(e));break;case"mat3":this.gl.uniformMatrix3fv(t.pos,!1,this.f32Array(e));break;case"mat4":this.gl.uniformMatrix4fv(t.pos,!1,this.f32Array(e));break;case"vec2":this.gl.uniform2fv(t.pos,this.f32Array(e));break;case"vec2v":this.gl.uniform2fv(t.pos,this.f32Array(s));break;case"vec3":this.gl.uniform3fv(t.pos,this.f32Array(e));break;case"vec3v":this.gl.uniform3fv(t.pos,this.f32Array(s));break;case"vec4":this.gl.uniform4fv(t.pos,this.f32Array(e));break;case"vec4v":this.gl.uniform4fv(t.pos,this.f32Array(s));break;case"int":case"bool":this.gl.uniform1i(t.pos,e);break;case"ivec2":case"bvec2":this.gl.uniform2iv(t.pos,this.i16Array(e));break;case"ivec2v":case"bvec2v":this.gl.uniform2iv(t.pos,this.i16Array(s));break;case"ivec3":case"bvec3":this.gl.uniform3iv(t.pos,this.i16Array(e));break;case"ivec3v":case"bvec3v":this.gl.uniform3iv(t.pos,this.i16Array(s));break;case"ivec4":case"bvec4":this.gl.uniform4iv(t.pos,this.i16Array(e));break;case"ivec4v":case"bvec4v":this.gl.uniform4iv(t.pos,this.i16Array(s));break;case"intv":case"boolv":this.gl.uniform1iv(t.pos,this.i16Array(e));break;case"float":this.gl.uniform1f(t.pos,e);break;case"floatv":this.gl.uniform1fv(t.pos,this.f32Array(e));break;case"sampler2D":if("string"==typeof e&&(e=this.getTexIndex(e)),this.gl.activeTexture(this.gl.TEXTURE0+t.texunit),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[e]),void 0==this.data.texture[e])break;this.data.texture&&this.data.texture[e].video&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.data.texture[e].video),this.gl.uniform1i(t.pos,t.texunit)}},e.prototype.Render.prototype.setShader=function(t){let e=0;function s(t){const s=t.split("\n"),r=[],a=[],n={};for(i=0;i<s.length;i++){let t=s[i];if(t.match(/^\s*#define\s*([^\s]+)\s+([^\s]+)/)&&(n[RegExp.$1.trim()]=RegExp.$2.trim()),t.match(/^\s*uniform\s*([0-9a-z]+)\s+([0-9a-z_]+)(\[[^\]]+\])?/i)){let t={type:RegExp.$1,name:RegExp.$2};if(""!=RegExp.$3){t.type=t.type+"v";let e=RegExp.$3.substr(1,RegExp.$3.length-2).trim();t.dim=parseInt(e),isNaN(t.dim)&&(t.dim=n[e])}"sampler2D"==t.type&&(t.texunit=e++),r.push(t)}t.match(/^\s*(?:attribute|in)\s+([0-9a-z]+)\s*([0-9a-z_]+)/i)&&a.push({type:RegExp.$1,name:RegExp.$2})}return{uni:r,att:a}}const r=this.gl;return new Promise((e,i)=>{if(!t.vshader)return i("no vshader"),!1;if(!t.fshader)return i("no fshader"),!1;let a,n,o=[];t.vshader.text?a=t.vshader.text:t.vshader.src&&o.push(this.wwg.loadAjax(t.vshader.src).then(t=>{a=t,e()}).catch(t=>{i(t)})),t.fshader.text?n=t.fshader.text:t.fshader.src&&o.push(this.wwg.loadAjax(t.fshader.src).then(t=>{n=t,e()}).catch(t=>{i(t)})),Promise.all(o).then(t=>{let o={},h=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(h,a),r.compileShader(h),!r.getShaderParameter(h,r.COMPILE_STATUS))return i("vs error:"+r.getShaderInfoLog(h)),!1;o.vshader=h;let u=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(u,n),r.compileShader(u),!r.getShaderParameter(u,r.COMPILE_STATUS))return i("fs error:"+r.getShaderInfoLog(u)),!1;o.fshader=u;let c=r.createProgram();if(r.attachShader(c,h),r.attachShader(c,u),r.linkProgram(c),!r.getProgramParameter(c,r.LINK_STATUS))return i("link error:"+r.getProgramInfoLog(c)),!1;o.program=c,r.useProgram(c);let f=s(a);o.vs_att={};for(let t in f.att)f.att[t].pos=r.getAttribLocation(c,f.att[t].name),o.vs_att[f.att[t].name]=f.att[t];o.vs_uni={};for(let t in f.uni)f.uni[t].pos=r.getUniformLocation(c,f.uni[t].name),f.uni[t].cache=null,o.vs_uni[f.uni[t].name]=f.uni[t];let l=s(n);o.fs_uni={};for(let t in l.uni)l.uni[t].pos=r.getUniformLocation(c,l.uni[t].name),l.uni[t].cache=null,o.fs_uni[l.uni[t].name]=l.uni[t];e(o)}).catch(t=>{i(t)})})},e.prototype.Render.prototype.setUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.vs_uni[e]&&this.setUnivec(this.vs_uni[e],t.vs_uni[e]);if(t.fs_uni)for(let e in t.fs_uni)this.fs_uni[e]&&this.setUnivec(this.fs_uni[e],t.fs_uni[e]);return!0},e.prototype.Render.prototype.genTex=function(t,e){e||(e={flevel:0});let i=this.gl;const s={rgb:i.RGB,gray:i.LUMINANCE,grayalpha:i.LUMINANCE_ALPHA};let r=e.format&&s[e.format]?s[e.format]:i.RGBA,a=i.createTexture();switch(i.bindTexture(i.TEXTURE_2D,a),e.isarray?(t instanceof Float32Array?i.texImage2D(i.TEXTURE_2D,0,i.RGBA32F,e.width,e.height,0,r,i.FLOAT,t,0):i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,r,i.UNSIGNED_BYTE,t),e.flevel=0,e.nomipmap=!0):i.texImage2D(i.TEXTURE_2D,0,r,r,i.UNSIGNED_BYTE,t),e.nomipmap||i.generateMipmap(i.TEXTURE_2D),e.flevel){case 0:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);break;case 1:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);break;case 2:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)}return 2==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)):1==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.MIRRORED_REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.MIRRORED_REPEAT)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT)),this.wwg.ext_anis&&e.anisotropy&&i.texParameteri(i.TEXTURE_2D,this.wwg.ext_anis.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropy),i.bindTexture(i.TEXTURE_2D,null),a},e.prototype.Render.prototype.loadTex=function(t){this.gl;return new Promise((e,i)=>{if(t.src)if(t.opt&&t.opt.cors)this.wwg.loadImageAjax(t.src).then(i=>{e(this.genTex(i,t.opt))}).catch(t=>i(t));else{let s=new Image;s.onload=(()=>{e(this.genTex(s,t.opt))}),s.onerror=(()=>{i("cannot load image")}),s.src=t.src}else t.img instanceof Image?e(this.genTex(t.img,t.opt)):t.video?e(this.genTex(t.video,{nomipmap:!0,flevel:0,repeat:2})):t.buffer?void 0!=t.mrt?e(t.buffer.fb.t[t.mrt]):e(t.buffer.fb.t):t.texture?e(t.texture):t.canvas?e(this.genTex(t.canvas,t.opt)):t.array?(t.opt.isarray=!0,e(this.genTex(t.array,t.opt))):i("no image")})},e.prototype.Render.prototype.getTexIndex=function(t){if(!this.data.texture)return null;let e;for(e=0;e<this.data.texture.length&&this.data.texture[e].name!=t;e++);return e==this.data.texture.length?null:e},e.prototype.Render.prototype.addTex=function(t){return new Promise((e,i)=>{this.data.texture||(this.data.texture=[]),this.data.texture.push(t),this.loadTex(t).then(t=>{this.texobj.push(t),e(this.texobj.length-1)}).catch(t=>i(t))})},e.prototype.Render.prototype.removeTex=function(t){"string"==typeof t&&(t=this.getTexIndex(t)),null!==t&&(this.data.texture[t]=null,this.texobj[t]=null)},e.prototype.Render.prototype.frameBuffer=function(t){let e=this.gl;console.log("create framebuffer "+t.width+"x"+t.height);let i=t.mrt,s=e.UNSIGNED_BYTE,r=e.LINEAR;this.wwg.ext_ftex&&t.float&&(s=e.FLOAT,r=e.NEAREST,console.log("use float tex"));let a=[],n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n);let o=e.createRenderbuffer();if(e.bindRenderbuffer(e.RENDERBUFFER,o),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,o),i){let n=[];for(let o=0;o<i;o++)n[o]=e.createTexture(),e.bindTexture(e.TEXTURE_2D,n[o]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.framebufferTexture2D(e.FRAMEBUFFER,this.wwg.mrt_att+o,e.TEXTURE_2D,n[o],0),a.push(this.wwg.mrt_att+o)}else{let i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null);let h={ox:t.offsetX,oy:t.offsetY,width:t.width,height:t.height,f:n,d:o,t:fTexture};return i&&(h.fblist=a),h},e.prototype.Render.prototype.setRender=function(t){let e=this.gl;return this.env=t.env,this.data=t,new Promise((i,s)=>{if(!e)return void s("no init");let r=[];this.setShader({fshader:t.fshader,vshader:t.vshader}).then(a=>{if(this.vshader=a.vshader,this.fshader=a.fshader,this.program=a.program,this.vs_uni=a.vs_uni,this.vs_att=a.vs_att,this.fs_uni=a.fs_uni,t.texture)for(let e=0;e<t.texture.length;e++)r.push(this.loadTex(t.texture[e]));Promise.all(r).then(r=>{if(this.texobj=r,this.setUniValues(t)){this.env.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.env.face_cw?e.frontFace(e.CW):e.frontFace(e.CCW),this.env.nodepth?e.disable(e.DEPTH_TEST):e.enable(e.DEPTH_TEST);for(let e=0;e<t.model.length;e++)t.model[e].id=++this.modelId,t.model[e].obuf=this.setObj(t.model[e],!0);this.modelCount=t.model.length,this.env.offscreen&&(this.env.offscreen.mrt&&(this.wwg.ext_mrt||s("MRT not support")),this.fb=this.frameBuffer(this.env.offscreen)),i(this)}else s("no uniform name")}).catch(t=>{s(t)})}).catch(t=>{s(t)})})},e.prototype.Render.prototype.clear=function(){let t=this.env.clear_color;this.gl.clearColor(t[0],t[1],t[2],t[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},e.prototype.Render.prototype.f32Array=function(t){return t instanceof Float32Array?t:new Float32Array(t)},e.prototype.Render.prototype.i16Array=function(t){return t instanceof Int16Array?t:new Int16Array(t)},e.prototype.Render.prototype.i32Array=function(t){return t instanceof Uint32Array?t:new Uint32Array(t)},e.prototype.Render.prototype.setObj=function(t,e){let i,s=this.gl,r=t.geo,a=t.inst,n={};this.wwg.ext_vao&&(i=this.wwg.vao_create(),this.wwg.vao_bind(i),n.vao=i);let o=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,o);let h=0,u=[];for(let t=0;t<r.vtx_at.length;t++)u.push(this.vs_att[r.vtx_at[t]]),h+=this.wwg.vsize[this.vs_att[r.vtx_at[t]].type];n.ats=u,n.tl=h;let c,f,l=0;for(let t in this.vs_att)this.vs_att[t].pos>=0&&s.disableVertexAttribArray(this.vs_att[t].pos);for(let t=0;t<u.length;t++){let e=this.wwg.vsize[u[t].type];s.enableVertexAttribArray(this.vs_att[u[t].name].pos),s.vertexAttribPointer(this.vs_att[u[t].name].pos,e,s.FLOAT,!1,4*h,l),l+=4*e}if(n.vbo=o,r.idx&&(c=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,c),n.ibo=c),a){f=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,f);let t=0,e=[];for(let i=0;i<a.attr.length;i++)e.push(this.vs_att[a.attr[i]]),t+=this.wwg.vsize[this.vs_att[a.attr[i]].type];t*=4,n.iats=e,n.itl=t;let i=0;for(let r=0;r<e.length;r++){let n=a.divisor?a.divisor[r]:1,o=this.wwg.vsize[e[r].type],h=this.vs_att[e[r].name].pos;s.enableVertexAttribArray(h),s.vertexAttribPointer(h,o,s.FLOAT,!1,t,i),i+=4*o,this.wwg.inst_divisor(h,n)}n.inst=f}return this.wwg.ext_vao&&this.wwg.vao_bind(null),this.wwg.ext_vao&&this.wwg.vao_bind(i),e&&(s.bindBuffer(s.ARRAY_BUFFER,o),s.bufferData(s.ARRAY_BUFFER,this.f32Array(r.vtx),r.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),e&&r.idx&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,c),r.vtx.length/n.tl>65536&&this.wwg.ext_i32?(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i32Array(r.idx),s.STATIC_DRAW),n.i32=!0):(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i16Array(r.idx),s.STATIC_DRAW),n.i32=!1)),e&&a&&(s.bindBuffer(s.ARRAY_BUFFER,f),s.bufferData(s.ARRAY_BUFFER,this.f32Array(a.data),a.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),this.wwg.ext_vao&&this.wwg.vao_bind(null),n},e.prototype.Render.prototype.getModels=function(){return this.data.model.filter(t=>null!==t)},e.prototype.Render.prototype.getModelIdx=function(t){let e=!1;if("string"!=typeof t)e=parseInt(t);else for(let i=0;i<this.data.model.length;i++)if(null!==this.data.model[i]&&t==this.data.model[i].name){e=i;break}return e},e.prototype.Render.prototype.addModel=function(t){let e=!1;if(t.name&&(e=this.getModelIdx(t.name)),!1!==e)return this.data.model[e]=t,void(this.data.model[e].obuf=this.setObj(t,!0));t.id=++this.modelId,this.data.model.push(t),this.data.model[this.data.model.length-1].obuf=this.setObj(t,!0),this.modelCount++},e.prototype.Render.prototype.removeModel=function(t){let e=this.getModelIdx(t);return!1!==e&&(this.data.model[e].obuf=null,this.data.model[e]=null,this.modelCount--,!0)},e.prototype.Render.prototype.updateModel=function(t,e,i,s=null){let r=this.getModelIdx(t),a=this.data.model[r].obuf;switch(e){case"vbo":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.vbo);break;case"inst":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.inst)}s?this.gl.bufferSubData(this.gl.ARRAY_BUFFER,4*s.dofs,this.f32Array(i),s.sofs,s.count):this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.f32Array(i))},e.prototype.Render.prototype.updateModelInstance=function(t,e,i){let s=this.getModelIdx(t),r=this.data.model[s].obuf;this.data.model[s].inst.count=i,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.inst),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.f32Array(e),this.gl.DYNAMIC_DRAW)},e.prototype.Render.prototype.getModelData=function(t){let e=this.getModelIdx(t);return this.data.model[e]},e.prototype.Render.prototype.updateTex=function(t,e,i){"string"==typeof t&&(t=this.getTexIndex(t));var s=this.data.texture[t];this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[t]),s.array?i?s.array instanceof Float32Array?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.FLOAT,e,i.ofs):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e,i.ofs):s.array instanceof Float32Array?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA16F,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.FLOAT,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):i?i.wx>0&&i.wy>0?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.wx,i.wy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),s.opt&&!s.opt.nomipmap&&this.gl.generateMipmap(this.gl.TEXTURE_2D)},e.prototype.Render.prototype.pushUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.update_uni.vs_uni[e]=t.vs_uni[e];if(t.fs_uni)for(let e in t.fs_uni)this.update_uni.fs_uni[e]=t.fs_uni[e]},e.prototype.Render.prototype.updateUniValues=function(t){t?this.setUniValues(this.update_uni):this.update_uni={vs_uni:{},fs_uni:{}}},e.prototype.Render.prototype.draw=function(t,e){let i=this.gl;i.useProgram(this.program),this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,this.fb.f),this.env.offscreen.mrt&&this.wwg.mrt_draw(this.fb.fblist),i.viewport(fb.offsetX,fb.offsetY,this.fb.width,this.fb.height)),e||this.clear();let s=this.data.model;for(let e=0;e<s.length;e++){if(null===s[e])continue;let r=s[e];if(r.hide)continue;if(null==r.obuf)continue;let a=r.geo;if(this.updateUniValues(0),this.pushUniValues(this.data),this.pushUniValues(r),t){Array.isArray(t)||(t=[t]);for(let i=0;i<t.length;i++)if(this.pushUniValues(t[i]),t[i].model){let s=t[i].model[e];s&&this.pushUniValues(s)}}this.updateUniValues(1);let n=r.obuf,o=a.ofs>0?a.ofs:0;if(this.wwg.ext_vao)this.wwg.vao_bind(n.vao);else{i.bindBuffer(i.ARRAY_BUFFER,n.vbo);let t=0;for(let t in this.vs_att)i.disableVertexAttribArray(this.vs_att[t].pos);for(let e=0;e<n.ats.length;e++){let s=this.wwg.vsize[n.ats[e].type];i.enableVertexAttribArray(this.vs_att[n.ats[e].name].pos),i.vertexAttribPointer(this.vs_att[n.ats[e].name].pos,s,i.FLOAT,!1,4*n.tl,t),t+=4*s}if(n.ibo&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n.ibo),n.inst){let t=r.inst;i.bindBuffer(i.ARRAY_BUFFER,n.inst);let e=0;for(let s=0;s<n.iats.length;s++){let r=t.divisor?t.divisor[s]:1,a=this.wwg.vsize[n.iats[s].type],o=this.vs_att[n.iats[s].name].pos;i.enableVertexAttribArray(o),i.vertexAttribPointer(o,a,i.FLOAT,!1,n.itl,e),e+=4*a,this.wwg.inst_divisor(o,r)}}}r.preFunction&&r.preFunction(i,r,n),void 0!==r.blend&&(i.enable(i.BLEND),"alpha"==r.blend&&i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE)),void 0!==r.cull&&(r.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE));let h=this.wwg.dmodes[a.mode];if(void 0==h)return console.log("Error: illigal draw mode"),!1;r.inst?a.idx?this.wwg.inst_draw(h,a.idx.length,n.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,o,r.inst.count):this.wwg.inst_drawa(h,o,a.count>0?a.count:a.vtx.length/n.tl,r.inst.count):a.idx?i.drawElements(h,a.idx.length,n.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,o):i.drawArrays(h,o,a.count>0?a.count:a.vtx.length/n.tl),this.wwg.ext_vao&&this.wwg.vao_bind(null),void 0!==r.blend&&i.disable(i.BLEND),void 0!==r.cull&&(this.env.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE)),r.postFunction&&r.postFunction(i,r)}return this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.wwg.can.width,this.wwg.can.height)),!0},t.WWG=e}),t("skylark-poxp/PoxPlayer",["./poxp","./CanvasMatrix4","./GPad","./Pointer","./PoxCamera","./POXPDevice","./PoxProfile","./WBind","./WWG"],function(t,e,i,s,r,a,n,o,h){"use strict";var u=t.$;const c=e;Math.PI;class f{constructor(t,e){if(this.version="3.0.0",!Promise)throw"This browser is not supported!!";e||(e={}),this.can=t instanceof HTMLElement?t:document.querySelector(t);const s=new h,r={preserveDrawingBuffer:e.capture,antialias:!0,xrCompatible:!0},n=!e.noWebGL2;if(!(n&&s.init2(this.can,r)||s.init(this.can,r)))throw"wgl not supported!";if(e.needWebGL2&&2!=s.version)throw"needs wgl2";this.wwg=s;const u=o.create();this.param=u,u.bindInput("isStereo",e.ui&&e.ui.isStereo?e.ui.isStereo:"#isstereo"),u.bindInput("autorot",e.ui&&e.ui.autorot?e.ui.autorot:"#autorot"),u.bindInput("pause",e.ui&&e.ui.pause?e.ui.pause:"#pause"),u.bindHtml("fps",e.ui&&e.ui.fps?e.ui.fps:"#fps"),u.bindInput("camselect",e.ui&&e.ui.camselect?e.ui.camselect:"#camselect"),this.pixRatio=1,this.pox={can:this.can,wwg:this.wwg,synth:this.synth,poxp:this},this.setpox(this.pox),this.eventListener={},this.clearEvent(),i&&(this.pox.gPad=new i,this.pox.gPad.name="1",this.pox.gPad2=new i,this.pox.gPad2.name="2",this.pox.gPad.init(0,(t,e)=>{e&&this.pox.log("set 1"+t.gp.hand)})||this.pox.gPad2.init(1,(t,e)=>{e&&this.pox.log("set 2"+t.gp.hand)})||(this.pox.gPad.ev=(t=>{this.callEvent("gpad",t)})),this.pox.gPad2.ev=((t,e,i)=>{this.callEvent("gpad",t)})),this.resize(),window.addEventListener("resize",()=>{this.resize()}),this.pause=!0,this.setMouseEvent(),a.checkVR(this).then(t=>{t&&console.log("WebXR supported"),this.vrReady=t}),this.scenes=[],this.cam0=this.createCamera(),this.cam1=this.createCamera(),this.ccam=this.cam1}addEvent(t,e){let i=null;switch(t){case"frame":i={cb:e,active:!0},this.eventListener.frame.push(i);break;case"gpad":i={cb:e,active:!0},this.eventListener.gpad.push(i);break;case"vrchange":i={cb:e,active:!0},this.eventListener.vrchange.push(i);break;case"param":i={cb:e,active:!0},this.eventListener.param.push(i)}return i}removeEvent(t){this.eventListener.frame=this.eventListener.frame.filter(e=>e!==t),this.eventListener.gpad=this.eventListener.gpad.filter(e=>e!==t),this.eventListener.vrchange=this.eventListener.vrchange.filter(e=>e!==t),this.eventListener.param=this.eventListener.param.filter(e=>e!==t)}clearEvent(){this.eventListener.frame=[],this.eventListener.gpad=[],this.eventListener.vrchange=[],this.eventListener.param=[]}async load(t){return new Promise((e,i)=>{if("string"==typeof t){const s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="json",s.onload=(()=>{200==s.status?e(s.response):i("Ajax error:"+s.statusText)}),s.onerror=(()=>{i("Ajax error:"+s.statusText)}),s.send()}else e(t)})}loadImage(t){return t.match(/^https?:/)?this.wwg.loadImageAjax(t):new Promise((e,i)=>{const s=new Image;s.onload=(()=>{e(s)}),s.onerror=(()=>{i("cannot load image")}),s.src=t})}setpox(t){t.log=(t=>{this.errCb&&this.errCb(t)}),t.loadImage=this.loadImage,t.loadAjax=this.wwg.loadAjax,t.addEvent=((t,e)=>this.addEvent(t,e)),t.exitVR=this.exitVR;try{t.profile=new n(this)}catch(e){t.profile=null}t.setScene=(async t=>new Promise((e,i)=>{this.setScene(t).then(()=>{e()}).catch(t=>{console.log("render err"+t.stack)})})),t.getModule=(t=>this.m1),t.getWorker=(t=>this.w1),t.loadModule=(t=>this.loadModule(t)),t.initModule=(t=>this.initModule(t)),t.addModel=(t=>{if(this.render)return this.render.addModel(t)}),t.removeModel=(t=>{if(this.render)return this.render.removeModel(t)}),t.getModelData=(t=>{if(this.render)return this.render.getModelData(t)}),t.setModelData=((t,e)=>{const i=this.render.getModelData(t);if(e.matrix&&(i.mm=e.matrix),e.fs_uni)for(let t in e.fs_uni)i.fs_uni[t]=e.fs_uni[t];if(e.vs_uni)for(let t in e.vs_uni)i.vs_uni[t]=e.vs_uni[t];for(let t of["hide","parent","blend","cull"])void 0!==e[t]&&(i[t]=e[t]);e.geo&&this.render.updateModel(t,"vbo",e.geo.vtx,e.geo.subdata),e.inst&&this.render.updateModel(t,"inst",e.inst.data,e.inst.subdata)}),t.setSceneData=(t=>{if(t.fs_uni)for(let e in t.fs_uni)this.render.data.fs_uni[e]=t.fs_uni[e];if(t.vs_uni)for(let e in t.vs_uni)this.render.data.vs_uni[e]=t.vs_uni[e];if(t.env)for(let e in t.env)this.render.data.env[e]=t.env[e]}),t.addTex=(t=>this.render.addTex(t)),t.updateTex=((t,e)=>this.render.updateTex(t,e)),t.removeTex=(t=>this.render.removeTex(t)),t.loading=(t=>{u("loading")&&(u("loading").style.display=t?"block":"none")})}async loadScene(t){}async setsrc(t,e){this.pox.src=t,this.pox.setting=e,this.loadModuleSrc(t.js).then(t=>{this.initModule(t)})}loadModuleSrc(t,e){return this.loadModule("data:text/javascript;base64,"+btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)})),e)}async loadModule(t,e){return new Promise((e,i)=>{import(t).then(module=>{e(module)}).catch(t=>{this.pox.log("module "+t.stack),i(["module",t.stack])})})}initModule(module){return new Promise(async(t,e)=>{if(module.init)try{await module.init(this.pox)}catch(t){this.pox.log("init "+t.stack),e(["init",t.stack])}module.frame&&this.addEvent("frame",module.frame),t(module)})}stop(){window.cancelAnimationFrame(this.loop),this.pox.unload&&this.pox.unload()}cls(){this.render&&this.render.clear()}setError(t){this.errCb=t}callEvent(t,e,i){"object"==typeof e&&(e.rtime=this.rtime);let s=!0;if(this.pox.event)try{s=this.pox.event(t,e,i)}catch(t){this.errCb(t.stack)}if("vrchange"==t){this.cam1.vrchange(e);for(let t=0;t<this.eventListener.vrchange.length;t++){const i=this.eventListener.vrchange[t];i.active&&i.cb({vrmode:e})}}if("gpad"==t){-1==e.dbtn[5]&&a.closeVR();for(let t=0;t<this.eventListener.gpad.length;t++){const i=this.eventListener.gpad[t];if(i.active){let t={gpad:e};"left"==e.hand&&(t.leftPad=e),"right"==e.hand&&(t.rightPad=e),this.pox.setting.primaryPad==e.hand?t.primaryPad=e:t.secondaryPad=e,i.cb(t)}}}if("param"==t)for(let t=0;t<this.eventListener.param.length;t++){const i=this.eventListener.param[t];i.active&&i.cb(e)}return s}setParam(t,e){if(void 0===t)return;this.uparam=o.create();const i=[];for(let e in t){const s=t[e],r=s.name?s.name:e;let a="";s.type||(s.type="range"),s.step||(s.step=100),s.size&&(a="size="+s.size);let n=`<div class=b><div class=t>${r}</div> <input type=${s.type} id="_p_${e}" ${a} min=0 max=${s.step} style="${"disp"==s.type?"display:none":""}"  /><div class=v id=${"_p_d_"+e}></div></div>`;i.push(n)}function s(t){let e=(255*t).toString(16);return 1==e.length&&(e="0"+e),e}function r(e,i){void 0!==i&&"file"!=t[e].type&&"text"!=t[e].type&&"button"!=t[e].type&&("color"==t[e].type&&i?document.getElementById("_p_d_"+e).innerHTML=i.map(t=>t.toString().substr(0,5)):"range"==t[e].type?t[e].enum?document.getElementById("_p_d_"+e).innerHTML=t[e].enum[Math.floor(i)]:document.getElementById("_p_d_"+e).innerHTML=i.toString().substr(0,5):document.getElementById("_p_d_"+e).innerHTML=i)}e.innerHTML=i.join("");for(let e in t){let i=t[e];this.uparam.bindInput(e,"#_p_"+e),this.uparam.setFunc(e,{set:t=>{let a=t;return"color"==i.type?a="#"+s(t[0])+s(t[1])+s(t[2]):"range"==i.type&&(a="log10"==i.scale?Math.log10(t/i.min)/Math.log10(i.max/i.min)*i.step:(t-i.min)*i.step/(i.max-i.min)),r(e,a),a},get:t=>{let e=t;return"color"==i.type?e="string"==typeof t&&t.match(/#[0-9A-F]+/i)?[parseInt(t.substr(1,2),16)/255,parseInt(t.substr(3,2),16)/255,parseInt(t.substr(5,2),16)/255]:t:"range"==i.type&&(e="log10"==i.scale?Math.pow(10,Math.log10(i.min)+Math.log10(i.max/i.min)*t/i.step):t*(i.max-i.min)/i.step+i.min),e},input:t=>{r(e,this.uparam[e]),this.callEvent("param",{key:e,value:t})}}),this.uparam[e]=i.value}this.pox.param=this.uparam}setScene(t){const i=this.wwg,s=this.pox,r=this.can,n=(this.pixRatio,this.param),o=s.setting||{};o.scale||(o.scale=1),o.primaryPad||(o.primaryPad="right"),t.cam&&(s.setting.cam=t.cam),t.param&&(s.param=t.param),t.vshader={text:s.src.vs},t.fshader={text:s.src.fs},s.scene=t;const h=i.createRender();this.render=h,s.render=h;let u=this.ccam;this.isVR=!1;const f=this,l=new e,d=[],m=[],p=[],b=[],g=[];return new Promise((i,c)=>{h.setRender(t).then(()=>{this.errCb&&this.errCb("scene set ok"),this.renderStart&&this.renderStart(),s.setting&&s.setting.pixRatio?this.pixRatio=s.setting.pixRatio:this.pixRatio=1,this.resize(),s.setting.cam&&(this.cam0.setCam(s.setting.cam),this.cam0.setCam({camMode:"bird"}),this.cam1.setCam(s.setting.cam)),this.keyElelment.value="",this.clearEvent(),i();let t=(new Date).getTime();this.ctime=t,this.ltime=t;let c=0,x=0,y=t,_=0;const R=(i,E)=>{a.animationFrame(this,R,E);const w=(new Date).getTime();if(this.ctime=w,n.pause)return n.fps=0,c=x,void(t=w);x=c+w-t,_++,w-y>=500&&(n.fps=Math.floor(1e3*_/(w-y)+.5),_=0,y=w),this.ccam=n.camselect&&!this.isVR?this.cam0:this.cam1,u=this.ccam,s.cam=u.cam,n.autorot&&u.setCam({camRY:x/100%360});let A=null,T=null,P=null,M=null;const L=a.getInput();if(s.gPad){let t=s.gPad.get(),e=s.gPad2.get();this.isVR?(t.emu||"right"!=t.hand||(A=t),t.emu||"left"!=t.hand||(T=t),e.emu||"right"!=e.hand||(A=e),e.emu||"left"!=e.hand||(T=e)):("right"==t.hand&&(A=t),"right"==e.hand&&(A=e),"left"==t.hand&&(T=t),"left"==e.hand&&(T=e))}"left"==o.primaryPad?(P=T,M=A):(P=A,M=T),P&&P.conn||(P=M,M=null),u.cam.gPad&&u.setPad(P,M),u.update();let k=u.getMtx(o.scale,n.isStereo||f.isVR?1:0);for(let t=0;t<this.eventListener.frame.length;t++){const e=this.eventListener.frame[t];if(e.active)try{e.cb({render:h,pox:s,ccam:u,cam:u.cam,rtime:x/1e3,xrinput:L,rightPad:A,leftPad:T,primaryPad:P,secondaryPad:M})}catch(t){this.pox.log(t.stack),n.pause=!0}}let F={};s.update&&(F=s.update(h,u.cam,x,-1)),n.updateTimer(),function(t,i,s,o,h){t.data.model.sort((t,e)=>{if(null===t)return-1;if(null===e)return 1;let i=t.layer,s=e.layer;return void 0===i&&(i=0),void 0===s&&(s=0),i-s});let u=function(t,i){const s=[[],[]],a=t.data.model;for(let r=0;r<a.length;r++){let n=a[r];if(!n)continue;if(l.load(n.bm),n.mm&&l.multRight(n.mm),void 0!==n.parent&&l.multRight(v(t,n.parent)),t.data.group){let e=t.data.group;for(let i=0;i<e.length;i++){let s=e[i];if(s.bm)for(let e=0;e<s.model.length;e++)t.getModelIdx(s.model[e])==r&&l.multRight(s.bm)}}d[r]||(d[r]=new e),b[r]||(b[r]=new e),g[r]||(g[r]=new e),m[r]||(m[r]=[new e,new e]),p[r]||(p[r]=[new e,new e]),n.modelMtx=d[r];const o={vs_uni:{modelMatrix:d[r].load(l).getAsWebGLFloatArray(),vpMatrix:p[r][0].load(n.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),mvpMatrix:m[r][0].load(l).multRight(n.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),invMatrix:b[r].load(l).invert().transpose().getAsWebGLFloatArray(),minvMatrix:g[r].load(l).invert().getAsWebGLFloatArray()}},h={vs_uni:{modelMatrix:d[r].load(l).getAsWebGLFloatArray(),vpMatrix:p[r][1].load(n.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),mvpMatrix:m[r][1].load(l).multRight(n.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),invMatrix:b[r].load(l).invert().transpose().getAsWebGLFloatArray(),minvMatrix:g[r].load(l).invert().getAsWebGLFloatArray()}};o.fs_uni=o.vs_uni,h.fs_uni=h.vs_uni,o.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,o.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,h.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,h.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,s[0][r]=o,s[1][r]=h,n.modelMtx=d[r]}let n=[{model:s[0],fs_uni:{},vs_uni:{}},{model:s[1],fs_uni:{},vs_uni:{}}];return n[0].fs_uni.stereo=1,n[0].fs_uni.resolution=[r.width,r.height],n[0].fs_uni.camMatirx=i[0].camV.getAsWebGLFloatArray(),n[0].fs_uni.eyevec=[i[0].camX,i[0].camY,i[0].camZ],n[0].vs_uni.stereo=1,n[0].vs_uni.camMatirx=n[0].fs_uni.camMatirx,n[0].vs_uni.eyevec=n[0].fs_uni.eyevec,n[1].fs_uni.stereo=2,n[1].fs_uni.resolution=n[0].fs_uni.resolution,n[1].fs_uni.camMatirx=i[1].camV.getAsWebGLFloatArray(),n[1].fs_uni.eyevec=[i[1].camX,i[1].camY,i[1].camZ],n[1].vs_uni.stereo=2,n[1].vs_uni.camMatirx=n[1].fs_uni.camMatirx,n[1].vs_uni.eyevec=n[1].fs_uni.eyevec,n}(t,s);if(n.isStereo||f.isVR){let e=a.getViewport(r);t.viewport=e,a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,a.webGLLayer.framebuffer),void 0===h.vs_uni&&(h.vs_uni={}),void 0===h.fs_uni&&(h.fs_uni={}),h.fs_uni.rtime=o/1e3,h.fs_uni.time=h.fs_uni.rtime,h.vs_uni.rtime=o/1e3,h.vs_uni.time=h.vs_uni.rtime,t.gl.viewport(e.leftViewport.x,e.leftViewport.y,e.leftViewport.width,e.leftViewport.height),t.draw([h,u[0]],!1),t.gl.viewport(e.rightViewport.x,e.rightViewport.y,e.rightViewport.width,e.rightViewport.height),t.draw([h,u[1]],!0),a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null)}else void 0===h.vs_uni&&(h.vs_uni={}),void 0===h.fs_uni&&(h.fs_uni={}),u[0].vs_uni.stereo=0,h.fs_uni.rtime=o/1e3,h.fs_uni.time=h.fs_uni.rtime,h.vs_uni.rtime=o/1e3,h.vs_uni.time=h.vs_uni.rtime,t.gl.viewport(0,0,r.width,r.height),t.draw([h,u[0]],!1)}(h,0,k,x,F),a.submitFrame(this),this.ltime=w,this.rtime=x};R()}).catch(t=>{console.log(t),this.errCb&&this.errCb(t.stack?t.stack:t),c(t)})});function v(t,e){let i=t.getModelData(e);if(!i)return new c;let s=new c(i.bm);return s||(s=new c),i.mm&&s.multRight(i.mm),void 0!==i.parent&&s.multRight(v(t,i.parent)),s}}enterVR(){let t=!0;if(a.VRReady)console.log("enter VR"),a.presentVR(this);else if(document.body.webkitRequestFullscreen){console.log("fullscreen");const t=this.can.parentNode;this.ssize={width:t.offsetWidth,height:t.offsetHeight},document.addEventListener("webkitfullscreenchange",e=>{document.webkitFullscreenElement?(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px"):(t.style.width=this.ssize.width+"px",t.style.height=this.ssize.height+"px")}),t.webkitRequestFullscreen()}else t=!1;return t}exitVR(){a.VRReady&&a.closeVR(this)}setMouseEvent(){const t=document.createElement("input");t.setAttribute("type","checkbox"),t.style.position="absolute",t.style.zIndex=-100,t.style.top=0,t.style.left="-20px",t.style.width="10px",t.style.height="10px",t.style.padding=0,t.style.border="none",t.style.opacity=0,this.can.parentNode.appendChild(t),this.keyElelment=t,this.keyElelment.focus();let e=!1;const i=this.param,r=this.can;new s(r,{down:t=>{if(!this.ccam||i.pause)return!0;let s=!0;return(s=this.callEvent("down",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,sx:t.sx*this.pixRatio,sy:t.sy*this.pixRatio}))&&this.ccam.event("down",t),e=!0,"walk"==this.ccam.cam.camMode&&this.keyElelment.focus(),!1},move:t=>{if(!this.ccam||i.pause)return!0;let e=!0;return(e=this.callEvent("move",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,ox:t.ox*this.pixRatio,oy:t.oy*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio}))&&this.ccam.event("move",t),!1},up:t=>{if(!this.ccam)return!0;e=!1;let i=!0;return(i=this.callEvent("up",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio,ex:t.ex*this.pixRatio,ey:t.ey*this.pixRatio}))&&this.ccam.event("up",t),!1},out:t=>{if(!this.ccam)return!0;e=!1;let i=!0;return(i=this.callEvent("out",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio}))&&this.ccam.event("out",t),!1},wheel:t=>{if(!this.ccam||i.pause)return!0;let e=!0;return(e=this.callEvent("wheel",t))&&this.ccam.event("wheel",t),!1},gesture:(t,e)=>{if(!this.ccam||i.pause)return!0;let s=!0;return(s=this.callEvent("gesture",{z:t,r:e}))&&this.ccam.event("gesture",{z:t,r:e}),!1},gyro:t=>{if(!this.ccam||i.pause||a.VRReady)return!0;if(e)return!0;let s=!0;return(s=this.callEvent("gyro",t))&&this.ccam.event("gyro",t),!1}});o.addev(this.keyElelment,"keydown",t=>!!i.pause||(!(!this.pox.event||this.callEvent("keydown",t))||(this.ccam&&this.ccam.event("keydown",t),!1))),o.addev(this.keyElelment,"keyup",t=>!!i.pause||(!(!this.pox.event||this.callEvent("keyup",t))||(this.ccam&&this.ccam.event("keyup",t),!1))),document.querySelectorAll("#bc button").forEach(t=>{t.addEventListener("mousedown",t=>{this.callEvent("btndown",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("touchstart",t=>{this.callEvent("touchstart",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("mouseup",t=>{this.callEvent("btnup",t.target.id),this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),this.keyElelment.focus(),t.preventDefault()}),t.addEventListener("touchend",t=>{let e=!0;(e=this.callEvent("touchend",t.target.id))&&this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),t.preventDefault()})})}resize(){this.can.offsetWidth<300||a.isPresenting||(this.can.width=this.can.offsetWidth*this.pixRatio*window.devicePixelRatio,this.can.height=this.can.offsetHeight*this.pixRatio*window.devicePixelRatio)}}return f.prototype.createCamera=function(t){return new this.Camera(this,t)},f.prototype.Camera=r,t.init=function(e=null){let i;try{i=new f(e||"#screen1",{capture:!0,noWebGL2:!1})}catch(t){return console.log(t),void alert(t)}console.log(i),t.player=i,i.setError(t.msg),u("vrbtn").addEventListener("click",t=>{window.DeviceOrientationEvent&&DeviceOrientationEvent.requestPermission&&"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission(),window.addEventListener("deviceorientation",function(t){var e=window.orientation,s=90==e||-90==e;i.param.isStereo=s,u("cc").style.opacity=s?0:.4,u("footer").style.display=s?"none":"block",u("vrbtn").style.display=s?"none":"block",u("padl").style.opacity=s?0:.4,u("padr").style.opacity=s?0:.4,window.scrollTo(0,1e3)}),i.enterVR()}),u("screen1").addEventListener("mousedown",t=>{i.keyElelment.focus()});let s={},r={};function a(t,e){t.buttons=[{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1}],t.axes=[0,0],t.hand=e?"left":"right"}function n(t,e,i){const s=i.target.getAttribute("data-key");if(2==s){const e=i.target.getAttribute("data-dir");t.axes[2]=0,t.axes[3]=0,t.axes[2&e?1:0]=1&e?.8:-.8,t.axes[2&e?3:2]=1&e?.8:-.8}t.buttons[s].touched=!0,e&&e.set(t),i.preventDefault()}function o(t,e,i){const s=i.target.getAttribute("data-key");if(2==s){const e=i.target.getAttribute("data-dir");t.axes[2]=0,t.axes[3]=0,t.axes[2&e?1:0]=1&e?.8:-.8,t.axes[2&e?3:2]=1&e?.8:-.8}t.buttons[s].touched=!0,t.buttons[s].pressed=!0,e&&e.set(t),i.preventDefault()}function h(t,e,i){const s=i.target.getAttribute("data-key");t.buttons[s].pressed=!0,e&&e.set(t),i.preventDefault()}function c(t,e,i){const s=i.target.getAttribute("data-key");t.buttons[s].pressed=!1,e&&e.set(t),i.preventDefault()}function l(t,e,i,s){const r=s.target.getAttribute("data-key");t.buttons[r].touched=!1,t.buttons[r].pressed=!1,a(t,i),e&&e.set(t),s.preventDefault()}function d(t,e,i,s){a(t,i),e&&e.set(t),s.preventDefault()}a(s,!0),i.pox.gPad.set(s),a(r,!1),i.pox.gPad2.set(r),document.querySelectorAll("#padl button").forEach(t=>{t.addEventListener("mouseover",t=>{n(s,i.pox.leftPad,t)}),t.addEventListener("touchstart",t=>{o(s,i.pox.leftPad,t)}),t.addEventListener("mousedown",t=>{h(s,i.pox.leftPad,t)}),t.addEventListener("mouseup",t=>{c(s,i.pox.leftPad,t)}),t.addEventListener("touchend",t=>{l(s,i.pox.leftPad,!0,t)}),t.addEventListener("mouseout",t=>{d(s,i.pox.leftPad,!0,t)}),t.addEventListener("touchcancel",t=>{d(s,i.pox.leftPad,!0,t)})}),document.querySelectorAll("#padr button").forEach(t=>{t.addEventListener("mouseover",t=>{n(r,i.pox.rightPad,t)}),t.addEventListener("touchstart",t=>{o(r,i.pox.rightPad,t)}),t.addEventListener("mousedown",t=>{h(r,i.pox.rightPad,t)}),t.addEventListener("mouseup",t=>{c(r,i.pox.rightPad,t)}),t.addEventListener("touchend",t=>{l(r,i.pox.rightPad,!1,t)}),t.addEventListener("mouseout",t=>{d(r,i.pox.rightPad,!1,t)}),t.addEventListener("touchcancel",t=>{d(r,i.pox.rightPad,!1,t)})})},t.load=function(t,e=null){const i=this.player;return new Promise(async(s,r)=>{if(null==e&&(e=location.search.substr(1).split("&")),e[0].match(/.+\.json/))i.load(e[0]+"?"+Math.random()).then(t=>{e.shift(),s({src:t,query:e})});else if("string"==typeof t)i.load(t+"?"+Math.random()).then(t=>{s({src:t,query:e})});else if(null!==t)s({src:t,query:e});else{var a,n=localStorage.getItem("poxe_save");n&&(a=JSON.parse(n)),i.load(a).then(t=>{s({src:t,query:e})}).catch(t=>{r("cannot load source")})}})},t.set=function(e,i){return new Promise(async(i,s)=>{if(e.modules)try{const i=await t.player.loadModuleSrc(e.modules[0]);for(k in t.player.m1=i,i)console.log(k)}catch(t){}if(e.workers)try{const i=new Blob([e.workers[0]]);t.player.w1=new Worker(window.URL.createObjectURL(i))}catch(t){}t.setting=e.settings,""==document.title&&(document.title=`PoExE:${t.setting.name}`),e.settings.copyright&&(u("footer").innerHTML=t.setting.copyright),e.settings.gui&&t.player.setParam(e.settings.gui,u("pui")),t.player.setsrc(e.renders[0],e.settings).then(e=>{t.msg("init ok")}).catch(e=>{console.log(e),console.log("catch"),t.msg(t.player.emsg),s()})})},t.PoxPlayer=f}),t("skylark-poxp/main",["./poxp","./PoxPlayer"],function(t,e){return t}),t("skylark-poxp",["skylark-poxp/main"],function(t){return t})}(r),!a){var h=require("skylark-langx-ns");n?module.exports=h:e.skylarkjs=h}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-poxp.js.map
