/**
 * skylark-pox - A version of pox that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-pox/
 * @license MIT
 */
define(["./pox","./CanvasMatrix4"],function(t,e){class s{primitive(t,s){s||(s={});let h=s.wx?s.wx:1,o=s.wy?s.wy:1,l=s.wz?s.wz:1,n=s.div?s.div:10,r=s.divx?s.divx:n,a=s.divy?s.divy:n,p=s.divz?s.divz:n,i=s.ninv?-1:1,u=[],c=[],f=[],b=[],v=2*Math.PI,g={r05:{v:[[-.52573111,-.7236068,.4472136],[-.85065081,.2763932,.4472136],[-0,.89442719,.4472136],[.85065081,.2763932,.4472136],[.52573111,-.7236068,.4472136],[0,-.89442719,-.4472136],[-.85065081,-.2763932,-.4472136],[-.52573111,.7236068,-.4472136],[.52573111,.7236068,-.4472136],[.85065081,-.2763932,-.4472136],[0,0,1],[-0,0,-1]],s:[[0,1,6],[0,6,5],[0,5,4],[0,4,10],[0,10,1],[1,2,7],[1,7,6],[1,10,2],[2,3,8],[2,8,7],[2,10,3],[3,4,9],[3,9,8],[3,10,4],[4,5,9],[5,6,11],[5,11,9],[6,7,11],[7,8,11],[8,9,11]]},r04:{v:[[-.35682209,-.49112347,.79465447],[.35682209,-.49112347,.79465447],[.57735027,-.79465447,.18759247],[0,-.98224695,-.18759247],[-.57735027,-.79465447,.18759247],[-.57735027,.18759247,.79465447],[.57735027,.18759247,.79465447],[.93417236,-.303531,-.18759247],[-0,-.607062,-.79465447],[-.93417236,-.303531,-.18759247],[-.93417236,.303531,.18759247],[0,.607062,.79465447],[.93417236,.303531,.18759247],[.57735027,-.18759247,-.79465447],[-.57735027,-.18759247,-.79465447],[-.57735027,.79465447,-.18759247],[0,.98224695,.18759247],[.57735027,.79465447,-.18759247],[.35682209,.49112347,-.79465447],[-.35682209,.49112347,-.79465447]],s:[[0,1,6,11,5],[0,5,10,9,4],[0,4,3,2,1],[1,2,7,12,6],[2,3,8,13,7],[3,4,9,14,8],[5,11,16,15,10],[6,12,17,16,11],[7,13,18,17,12],[8,14,19,18,13],[9,10,15,19,14],[15,16,17,18,19]]},r03:{v:[[-.57735027,-.57735027,.57735027],[-.57735027,.57735027,.57735027],[.57735027,.57735027,.57735027],[.57735027,-.57735027,.57735027],[-.57735027,-.57735027,-.57735027],[-.57735027,.57735027,-.57735027],[.57735027,.57735027,-.57735027],[.57735027,-.57735027,-.57735027]],s:[[0,1,5,4],[0,4,7,3],[0,3,2,1],[1,2,6,5],[2,3,7,6],[4,5,6,7]]},r02:{v:[[-.70710678,-.70710678,0],[-.70710678,.70710678,0],[.70710678,.70710678,0],[.70710678,-.70710678,0],[0,0,-1],[0,0,1]],s:[[0,1,4],[0,4,3],[0,3,5],[0,5,1],[1,2,4],[1,5,2],[2,3,4],[2,5,3]]},r01:{v:[[-.81649658,-.47140452,.33333333],[.81649658,-.47140452,.33333333],[0,0,-1],[0,.94280904,.33333333]],s:[[0,1,3],[0,3,2],[0,2,1],[1,2,3]]},s11:{v:[[-.13149606,-.40470333,.90494412],[-.34426119,-.25012042,.90494412],[-.42553024,-1e-8,.90494412],[-.34426119,.2501204,.90494412],[-.13149606,.40470332,.90494412],[.13149611,.40470332,.90494412],[.34426124,.2501204,.90494412],[.42553028,-1e-8,.90494412],[.34426124,-.25012042,.90494412],[.13149611,-.40470333,.90494412],[-.13149606,-.62841783,.76668096],[-.34426119,-.69754941,.6284178],[-.42553024,-.80940666,.4047033],[-.34426119,-.92126391,.18098881],[-.13149606,-.99039549,.04272564],[.13149611,-.99039549,.04272564],[.34426124,-.92126391,.18098881],[.42553028,-.80940666,.4047033],[.34426124,-.69754941,.6284178],[.13149611,-.62841783,.76668096],[-.55702632,-.5429665,.6284178],[-.55702632,-.319252,.76668096],[-.63829537,-.06913159,.76668096],[-.76979145,.11185724,.6284178],[-.90128753,.15458291,.4047033],[-.98255658,.04272566,.1809888],[-.98255658,-.18098884,.04272564],[-.90128753,-.43110925,.04272564],[-.76979145,-.61209808,.18098881],[-.63829537,-.65482375,.4047033],[-.82001848,.54296648,.18098881],[-.82001848,.40470332,.4047033],[-.6885224,.36197765,.6284178],[-.47575727,.43110923,.76668096],[-.26299214,.58569215,.76668096],[-.13149606,.76668098,.6284178],[-.13149606,.90494414,.4047033],[-.26299214,.94766981,.18098881],[-.47575727,.87853823,.04272564],[-.6885224,.72395531,.04272564],[.47575732,.87853821,.04272564],[.26299219,.94766979,.1809888],[.13149611,.90494413,.4047033],[.13149611,.76668098,.6284178],[.26299219,.58569215,.76668096],[.47575732,.43110923,.76668096],[.68852245,.36197765,.6284178],[.82001853,.4047033,.40470331],[.82001853,.54296646,.18098881],[.68852245,.72395529,.04272564],[.63829541,-.65482375,.4047033],[.7697915,-.61209808,.18098881],[.90128758,-.43110925,.04272564],[.98255663,-.18098884,.04272564],[.98255647,.04272561,.18098879],[.9012875,.15458288,.40470331],[.7697915,.11185724,.6284178],[.63829541,-.06913159,.76668096],[.55702637,-.319252,.76668096],[.55702637,-.5429665,.6284178],[-.47575727,-.87853824,-.04272569],[-.6885224,-.72395533,-.04272569],[-.82001848,-.5429665,-.18098886],[-.82001848,-.40470333,-.40470335],[-.6885224,-.36197767,-.62841785],[-.47575727,-.43110925,-.76668101],[-.26299214,-.58569216,-.76668101],[-.13149605,-.76668099,-.62841784],[-.13149606,-.90494416,-.40470335],[-.26299214,-.94766982,-.18098885],[-.90128753,-.15458292,-.40470335],[-.98255658,-.04272567,-.18098885],[-.98255658,.18098882,-.04272569],[-.90128753,.43110923,-.04272569],[-.76979145,.61209806,-.18098885],[-.63829536,.65482373,-.40470335],[-.55702632,.54296648,-.62841785],[-.55702632,.31925199,-.76668101],[-.63829537,.06913157,-.76668101],[-.76979145,-.11185726,-.62841785],[-.13149606,.62841781,-.76668101],[-.34426119,.6975494,-.62841785],[-.42553023,.80940665,-.40470335],[-.34426119,.92126389,-.18098885],[-.13149606,.99039547,-.04272569],[.13149611,.99039546,-.04272569],[.34426124,.92126387,-.18098886],[.42553028,.80940661,-.40470335],[.34426124,.69754939,-.62841785],[.13149611,.62841781,-.76668101],[.76979153,-.11185725,-.62841782],[.63829541,.06913155,-.76668097],[.55702634,.31925197,-.76668097],[.55702635,.54296649,-.62841782],[.63829541,.6548237,-.40470335],[.76979149,.61209803,-.18098885],[.9012875,.43110919,-.04272571],[.98255648,.18098877,-.04272572],[.9825564,-.04272561,-.18098874],[.90128711,-.15458281,-.4047032],[.26299219,-.94766982,-.18098885],[.13149611,-.90494416,-.40470335],[.13149611,-.76668098,-.62841784],[.26299219,-.58569215,-.76668099],[.47575682,-.43110886,-.76668009],[.68852237,-.36197738,-.6284173],[.82001805,-.40470325,-.40470322],[.82001853,-.5429665,-.18098885],[.68852245,-.72395533,-.04272569],[.47575732,-.87853824,-.04272569],[-.13149606,-.40470333,-.90494417],[-.34426119,-.25012042,-.90494417],[-.42553024,-0,-.90494417],[-.34426119,.2501204,-.90494417],[-.13149606,.40470332,-.90494417],[.13149611,.40470332,-.90494417],[.3442612,.25012038,-.90494414],[.42553027,-3e-8,-.90494414],[.3442606,-.25012001,-.90494332],[.13149611,-.40470332,-.90494416]],s:[[0,1,21,20,11,10],[0,10,19,9],[0,9,8,7,6,5,4,3,2,1],[1,2,22,21],[2,3,33,32,23,22],[3,4,34,33],[4,5,44,43,35,34],[5,6,45,44],[6,7,57,56,46,45],[7,8,58,57],[8,9,19,18,59,58],[10,11,12,13,14,15,16,17,18,19],[11,20,29,12],[12,29,28,61,60,13],[13,60,69,14],[14,69,68,101,100,15],[15,100,109,16],[16,109,108,51,50,17],[17,50,59,18],[20,21,22,23,24,25,26,27,28,29],[23,32,31,24],[24,31,30,73,72,25],[25,72,71,26],[26,71,70,63,62,27],[27,62,61,28],[30,31,32,33,34,35,36,37,38,39],[30,39,74,73],[35,43,42,36],[36,42,41,85,84,37],[37,84,83,38],[38,83,82,75,74,39],[40,41,42,43,44,45,46,47,48,49],[40,49,95,94,87,86],[40,86,85,41],[46,56,55,47],[47,55,54,97,96,48],[48,96,95,49],[50,51,52,53,54,55,56,57,58,59],[51,108,107,52],[52,107,106,99,98,53],[53,98,97,54],[60,61,62,63,64,65,66,67,68,69],[63,70,79,64],[64,79,78,112,111,65],[65,111,110,66],[66,110,119,103,102,67],[67,102,101,68],[70,71,72,73,74,75,76,77,78,79],[75,82,81,76],[76,81,80,114,113,77],[77,113,112,78],[80,81,82,83,84,85,86,87,88,89],[80,89,115,114],[87,94,93,88],[88,93,92,116,115,89],[90,91,92,93,94,95,96,97,98,99],[90,99,106,105],[90,105,104,118,117,91],[91,117,116,92],[100,101,102,103,104,105,106,107,108,109],[103,119,118,104],[110,111,112,113,114,115,116,117,118,119]]},s06:{v:[[-.20177411,-.27771823,.93923362],[-.40354821,-.55543646,.72707577],[-.20177411,-.8331547,.51491792],[.20177411,-.8331547,.51491792],[.40354821,-.55543646,.72707577],[.20177411,-.27771823,.93923362],[-.32647736,.10607893,.93923362],[-.65295472,.21215785,.72707577],[-.85472883,-.06556038,.51491792],[-.73002557,-.44935754,.51491792],[-.73002557,-.66151539,.17163931],[-.40354821,-.89871508,.17163931],[-.20177411,-.96427546,-.17163931],[.20177411,-.96427546,-.17163931],[.40354821,-.89871508,.17163931],[.73002557,-.66151539,.17163931],[.73002557,-.44935754,.51491792],[.85472883,-.06556038,.51491792],[.65295472,.21215785,.72707577],[.32647736,.10607893,.93923362],[-0,.34327861,.93923362],[-.65295472,.55543646,.51491792],[-.85472883,.48987608,.17163931],[-.97943209,.10607893,.17163931],[-.97943209,-.10607892,-.17163931],[-.85472883,-.48987608,-.17163931],[-.65295472,-.55543646,-.51491792],[-.32647736,-.79263615,-.51491792],[-0,-.68655723,-.72707577],[.32647736,-.79263615,-.51491792],[.65295472,-.55543646,-.51491792],[.85472883,-.48987608,-.17163931],[.97943209,-.10607893,-.17163931],[.97943209,.10607893,.17163931],[.85472883,.48987608,.17163931],[.65295472,.55543646,.51491792],[.32647736,.79263615,.51491792],[0,.68655723,.72707577],[-.32647736,.79263615,.51491792],[-.73002557,.66151539,-.17163931],[-.73002557,.44935754,-.51491792],[-.85472883,.06556038,-.51491792],[-.65295472,-.21215785,-.72707577],[-.32647736,-.10607892,-.93923362],[0,-.34327861,-.93923362],[.32647736,-.10607892,-.93923362],[.65295472,-.21215785,-.72707577],[.85472883,.06556038,-.51491792],[.73002557,.44935754,-.51491792],[.73002557,.66151539,-.17163931],[.40354821,.89871508,-.17163931],[.20177411,.96427546,.17163931],[-.20177411,.96427546,.17163931],[-.40354821,.89871508,-.17163931],[-.20177411,.83315469,-.51491792],[-.40354821,.55543646,-.72707577],[-.20177411,.27771823,-.93923362],[.2017741,.27771823,-.93923362],[.40354821,.55543646,-.72707577],[.20177411,.83315469,-.51491792]],s:[[0,5,19,20,6],[0,6,7,8,9,1],[0,1,2,3,4,5],[1,9,10,11,2],[2,11,12,13,14,3],[3,14,15,16,4],[4,16,17,18,19,5],[6,20,37,38,21,7],[7,21,22,23,8],[8,23,24,25,10,9],[10,25,26,27,12,11],[12,27,28,29,13],[13,29,30,31,15,14],[15,31,32,33,17,16],[17,33,34,35,18],[18,35,36,37,20,19],[21,38,52,53,39,22],[22,39,40,41,24,23],[24,41,42,26,25],[26,42,43,44,28,27],[28,44,45,46,30,29],[30,46,47,32,31],[32,47,48,49,34,33],[34,49,50,51,36,35],[36,51,52,38,37],[39,53,54,55,40],[40,55,56,43,42,41],[43,56,57,45,44],[45,57,58,48,47,46],[48,58,59,50,49],[50,59,54,53,52,51],[54,59,58,57,56,55]]}};switch(t){case"sphere":for(let t=0;t<=n;++t){let e=t/(0+n),s=Math.cos(Math.PI*e),r=Math.sin(Math.PI*e);for(let t=0;t<=2*n;++t){let a=t/(0+2*n),p=Math.cos(v*a)*r,b=Math.sin(v*a)*r;u.push([p*h,s*o,b*l]),c.push([p*i,s*i,b*i]),f.push([i>0?1-a:a,1-e])}}let e=2*n+1;for(let t=0;t<n;++t){let s=t*e;for(let t=0;t<2*n;++t)i>0?b.push([s+t,s+t+1,s+t+e],[s+t+e,s+t+1,s+t+1+e]):b.push([s+t+e,s+t+1,s+t],[s+t+1+e,s+t+1,s+t+e])}break;case"sphere2":const _=s.div?s.div:6,m=Math.PI/2;for(let t=0;t<_;t++){let e=Math.sin(m*t/_),s=Math.cos(m*t/_),n=_-t;for(let r=0;r<=n;r++){let a=Math.cos(m*r/n)*s,p=Math.sin(m*r/n)*s;u.push([a*h,e*o,p*l]),c.push([a,e,p]),f.push([1-r/n/4,.5+t/_/2])}}u.push([0,o,0]),c.push([0,1,0]),f.push([.75,1]);let M=0;for(let t=0;t<_;t++){let e=2*(_-t)-1,s=_-t+1;for(let t=0;t<e;t++){let e=Math.floor(t/2);t%2==0?i>0?b.push([e+M,e+M+s,e+M+1]):b.push([e+M,e+M+1,e+M+s]):i>0?b.push([e+1+M,e+M+s,e+M+s+1]):b.push([e+1+M,e+M+s+1,e+M+s])}M+=s}let x=u.length,y=b.length;for(let t=0;t<x;t++)u.push([u[t][0],-u[t][1],u[t][2]]),c.push([u[t][0],-u[t][1],u[t][2]]),f.push([f[t][0],1-f[t][1]]);for(let t=0;t<y;t++)b.push([b[t][0]+x,b[t][2]+x,b[t][1]+x]);x=u.length,y=b.length;for(let t=0;t<x;t++)u.push([-u[t][0],u[t][1],u[t][2]]),c.push([-u[t][0],u[t][1],u[t][2]]),f.push([1-f[t][0]+.5,f[t][1]]);for(let t=0;t<y;t++)b.push([b[t][0]+x,b[t][2]+x,b[t][1]+x]);x=u.length,y=b.length;for(let t=0;t<x;t++)u.push([u[t][0],u[t][1],-u[t][2]]),c.push([u[t][0],u[t][1],-u[t][2]]),f.push([1-f[t][0],f[t][1]]);for(let t=0;t<y;t++)b.push([b[t][0]+x,b[t][2]+x,b[t][1]+x]);break;case"cylinder":a=s.divy?s.divy:1;for(let t=0;t<=n;++t){let e=t/(0+n),s=Math.sin(v*e)*l,r=Math.cos(v*e)*h,p=2*o/a;for(let t=0;t<=a;t++)u.push([r,t*p-o,s]),c.push([r*i,0,s*i]),f.push([i>0?1-e:e,t/a])}for(let t=0;t<n;t++)for(let e=0;e<a;e++){let s=t*(a+1)+e;i<0?b.push([s,s+(a+1),s+(a+1)+1,s+1]):b.push([s,s+1,s+3,s+2])}s.cap;break;case"ring":a=s.divy?s.divy:1;for(let t=0;t<=n;++t){let e=t/(0+n),s=Math.sin(v*e)*l,r=Math.cos(v*e)*h;for(let t=0;t<a;t++)u.push([r,o,s]),c.push([r*i,0,s*i]),f.push([i>0?1-e:e,1]),u.push([r,-o,s]),c.push([r*i,0,s*i,0]),f.push([i>0?1-e:e,0])}for(let t=0;t<n;t++)i>0?b.push([2*t,2*t+2,2*t+3,2*t+1]):b.push([2*t,2*t+1,2*t+3,2*t+2]);s.cap;break;case"cone":for(let t=0;t<=n;++t){let e=t/(0+n),s=Math.sin(v*e)*l,r=Math.cos(v*e)*h;u.push([0,o,0]),c.push([r*i,0,s*i]),f.push([i>0?1-e:e,1]),u.push([r,-o,s]),c.push([r*i,0,s*i,0]),f.push([i>0?1-e:e,0])}for(let t=0;t<n;t++)i>0?b.push([2*t,2*t+2,2*t+3,2*t+1]):b.push([2*t,2*t+1,2*t+3,2*t+2]);break;case"disc":for(let t=0;t<n;++t){let e=t/(0+n),s=Math.cos(v*e)*l,o=Math.sin(v*e)*h;u.push([o,0,s]),c.push([0,1,0]),f.push([(o/h+1)/2,(s/l+1)/2])}u.push([0,0,0]),c.push([0,1,0]),f.push([.5,.5]);for(let t=0;t<n-1;t++)b.push([t,t+1,n]);b.push([n-1,0,n]);break;case"plane":s.wz?s.wx?(u=[[h,0,l],[h,0,-l],[-h,0,-l],[-h,0,l]],c=[[0,i,0],[0,i,0],[0,i,0],[0,i,0]]):(u=[[0,-o,-l],[0,o,-l],[0,o,l],[0,-o,l]],c=[[i,0,0],[i,0,0],[i,0,0],[i,0,0]]):(u=[[h,-o,0],[h,o,0],[-h,o,0],[-h,-o,0]],c=[[0,0,i],[0,0,i],[0,0,i],[0,0,i]]),f=i>0?[[1,0],[1,1],[0,1],[0,0]]:[[-1,0],[-1,1],[0,1],[0,0]],b=i>0?[[0,1,2],[2,3,0]]:[[2,1,0],[0,3,2]];break;case"box":u=[[h,o,l],[h,-o,l],[-h,-o,l],[-h,o,l],[h,o,-l],[h,-o,-l],[-h,-o,-l],[-h,o,-l],[h,o,l],[h,-o,l],[h,-o,-l],[h,o,-l],[-h,o,l],[-h,-o,l],[-h,-o,-l],[-h,o,-l],[h,o,l],[h,o,-l],[-h,o,-l],[-h,o,l],[h,-o,l],[h,-o,-l],[-h,-o,-l],[-h,-o,l]],c=[[0,0,i],[0,0,i],[0,0,i],[0,0,i],[0,0,-i],[0,0,-i],[0,0,-i],[0,0,-i],[i,0,0],[i,0,0],[i,0,0],[i,0,0],[-i,0,0],[-i,0,0],[-i,0,0],[-i,0,0],[0,i,0],[0,i,0],[0,i,0],[0,i,0],[0,-i,0],[0,-i,0],[0,-i,0],[0,-i,0]],f=1==s.cubemap?[[.75,2/3],[.75,1/3],[1,1/3],[1,2/3],[.5,2/3],[.5,1/3],[.25,1/3],[.25,2/3],[.75,2/3],[.75,1/3],[.5,1/3],[.5,2/3],[0,2/3],[0,1/3],[.25,1/3],[.25,2/3],[.5,1],[.5,2/3],[.25,2/3],[.25,1],[.5,0],[.5,1/3],[.25,1/3],[.25,0]]:[[1,1],[1,0],[0,0],[0,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[1,1],[1,0],[0,0],[0,1],[1,0],[1,1],[0,1],[0,0],[1,1],[1,0],[0,0],[0,1]],b=i>0?[[3,1,0],[2,1,3],[4,5,7],[7,5,6],[8,9,11],[11,9,10],[15,13,12],[14,13,15],[16,17,19],[19,17,18],[23,21,20],[22,21,23]]:[[0,1,3],[3,1,2],[7,5,4],[6,5,7],[11,9,8],[10,9,11],[12,13,15],[15,13,14],[19,17,16],[18,17,19],[20,21,23],[23,21,22]];break;case"mesh":return this.parametricModel(function(t,e){return{px:(t-.5)*h,py:0,pz:(e-.5)*l,nx:0,ny:1,nz:0,mu:t,mv:e}},{start:1,end:0,div:r},{start:0,end:1,div:p},{ninv:s.ninv}),this;case"torus":return this.parametricModel(function(t,e){let n=s.sr?s.sr:.5,r=t,a=-e,p=Math.sin(r*v),i=Math.cos(r*v),u=Math.sin(a*v),c=n*u*p,f=n*u*i,b=n*Math.cos(a*v);Math.hypot(c,b,f);return{px:(1*p+1*c)*h,py:1*b*o,pz:(1*i+1*f)*l,nx:0,ny:0,nz:0,mu:t,mv:e}},{start:0,end:1,div:2*r},{start:0,end:1,div:a},{ninv:s.ninv}),this;case"polyhedron":if(!g[s.shape])return null;let w=g[s.shape].v,k=g[s.shape].s,z=0;for(let t=0;t<k.length;t++){let e=0,s=0,h=0,o=[];for(let l=k[t].length-1;l>=0;l--){let n=w[k[t][l]];u.push([n[0],n[2],n[1]]),e+=n[0],s+=n[2],h+=n[1],o.push(z),z++}let l=Math.hypot(e,s,h);for(let o=0;o<k[t].length;o++)c.push([e/l,s/l,h/l]);b.push(o)}f=null;break;case"icosa":w=g.r05.v,k=g.r05.s;for(let t=0;t<w.length;t++){let e=[w[t][0],w[t][2],w[t][1]];u.push(e),c.push(e),d(e)}for(let t=0;t<k.length;t++)i<0?b.push([k[t][0],k[t][1],k[t][2]]):b.push([k[t][0],k[t][2],k[t][1]]);const A=void 0!==s.div?s.div:2;for(let t=0;t<A;t++)j(u,b);for(let t=0;t<u.length;t++)u[t][0]*=h,u[t][1]*=o,u[t][2]*=l}function d(t){let e=Math.atan2(t[2],t[0])/Math.PI/2;f.push([(1-e)%1,1-Math.acos(t[1])/Math.PI])}function j(t,s){let h=t.length,o=s.length;for(let l=0;l<o;l++){let o=s[l][0],n=s[l][1],r=s[l][2],a=t[o],p=t[n],i=t[r],u=e.V3norm(e.V3add(a,p)),f=e.V3norm(e.V3add(p,i)),b=e.V3norm(e.V3add(i,a));t.push(u),t.push(f),t.push(b),c.push(u),c.push(f),c.push(b),d(u),d(f),d(b),s[l]=[o,h,h+2],s.push([h,h+1,h+2]),s.push([n,h+1,h]),s.push([r,h+2,h+1]),h+=3}}return this.obj_v=u,this.obj_n=c,this.obj_t=f,this.obj_i=b,this}parametricModel(t,e,s,h){let o=[],l=[],n=[],r=[],a=h&&h.ninv?-1:1,p=(e.end-e.start)/e.div,i=(s.end-s.start)/s.div;for(let h=0;h<=e.div;h++)for(let r=0;r<=s.div;r++){let u=e.start+p*h,c=s.start+i*r,f=t(u,c);if(o.push([f.px,f.py,f.pz]),void 0!=f.mu&&n.push([f.mu,f.mv]),0==f.nx&&0==f.ny&&0==f.nz){let e=p/10,s=i/10,h=t(u-e,c),o=t(u+e,c),l=(o.px-h.px)/(2*e),n=(o.py-h.py)/(2*e),r=(o.pz-h.pz)/(2*e),a=t(u,c-s),b=t(u,c+s),v=(b.px-a.px)/(2*s),g=(b.py-a.py)/(2*s),d=(b.pz-a.pz)/(2*s),j=n*d-r*g,_=r*v-l*d,m=l*g-n*v,M=Math.hypot(j,_,m);f.nx=j/M,f.ny=_/M,f.nz=m/M}l.push([f.nx*a,f.ny*a,f.nz*a])}let u=s.div+1;for(let t=0;t<e.div;++t){let e=t*u;for(let t=0;t<s.div;++t)a>0?r.push([e+t,e+t+u,e+t+u+1,e+t+1]):r.push([e+t+1,e+t+u+1,e+t+u,e+t])}return this.obj_v=o,this.obj_n=l,n.length>0&&(this.obj_t=n),this.obj_i=r,this}objModel(t,e){let s=this.obj_v,h=this.obj_i,o=this.obj_n,l=this.obj_t,n=this.obj_c,r=[],a=[],p=[],i=[],u=0;o||(this.obj_n=[]);for(let t=0,e=h.length;t<e;t++){let e=h[t];if(!o){let h=[];for(let t=0;t<3;t++)h[t]=s[e[t]];let o=h[1][0]-h[0][0],l=h[1][1]-h[0][1],n=h[1][2]-h[0][2],r=h[2][0]-h[0][0],a=h[2][1]-h[0][1],u=h[2][2]-h[0][2],c=l*u-n*a,f=-o*u+n*r,b=o*a-l*r,v=Math.hypot(c,f,b);c/=v,f/=v,b/=v,p.push([c,f,b]);for(let s=0,h=e.length;s<h;s++)i[e[s]]||(i[e[s]]=[]),i[e[s]].push(t)}for(let t=1,s=e.length-1;t<s;t++)a.push(e[0]),a.push(e[t]),a.push(e[t+1]);u+=e.length}console.log(" vert:"+s.length),console.log(" poly:"+a.length/3);for(let e=0,h=s.length;e<h;e++){r.push(parseFloat(s[e][0])),r.push(parseFloat(s[e][1])),r.push(parseFloat(s[e][2]));let h=0,a=0,u=0;if(o)h=o[e][0],a=o[e][1],u=o[e][2];else for(let t=0;t<i[e].length;t++){let s=i[e][t];h+=p[s][0],a+=p[s][1],u+=p[s][2]}let c=Math.hypot(h,a,u);if(0==c?(r.push(0),r.push(0),r.push(0)):(r.push(h/c),r.push(a/c),r.push(u/c)),o||this.obj_n.push([h/c,a/c,u/c]),l&&(r.push(parseFloat(l[e][0])),r.push(parseFloat(l[e][1]))),n&&(r.push(parseFloat(n[e][0])),r.push(parseFloat(n[e][1])),r.push(parseFloat(n[e][2]))),t)for(av=0;av<t.length;av++)r=r.concat(t[av].data[e])}this.ibuf=a,this.vbuf=r;let c={mode:"tri",vtx_at:["position","norm"],vtx:r,idx:a};if(l&&c.vtx_at.push("uv"),n&&c.vtx_at.push("color"),t)for(av=0;av<t.length;av++)c.vtx_at.push(t[av].attr);return c}normLines(t){let e=[],s=this.obj_v,h=this.obj_n;void 0==t&&(t=.1);for(let o=0,l=s.length;o<l;o++)e.push(s[o][0]),e.push(s[o][1]),e.push(s[o][2]),e.push(s[o][0]+h[o][0]*t),e.push(s[o][1]+h[o][1]*t),e.push(s[o][2]+h[o][2]*t);return{mode:"lines",vtx_at:["position"],vtx:e}}wireframe(){let t=[],e=this.obj_v,s=this.obj_i;for(let h=0,o=s.length;h<o;h++){let o,l=s[h];for(o=1;o<l.length;o++)t.push(e[l[o-1]][0]),t.push(e[l[o-1]][1]),t.push(e[l[o-1]][2]),t.push(e[l[o]][0]),t.push(e[l[o]][1]),t.push(e[l[o]][2]);t.push(e[l[o-1]][0]),t.push(e[l[o-1]][1]),t.push(e[l[o-1]][2]),t.push(e[l[0]][0]),t.push(e[l[0]][1]),t.push(e[l[0]][2])}return{mode:"lines",vtx_at:["position"],vtx:t}}multMatrix4(t){let s=new e(t).invert().transpose(),h=t.getAsArray();for(let t=0;t<this.obj_v.length;t++){let e=this.obj_v[t],s=h[0]*e[0]+h[4]*e[1]+h[8]*e[2]+h[12],o=h[1]*e[0]+h[5]*e[1]+h[9]*e[2]+h[13],l=h[2]*e[0]+h[6]*e[1]+h[10]*e[2]+h[14];this.obj_v[t]=[s,o,l]}h=s.getAsArray();for(let t=0;t<this.obj_n.length;t++){let e=this.obj_n[t],s=h[0]*e[0]+h[4]*e[1]+h[8]*e[2]+h[12],o=h[1]*e[0]+h[5]*e[1]+h[9]*e[2]+h[13],l=h[2]*e[0]+h[6]*e[1]+h[10]*e[2]+h[14];this.obj_n[t]=[s,o,l]}}mergeModels(t){let e=this,s=0;for(let h=0;h<t.length;h++){e.obj_v=e.obj_v.concat(t[h].obj_v),e.obj_n=e.obj_n.concat(t[h].obj_n),e.obj_t=e.obj_t.concat(t[h].obj_t);for(let o=0;o<t[h].obj_i.length;o++){let l=t[h].obj_i[o],r=[];for(n=0;n<l.length;n++)r.push(l[n]+s);e.obj_i.push(r)}s+=t[h].obj_v.length}return e}boundbox(){let t=Number.MAX_VALUE,e=t,s=t,h=Number.MIN_VALUE,o=h,l=h;for(let n=0;n<this.obj_v.length;n++){let r=this.obj_v[n];r[0]<t&&(t=r[0]),r[1]<e&&(e=r[1]),r[2]<s&&(s=r[2]),r[0]>h&&(h=r[0]),r[1]>o&&(o=r[1]),r[2]>l&&(l=r[2])}return[[t,e,s],[h,o,l]]}loadAjax(t){return new Promise(function(e,s){let h=new XMLHttpRequest;h.open("get",t,!0),h.responseType="text",h.onload=function(){200==this.status?e(this.response):s("Ajax error:"+this.statusText)},h.onerror=function(){s("Ajax error:"+this.statusText)},h.send()})}static loadLines(t,e,s){s||(s=1e4);const h=new TextDecoder;return new Promise((o,l)=>{fetch(t,{method:"GET"}).then(async t=>{if(t.ok){const l=t.body.getReader(),n=new Uint8Array(s);let r=0;for(;;){const{done:s,value:a}=await l.read();if(s){e(h.decode(n.slice(0,r))),o(t);break}for(const t of a)n[r++]=t,10==t&&(e(h.decode(n.slice(0,r-1))),r=0)}}else l(t)})})}async loadObj(t,e){return e||(e=1),new Promise((s,h)=>{this.loadAjax(t).then(h=>{let o=h.split("\n"),l=[],n=[],r=[],a=[],p=[],i={},u=0;for(let t=0,s=o.length;t<s;t++){if(o[t].match(/^#/))continue;if(o[t].match(/^eof/))break;let s=o[t].split(/\s+/);if("v"==s[0]&&(l.push([s[1]*e,s[2]*e,s[3]*e]),7==s.length&&p.push([s[4],s[5],s[6]])),"vt"==s[0]&&a.push([s[1],s[2]]),"vn"==s[0]&&n.push([s[1],s[2],s[3]]),"f"==s[0]){let t=[];for(let e=1;e<s.length;e++)""!=s[e]&&(s[e]in i||(i[s[e]]=u++),t.push(i[s[e]]));r.push(t)}}if(this.obj_v=[],p.length>0&&(this.obj_c=[]),this.obj_i=r,n.length>0&&(this.obj_n=[]),a.length>0&&(this.obj_t=[]),r.length>0)for(let t in i){let e=t.split("/"),s=i[t];this.obj_v[s]=l[e[0]-1],p.length>0&&(this.obj_c[s]=p[e[0]-1]),a.length>0&&(this.obj_t[s]=a[e[1]-1]),n.length>0&&(this.obj_n[s]=n[e[2]-1])}else this.obj_v=l,p.length>0&&(this.obj_c=p),n.length>0&&(this.obj_n=n);console.log("loadobj "+t+" vtx:"+l.length+" norm:"+n.length+" tex:"+a.length+" idx:"+r.length+" vbuf:"+this.obj_v.length),s(this)}).catch(function(t){h(t)})})}static async loadObj2(t,e){let h=1,o=!1,l=!1,n=!1;return e&&(e.scale&&(h=e.scale),e.zup&&(o=e.zup),e.nogroup&&(l=e.nogroup),e.nomtl&&(n=e.nomtl)),new Promise((e,r)=>{const a=[],p=[],i={},u=[],c=[],f={},b=[];let v=0,g="",d="";const j=[],_=[];s.loadLines(t,async e=>{if(e.match(/^#/))return;if(e.match(/^eof/))return;const r=e.split(/\s+/),m=r[0];if("v"==m&&(o?a.push([r[1]*h,r[3]*h,-r[2]*h]):a.push([r[1]*h,r[2]*h,r[3]*h]),7==r.length&&c.push([r[4],r[5],r[6]])),"vt"==m&&u.push([r[1],r[2]]),"vn"==m&&(o?p.push([r[1],r[3],-r[2]]):p.push([r[1],r[2],r[3]])),"f"==m){let t=[];for(let e=1;e<r.length;e++)""!=r[e]&&(r[e]in f||(f[r[e]]=v++,b[f[r[e]]]=r[e]),t.push(f[r[e]]));i[d]||(i[d]={}),i[d][g]||(i[d][g]=[]),i[d][g].push(t)}if("mtllib"==m){let e=t.split("/");e[e.length-1]=r[1],j.push(s.loadMtl(e.join("/"))),_.push(e)}"usemtl"==m&&(n||(g=r[1])),"g"==m&&(l||(d=r[1]))}).then(h=>{const o=[];let n;console.log(i),console.log(b);for(let e in i){n=[];for(let h in i[e]){let o=i[e][h];const l=new s;if(l.obj_v=[],c.length>0&&(l.obj_c=[]),p.length>0&&(l.obj_n=[]),u.length>0&&(l.obj_t=[]),l.obj_i=o,o.length>0)for(let t in f){let e=t.split("/"),s=f[t];l.obj_v[s]=a[e[0]-1],c.length>0&&(l.obj_c[s]=c[e[0]-1]),u.length>0&&(l.obj_t[s]=u[e[1]-1]),p.length>0&&(l.obj_n[s]=p[e[2]-1])}else l.obj_v=a,c.length>0&&(l.obj_c=c),p.length>0&&(l.obj_n=p);n.push({obj:l,mtlname:h}),console.log("loadobj "+t+" vtx:"+a.length+" norm:"+p.length+" tex:"+u.length+" idx:"+o.length+" vbuf:"+l.obj_v.length)}o.push({objs:n,group:e})}j.length>0?Promise.all(j).then(t=>{let s={};for(let e in t)s=Object.assign(s,t[e]);e(l?{objs:n,mtls:s}:{groups:o,mtls:s})}):e(l?{objs:n}:{groups:o})}).catch(t=>{r(t)})})}static async loadMtl(t){const e=[];let h="";return new Promise((o,l)=>{s.loadLines(t,t=>{if(t.match(/^#/))return;if(t.match(/^eof/))return;const s=t.split(/\s+/),o=s[0];if("newmtl"==o)return h=s[1],void(e[h]={});switch(o){case"Kd":case"Ks":case"Ka":case"Tf":e[h][o]=[parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])];break;case"Ni":case"d":case"Ns":e[h][o]=parseFloat(s[1]);break;case"illum":e[h][o]=parseInt(s[1]);break;case"map_Kd":case"map_Ka":case"map_Ks":e[h][o]=s[1]}}).then(t=>{o(e)}).catch(t=>{l(t)})})}static HSV2RGB(t,e,s,h){let o,l,n,r,a,p,i;switch(l=(t*=6)-(o=Math.floor(t)),1&o||(l=1-l),n=s*(1-e),r=s*(1-e*l),o){case 0:case 6:a=s,p=r,i=n;break;case 1:a=r,p=s,i=n;break;case 2:a=n,p=s,i=r;break;case 3:a=n,p=r,i=s;break;case 4:a=r,p=n,i=s;break;case 5:a=s,p=n,i=r}return[a,p,i,void 0===h?1:h]}static snormal(t){let e=t[1][0]-t[0][0],s=t[1][1]-t[0][1],h=t[1][2]-t[0][2],o=t[2][0]-t[0][0],l=t[2][1]-t[0][1],n=t[2][2]-t[0][2],r=s*n-h*l,a=-e*n+h*o,p=e*l-s*o,i=Math.hypot(r,a,p);return[r/=i,a/=i,p/=i]}}return t.WWModel=s});
//# sourceMappingURL=sourcemaps/WWModel.js.map
