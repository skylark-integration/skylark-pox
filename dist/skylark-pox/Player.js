/**
 * skylark-pox - A version of pox that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-pox/
 * @license MIT
 */
define(["./pox","./CanvasMatrix4","./GPad","./Pointer","./Camera","./Device","./WBind","./WWG","./WWModel"],function(t,e,i,s,n,a,r,o,h){"use strict";t.$;const c=e;t.RAD;class l{constructor(t,e){if(this.version="2.2.0",!Promise)throw"This browser is not supported!!";e||(e={}),this.can=t instanceof HTMLElement?t:document.querySelector(t);const s=new o,n={preserveDrawingBuffer:e.capture,antialias:!0,xrCompatible:!0};if(!(!e.noWebGL2&&s.init2(this.can,n)||s.init(this.can,n)))throw"wgl not supported!";if(e.needWebGL2&&2!=s.version)throw"needs wgl2";this.wwg=s;const c=r.create();this.param=c,c.bindInput("isStereo",e.ui&&e.ui.isStereo?e.ui.isStereo:"#isstereo"),c.bindInput("autorot",e.ui&&e.ui.autorot?e.ui.autorot:"#autorot"),c.bindInput("pause",e.ui&&e.ui.pause?e.ui.pause:"#pause"),c.bindHtml("fps",e.ui&&e.ui.fps?e.ui.fps:"#fps"),c.bindInput("camselect",e.ui&&e.ui.camselect?e.ui.camselect:"#camselect"),this.pixRatio=1,this.pox={can:this.can,wwg:this.wwg,WWModel:h,synth:this.synth,poxp:this},this.eventListener={},i&&(this.pox.gPad=new i,this.pox.gPad.name="1",this.pox.gPad2=new i,this.pox.gPad2.name="2",this.pox.gPad.init(0,(t,e)=>{e&&this.pox.log("set 1"+t.gp.hand)})||this.pox.gPad2.init(1,(t,e)=>{e&&this.pox.log("set 2"+t.gp.hand)})||(this.pox.gPad.ev=(t=>{ret=this.callEvent("gpad",t)})),this.pox.gPad2.ev=((t,e,i)=>{ret=this.callEvent("gpad",t)})),this.resize(),window.addEventListener("resize",()=>{this.resize()}),this.pause=!0;const l=document.createElement("input");l.setAttribute("type","checkbox"),l.style.position="absolute",l.style.zIndex=-100,l.style.top=0,l.style.left="-20px",l.style.width="10px",l.style.height="10px",l.style.padding=0,l.style.border="none",l.style.opacity=0,this.can.parentNode.appendChild(l),this.keyElelment=l,this.keyElelment.focus(),this.setEvent(),a.checkVR(this).then(t=>{t&&console.log(a.vrDisplay?"WebVR":"WebXR supported"),this.vrReady=t}),this.cam0=this.createCamera(),this.cam0.setCam({camFar:1e4}),this.cam1=this.createCamera(),this.ccam=this.cam1}addEvent(t,e){let i=null;switch(t){case"frame":i={cb:e,active:!0},this.eventListener.frame.push(i);break;case"gpad":i={cb:e,active:!0},this.eventListener.gpad.push(i);break;case"vrchange":i={cb:e,active:!0},this.eventListener.vrchange.push(i)}return i}removeEvent(t){this.eventListener.frame=this.eventListener.frame.filter(e=>e!==t),this.eventListener.gpad=this.eventListener.gpad.filter(e=>e!==t),this.eventListener.vrchange=this.eventListener.vrchange.filter(e=>e!==t)}clearEvent(){this.eventListener.frame=[],this.eventListener.gpad=[],this.eventListener.vrchange=[]}enterVR(){let t=!0;if(a.VRReady)console.log("enter VR"),a.presentVR(this);else if(document.body.webkitRequestFullscreen){console.log("fullscreen");const t=this.can.parentNode;this.ssize={width:t.offsetWidth,height:t.offsetHeight},document.addEventListener("webkitfullscreenchange",e=>{document.webkitFullscreenElement?(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px"):(t.style.width=this.ssize.width+"px",t.style.height=this.ssize.height+"px")}),t.webkitRequestFullscreen()}else t=!1;return t}exitVR(){a.VRReady&&a.closeVR(this)}setEvent(){let t=!1;const e=this.param,i=this.can;new s(i,{down:i=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("down",{x:i.x*this.pixRatio,y:i.y*this.pixRatio,sx:i.sx*this.pixRatio,sy:i.sy*this.pixRatio}))&&this.ccam.event("down",i),t=!0,"walk"==this.ccam.cam.camMode&&this.keyElelment.focus(),!1},move:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("move",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,ox:t.ox*this.pixRatio,oy:t.oy*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio}))&&this.ccam.event("move",t),!1},up:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("up",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio,ex:e.ex*this.pixRatio,ey:e.ey*this.pixRatio}))&&this.ccam.event("up",e),!1},out:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("out",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio}))&&this.ccam.event("out",e),!1},wheel:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("wheel",t))&&this.ccam.event("wheel",t),!1},gesture:(t,i)=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("gesture",{z:t,r:i}))&&this.ccam.event("gesture",{z:t,r:i}),!1},gyro:i=>{if(!this.ccam||e.pause||a.VRReady)return!0;if(t)return!0;let s=!0;return(s=this.callEvent("gyro",i))&&this.ccam.event("gyro",i),!1}});r.addev(this.keyElelment,"keydown",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keydown",t))||(this.ccam&&this.ccam.event("keydown",t),!1))),r.addev(this.keyElelment,"keyup",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keyup",t))||(this.ccam&&this.ccam.event("keyup",t),!1))),document.querySelectorAll("#bc button").forEach(t=>{t.addEventListener("mousedown",t=>{this.callEvent("btndown",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("touchstart",t=>{this.callEvent("touchstart",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("mouseup",t=>{this.callEvent("btnup",t.target.id),this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),this.keyElelment.focus(),t.preventDefault()}),t.addEventListener("touchend",t=>{ret=!0,ret=this.callEvent("touchend",t.target.id),ret&&this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),t.preventDefault()})})}resize(){this.can.offsetWidth<300||a.isPresenting||(this.can.width=this.can.offsetWidth*this.pixRatio*window.devicePixelRatio,this.can.height=this.can.offsetHeight*this.pixRatio*window.devicePixelRatio,console.log("canvas:"+this.can.width+" x "+this.can.height))}async load(t){return new Promise((e,i)=>{if("string"==typeof t){const s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="json",s.onload=(()=>{200==s.status?e(s.response):i("Ajax error:"+s.statusText)}),s.onerror=(()=>{i("Ajax error:"+s.statusText)}),s.send()}else e(t)})}loadImage(t){return t.match(/^https?:/)?this.wwg.loadImageAjax(t):new Promise((e,i)=>{const s=new Image;s.onload=(()=>{e(s)}),s.onerror=(()=>{i("cannot load image")}),s.src=t})}async set(t,e={},i){t.vs,t.fs;this.pox.src=t,this.pox.param=e;const s=this.pox;if(s.loadImage=this.loadImage,s.loadAjax=this.wwg.loadAjax,s.addEvent=((t,e)=>this.addEvent(t,e)),s.exitVR=this.exitVR,s.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},s.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},s.V3norm=function(t,e){const i=V3len(t);return void 0===e&&(e=1),0==i?[0,0,0]:[t[0]*e/i,t[1]*e/i,t[2]*e/i]},s.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},s.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.Vdistance=function(t,e){return Math.hypot(...t.map((t,i)=>t-e[i]))},s.setScene=(async t=>new Promise((e,i)=>{this.setScene(t).then(()=>{e()}).catch(t=>{console.log("render err"+t.stack)})})),s.log=(t=>{this.errCb&&this.errCb(t)}),s.addModel=(t=>{if(this.render)return this.render.addModel(t)}),s.removeModel=(t=>{if(this.render)return this.render.removeModel(t)}),s.getModelData=(t=>{if(this.render)return this.render.getModelData(t)}),"string"==typeof t.m){const e=await this.parseJS(t.m);try{s.eval=new Function("POX",'"use strict";'+e)}catch(t){return console.log(t),this.emsg="parse error "+t.stack,null}try{s.eval(s)}catch(t){return this.emsg="eval error "+t.stack,null}}else if(t.m.constructor===Function)try{t.m(s)}catch(t){return this.emsg="eval error "+t.stack,null}if(s.setting.needWGL2&&2!=this.wwg.version)return this.emsg="needs WebGL 2.0",null;if(i&&this.setParam(i),s.init)try{await s.init()}catch(t){return this.emsg="init error "+t.stack,null}return s}parseJS(t){return new Promise((e,i)=>{const s=t.split("\n"),n=[];for(let t of s)t.match(/^\/\/\@INCLUDE\("(.+)"\)/)&&n.push(this.wwg.loadAjax(RegExp.$1));Promise.all(n).then(t=>{let i=[],n=0;for(let e of s)e.match(/^\/\/\@INCLUDE\("(.+)"\)/)?i=i.concat(t[n++].split("\n")):i.push(e);e(i.join("\n"))})})}stop(){window.cancelAnimationFrame(this.loop),this.pox.unload&&this.pox.unload()}cls(){this.render&&this.render.clear()}setError(t){this.errCb=t}callEvent(t,e,i){"object"==typeof e&&(e.rtime=this.rtime);let s=!0;if(this.pox.event)try{s=this.pox.event(t,e,i)}catch(t){this.errCb(t.stack)}if("vrchange"==t){this.ccam.vrchange(e);for(let t=0;t<this.eventListener.vrchange.length;t++){const i=this.eventListener.vrchange[t];i.active&&i.cb({vrmode:e})}}if("gpad"==t){-1==e.dbtn[5]&&a.closeVR();for(let t=0;t<this.eventListener.gpad.length;t++){const i=this.eventListener.gpad[t];if(i.active){let t={gpad:e};"left"==e.hand&&(t.leftPad=e),"right"==e.hand&&(t.rightPad=e),this.pox.setting.primaryPad==e.hand?t.primaryPad=e:t.secondaryPad=e,i.cb(t)}}}return s}setParam(t){const e=this.pox.setting.param;if(void 0===e)return;this.uparam=r.create();const i=[];for(let t in e){const s=e[t],n=s.name?s.name:t;s.type||(s.type="range"),s.step||(s.step=100);let a=`<div class=t>${n}</div> <input type=${s.type} id="_p_${t}" min=0 max=${s.step} style="${"disp"==s.type?"display:none":""}"  /><span id=${"_p_d_"+t}></span><br/>`;i.push(a)}function s(t){let e=(255*t).toString(16);return 1==e.length&&(e="0"+e),e}function n(t,i){"color"==e[t].type&&i?document.getElementById("_p_d_"+t).innerHTML=i.map(t=>t.toString().substr(0,5)):"range"==e[t].type?document.getElementById("_p_d_"+t).innerHTML=i.toString().substr(0,5):document.getElementById("_p_d_"+t).innerHTML=i}t.innerHTML=i.join("");for(let t in e)this.uparam.bindInput(t,"#_p_"+t),this.uparam.setFunc(t,{set:i=>{let a=i;return a="color"==e[t].type?"#"+s(i[0])+s(i[1])+s(i[2]):"range"==e[t].type?(i-e[t].min)*e[t].step/(e[t].max-e[t].min):i,n(t,i),a},get:i=>{let s;return s="color"==e[t].type?"string"==typeof i&&i.match(/#[0-9A-F]+/i)?[parseInt(i.substr(1,2),16)/255,parseInt(i.substr(3,2),16)/255,parseInt(i.substr(5,2),16)/255]:i:"range"==e[t].type?i*(e[t].max-e[t].min)/e[t].step+e[t].min:i},input:e=>{n(t,this.uparam[t])}}),this.uparam[t]=e[t].value;this.pox.param=this.uparam}setScene(t){const i=this.wwg,s=this.pox,n=this.can,r=(this.pixRatio,this.param),o=s.setting||{};o.scale||(o.scale=1),o.primaryPad||(o.primaryPad="right"),t.vshader={text:s.src.vs},t.fshader={text:s.src.fs},s.scene=t;const h=i.createRender();this.render=h,s.render=h;let l=this.ccam;this.isVR=!1;const u=this,d=new e,p=[],m=[],g=[],v=[],f=[];return new Promise((e,i)=>{h.setRender(t).then(()=>{this.errCb&&this.errCb("scene set ok"),this.renderStart&&this.renderStart(),s.setting&&s.setting.pixRatio?this.pixRatio=s.setting.pixRatio:this.pixRatio=1,this.resize(),s.setting.cam&&this.cam1.setCam(s.setting.cam),this.keyElelment.value="",this.clearEvent(),e();let t=(new Date).getTime();this.ctime=t,this.ltime=t;let i=0,c=0,d=t,p=0;const m=(e,g)=>{a.animationFrame(this,m,g);const v=(new Date).getTime();if(this.ctime=v,r.pause)return r.fps=0,i=c,void(t=v);c=i+v-t,p++,v-d>=500&&(r.fps=Math.floor(1e3*p/(v-d)+.5),p=0,d=v),this.ccam=r.camselect?this.cam0:this.cam1,l=this.ccam,s.cam=l.cam,r.autorot&&l.setCam({camRY:c/100%360});let f=null,x=null,w=null,b=null;if(s.gPad){let t=s.gPad.get(),e=s.gPad2.get();this.isVR?(t.emu||"right"!=t.hand||(f=t),t.emu||"left"!=t.hand||(x=t),e.emu||"right"!=e.hand||(f=e),e.emu||"left"!=e.hand||(x=e)):("right"==t.hand&&(f=t),"right"==e.hand&&(f=e),"left"==t.hand&&(x=t),"left"==e.hand&&(x=e)),"left"==o.primaryPad?(w=x,b=f):(w=f,b=x),w&&w.conn||(w=b,b=null),l.cam.gPad&&l.setPad(w,b)}l.update();let R=l.getMtx(o.scale,r.isStereo||u.isVR?1:0);for(let t=0;t<this.eventListener.frame.length;t++){const e=this.eventListener.frame[t];e.active&&e.cb({render:h,pox:s,ccam:l,cam:l.cam,rtime:c,rightPad:f,leftPad:x,primaryPad:w,secondaryPad:b})}let _={};s.update&&(_=s.update(h,l.cam,c,-1)),r.updateTimer(),function(t,e,i,s,o){if(t.data.model.sort((t,e)=>{if(null===t)return-1;if(null===e)return 1;let i=t.layer,s=e.layer;return void 0===i&&(i=0),void 0===s&&(s=0),i-s}),r.isStereo||u.isVR){let e=a.getViewport(n);a.WebXR&&a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,a.webGLLayer.framebuffer);let r=y(t,i);void 0===o.vs_uni&&(o.vs_uni={}),void 0===o.fs_uni&&(o.fs_uni={}),o.fs_uni.time=s/1e3,o.vs_uni.time=s/1e3,t.gl.viewport(e.leftViewport.x,e.leftViewport.y,e.leftViewport.width,e.leftViewport.height),t.draw([o,r[0]],!1),t.gl.viewport(e.rightViewport.x,e.rightViewport.y,e.rightViewport.width,e.rightViewport.height),t.draw([o,r[1]],!0),a.WebXR&&a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null)}else{let e=y(t,i);void 0===o.vs_uni&&(o.vs_uni={}),void 0===o.fs_uni&&(o.fs_uni={}),e[0].vs_uni.stereo=0,o.fs_uni.time=s/1e3,o.vs_uni.time=s/1e3,t.gl.viewport(0,0,n.width,n.height),t.draw([o,e[0]],!1)}}(h,0,R,c,_),a.submitFrame(this),this.ltime=v,this.rtime=c};m()}).catch(t=>{console.log(t),this.errCb&&this.errCb(t.stack?t.stack:t),i(t)})});function x(t,e){let i=t.getModelData(e);if(!i)return new c;let s=new c(i.bm);return s||(s=new c),i.mm&&s.multRight(i.mm),void 0!==i.parent&&s.multRight(x(t,i.parent)),s}function y(t,i){const s=[[],[]],a=t.data.model;for(let n=0;n<a.length;n++){let r=a[n];if(!r)continue;if(d.load(r.bm),r.mm&&d.multRight(r.mm),void 0!==r.parent&&d.multRight(x(t,r.parent)),t.data.group){let e=t.data.group;for(let i=0;i<e.length;i++){let s=e[i];if(s.bm)for(let e=0;e<s.model.length;e++)t.getModelIdx(s.model[e])==n&&d.multRight(s.bm)}}p[n]||(p[n]=new e),v[n]||(v[n]=new e),f[n]||(f[n]=new e),m[n]||(m[n]=[new e,new e]),g[n]||(g[n]=[new e,new e]);const o={vs_uni:{modelMatrix:p[n].load(d).getAsWebGLFloatArray(),vpMatrix:g[n][0].load(r.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][0].load(d).multRight(r.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),invMatrix:v[n].load(d).invert().transpose().getAsWebGLFloatArray(),minvMatrix:f[n].load(d).invert().getAsWebGLFloatArray()}},h={vs_uni:{modelMatrix:p[n].load(d).getAsWebGLFloatArray(),vpMatrix:g[n][1].load(r.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][1].load(d).multRight(r.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),invMatrix:v[n].load(d).invert().transpose().getAsWebGLFloatArray(),minvMatrix:f[n].load(d).invert().getAsWebGLFloatArray()}};o.fs_uni=o.vs_uni,h.fs_uni=h.vs_uni,o.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,o.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,h.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,h.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,s[0][n]=o,s[1][n]=h}let r=[{model:s[0],fs_uni:{},vs_uni:{}},{model:s[1],fs_uni:{},vs_uni:{}}];return r[0].fs_uni.stereo=1,r[0].fs_uni.resolution=[n.width,n.height],r[0].fs_uni.camMatirx=i[0].camV.getAsWebGLFloatArray(),r[0].fs_uni.eyevec=[i[0].camX,i[0].camY,i[0].camZ],r[0].vs_uni.stereo=1,r[0].vs_uni.camMatirx=r[0].fs_uni.camMatirx,r[0].vs_uni.eyevec=r[0].fs_uni.eyevec,r[1].fs_uni.stereo=2,r[1].fs_uni.resolution=r[0].fs_uni.resolution,r[1].fs_uni.camMatirx=i[1].camV.getAsWebGLFloatArray(),r[1].fs_uni.eyevec=[i[1].camX,i[1].camY,i[1].camZ],r[1].vs_uni.stereo=2,r[1].vs_uni.camMatirx=r[1].fs_uni.camMatirx,r[1].vs_uni.eyevec=r[1].fs_uni.eyevec,r}}}return l.prototype.createCamera=function(t){return new this.Camera(this,t)},l.prototype.Camera=n,t.Player=l});
//# sourceMappingURL=sourcemaps/Player.js.map
