/**
 * skylark-pox - A version of pox that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-pox/
 * @license MIT
 */
!function(t,e){var r=e.define,require=e.require,a="function"==typeof r&&r.amd,h=!a&&"undefined"!=typeof exports;if(!a&&!r){var o={};r=e.define=function(t,e,i){"function"==typeof i?(o[t]={factory:i,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var i=e.split("/"),s=t.split("/");i.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?i.pop():i.push(s[r]));return i.join("/")}(e,t)}),resolved:!1,exports:null},require(t)):o[t]={factory:null,resolved:!0,exports:i}},require=e.require=function(t){if(!o.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var module=o[t];if(!module.resolved){var i=[];module.deps.forEach(function(t){i.push(require(t))}),module.exports=module.factory.apply(e,i)||null,module.resolved=!0}return module.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,require){t("skylark-pox/pox",["skylark-langx/skylark"],function(t){const e={};function i(t){return document.getElementById(t)}return e.$=i,e.RAD=Math.PI/180,e.msg=(t=>{let e=new Date;if("string"==typeof t){let e=location.protocol+"//"+location.host;t=t.replace(new RegExp(e,"g"),"").replace(/data:[^:]+/,"module")}if(i("msglog")&&(i("msglog").value+=e.toTimeString().substr(0,8)+"."+("000"+e.getMilliseconds()).substr(-3)+" "+t+"\n",i("msglog").scrollTop=i("msglog").scrollHeight),!i("msgc"))return void console.log(t);const s=document.createElement("div");s.innerHTML=t,i("msgc").appendChild(s),i("msg").scrollTop=i("msgc").offsetHeight}),t.attach("intg.pox",e)}),t("skylark-pox/CanvasMatrix4",["./pox"],function(t){var e=function(t){if(void 0!=t&&"Float32Array"==t.name)return this.buf=t,this;if(this.buf=new Float32Array(16),this.matrix=null,"object"==typeof t){if("length"in t&&t.length>=16)return this.load(t),this;if(t instanceof e)return this.load(t),this}return this.makeIdentity(),this};return e.RAD=t.RAD,e.prototype.load=function(){if(1==arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];if("length"in t&&16==t.length)return this.buf[0]=t[0],this.buf[1]=t[1],this.buf[2]=t[2],this.buf[3]=t[3],this.buf[4]=t[4],this.buf[5]=t[5],this.buf[6]=t[6],this.buf[7]=t[7],this.buf[8]=t[8],this.buf[9]=t[9],this.buf[10]=t[10],this.buf[11]=t[11],this.buf[12]=t[12],this.buf[13]=t[13],this.buf[14]=t[14],this.buf[15]=t[15],this;if(arguments[0]instanceof e)return this.buf[0]=t.buf[0],this.buf[1]=t.buf[1],this.buf[2]=t.buf[2],this.buf[3]=t.buf[3],this.buf[4]=t.buf[4],this.buf[5]=t.buf[5],this.buf[6]=t.buf[6],this.buf[7]=t.buf[7],this.buf[8]=t.buf[8],this.buf[9]=t.buf[9],this.buf[10]=t.buf[10],this.buf[11]=t.buf[11],this.buf[12]=t.buf[12],this.buf[13]=t.buf[13],this.buf[14]=t.buf[14],this.buf[15]=t.buf[15],this}return this.makeIdentity(),this},e.prototype.getAsArray=function(){return[this.buf[0],this.buf[1],this.buf[2],this.buf[3],this.buf[4],this.buf[5],this.buf[6],this.buf[7],this.buf[8],this.buf[9],this.buf[10],this.buf[11],this.buf[12],this.buf[13],this.buf[14],this.buf[15]]},e.prototype.getAsWebGLFloatArray=function(){return this.buf},e.prototype.initmatrix=function(){return this.matrix||(this.matrix=new e),this.matrix.makeIdentity(),this},e.prototype.makeIdentity=function(){return this.buf[0]=1,this.buf[1]=0,this.buf[2]=0,this.buf[3]=0,this.buf[4]=0,this.buf[5]=1,this.buf[6]=0,this.buf[7]=0,this.buf[8]=0,this.buf[9]=0,this.buf[10]=1,this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.prototype.transpose=function(){var t=this.buf[1];return this.buf[1]=this.buf[4],this.buf[4]=t,t=this.buf[2],this.buf[2]=this.buf[8],this.buf[8]=t,t=this.buf[3],this.buf[3]=this.buf[12],this.buf[12]=t,t=this.buf[6],this.buf[6]=this.buf[9],this.buf[9]=t,t=this.buf[7],this.buf[7]=this.buf[13],this.buf[13]=t,t=this.buf[11],this.buf[11]=this.buf[14],this.buf[14]=t,this},e.prototype.invert=function(){var t=this._determinant4x4();return Math.abs(t)<1e-8?null:(this._makeAdjoint(),this.buf[0]/=t,this.buf[1]/=t,this.buf[2]/=t,this.buf[3]/=t,this.buf[4]/=t,this.buf[5]/=t,this.buf[6]/=t,this.buf[7]/=t,this.buf[8]/=t,this.buf[9]/=t,this.buf[10]/=t,this.buf[11]/=t,this.buf[12]/=t,this.buf[13]/=t,this.buf[14]/=t,this.buf[15]/=t,this)},e.prototype.translate=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=0),void 0==e&&(e=0),void 0==i&&(i=0),this.buf[12]+=t,this.buf[13]+=e,this.buf[14]+=i,this},e.prototype.scale=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=1),void 0==i?void 0==e?(e=t,i=t):i=1:void 0==e&&(e=t),this.buf[0]*=t,this.buf[1]*=t,this.buf[2]*=t,this.buf[4]*=e,this.buf[5]*=e,this.buf[6]*=e,this.buf[8]*=i,this.buf[9]*=i,this.buf[10]*=i,this},e.prototype.rotate=function(t,i,s,r){if(0==t)return this;(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],r=i[2],i=i[0]),t*=e.RAD,t/=2;var a=Math.sin(t),n=Math.cos(t),h=a*a;if(this.initmatrix(),1==i&&0==s&&0==r)this.matrix.buf[5]=1-2*h,this.matrix.buf[6]=2*a*n,this.matrix.buf[9]=-2*a*n,this.matrix.buf[10]=1-2*h;else if(0==i&&1==s&&0==r)this.matrix.buf[0]=1-2*h,this.matrix.buf[2]=-2*a*n,this.matrix.buf[8]=2*a*n,this.matrix.buf[10]=1-2*h;else if(0==i&&0==s&&1==r)this.matrix.buf[0]=1-2*h,this.matrix.buf[1]=2*a*n,this.matrix.buf[4]=-2*a*n,this.matrix.buf[5]=1-2*h;else{var o=Math.hypot(i,s,r);0==o?(i=0,s=0,r=1):1!=o&&(i/=o,s/=o,r/=o);var u=i*i,c=s*s,f=r*r;this.matrix.buf[0]=1-2*(c+f)*h,this.matrix.buf[1]=2*(i*s*h+r*a*n),this.matrix.buf[2]=2*(i*r*h-s*a*n),this.matrix.buf[4]=2*(s*i*h-r*a*n),this.matrix.buf[5]=1-2*(f+u)*h,this.matrix.buf[6]=2*(s*r*h+i*a*n),this.matrix.buf[8]=2*(r*i*h+s*a*n),this.matrix.buf[9]=2*(r*s*h-i*a*n),this.matrix.buf[10]=1-2*(u+c)*h}return this.multRight(this.matrix),this},e.prototype.multRight=function(t){var e=this.buf[0]*t.buf[0]+this.buf[1]*t.buf[4]+this.buf[2]*t.buf[8]+this.buf[3]*t.buf[12],i=this.buf[0]*t.buf[1]+this.buf[1]*t.buf[5]+this.buf[2]*t.buf[9]+this.buf[3]*t.buf[13],s=this.buf[0]*t.buf[2]+this.buf[1]*t.buf[6]+this.buf[2]*t.buf[10]+this.buf[3]*t.buf[14],r=this.buf[0]*t.buf[3]+this.buf[1]*t.buf[7]+this.buf[2]*t.buf[11]+this.buf[3]*t.buf[15],a=this.buf[4]*t.buf[0]+this.buf[5]*t.buf[4]+this.buf[6]*t.buf[8]+this.buf[7]*t.buf[12],n=this.buf[4]*t.buf[1]+this.buf[5]*t.buf[5]+this.buf[6]*t.buf[9]+this.buf[7]*t.buf[13],h=this.buf[4]*t.buf[2]+this.buf[5]*t.buf[6]+this.buf[6]*t.buf[10]+this.buf[7]*t.buf[14],o=this.buf[4]*t.buf[3]+this.buf[5]*t.buf[7]+this.buf[6]*t.buf[11]+this.buf[7]*t.buf[15],u=this.buf[8]*t.buf[0]+this.buf[9]*t.buf[4]+this.buf[10]*t.buf[8]+this.buf[11]*t.buf[12],c=this.buf[8]*t.buf[1]+this.buf[9]*t.buf[5]+this.buf[10]*t.buf[9]+this.buf[11]*t.buf[13],f=this.buf[8]*t.buf[2]+this.buf[9]*t.buf[6]+this.buf[10]*t.buf[10]+this.buf[11]*t.buf[14],l=this.buf[8]*t.buf[3]+this.buf[9]*t.buf[7]+this.buf[10]*t.buf[11]+this.buf[11]*t.buf[15],p=this.buf[12]*t.buf[0]+this.buf[13]*t.buf[4]+this.buf[14]*t.buf[8]+this.buf[15]*t.buf[12],m=this.buf[12]*t.buf[1]+this.buf[13]*t.buf[5]+this.buf[14]*t.buf[9]+this.buf[15]*t.buf[13],d=this.buf[12]*t.buf[2]+this.buf[13]*t.buf[6]+this.buf[14]*t.buf[10]+this.buf[15]*t.buf[14],b=this.buf[12]*t.buf[3]+this.buf[13]*t.buf[7]+this.buf[14]*t.buf[11]+this.buf[15]*t.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=r,this.buf[4]=a,this.buf[5]=n,this.buf[6]=h,this.buf[7]=o,this.buf[8]=u,this.buf[9]=c,this.buf[10]=f,this.buf[11]=l,this.buf[12]=p,this.buf[13]=m,this.buf[14]=d,this.buf[15]=b,this},e.prototype.multLeft=function(t){var e=t.buf[0]*this.buf[0]+t.buf[1]*this.buf[4]+t.buf[2]*this.buf[8]+t.buf[3]*this.buf[12],i=t.buf[0]*this.buf[1]+t.buf[1]*this.buf[5]+t.buf[2]*this.buf[9]+t.buf[3]*this.buf[13],s=t.buf[0]*this.buf[2]+t.buf[1]*this.buf[6]+t.buf[2]*this.buf[10]+t.buf[3]*this.buf[14],r=t.buf[0]*this.buf[3]+t.buf[1]*this.buf[7]+t.buf[2]*this.buf[11]+t.buf[3]*this.buf[15],a=t.buf[4]*this.buf[0]+t.buf[5]*this.buf[4]+t.buf[6]*this.buf[8]+t.buf[7]*this.buf[12],n=t.buf[4]*this.buf[1]+t.buf[5]*this.buf[5]+t.buf[6]*this.buf[9]+t.buf[7]*this.buf[13],h=t.buf[4]*this.buf[2]+t.buf[5]*this.buf[6]+t.buf[6]*this.buf[10]+t.buf[7]*this.buf[14],o=t.buf[4]*this.buf[3]+t.buf[5]*this.buf[7]+t.buf[6]*this.buf[11]+t.buf[7]*this.buf[15],u=t.buf[8]*this.buf[0]+t.buf[9]*this.buf[4]+t.buf[10]*this.buf[8]+t.buf[11]*this.buf[12],c=t.buf[8]*this.buf[1]+t.buf[9]*this.buf[5]+t.buf[10]*this.buf[9]+t.buf[11]*this.buf[13],f=t.buf[8]*this.buf[2]+t.buf[9]*this.buf[6]+t.buf[10]*this.buf[10]+t.buf[11]*this.buf[14],l=t.buf[8]*this.buf[3]+t.buf[9]*this.buf[7]+t.buf[10]*this.buf[11]+t.buf[11]*this.buf[15],p=t.buf[12]*this.buf[0]+t.buf[13]*this.buf[4]+t.buf[14]*this.buf[8]+t.buf[15]*this.buf[12],m=t.buf[12]*this.buf[1]+t.buf[13]*this.buf[5]+t.buf[14]*this.buf[9]+t.buf[15]*this.buf[13],d=t.buf[12]*this.buf[2]+t.buf[13]*this.buf[6]+t.buf[14]*this.buf[10]+t.buf[15]*this.buf[14],b=t.buf[12]*this.buf[3]+t.buf[13]*this.buf[7]+t.buf[14]*this.buf[11]+t.buf[15]*this.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=r,this.buf[4]=a,this.buf[5]=n,this.buf[6]=h,this.buf[7]=o,this.buf[8]=u,this.buf[9]=c,this.buf[10]=f,this.buf[11]=l,this.buf[12]=p,this.buf[13]=m,this.buf[14]=d,this.buf[15]=b,this},e.prototype.ortho=function(t,e,i,s,r,a){var n=(t+e)/(e-t),h=(s+i)/(s-i),o=(a+r)/(a-r);return this.initmatrix(),this.matrix.buf[0]=2/(e-t),this.matrix.buf[5]=2/(s-i),this.matrix.buf[10]=-2/(a-r),this.matrix.buf[12]=n,this.matrix.buf[13]=h,this.matrix.buf[14]=-o,this.multRight(this.matrix),this},e.prototype.frustum=function(t,e,i,s,r,a){this.initmatrix();var n=(e+t)/(e-t),h=(s+i)/(s-i),o=-(a+r)/(a-r),u=-2*a*r/(a-r);return this.matrix.buf[0]=2*r/(e-t),this.matrix.buf[5]=2*r/(s-i),this.matrix.buf[8]=n,this.matrix.buf[9]=h,this.matrix.buf[10]=o,this.matrix.buf[11]=-1,this.matrix.buf[14]=u,this.matrix.buf[15]=0,this.multRight(this.matrix),this},e.prototype.perspective=function(t,e,i,s){var r=Math.tan(t*Math.PI/360)*i,a=-r,n=e*a,h=e*r;return this.frustum(n,h,a,r,i,s),this},e.prototype.pallarel=function(t,e,i,s){var r=t/2,a=-r,n=r/e,h=-n;return this.ortho(a,r,h,n,i,s),this},e.prototype.lookat=function(t,e,i,s,r,a,n,h,o){this.initmatrix();var u=t-s,c=e-r,f=i-a,l=Math.hypot(u,c,f);return l&&(u/=l,c/=l,f/=l),xx=h*f-o*c,xy=-n*f+o*u,xz=n*c-h*u,yx=c*xz-f*xy,yy=-u*xz+f*xx,yz=u*xy-c*xx,(l=Math.hypot(xx,xy,xz))&&(xx/=l,xy/=l,xz/=l),(l=Math.hypot(yx,yy,yz))&&(yx/=l,yy/=l,yz/=l),this.matrix.buf[0]=xx,this.matrix.buf[1]=yx,this.matrix.buf[2]=u,this.matrix.buf[4]=xy,this.matrix.buf[5]=yy,this.matrix.buf[6]=c,this.matrix.buf[8]=xz,this.matrix.buf[9]=yz,this.matrix.buf[10]=f,this.matrix.buf[12]=-(xx*t+xy*e+xz*i),this.matrix.buf[13]=-(yx*t+yy*e+yz*i),this.matrix.buf[14]=-(u*t+c*e+f*i),this.multRight(this.matrix),this},e.prototype._determinant2x2=function(t,e,i,s){return t*s-e*i},e.prototype._determinant3x3=function(t,e,i,s,r,a,n,h,o){return t*this._determinant2x2(r,a,h,o)-s*this._determinant2x2(e,i,h,o)+n*this._determinant2x2(e,i,r,a)},e.prototype._determinant4x4=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],r=this.buf[4],a=this.buf[5],n=this.buf[6],h=this.buf[7],o=this.buf[8],u=this.buf[9],c=this.buf[10],f=this.buf[11],l=this.buf[12],p=this.buf[13],m=this.buf[14],d=this.buf[15];return t*this._determinant3x3(a,u,p,n,c,m,h,f,d)-e*this._determinant3x3(r,o,l,n,c,m,h,f,d)+i*this._determinant3x3(r,o,l,a,u,p,h,f,d)-s*this._determinant3x3(r,o,l,a,u,p,n,c,m)},e.prototype._makeAdjoint=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],r=this.buf[4],a=this.buf[5],n=this.buf[6],h=this.buf[7],o=this.buf[8],u=this.buf[9],c=this.buf[10],f=this.buf[11],l=this.buf[12],p=this.buf[13],m=this.buf[14],d=this.buf[15];this.buf[0]=this._determinant3x3(a,u,p,n,c,m,h,f,d),this.buf[4]=-this._determinant3x3(r,o,l,n,c,m,h,f,d),this.buf[8]=this._determinant3x3(r,o,l,a,u,p,h,f,d),this.buf[12]=-this._determinant3x3(r,o,l,a,u,p,n,c,m),this.buf[1]=-this._determinant3x3(e,u,p,i,c,m,s,f,d),this.buf[5]=this._determinant3x3(t,o,l,i,c,m,s,f,d),this.buf[9]=-this._determinant3x3(t,o,l,e,u,p,s,f,d),this.buf[13]=this._determinant3x3(t,o,l,e,u,p,i,c,m),this.buf[2]=this._determinant3x3(e,a,p,i,n,m,s,h,d),this.buf[6]=-this._determinant3x3(t,r,l,i,n,m,s,h,d),this.buf[10]=this._determinant3x3(t,r,l,e,a,p,s,h,d),this.buf[14]=-this._determinant3x3(t,r,l,e,a,p,i,n,m),this.buf[3]=-this._determinant3x3(e,a,u,i,n,c,s,h,f),this.buf[7]=this._determinant3x3(t,r,o,i,n,c,s,h,f),this.buf[11]=-this._determinant3x3(t,r,o,e,a,u,s,h,f),this.buf[15]=this._determinant3x3(t,r,o,e,a,u,i,n,c)},e.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},e.V3sub=function(){let t=arguments[0][0],e=arguments[0][1],i=arguments[0][2];for(let s=1;s<arguments.length;s++)t-=arguments[s][0],e-=arguments[s][1],i-=arguments[s][2];return[t,e,i]},e.V3inv=function(t){return[-t[0],-t[1],-t[2]]},e.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},e.V3norm=function(t,i){const s=e.V3len(t);return void 0===i&&(i=1),0==s?[0,0,0]:[t[0]*i/s,t[1]*i/s,t[2]*i/s]},e.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},e.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},e.V3cross=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},e.prototype.multVec4=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var r=this.buf[0]*t+this.buf[4]*e+this.buf[8]*i+this.buf[12]*s,a=this.buf[1]*t+this.buf[5]*e+this.buf[9]*i+this.buf[13]*s,n=this.buf[2]*t+this.buf[6]*e+this.buf[10]*i+this.buf[14]*s,h=this.buf[3]*t+this.buf[7]*e+this.buf[11]*i+this.buf[15]*s;return[r,a,n,h]},e.rotAndTrans=function(t,i,s,r,a,n){var h=new e;return 0!=t&&h.rotate(t,1,0,0),0!=i&&h.rotate(i,0,1,0),0!=s&&h.rotate(s,0,0,1),h.translate(r,a,n),h},e.prototype.q2m=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var r=t*t,a=e*e,n=i*i;return this.buf[0]=1-2*(a+n),this.buf[1]=2*(t*e+s*i),this.buf[2]=2*(t*i-s*e),this.buf[3]=0,this.buf[4]=2*(t*e-s*i),this.buf[5]=1-2*(r+n),this.buf[6]=2*(e*i+s*t),this.buf[7]=0,this.buf[8]=2*(t*i+s*e),this.buf[9]=2*(e*i-s*t),this.buf[10]=1-2*(r+a),this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.v2q=function(t,i,s,r){(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],r=i[2],i=i[0]);let a=i*i+s*s+r*r;if(0==a)return[0,0,0,1];1!=a&&(a=Math.sqrt(a),i/=a,s/=a,r/=a),t=t*e.RAD/2;let n=Math.sin(t);return[i*n,s*n,r*n,Math.cos(t)]},e.e2q=function(t,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(i=t[1],s=t[2],t=t[0]),t*=.5*e.RAD,i*=.5*e.RAD,s*=.5*e.RAD;let r=Math.cos(t),a=Math.cos(i),n=Math.cos(s),h=Math.sin(t),o=Math.sin(i),u=Math.sin(s),c=h*a*n+r*o*u,f=r*o*n-h*a*u,l=r*a*u-h*o*n,p=r*a*n+h*o*u;return[c,f,l,p]},e.qMult=function(t,e){let i=t[3]*e[3]-(t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),s=t[1]*e[2]-t[2]*e[1]+t[3]*e[0]+e[3]*t[0],r=t[2]*e[0]-t[0]*e[2]+t[3]*e[1]+e[3]*t[1],a=t[0]*e[1]-t[1]*e[0]+t[3]*e[2]+e[3]*t[2];return[s,r,a,i]},t.CanvasMatrix4=e}),t("skylark-pox/Vector",["./pox"],function(t){class e extends Array{constructor(...t){let e=t;Array.isArray(t[0])&&(e=t[0]),super(...e),this._setxyz()}_setxyz(){this.x=this[0],void 0!==this[1]&&(this.y=this[1]),void 0!==this[2]&&(this.z=this[2]),void 0!==this[3]&&(this.w=this[3])}set x(t){this._x=t,this[0]=t}set y(t){this._y=t,this[1]=t}set z(t){this._z=t,this[2]=t}set w(t){this._w=t,this[3]=t}set r(t){this._x=t,this[0]=t}set g(t){this._y=t,this[1]=t}set b(t){this._z=t,this[2]=t}set a(t){this._w=t,this[3]=t}get x(){return this._x}get y(){return this._y}get z(){return this._z}get w(){return this._w}get r(){return this._x}get g(){return this._y}get b(){return this._z}get a(){return this._w}get xy(){return new e(this[0],this[1])}get yx(){return new e(this[1],this[0])}get xz(){return new e(this[0],this[2])}get zx(){return new e(this[2],this[0])}get yz(){return new e(this[1],this[2])}get zy(){return new e(this[2],this[1])}get xyz(){return new e(this[0],this[1],this[2])}get xzy(){return new e(this[0],this[2],this[1])}get yxz(){return new e(this[1],this[0],this[2])}get yzx(){return new e(this[1],this[2],this[0])}get zxy(){return new e(this[2],this[0],this[1])}get zyx(){return new e(this[2],this[1],this[0])}get rgb(){return new e(this[0],this[1],this[2])}cross(t){if(3!=this.length||3!=t.length)throw-1;let i=[this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0]];return new e(i)}mix(t,i){return new e(this.map((e,s)=>e*(1-i)+t[s]*i))}invert(){return new e(this.map(t=>-t))}add(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e+t[i]))}sub(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e-t[i]))}mult(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e*t[i]))}normalize(){let t=this.hypot();return new e(this.map((e,i)=>0!=t?e/t:0))}floor(){return new e(this.map((t,e)=>Math.floor(t)))}ceil(){return new e(this.map((t,e)=>Math.ceil(t)))}fract(){return new e(this.map((t,e)=>t-Math.floor(t)))}min(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e<t[i]?e:t[i]))}max(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e>t[i]?e:t[i]))}clamp(t,i){return new e(this.map((e,s)=>e<t?t:e>i?i:e))}step(t){return new e(this.map((e,i)=>e<t?0:1))}mod(t){return new e(this.map((e,i)=>e%t))}dot(t){return this.reduce((e,i,s)=>e+=i*t[s],0)}distance(t){let i=new e(...this);return i.sub(t).hypot()}hypot(){return Math.hypot(...this)}equal(t){return this.reduce((e,i,s)=>e&&i===t[s],!0)}}return t.Vector=e}),t("skylark-pox/Device",["./pox","./Vector"],function(t,e){const i={VRReady:!1,isPresenting:!1,WebXR:!1,checkVR:function(t){return new Promise((e,s)=>{navigator.xr?navigator.xr.isSessionSupported("immersive-vr").then(t=>{i.VRReady=t,i.WebXR=t,e(t)}).catch(t=>{console.log(t),e(!1)}):navigator.getVRDisplays?(void 0!=window.VRFrameData&&(i.vrFrame=new VRFrameData),navigator.getVRDisplays().then(s=>{console.log("VR init with WebVR"),i.vrDisplay=s[s.length-1],console.log(i.vrDisplay),i.VRReady=!0,window.addEventListener("vrdisplaypresentchange",()=>{console.log("vr presenting= "+i.vrDisplay.isPresenting),i.vrDisplay.isPresenting?(t.callEvent("vrchange",1),i.isPresenting=!0):(t.resize(),t.callEvent("vrchange",0),i.isPresenting=!1)},!1),window.addEventListener("vrdisplayactivate",()=>{console.log("vr active")},!1),window.addEventListener("vrdisplaydeactivate",()=>{console.log("vr deactive")},!1),e(!0)}).catch(t=>{s(t)})):e(!1)})},presentVR:function(t){return new Promise((e,s)=>{if(i.WebXR)navigator.xr.requestSession("immersive-vr").then(function(e){i.session=e,i.isPresenting=!0,console.log("vr start"),e.updateRenderState({baseLayer:new XRWebGLLayer(e,t.wwg.gl,{framebufferScaleFactor:t.pixRatio})}),e.requestReferenceSpace("local").then(e=>{i.referenceSpace=e,i.session.requestAnimationFrame(i.loopf),t.callEvent("vrchange",1)}),e.addEventListener("end",e=>{i.session=null,i.isPresenting=!1,console.log("VR end"),t.callEvent("vrchange",0)})});else if(i.vrDisplay){const e={source:t.can,attributes:{}};void 0!==t.pox.setting.highRefreshRate&&(e.attributes.highRefreshRate=t.pox.setting.highRefreshRate),void 0!==t.pox.setting.foveationLevel&&(e.attributes.foveationLevel=t.pox.setting.foveationLevel),i.vrDisplay.requestPresent([e]).then(()=>{console.log("present ok");const e=i.vrDisplay.getEyeParameters("left"),s=i.vrDisplay.getEyeParameters("right");t.can.width=2*Math.max(e.renderWidth,s.renderWidth),t.can.height=Math.max(e.renderHeight,s.renderHeight),"Oculus Go"==i.vrDisplay.displayName&&(t.can.width=2560,t.can.height=1280),t.can.width=t.can.width*t.pixRatio,t.can.height=t.can.height*t.pixRatio,t.pox.log(i.vrDisplay.displayName),t.pox.log("vr canvas:"+t.can.width+" x "+t.can.height)}).catch(t=>{console.log(t)})}})},closeVR:function(t){i.WebXR&&(console.log("vr closing"),i.isPresenting=!1,i.session.end()),i.vrDisplay&&i.vrDisplay.exitPresent().then(()=>{console.log("VR end")})},animationFrame:function(t,e,s){if(i.loopf=e,i.isPresenting){if(!s)return;i.WebXR?(i.session.requestAnimationFrame(e),i.vrFrame=s,t.isVR=!0):i.vrDisplay&&i.vrDisplay.isPresenting&&(t.loop=i.vrDisplay.requestAnimationFrame(e),t.isVR=!0)}else t.loop=window.requestAnimationFrame(e),t.isVR=!1},submitFrame:function(t){i.WebXR,i.vrDisplay&&i.vrDisplay.isPresenting&&i.vrDisplay.submitFrame()},getFrameData:function(t){if(i.WebXR&&i.vrFrame){let t=i.vrFrame.getViewerPose(i.referenceSpace);t.orientation=[t.transform.orientation.x,t.transform.orientation.y,t.transform.orientation.z,t.transform.orientation.w],t.position=[t.transform.position.x,t.transform.position.y,t.transform.position.z];let s={pose:t},r=i.session.renderState.baseLayer;i.webGLLayer=r;for(let i=0;i<=t.views.length-1;i++){var e=r.getViewport(t.views[i]);1==i?(s.rightViewMatrix=t.views[i].transform.inverse.matrix,s.rightProjectionMatrix=t.views[i].projectionMatrix,s.rightViewport=e):(s.leftViewMatrix=t.views[i].transform.inverse.matrix,s.leftProjectionMatrix=t.views[i].projectionMatrix,s.leftViewport=e)}return i.viewport={leftViewport:s.leftViewport,rightViewport:s.rightViewport},s}if(i.vrDisplay)return i.vrDisplay.getFrameData(i.vrFrame),i.vrFrame},getViewport:function(t){return i.WebXR&&i.isPresenting?i.viewport:{leftViewport:{x:0,y:0,width:t.width/2,height:t.height},rightViewport:{x:t.width/2,y:0,width:t.width/2,height:t.height}}},setDepth:function(t){i.isPresenting&&(i.WebXR&&i.session.updateRenderState({depthNear:t.camNear,depthFar:t.camFar}),i.vrDisplay&&(i.vrDisplay.depthNear=t.camNear,i.vrDisplay.depthFar=t.camFar))}};return t.Device=i}),t("skylark-pox/GPad",["./pox","./Device"],function(t,e){var i=function(){return this.idx=0,this.conn=!1,this.gpadcount=0,!!navigator.getGamepads&&(gamepads=navigator.getGamepads(),this.gpadcount=gamepads.length,this.gpadcount>0)};return i.prototype.init=function(t,e){if(void 0==t&&(t=0),this.idx=t,!navigator.getGamepads)return!1;let i=!0;return gamepads=navigator.getGamepads(),gamepads[this.idx]?(console.log("gpad init "+this.idx),this.axes=gamepads[this.idx].axes,this.conn=!1,this.egp=null):(this.conn=!1,i=!1),addEventListener("gamepadconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad reconnected "+t.gamepad.index),this.axes=t.gamepad.axes,this.conn=!0,this.get(),e&&e(this,!0))}),addEventListener("gamepaddisconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad disconnected "+t.gamepad.index),this.conn=!1,e&&e(this,!1))}),this.lastGp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]},this.egp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]},i},i.prototype.get=function(t){var i;if(e&&e.WebXR)if(this.emu=!1,e.isPresenting&&e.session.inputSources){const t=e.session.inputSources;for(let s=0;s<=t.length-1;s++)if(t[s].gamepad&&"xr-standard"==t[s].gamepad.mapping){if(t[s].gamepad.hand=t[s].handedness,"left"==t[s].handedness&&1==this.idx&&(i=t[s].gamepad),"right"==t[s].handedness&&0==this.idx&&(i=t[s].gamepad),i){let r=e.vrFrame.getPose(t[s].gripSpace,e.referenceSpace);r&&(i.pose={},r.transform.orientation&&(i.pose.orientation=[r.transform.orientation.x,r.transform.orientation.y,r.transform.orientation.z,r.transform.orientation.w]),r.transform.position&&(i.pose.position=[r.transform.position.x,r.transform.position.y,r.transform.position.z])),this.conn=!0;break}this.conn=!1}}else this.conn=!1;if(!i){if(null==this.egp)return null;this.conn=!0,i=this.egp,this.emu=!0}var s=this.lastGp;i.conn=this.conn,i.emu=this.emu,i.bf=!1,i.pf=!1,i.tf=!1,i.dbtn=[],i.dpad=[],i.dtouch=[];for(var r=0;r<i.buttons.length;r++)i.dbtn[r]=0,i.dtouch[r]=0,s&&s.buttons[r]&&(!s.buttons[r].pressed&&i.buttons[r].pressed&&(i.dbtn[r]=1,i.bf=!0),s.buttons[r].pressed&&!i.buttons[r].pressed&&(i.dbtn[r]=-1,i.bf=!0),!s.buttons[r].touched&&i.buttons[r].touched&&(i.dtouch[r]=1,i.tf=!0),s.buttons[r].touched&&!i.buttons[r].touched&&(i.dtouch[r]=-1,i.tf=!0)),s.buttons[r]={pressed:i.buttons[r].pressed,touched:i.buttons[r].touched};let a=[i.axes[0],i.axes[1],i.axes[2],i.axes[3]];void 0!==i.axes[2]&&void 0!==i.axes[3]?(a[0]=i.axes[2],a[1]=i.axes[3],i.stick=!0):i.stick=!1,i.eaxes=a;for(var r=0;r<a.length;r++)Math.abs(a[r])<.001&&(i.axes[r]=0),i.dpad[r]=0,s&&(Math.abs(s.axes[r])<.5&&Math.abs(a[r])>=.5&&(i.dpad[r]=1,i.pf=!0),Math.abs(s.axes[r])>=.5&&Math.abs(a[r])<.5&&(i.dpad[r]=-1,i.pf=!0)),s.axes[r]=a[r];return this.gp=i,this.ev&&(i.bf||i.pf||i.tf)&&this.ev(i),i},i.prototype.set=function(t){this.egp=t},i.prototype.clear=function(t){void 0==t&&(t={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]}),this.egp=t,this.cf=!0},t.GPad=i}),t("skylark-pox/Pointer",["./pox"],function(t){return t.Pointer=function(t,e){var i,s,r,a,n,h=this;function o(t){var e,s;return i&&t.touches.length>0?(e=t.touches[0].pageX-t.target.offsetLeft,s=t.touches[0].pageY-t.target.offsetTop):(e=t.offsetX,s=t.offsetY),{x:e,y:s}}function u(u){s||(r||(i="touchstart"==u.type,function(){i?(r="touchstart",a="touchend",EV_O="touchcancel",n="touchmove"):(r="mousedown",a="mouseup",EV_O="mouseout",n="mousemove");t.addEventListener(a,function(t){var i=o(t),s="touchend"==t.type?h.lastd:o(t);h.mf=!1,e.up&&(e.up({x:i.x,y:i.y,ex:s.x,ey:s.y,dx:h.dx,dy:h.dy})||t.preventDefault())},!1),t.addEventListener(EV_O,function(t){h.mf=!1;var i=o(t);e.out&&(e.out({x:i.x,y:i.y,dx:h.dx,dy:h.dy})||t.preventDefault())},!1),t.addEventListener(n,function(t){if(!s){var i=o(t);h.lastd=i,h.mf&&(h.dx=i.x-h.s.x,h.dy=i.y-h.s.y,e.move&&(e.move({x:i.x,y:i.y,ox:i.x,oy:i.y,dx:h.dx,dy:h.dy})||t.preventDefault()))}},!1)}(),first=!1),h.mf=!0,h.dx=h.dy=0,h.s=o(u),h.lastd=h.s,e.down&&(e.down({x:h.s.x,y:h.s.y,sx:h.s.x,sy:h.s.y})||u.preventDefault()))}t.addEventListener("mousedown",u,!1),t.addEventListener("touchstart",u,!1),e.contextmenu&&t.addEventListener("contextmenu",function(t){e.contextmenu({px:t.offsetX,py:t.offsetY})||t.preventDefault()},!1);e.wheel&&t.addEventListener("wheel",function(t){e.wheel(t.deltaY)||t.preventDefault()},!1);e.gesture&&(t.addEventListener("gesturestart",function(t){s=!0,e.gesture(0,0)||t.preventDefault()}),t.addEventListener("gesturechange",function(t){e.gesture(t.scale,t.rotation)||t.preventDefault()}),t.addEventListener("gestureend",function(t){s=!1}));e.gyro&&window.addEventListener("deviceorientation",function(t){var i,s,r,a=window.orientation;switch(i=null,s=null,r=null,a){case 90:t.gamma<0?(i=t.gamma+90,s=180-t.alpha,r=t.beta+180):(i=t.gamma-90,s=360-t.alpha,r=t.beta);break;case-90:t.gamma<0?(i=-t.gamma-90,s=180-t.alpha,r=180-t.beta):(i=90-t.gamma,s=360-t.alpha,r=-t.beta)}e.gyro({rx:i,ry:s,rz:r,orientation:a})})}}),t("skylark-pox/Camera",["./pox","./CanvasMatrix4"],function(t,e){const i=t.RAD,s=e;return t.Camera=class{constructor(t,i){this.poxp=t,this.cam={camCX:0,camCY:0,camCZ:0,camVX:0,camVY:0,camVZ:1,camUPX:0,camUPY:1,camUPZ:0,camRX:30,camRY:-30,camRZ:0,camd:20,camAngle:90,camWidth:1,camNear:.01,camFar:1e3,camGyro:!0,gPad:!0,sbase:.06,moveSpeed:1.3,rotAngle:30,moveY:!1,padMoveUD:!0,padRot:!0,headVec:[0,0,0]};for(let t in i)this.cam[t]=i[t];this.cama=!1,this.rotX=0,this.rotY=0,this.gev=null,this.gx=0,this.gy=0,this.gz=0,this.vcx=0,this.vcy=0,this.vcz=0,this.vrx=0,this.vry=0,this.vrz=0,this.keydown=!1,this.vr=!1,this.camVP=[new e,new e],this.camP=[new e,new e],this.camV=[new e,new e],this.vrv=[new e,new e],this.vrp=[new e,new e],this.tempM=new e,this.pvy=!1,this.pvx=!1}setCam(t){for(let e in t)this.cam[e]=t[e];this.cama=!1}getCam(){const t={basePos:[this.cam.camCX,this.cam.camCY,this.cam.camCZ],baseRot:[this.cam.camRX,this.cam.camRY,this.cam.camRZ],position:Array.from(this.cam.campos),headVec:Array.from(this.cam.headVec)};return this.cam.orientation?t.headOri=Array.from(this.cam.orientation):t.headOri=[0,0,0,1],this.cam.position?t.headPos=Array.from(this.cam.position):t.headPos=[0,0,0],t}vrchange(t){t&&(this.cam.camRX=0,this.cam.camRZ=0)}event(t,e){const s=300*this.poxp.pixRatio/this.poxp.can.width,r=this.poxp.pox.setting&&this.poxp.pox.setting.scale?this.poxp.pox.setting.scale:1;switch(t){case"down":this.rotX=this.cam.camRX,this.rotY=this.cam.camRY;break;case"move":this.cam.camRX=this.rotX+e.dy*s,this.cam.camRY=this.rotY+e.dx*s,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"up":this.rotX+=e.dy*s,this.rotY+=e.dx*s,null!==this.gev&&(this.gx=this.gev.rx-this.rotX,this.gy=this.gev.ry-this.rotY);break;case"out":this.rotX+=e.dy*s,this.rotY+=e.dx*s;break;case"wheel":this.cam.camd+=e/100*r;break;case"gesture":if(0==e.z)return this.gz=this.cam.camd,!1;this.cam.camd=this.gz/e.z;break;case"gyro":if(this.keydown||!this.cam.camGyro)return!0;if(null===e.rx)return!0;this.gev=e,this.cam.camRX=e.rx-this.gx,this.cam.camRY=e.ry-this.gy,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"keydown":this.cam.camd;const a=this.cam.moveSpeed;let n="";if(this.keydown=!0,e.altKey)switch(e.key){case"ArrowUp":this.cam.camd=this.cam.camd-a,this.cam.camd<0&&(cthis.am.camd=0);break;case"ArrowDown":this.cam.camd=this.cam.camd+a}else switch(e.key){case"ArrowLeft":case"Left":case"h":this.vry=-a;break;case"ArrowUp":case"Up":case"k":this.vrx=-a;break;case"ArrowRight":case"Right":case"l":this.vry=a;break;case"ArrowDown":case"Down":case"j":this.vrx=a;break;case"w":n="f";break;case"s":n="b";break;case"a":n="l";break;case"d":n="r";break;case"q":n="u";break;case"e":n="d"}if(""!=n){const t=("b"==n||"d"==n?-1:1)*a*r,e=this.cam;if("u"==n||"d"==n)this.vcy=t;else{let s=e.camRY;"l"==n&&(s-=90),"r"==n&&(s+=90),this.vcx=Math.sin(s*i)*t,this.vcz=-Math.cos(s*i)*t}}break;case"keyup":switch(this.keydown=!1,null!==this.gev&&(this.gx=this.gev.rx-this.cam.camRX,this.gy=this.gev.ry-this.cam.camRY),e.key){case"ArrowLeft":case"Left":case"h":case"ArrowRight":case"Right":case"l":this.vry=0;break;case"ArrowUp":case"Up":case"k":case"ArrowDown":case"Down":case"j":this.vrx=0;break;case"w":case"d":case"a":case"s":case" ":this.vcx=0,this.vcz=0;break;case"q":case"e":this.vcy=0;break;case"Dead":this.vrx=0,this.vry=0,this.vcx=0,this.vcz=0}}}update(t){const e=(this.poxp.ctime-this.poxp.ltime)/1e3;"fix"!=this.cam.camMode&&(this.cam.camRX+=this.vrx,this.cam.camRX<-89&&(this.cam.camRX=-89),this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRY+=this.vry),"walk"==this.cam.camMode&&(this.cama||(this.cam.camCX+=this.vcx*e,this.cam.camCY+=this.vcy*e,this.cam.camCZ+=this.vcz*e),this.cam.camRY+=this.vry*e),this.cama&&(this.cam.camCX+=this.acx*e,this.cam.camCY+=this.acy*e,this.cam.camCZ+=this.acz*e,this.ad+=this.av*e,this.ad>this.al&&(this.cam.camCX=this.aex,this.cam.camCY=this.aey,this.cam.camCZ=this.aez,this.cama=!1))}setPad(t,e){let i=t||e;if(i&&"walk"==this.cam.camMode){let t=[i.axes[0],i.axes[1]];if(void 0!=i.axes[2]&&0!=i.axes[2]&&(t[0]=i.axes[2]),void 0!=i.axes[3]&&0!=i.axes[3]&&(t[1]=i.axes[3]),this.cam.padMoveUD&&i.buttons[1]&&i.buttons[1].pressed)return this.vcy=-t[1]*this.cam.moveSpeed,void(this.pvy=!0);this.pvy&&(this.vcy=0,this.pvy=!1);let e=i.buttons[2]&&i.buttons[2].pressed,s=e?5*this.cam.moveSpeed:this.cam.moveSpeed;if(Math.abs(t[0])<Math.abs(t[1])&&Math.abs(t[1])>0)return this.vcx=-this.cam.headVec[0]*t[1]*s,this.cam.moveY&&(this.vcy=-this.cam.headVec[1]*t[1]*s),this.vcz=-this.cam.headVec[2]*t[1]*s,void(this.pvx=!0);if(this.pvx&&(this.vcx=0,this.vcy=0,this.vcz=0,this.pvx=!1),this.cam.padRot&&i.dpad[0]>0){let e=(t[0]>0?1:-1)*this.cam.rotAngle;this.cam.camRY+=e}}}moveTo(t,e,i,s){if(this.cama)return;let r=null!==t?t:this.cam.camCX,a=null!==e?e:this.cam.camCY,n=null!==i?i:this.cam.camCZ;if(s&&s.velocity){let t=r-this.cam.camCX,e=a-this.cam.camCY,i=n-this.cam.camCZ,h=s.velocity/Math.hypot(t,e,i);t*=h,e*=h,i*=h,this.acx=t,this.acy=e,this.acz=i,this.aex=r,this.aey=a,this.aez=n,this.al=s.velocity/h,this.ad=0,this.av=s.velocity,this.cama=!0}else this.cam.camCX=r,this.cam.camCY=a,this.cam.camCZ=n,this.cama=!1}moveCancel(){this.cama=!1}getMtx(t,e){const r=this.cam,a=this.poxp.render.wwg.can,n=a.width/(a.height*(e?2:1));let h,o,u,c,f,l,p,m,d,b,g=null;if(p=r.camUPX,m=r.camUPY,d=r.camUPZ,c=[0,0],f=[0,0],l=[0,0],!this.poxp.isVR){if("fix"==r.camMode)h=r.camVX,o=r.camVY,u=r.camVZ,this.cam.headVec=[h,o,u,0];else if("vr"==r.camMode||"walk"==r.camMode){h=r.camCX+1*Math.sin(r.camRY*i)*Math.cos(r.camRX*i),o=r.camCY+1*-Math.sin(r.camRX*i),u=r.camCZ+1*-Math.cos(r.camRY*i)*Math.cos(r.camRX*i);let t=(new s).rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0).rotate(-this.cam.camRZ,0,0,1);p=-Math.sin(r.camRZ*i),m=Math.cos(r.camRZ*i),this.cam.headVec=t.multVec4(0,0,-1,0)}else{b=r.camd*t,r.camCX=-Math.sin(r.camRY*i)*b*Math.cos(r.camRX*i),r.camCY=Math.sin(r.camRX*i)*b,r.camCZ=Math.cos(r.camRY*i)*b*Math.cos(r.camRX*i),h=0,o=0,u=0,b<0&&(h=2*r.camCX,o=2*r.camCY,u=2*r.camCZ);let e=Math.hypot(r.camCX,r.camCY,r.camCZ);this.cam.headVec=[-r.camCX/e,-r.camCY/e,-r.camCZ/e,0]}if(this.cam.campos=[r.camCX,r.camCY,r.camCZ],this.camVP[0].makeIdentity(),this.camVP[1].makeIdentity(),this.camP[0].makeIdentity(),this.camP[1].makeIdentity(),this.camV[0].makeIdentity(),this.camV[1].makeIdentity(),e){const e=-r.sbase*t;c[0]=m*(r.camCZ-u)-d*(r.camCY-o),f[0]=-p*(r.camCZ-u)+d*(r.camCX-h),l[0]=p*(r.camCY-o)-m*(r.camCX-h);const i=Math.hypot(c[0],f[0],l[0]);c[0]*=e/i,f[0]*=e/i,l[0]*=e/i,c[1]=-c[0],f[1]=-f[0],l[1]=-l[0],this.camV[0].lookat(c[0]+r.camCX,f[0]+r.camCY,l[0]+r.camCZ,h+c[0],o+f[0],u+l[0],p,m,d),this.camV[1].lookat(c[1]+r.camCX,f[1]+r.camCY,l[1]+r.camCZ,h+c[1],o+f[1],u+l[1],p,m,d),0!=r.camAngle?this.camP[0].perspective(r.camAngle,n,r.camNear,r.camFar):this.camP[0].pallarel(r.camd,n,r.camNear,r.camFar),this.camP[1]=this.camP[0],this.camVP[0].load(this.camV[0]).multRight(this.camP[0]),this.camVP[1].load(this.camV[1]).multRight(this.camP[1])}else this.camV[0].lookat(r.camCX,r.camCY,r.camCZ,h,o,u,p,m,d),0!=r.camAngle?this.camP[0].perspective(r.camAngle,n,r.camNear,r.camFar):this.camP[0].pallarel(r.camd,n,r.camNear,r.camFar),this.camVP[0].load(this.camV[0]).multRight(this.camP[0])}if(this.poxp.isVR){if(POXPDevice.setDepth({camNear:r.camNear,camFar:r.camFar}),!(g=POXPDevice.getFrameData()))return;this.cam.orientation=g.pose.orientation,this.cam.position=g.pose.position,this.cam.position||(this.cam.position=[0,0,0]),this.vrv[1].load(g.rightViewMatrix),this.vrv[0].load(g.leftViewMatrix),this.vrp[1].load(g.rightProjectionMatrix),this.vrp[0].load(g.leftProjectionMatrix),this.tempM.makeIdentity().translate(-r.camCX,-r.camCY,-r.camCZ).rotate(r.camRX,1,0,0).rotate(r.camRY,0,1,0).rotate(r.camRZ,0,0,1),this.camV[0].load(this.vrv[0]),this.leftCorrMtx&&this.camV[0].multRight(this.leftCorrMtx),this.camV[0].multLeft(this.tempM),this.camVP[0].load(this.camV[0]).multRight(this.vrp[0]),this.camP[0].load(this.vrp[0]),this.camV[1].load(this.vrv[1]),this.rightCorrMtx&&this.camV[1].multRight(this.rightCorrMtx),this.camV[1].multLeft(this.tempM),this.camVP[1].load(this.camV[1]).multRight(this.vrp[1]),this.camP[1].load(this.vrp[1]);let t=0,e=0,i=1;if(this.cam.orientation){let s=this.cam.orientation[0],r=this.cam.orientation[1],a=this.cam.orientation[2],n=this.cam.orientation[3];t=2*(-s*a-r*n),e=2*(-r*a+s*n),i=s*s+r*r-a*a-n*n;let h=Math.hypot(t,e,i);t/=h,e/=h,i/=h}this.tempM.invert();let a=this.tempM;this.cam.headVec=a.multVec4(t,e,i,0),this.cam.campos=a.multVec4(this.cam.position[0],this.cam.position[1],this.cam.position[2],1).slice(0,3);let n=(new s).load(this.camV[1]).invert(),h=(new s).load(this.camV[0]).invert();c[0]=h.buf[12]-r.camCX,f[0]=h.buf[13]-r.camCY,l[0]=h.buf[14]-r.camCZ,c[1]=n.buf[12]-r.camCX,f[1]=n.buf[13]-r.camCY,l[1]=n.buf[14]-r.camCZ}return[{camX:r.camCX+c[0],camY:r.camCY+f[0],camZ:r.camCZ+l[0],camV:this.camV[0],camVP:this.camVP[0],camP:this.camP[0],vrFrame:g},{camX:r.camCX+c[1],camY:r.camCY+f[1],camZ:r.camCZ+l[1],camV:this.camV[1],camVP:this.camVP[1],camP:this.camP[1],vrFrame:g}]}}}),t("skylark-pox/WBind",["./pox"],function(t){return WBind={},WBind.create=function(t){var e=new WBind.obj;if(void 0!==t)for(var i in t)e[i]=t[i];return e},WBind.obj=function(){this.prop={},this._elem={},this._check={},this._func={},this._tobjs={}},WBind._getobj=function(t,e){var i;return e||(e=document),"string"==typeof t?(1==(i=e.querySelectorAll(t)).length&&(i=i[0]),0==i.length&&(i=null)):i=t,i},WBind._getval=function(t){var e=t.value;if("checkbox"==t.type&&(e=t.checked),"select-multiple"==t.type){var i=t.querySelectorAll("option");e=[];for(var s=0;s<i.length;s++)i[s].selected&&e.push(i[s].value)}return"range"==t.type&&(e=parseFloat(e)),e},WBind.obj.prototype.bindHtml=function(t,e,i){var s=WBind._getobj(e);return s?(this._elem[t]=s,i||(i={}),this._func[t]=i,Object.defineProperty(this,t,{configurable:!0,get:function(){return s instanceof NodeList||Array.isArray(s)?this.prop[t]=s[0].innerHTML:this.prop[t]=s.innerHTML,this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,s instanceof NodeList||Array.isArray(s))for(var i=0;i<s.length;i++)this._elem[t][i].innerHTML=e;else this._elem[t].innerHTML=e}}),s instanceof NodeList||Array.isArray(s)?this.prop[t]=s[0].innerHTML:this.prop[t]=s.innerHTML,this):this},WBind.obj.prototype.bindStyle=function(t,e,i,s){var r=WBind._getobj(e);return r?(this._elem[t]=r,s||(s={}),this._func[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){return r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].style[i]:this.prop[t]=r.style[i],this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,r instanceof NodeList||Array.isArray(r))for(var s=0;s<r.length;s++)this._elem[t][s].style[i]=e;else this._elem[t].style[i]=e}}),r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].style[i]:this.prop[t]=r.style[i],this):this},WBind.obj.prototype.bindAttr=function(t,e,i,s){var r=WBind._getobj(e);return r?(this._elem[t]=r,s||(s={}),this._func[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){return r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].getAttribute(i):this.prop[t]=r.getAttribute(i),this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,r instanceof NodeList||Array.isArray(r))for(var s=0;s<r.length;s++)this._elem[t][s].setAttribute(i,e);else this._elem[t].setAttribute(i,e)}}),r instanceof NodeList||Array.isArray(r)?this.prop[t]=r[0].getAttribute(i):this.prop[t]=r.getAttribute(i),this):this},WBind.obj.prototype.bindInput=function(t,e,i){var s=WBind._getobj(e);if(!s)return this;i||(i={}),this._func[t]=i,(s instanceof NodeList||Array.isArray(s))&&"checkbox"!=s[0].type&&"radio"!=s[0].type&&(s=s[0]);var r=void 0!=this.prop[t];this._elem[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){var e=o(t);return this._func[t].get&&(e=this._func[t].get(e)),e},set:function(e){this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,function(t,e){var i=a._elem[t];if(i instanceof NodeList||Array.isArray(i)){if("radio"==i[0].type)for(var s=0;s<i.length;s++)i[s].value==e&&(i[s].checked=!0);else if("checkbox"==i[0].type){for(var r={},s=0;s<e.length;s++)r[e[s]]=!0;for(var s=0;s<i.length;s++)i[s].checked=r[i[s].value];a._check[t]=r}}else if("checkbox"==i.type)i.checked=e;else if("select-multiple"==i.type)for(var n=i.querySelectorAll("option"),s=0;s<n.length;s++){n[s].selected=!1;for(var h=0;h<e.length;h++)n[s].value==e[h]&&(n[s].selected=!0)}else i.value=e}(t,e),this._func[t].change&&this._func[t].change(o(t)),this._func[t].input&&this._func[t].input(o(t))}});var a=this,n=null;if(s instanceof NodeList||Array.isArray(s)){"checkbox"==s[0].type&&(a._check[t]={});for(var h=0;h<s.length;h++)"object"==typeof s[h]&&(r||s[h].addEventListener("change",function(e){var i;"checkbox"==this.type?(a._check[t][this.value]=this.checked,i=o(t)):i=this.value,a.prop[t]=i,a._func[t].get&&(i=a._func[t].get(i)),WBind.log("get "+t+"="+i),a._func[t].change&&a._func[t].change(i)}),"radio"==s[h].type&&s[h].checked?n=s[h].value:"checkbox"==s[h].type&&(a._check[t][s[h].value]=s[h].checked));"checkbox"==s[0].type&&(n=o(t))}else n=WBind._getval(s),r||s.addEventListener("change",function(e){var i=WBind._getval(this);a.prop[t]=i,a._func[t].get&&(i=a._func[t].get(i)),a._func[t].change&&a._func[t].change(i)}),r||s.addEventListener("input",function(e){var i=WBind._getval(this);a.prop[t]=i,a._func[t].get&&(i=a._func[t].get(i)),a._func[t].input&&a._func[t].input(i)});function o(t){var e;if(a._check[t]){for(var i in e=[],a._check[t])a._check[t][i]&&e.push(i);a.prop[t]=e}else e=a.prop[t];return e}return this._func[t].get&&(n=this._func[t].get(n)),this.prop[t]=n,a._func[t].input&&this._func[t].input(n),a._func[t].change&&this._func[t].change(n),this},WBind.obj.prototype.getCheck=function(t){return this._check[t]},WBind.obj.prototype.setFunc=function(t,e){for(var i in e)this._func[t][i]=e[i];var s=WBind._getval(this._elem[t]);return this._func[t].get&&(s=this._func[t].get(s)),this.prop[t]=s,this._func[t]},WBind.obj.prototype.bindAllInput=function(t){t||(t=document);for(var e=t.querySelectorAll("input,select,textarea"),i={},s=0;s<e.length;s++){var r=e[s].name;i[r]?Array.isArray(i[r])?i[r].push(e[s]):i[r]=[i[r],e[s]]:i[r]=e[s]}for(var s in i)this.bindInput(s,i[s]);return i},WBind.obj.prototype.bindAll=function(t,e){null==e&&(e=document);for(var i=e.querySelectorAll(t),s=0;s<i.length;s++){var r=i[s].getAttribute("data-bind");"INPUT"==i[s].tagName||"SELECT"==i[s].tagName?this.bindInput(r,i[s]):this.bindHtml(r,i[s])}},WBind.obj.prototype.setTimer=function(t,e,i,s){if(Array.isArray(e))return this.setTimerM(t,e);var r;s||(s={});if(r=s.from?s.from:this[t],isNaN(r)&&(r.match(/^([0-9\-\.]+)(.*)$/)?(r=parseFloat(RegExp.$1),s.sfx=RegExp.$2):r=0),r==e)return this;var a=0;s.delay&&(a=s.delay);var n=(new Date).getTime(),h={from:r,to:e,st:n+a,et:n+a+i,opt:s};return this._tobjs[t]={tl:[h],tc:0},this},WBind.obj.prototype.setTimerM=function(t,e){for(var i=[],s=(new Date).getTime(),r=this[t],a=0;a<e.length;a++){var n=e[a].to,h=e[a].time,o=e[a].opt;o||(o={});isNaN(r)&&(r.match(/^([0-9\-\.]+)(.*)$/)?(r=parseFloat(RegExp.$1),o.sfx=RegExp.$2):r=0);var u=0;o.delay&&(u=o.delay),i.push({from:r,to:n,st:s+u,et:s+u+h,opt:o}),r=n}return this._tobjs[t]={tl:i,tc:0},console.log(i),this},WBind.obj.prototype.clearTimer=function(t){delete this._tobjs[t]},WBind.obj.prototype.updateTimer=function(){var t=(new Date).getTime();for(var e in this._tobjs){var i=this._tobjs[e],s=i.tl[i.tc];if(void 0!==s&&!(s.st>t))if(s.et<=t){var r=s.to;s.opt.sfx&&(r+=s.opt.sfx),this[e]=r,i.tc++,this._tobjs[e].tl.length<i.tc&&delete this._tobjs[e],s.opt.efunc&&s.opt.efunc(s.to)}else{var a=(t-s.st)/(s.et-s.st);if(s.opt.tfunc)if("string"==typeof s.opt.tfunc)switch(s.opt.tfunc){case"ease-in":a*=a;break;case"ease-out":a*=2-a;break;case"ease-inout":a=a*a*(3-2*a)}else a=s.opt.tfunc(a);var r=s.from+(s.to-s.from)*a;s.opt.sfx&&(r+=s.opt.sfx),this[e]=r}}},WBind.log=function(t){console.log(t)},WBind.addev=function(t,e,i,s){var r=WBind._getobj(t,s);if(r){r instanceof NodeList||Array.isArray(r)||(r=[r]);for(var a=0;a<r.length;a++)r[a].addEventListener(e,function(t){i(t)||t.preventDefault()})}},WBind.set=function(t,e){e||(e=document),t instanceof Array||(t=[t]);for(var i=0;i<t.length;i++){var r,a=t[i];if(a.obj&&(r=WBind._getobj(a.obj,e)),a.id&&(r=e.getElementById(a.id)),a.sel&&(r=e.querySelectorAll(a.sel)),r){r instanceof NodeList||Array.isArray(r)||(r=[r]);for(var n=0;n<r.length;n++)if(void 0!=a.html&&(r[n].innerHTML=a.html),void 0!=a.value&&(r[n].value=a.value),void 0!=a.attr&&r[n].setAttribute(a.attr,a.value),void 0!=a.style)for(s in a.style)r[n].style[s]=a.style[s]}}},t.WBind=WBind}),t("skylark-pox/WWG",["./pox"],function(t){function e(){this.version="0.9.11",this.can=null,this.gl=null,this.vsize={float:1,vec2:2,vec3:3,vec4:4,mat2:4,mat3:9,mat4:16}}return e.prototype.init=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl",e))&&!(i=t.getContext("webgl",e)))&&(!!window.Promise&&(this.gl=i,this.ext_vao=i.getExtension("OES_vertex_array_object"),this.ext_vao&&(this.vao_create=function(){return this.ext_vao.createVertexArrayOES()},this.vao_bind=function(t){this.ext_vao.bindVertexArrayOES(t)}),this.ext_inst=i.getExtension("ANGLE_instanced_arrays"),this.ext_inst&&(this.inst_divisor=function(t,e){this.ext_inst.vertexAttribDivisorANGLE(t,e)},this.inst_draw=function(t,e,i,s,r){this.ext_inst.drawElementsInstancedANGLE(t,e,i,s,r)},this.inst_drawa=function(t,e,i,s){this.ext_inst.drawArrayInstancedANGLE(t,e,i,s)}),this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_ftex=i.getExtension("OES_texture_float"),this.ext_mrt=i.getExtension("WEBGL_draw_buffers"),this.ext_mrt&&(this.mrt_att=this.ext_mrt.COLOR_ATTACHMENT0_WEBGL,this.mrt_draw=function(t,e){return this.ext_mrt.drawBuffersWEBGL(t,e)}),this.ext_i32=i.getExtension("OES_element_index_uint"),this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=1,!0))},e.prototype.init2=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl2",e))&&!(i=t.getContext("webgl2",e)))&&(!!window.Promise&&(console.log("init for webGL2"),this.gl=i,this.ext_vao=!0,this.vao_create=function(){return this.gl.createVertexArray()},this.vao_bind=function(t){this.gl.bindVertexArray(t)},this.ext_inst=!0,this.inst_divisor=function(t,e){this.gl.vertexAttribDivisor(t,e)},this.inst_draw=function(t,e,i,s,r){this.gl.drawElementsInstanced(t,e,i,s,r)},this.inst_drawa=function(t,e,i,s){this.gl.drawArraysInstanced(t,e,i,s)},this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_anis&&(this.ext_anis_max=i.getParameter(this.ext_anis.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.ext_ftex=!0,this.ext_mrt=i.getParameter(i.MAX_DRAW_BUFFERS)>1,this.ext_mrt&&(this.mrt_att=i.COLOR_ATTACHMENT0,this.mrt_draw=function(t,e){return i.drawBuffers(t,e)}),this.ext_i32=!0,this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=2,!0))},e.prototype.loadAjax=function(t,e){return new Promise((i,s)=>{const r=new XMLHttpRequest;r.open("get",t,!0),r.responseType=e&&e.type?e.type:"text",r.onload=(()=>{200==r.status?i(r.response):s("Ajax error:"+r.statusText)}),r.onerror=(()=>{s("Ajax error:"+r.statusText)}),r.send()})},e.prototype.loadImageAjax=function(t){return new Promise((e,i)=>{this.loadAjax(t,{type:"blob"}).then(t=>{const i=new Image,s=URL.createObjectURL(t);i.onload=(()=>{URL.revokeObjectURL(s),e(i)}),i.src=s}).catch(t=>{console.log(t),e(null)})})},e.prototype.createRender=function(){return new this.Render(this)},e.prototype.Render=function(t){this.wwg=t,this.gl=t.gl,this.env={},this.modelCount=0},e.prototype.Render.prototype.setUnivec=function(t,e){if(null==t.pos)return;let s=[];if(t.dim>0&&!(e instanceof Float32Array))for(let i=0;i<t.dim;i++)s=s.concat(e[i]);else s=e;if(null!=t.cache)if(Array.isArray(s)){for(let e=0;e<s.length&&s[e]==t.cache[e];e++);if(i==s.length)return}else if(s==t.cache)return;switch(t.type){case"mat2":this.gl.uniformMatrix2fv(t.pos,!1,this.f32Array(e));break;case"mat3":this.gl.uniformMatrix3fv(t.pos,!1,this.f32Array(e));break;case"mat4":this.gl.uniformMatrix4fv(t.pos,!1,this.f32Array(e));break;case"vec2":this.gl.uniform2fv(t.pos,this.f32Array(e));break;case"vec2v":this.gl.uniform2fv(t.pos,this.f32Array(s));break;case"vec3":this.gl.uniform3fv(t.pos,this.f32Array(e));break;case"vec3v":this.gl.uniform3fv(t.pos,this.f32Array(s));break;case"vec4":this.gl.uniform4fv(t.pos,this.f32Array(e));break;case"vec4v":this.gl.uniform4fv(t.pos,this.f32Array(s));break;case"int":case"bool":this.gl.uniform1i(t.pos,e);break;case"ivec2":case"bvec2":this.gl.uniform2iv(t.pos,this.i16Array(e));break;case"ivec2v":case"bvec2v":this.gl.uniform2iv(t.pos,this.i16Array(s));break;case"ivec3":case"bvec3":this.gl.uniform3iv(t.pos,this.i16Array(e));break;case"ivec3v":case"bvec3v":this.gl.uniform3iv(t.pos,this.i16Array(s));break;case"ivec4":case"bvec4":this.gl.uniform4iv(t.pos,this.i16Array(e));break;case"ivec4v":case"bvec4v":this.gl.uniform4iv(t.pos,this.i16Array(s));break;case"intv":case"boolv":this.gl.uniform1iv(t.pos,this.i16Array(e));break;case"float":this.gl.uniform1f(t.pos,e);break;case"floatv":this.gl.uniform1fv(t.pos,this.f32Array(e));break;case"sampler2D":if("string"==typeof e&&(e=this.getTexIndex(e)),this.gl.activeTexture(this.gl.TEXTURE0+t.texunit),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[e]),void 0==this.data.texture[e])break;this.data.texture&&this.data.texture[e].video&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.data.texture[e].video),this.gl.uniform1i(t.pos,t.texunit)}},e.prototype.Render.prototype.setShader=function(t){let e=0;function s(t){const s=t.split("\n"),r=[],a=[],n={};for(i=0;i<s.length;i++){let t=s[i];if(t.match(/^\s*#define\s*([^\s]+)\s+([^\s]+)/)&&(n[RegExp.$1.trim()]=RegExp.$2.trim()),t.match(/^\s*uniform\s*([0-9a-z]+)\s+([0-9a-z_]+)(\[[^\]]+\])?/i)){let t={type:RegExp.$1,name:RegExp.$2};if(""!=RegExp.$3){t.type=t.type+"v";let e=RegExp.$3.substr(1,RegExp.$3.length-2).trim();t.dim=parseInt(e),isNaN(t.dim)&&(t.dim=n[e])}"sampler2D"==t.type&&(t.texunit=e++),r.push(t)}t.match(/^\s*(?:attribute|in)\s+([0-9a-z]+)\s*([0-9a-z_]+)/i)&&a.push({type:RegExp.$1,name:RegExp.$2})}return{uni:r,att:a}}const r=this.gl;return new Promise((e,i)=>{if(!t.vshader)return i("no vshader"),!1;if(!t.fshader)return i("no fshader"),!1;let a,n,h=[];t.vshader.text?a=t.vshader.text:t.vshader.src&&h.push(this.wwg.loadAjax(t.vshader.src).then(t=>{a=t,e()}).catch(t=>{i(t)})),t.fshader.text?n=t.fshader.text:t.fshader.src&&h.push(this.wwg.loadAjax(t.fshader.src).then(t=>{n=t,e()}).catch(t=>{i(t)})),Promise.all(h).then(t=>{let h={},o=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(o,a),r.compileShader(o),!r.getShaderParameter(o,r.COMPILE_STATUS))return i("vs error:"+r.getShaderInfoLog(o)),!1;h.vshader=o;let u=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(u,n),r.compileShader(u),!r.getShaderParameter(u,r.COMPILE_STATUS))return i("fs error:"+r.getShaderInfoLog(u)),!1;h.fshader=u;let c=r.createProgram();if(r.attachShader(c,o),r.attachShader(c,u),r.linkProgram(c),!r.getProgramParameter(c,r.LINK_STATUS))return i("link error:"+r.getProgramInfoLog(c)),!1;h.program=c,r.useProgram(c);let f=s(a);h.vs_att={};for(let t in f.att)f.att[t].pos=r.getAttribLocation(c,f.att[t].name),h.vs_att[f.att[t].name]=f.att[t];h.vs_uni={};for(let t in f.uni)f.uni[t].pos=r.getUniformLocation(c,f.uni[t].name),f.uni[t].cache=null,h.vs_uni[f.uni[t].name]=f.uni[t];let l=s(n);h.fs_uni={};for(let t in l.uni)l.uni[t].pos=r.getUniformLocation(c,l.uni[t].name),l.uni[t].cache=null,h.fs_uni[l.uni[t].name]=l.uni[t];e(h)}).catch(t=>{i(t)})})},e.prototype.Render.prototype.setUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.vs_uni[e]&&this.setUnivec(this.vs_uni[e],t.vs_uni[e]);if(t.fs_uni)for(let e in t.fs_uni)this.fs_uni[e]&&this.setUnivec(this.fs_uni[e],t.fs_uni[e]);return!0},e.prototype.Render.prototype.genTex=function(t,e){e||(e={flevel:0});let i=this.gl;const s={rgb:i.RGB,gray:i.LUMINANCE,grayalpha:i.LUMINANCE_ALPHA};let r=e.format&&s[e.format]?s[e.format]:i.RGBA,a=i.createTexture();switch(i.bindTexture(i.TEXTURE_2D,a),e.isarray?(t instanceof Float32Array?i.texImage2D(i.TEXTURE_2D,0,i.RGBA32F,e.width,e.height,0,r,i.FLOAT,t,0):i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,r,i.UNSIGNED_BYTE,t),e.flevel=0,e.nomipmap=!0):i.texImage2D(i.TEXTURE_2D,0,r,r,i.UNSIGNED_BYTE,t),e.nomipmap||i.generateMipmap(i.TEXTURE_2D),e.flevel){case 0:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);break;case 1:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);break;case 2:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)}return 2==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)):1==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.MIRRORED_REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.MIRRORED_REPEAT)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT)),this.wwg.ext_anis&&e.anisotropy&&i.texParameteri(i.TEXTURE_2D,this.wwg.ext_anis.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropy),i.bindTexture(i.TEXTURE_2D,null),a},e.prototype.Render.prototype.loadTex=function(t){this.gl;return new Promise((e,i)=>{if(t.src)if(t.opt&&t.opt.cors)this.wwg.loadImageAjax(t.src).then(i=>{e(this.genTex(i,t.opt))}).catch(t=>i(t));else{let s=new Image;s.onload=(()=>{e(this.genTex(s,t.opt))}),s.onerror=(()=>{i("cannot load image")}),s.src=t.src}else t.img instanceof Image?e(this.genTex(t.img,t.opt)):t.video?e(this.genTex(t.video,{nomipmap:!0,flevel:0,repeat:2})):t.buffer?void 0!=t.mrt?e(t.buffer.fb.t[t.mrt]):e(t.buffer.fb.t):t.texture?e(t.texture):t.canvas?e(this.genTex(t.canvas,t.opt)):t.array?(t.opt.isarray=!0,e(this.genTex(t.array,t.opt))):i("no image")})},e.prototype.Render.prototype.getTexIndex=function(t){if(!this.data.texture)return null;let e;for(e=0;e<this.data.texture.length&&this.data.texture[e].name!=t;e++);return e==this.data.texture.length?null:e},e.prototype.Render.prototype.addTex=function(t){return new Promise((e,i)=>{this.data.texture||(this.data.texture=[]),this.data.texture.push(t),this.loadTex(t).then(t=>{this.texobj.push(t),e(this.texobj.length-1)}).catch(t=>i(t))})},e.prototype.Render.prototype.removeTex=function(t){"string"==typeof t&&(t=this.getTexIndex(t)),null!==t&&(this.data.texture[t]=null,this.texobj[t]=null)},e.prototype.Render.prototype.frameBuffer=function(t){let e=this.gl;console.log("create framebuffer "+t.width+"x"+t.height);let i=t.mrt,s=e.UNSIGNED_BYTE,r=e.LINEAR;this.wwg.ext_ftex&&t.float&&(s=e.FLOAT,r=e.NEAREST,console.log("use float tex"));let a=[],n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n);let h=e.createRenderbuffer();if(e.bindRenderbuffer(e.RENDERBUFFER,h),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,h),i){let n=[];for(let h=0;h<i;h++)n[h]=e.createTexture(),e.bindTexture(e.TEXTURE_2D,n[h]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.framebufferTexture2D(e.FRAMEBUFFER,this.wwg.mrt_att+h,e.TEXTURE_2D,n[h],0),a.push(this.wwg.mrt_att+h)}else{let i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null);let o={ox:t.offsetX,oy:t.offsetY,width:t.width,height:t.height,f:n,d:h,t:fTexture};return i&&(o.fblist=a),o},e.prototype.Render.prototype.setRender=function(t){let e=this.gl;return this.env=t.env,this.data=t,new Promise((i,s)=>{if(!e)return void s("no init");let r=[];this.setShader({fshader:t.fshader,vshader:t.vshader}).then(a=>{if(this.vshader=a.vshader,this.fshader=a.fshader,this.program=a.program,this.vs_uni=a.vs_uni,this.vs_att=a.vs_att,this.fs_uni=a.fs_uni,t.texture)for(let e=0;e<t.texture.length;e++)r.push(this.loadTex(t.texture[e]));Promise.all(r).then(r=>{if(this.texobj=r,this.setUniValues(t)){this.env.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.env.face_cw?e.frontFace(e.CW):e.frontFace(e.CCW),this.env.nodepth?e.disable(e.DEPTH_TEST):e.enable(e.DEPTH_TEST);for(let e=0;e<t.model.length;e++)t.model[e].obuf=this.setObj(t.model[e],!0);this.modelCount=t.model.length,this.env.offscreen&&(this.env.offscreen.mrt&&(this.wwg.ext_mrt||s("MRT not support")),this.fb=this.frameBuffer(this.env.offscreen)),i(this)}else s("no uniform name")}).catch(t=>{s(t)})}).catch(t=>{s(t)})})},e.prototype.Render.prototype.clear=function(){let t=this.env.clear_color;this.gl.clearColor(t[0],t[1],t[2],t[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},e.prototype.Render.prototype.f32Array=function(t){return t instanceof Float32Array?t:new Float32Array(t)},e.prototype.Render.prototype.i16Array=function(t){return t instanceof Int16Array?t:new Int16Array(t)},e.prototype.Render.prototype.i32Array=function(t){return t instanceof Uint32Array?t:new Uint32Array(t)},e.prototype.Render.prototype.setObj=function(t,e){let i,s=this.gl,r=t.geo,a=t.inst;ret={},this.wwg.ext_vao&&(i=this.wwg.vao_create(),this.wwg.vao_bind(i),ret.vao=i);let n=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,n);let h=0,o=[];for(let t=0;t<r.vtx_at.length;t++)o.push(this.vs_att[r.vtx_at[t]]),h+=this.wwg.vsize[this.vs_att[r.vtx_at[t]].type];ret.ats=o,ret.tl=h;let u,c,f=0;for(let t in this.vs_att)this.vs_att[t].pos>=0&&s.disableVertexAttribArray(this.vs_att[t].pos);for(let t=0;t<o.length;t++){let e=this.wwg.vsize[o[t].type];s.enableVertexAttribArray(this.vs_att[o[t].name].pos),s.vertexAttribPointer(this.vs_att[o[t].name].pos,e,s.FLOAT,!1,4*h,f),f+=4*e}if(ret.vbo=n,r.idx&&(u=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u),ret.ibo=u),a){c=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,c);let t=0,e=[];for(let i=0;i<a.attr.length;i++)e.push(this.vs_att[a.attr[i]]),t+=this.wwg.vsize[this.vs_att[a.attr[i]].type];t*=4,ret.iats=e,ret.itl=t;let i=0;for(let r=0;r<e.length;r++){let n=a.divisor?a.divisor[r]:1,h=this.wwg.vsize[e[r].type],o=this.vs_att[e[r].name].pos;s.enableVertexAttribArray(o),s.vertexAttribPointer(o,h,s.FLOAT,!1,t,i),i+=4*h,this.wwg.inst_divisor(o,n)}ret.inst=c}return this.wwg.ext_vao&&this.wwg.vao_bind(null),this.wwg.ext_vao&&this.wwg.vao_bind(i),e&&(s.bindBuffer(s.ARRAY_BUFFER,n),s.bufferData(s.ARRAY_BUFFER,this.f32Array(r.vtx),r.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),e&&r.idx&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u),r.vtx.length/ret.tl>65536&&this.wwg.ext_i32?(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i32Array(r.idx),s.STATIC_DRAW),ret.i32=!0):(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i16Array(r.idx),s.STATIC_DRAW),ret.i32=!1)),e&&a&&(s.bindBuffer(s.ARRAY_BUFFER,c),s.bufferData(s.ARRAY_BUFFER,this.f32Array(a.data),a.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),this.wwg.ext_vao&&this.wwg.vao_bind(null),ret},e.prototype.Render.prototype.getModels=function(){return this.data.model.filter(t=>null!==t)},e.prototype.Render.prototype.getModelIdx=function(t){let e=!1;if("string"!=typeof t)e=parseInt(t);else for(let i=0;i<this.data.model.length;i++)if(null!==this.data.model[i]&&t==this.data.model[i].name){e=i;break}return e},e.prototype.Render.prototype.addModel=function(t){let e=!1;if(t.name&&(e=this.getModelIdx(t.name)),!1!==e)return this.data.model[e]=t,void(this.data.model[e].obuf=this.setObj(t,!0));this.data.model.push(t),this.data.model[this.data.model.length-1].obuf=this.setObj(t,!0),this.modelCount++},e.prototype.Render.prototype.removeModel=function(t){let e=this.getModelIdx(t);return!1!==e&&(this.data.model[e].obuf=null,this.data.model[e]=null,this.modelCount--,!0)},e.prototype.Render.prototype.updateModel=function(t,e,i,s=!0){let r=this.getModelIdx(t),a=this.data.model[r].obuf;switch(e){case"vbo":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.vbo);break;case"inst":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.inst)}s?this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.f32Array(i)):this.gl.bufferData(this.gl.ARRAY_BUFFER,this.f32Array(i),this.gl.DYNAMIC_DRAW)},e.prototype.Render.prototype.updateModelInstance=function(t,e,i){let s=this.getModelIdx(t),r=this.data.model[s].obuf;this.data.model[s].inst.count=i,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.inst),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.f32Array(e),this.gl.DYNAMIC_DRAW)},e.prototype.Render.prototype.getModelData=function(t){let e=this.getModelIdx(t);return this.data.model[e]},e.prototype.Render.prototype.updateTex=function(t,e,i){"string"==typeof t&&(t=this.getTexIndex(t));var s=this.data.texture[t];this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[t]),s.array?i?s.array instanceof Float32Array?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.FLOAT,e,i.ofs):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e,i.ofs):s.array instanceof Float32Array?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA16F,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.FLOAT,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):i?i.wx>0&&i.wy>0?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.wx,i.wy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),s.opt&&!s.opt.nomipmap&&this.gl.generateMipmap(this.gl.TEXTURE_2D)},e.prototype.Render.prototype.pushUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.update_uni.vs_uni[e]=t.vs_uni[e];if(t.fs_uni)for(let e in t.fs_uni)this.update_uni.fs_uni[e]=t.fs_uni[e]},e.prototype.Render.prototype.updateUniValues=function(t){t?this.setUniValues(this.update_uni):this.update_uni={vs_uni:{},fs_uni:{}}},e.prototype.Render.prototype.draw=function(t,e){let i=this.gl;i.useProgram(this.program),this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,this.fb.f),this.env.offscreen.mrt&&this.wwg.mrt_draw(this.fb.fblist),i.viewport(fb.offsetX,fb.offsetY,this.fb.width,this.fb.height)),e||this.clear();let s=this.data.model;for(let e=0;e<s.length;e++){if(null===s[e])continue;let r=s[e];if(r.hide)continue;if(null==r.obuf)continue;let a=r.geo;if(this.updateUniValues(0),this.pushUniValues(this.data),this.pushUniValues(r),t){Array.isArray(t)||(t=[t]);for(let i=0;i<t.length;i++)if(this.pushUniValues(t[i]),t[i].model){let s=t[i].model[e];s&&this.pushUniValues(s)}}this.updateUniValues(1);let n=r.obuf,h=a.ofs>0?a.ofs:0;if(this.wwg.ext_vao)this.wwg.vao_bind(n.vao);else{i.bindBuffer(i.ARRAY_BUFFER,n.vbo);let t=0;for(let t in this.vs_att)i.disableVertexAttribArray(this.vs_att[t].pos);for(let e=0;e<n.ats.length;e++){let s=this.wwg.vsize[n.ats[e].type];i.enableVertexAttribArray(this.vs_att[n.ats[e].name].pos),i.vertexAttribPointer(this.vs_att[n.ats[e].name].pos,s,i.FLOAT,!1,4*n.tl,t),t+=4*s}if(n.ibo&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n.ibo),n.inst){let t=r.inst;i.bindBuffer(i.ARRAY_BUFFER,n.inst);let e=0;for(let s=0;s<n.iats.length;s++){let r=t.divisor?t.divisor[s]:1,a=this.wwg.vsize[n.iats[s].type],h=this.vs_att[n.iats[s].name].pos;i.enableVertexAttribArray(h),i.vertexAttribPointer(h,a,i.FLOAT,!1,n.itl,e),e+=4*a,this.wwg.inst_divisor(h,r)}}}r.preFunction&&r.preFunction(i,r,n),void 0!==r.blend&&(i.enable(i.BLEND),"alpha"==r.blend&&i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE)),void 0!==r.cull&&(r.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE));let o=this.wwg.dmodes[a.mode];if(void 0==o)return console.log("Error: illigal draw mode"),!1;r.inst?a.idx?this.wwg.inst_draw(o,a.idx.length,n.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,h,r.inst.count):this.wwg.inst_drawa(o,h,a.count>0?a.count:a.vtx.length/n.tl,r.inst.count):a.idx?i.drawElements(o,a.idx.length,n.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,h):i.drawArrays(o,h,a.count>0?a.count:a.vtx.length/n.tl),this.wwg.ext_vao&&this.wwg.vao_bind(null),void 0!==r.blend&&i.disable(i.BLEND),void 0!==r.cull&&(this.env.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE)),r.postFunction&&r.postFunction(i,r)}return this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.wwg.can.width,this.wwg.can.height)),!0},t.WWG=e}),t("skylark-pox/WWModel",["./pox","./CanvasMatrix4"],function(t,e){class i{primitive(t,i){i||(i={});let s=i.wx?i.wx:1,r=i.wy?i.wy:1,a=i.wz?i.wz:1,n=i.div?i.div:10,h=i.divx?i.divx:n,o=i.divy?i.divy:n,u=i.divz?i.divz:n,c=i.ninv?-1:1,f=[],l=[],p=[],m=[],d=2*Math.PI,b={r05:{v:[[-.52573111,-.7236068,.4472136],[-.85065081,.2763932,.4472136],[-0,.89442719,.4472136],[.85065081,.2763932,.4472136],[.52573111,-.7236068,.4472136],[0,-.89442719,-.4472136],[-.85065081,-.2763932,-.4472136],[-.52573111,.7236068,-.4472136],[.52573111,.7236068,-.4472136],[.85065081,-.2763932,-.4472136],[0,0,1],[-0,0,-1]],s:[[0,1,6],[0,6,5],[0,5,4],[0,4,10],[0,10,1],[1,2,7],[1,7,6],[1,10,2],[2,3,8],[2,8,7],[2,10,3],[3,4,9],[3,9,8],[3,10,4],[4,5,9],[5,6,11],[5,11,9],[6,7,11],[7,8,11],[8,9,11]]},r04:{v:[[-.35682209,-.49112347,.79465447],[.35682209,-.49112347,.79465447],[.57735027,-.79465447,.18759247],[0,-.98224695,-.18759247],[-.57735027,-.79465447,.18759247],[-.57735027,.18759247,.79465447],[.57735027,.18759247,.79465447],[.93417236,-.303531,-.18759247],[-0,-.607062,-.79465447],[-.93417236,-.303531,-.18759247],[-.93417236,.303531,.18759247],[0,.607062,.79465447],[.93417236,.303531,.18759247],[.57735027,-.18759247,-.79465447],[-.57735027,-.18759247,-.79465447],[-.57735027,.79465447,-.18759247],[0,.98224695,.18759247],[.57735027,.79465447,-.18759247],[.35682209,.49112347,-.79465447],[-.35682209,.49112347,-.79465447]],s:[[0,1,6,11,5],[0,5,10,9,4],[0,4,3,2,1],[1,2,7,12,6],[2,3,8,13,7],[3,4,9,14,8],[5,11,16,15,10],[6,12,17,16,11],[7,13,18,17,12],[8,14,19,18,13],[9,10,15,19,14],[15,16,17,18,19]]},r03:{v:[[-.57735027,-.57735027,.57735027],[-.57735027,.57735027,.57735027],[.57735027,.57735027,.57735027],[.57735027,-.57735027,.57735027],[-.57735027,-.57735027,-.57735027],[-.57735027,.57735027,-.57735027],[.57735027,.57735027,-.57735027],[.57735027,-.57735027,-.57735027]],s:[[0,1,5,4],[0,4,7,3],[0,3,2,1],[1,2,6,5],[2,3,7,6],[4,5,6,7]]},r02:{v:[[-.70710678,-.70710678,0],[-.70710678,.70710678,0],[.70710678,.70710678,0],[.70710678,-.70710678,0],[0,0,-1],[0,0,1]],s:[[0,1,4],[0,4,3],[0,3,5],[0,5,1],[1,2,4],[1,5,2],[2,3,4],[2,5,3]]},r01:{v:[[-.81649658,-.47140452,.33333333],[.81649658,-.47140452,.33333333],[0,0,-1],[0,.94280904,.33333333]],s:[[0,1,3],[0,3,2],[0,2,1],[1,2,3]]},s11:{v:[[-.13149606,-.40470333,.90494412],[-.34426119,-.25012042,.90494412],[-.42553024,-1e-8,.90494412],[-.34426119,.2501204,.90494412],[-.13149606,.40470332,.90494412],[.13149611,.40470332,.90494412],[.34426124,.2501204,.90494412],[.42553028,-1e-8,.90494412],[.34426124,-.25012042,.90494412],[.13149611,-.40470333,.90494412],[-.13149606,-.62841783,.76668096],[-.34426119,-.69754941,.6284178],[-.42553024,-.80940666,.4047033],[-.34426119,-.92126391,.18098881],[-.13149606,-.99039549,.04272564],[.13149611,-.99039549,.04272564],[.34426124,-.92126391,.18098881],[.42553028,-.80940666,.4047033],[.34426124,-.69754941,.6284178],[.13149611,-.62841783,.76668096],[-.55702632,-.5429665,.6284178],[-.55702632,-.319252,.76668096],[-.63829537,-.06913159,.76668096],[-.76979145,.11185724,.6284178],[-.90128753,.15458291,.4047033],[-.98255658,.04272566,.1809888],[-.98255658,-.18098884,.04272564],[-.90128753,-.43110925,.04272564],[-.76979145,-.61209808,.18098881],[-.63829537,-.65482375,.4047033],[-.82001848,.54296648,.18098881],[-.82001848,.40470332,.4047033],[-.6885224,.36197765,.6284178],[-.47575727,.43110923,.76668096],[-.26299214,.58569215,.76668096],[-.13149606,.76668098,.6284178],[-.13149606,.90494414,.4047033],[-.26299214,.94766981,.18098881],[-.47575727,.87853823,.04272564],[-.6885224,.72395531,.04272564],[.47575732,.87853821,.04272564],[.26299219,.94766979,.1809888],[.13149611,.90494413,.4047033],[.13149611,.76668098,.6284178],[.26299219,.58569215,.76668096],[.47575732,.43110923,.76668096],[.68852245,.36197765,.6284178],[.82001853,.4047033,.40470331],[.82001853,.54296646,.18098881],[.68852245,.72395529,.04272564],[.63829541,-.65482375,.4047033],[.7697915,-.61209808,.18098881],[.90128758,-.43110925,.04272564],[.98255663,-.18098884,.04272564],[.98255647,.04272561,.18098879],[.9012875,.15458288,.40470331],[.7697915,.11185724,.6284178],[.63829541,-.06913159,.76668096],[.55702637,-.319252,.76668096],[.55702637,-.5429665,.6284178],[-.47575727,-.87853824,-.04272569],[-.6885224,-.72395533,-.04272569],[-.82001848,-.5429665,-.18098886],[-.82001848,-.40470333,-.40470335],[-.6885224,-.36197767,-.62841785],[-.47575727,-.43110925,-.76668101],[-.26299214,-.58569216,-.76668101],[-.13149605,-.76668099,-.62841784],[-.13149606,-.90494416,-.40470335],[-.26299214,-.94766982,-.18098885],[-.90128753,-.15458292,-.40470335],[-.98255658,-.04272567,-.18098885],[-.98255658,.18098882,-.04272569],[-.90128753,.43110923,-.04272569],[-.76979145,.61209806,-.18098885],[-.63829536,.65482373,-.40470335],[-.55702632,.54296648,-.62841785],[-.55702632,.31925199,-.76668101],[-.63829537,.06913157,-.76668101],[-.76979145,-.11185726,-.62841785],[-.13149606,.62841781,-.76668101],[-.34426119,.6975494,-.62841785],[-.42553023,.80940665,-.40470335],[-.34426119,.92126389,-.18098885],[-.13149606,.99039547,-.04272569],[.13149611,.99039546,-.04272569],[.34426124,.92126387,-.18098886],[.42553028,.80940661,-.40470335],[.34426124,.69754939,-.62841785],[.13149611,.62841781,-.76668101],[.76979153,-.11185725,-.62841782],[.63829541,.06913155,-.76668097],[.55702634,.31925197,-.76668097],[.55702635,.54296649,-.62841782],[.63829541,.6548237,-.40470335],[.76979149,.61209803,-.18098885],[.9012875,.43110919,-.04272571],[.98255648,.18098877,-.04272572],[.9825564,-.04272561,-.18098874],[.90128711,-.15458281,-.4047032],[.26299219,-.94766982,-.18098885],[.13149611,-.90494416,-.40470335],[.13149611,-.76668098,-.62841784],[.26299219,-.58569215,-.76668099],[.47575682,-.43110886,-.76668009],[.68852237,-.36197738,-.6284173],[.82001805,-.40470325,-.40470322],[.82001853,-.5429665,-.18098885],[.68852245,-.72395533,-.04272569],[.47575732,-.87853824,-.04272569],[-.13149606,-.40470333,-.90494417],[-.34426119,-.25012042,-.90494417],[-.42553024,-0,-.90494417],[-.34426119,.2501204,-.90494417],[-.13149606,.40470332,-.90494417],[.13149611,.40470332,-.90494417],[.3442612,.25012038,-.90494414],[.42553027,-3e-8,-.90494414],[.3442606,-.25012001,-.90494332],[.13149611,-.40470332,-.90494416]],s:[[0,1,21,20,11,10],[0,10,19,9],[0,9,8,7,6,5,4,3,2,1],[1,2,22,21],[2,3,33,32,23,22],[3,4,34,33],[4,5,44,43,35,34],[5,6,45,44],[6,7,57,56,46,45],[7,8,58,57],[8,9,19,18,59,58],[10,11,12,13,14,15,16,17,18,19],[11,20,29,12],[12,29,28,61,60,13],[13,60,69,14],[14,69,68,101,100,15],[15,100,109,16],[16,109,108,51,50,17],[17,50,59,18],[20,21,22,23,24,25,26,27,28,29],[23,32,31,24],[24,31,30,73,72,25],[25,72,71,26],[26,71,70,63,62,27],[27,62,61,28],[30,31,32,33,34,35,36,37,38,39],[30,39,74,73],[35,43,42,36],[36,42,41,85,84,37],[37,84,83,38],[38,83,82,75,74,39],[40,41,42,43,44,45,46,47,48,49],[40,49,95,94,87,86],[40,86,85,41],[46,56,55,47],[47,55,54,97,96,48],[48,96,95,49],[50,51,52,53,54,55,56,57,58,59],[51,108,107,52],[52,107,106,99,98,53],[53,98,97,54],[60,61,62,63,64,65,66,67,68,69],[63,70,79,64],[64,79,78,112,111,65],[65,111,110,66],[66,110,119,103,102,67],[67,102,101,68],[70,71,72,73,74,75,76,77,78,79],[75,82,81,76],[76,81,80,114,113,77],[77,113,112,78],[80,81,82,83,84,85,86,87,88,89],[80,89,115,114],[87,94,93,88],[88,93,92,116,115,89],[90,91,92,93,94,95,96,97,98,99],[90,99,106,105],[90,105,104,118,117,91],[91,117,116,92],[100,101,102,103,104,105,106,107,108,109],[103,119,118,104],[110,111,112,113,114,115,116,117,118,119]]},s06:{v:[[-.20177411,-.27771823,.93923362],[-.40354821,-.55543646,.72707577],[-.20177411,-.8331547,.51491792],[.20177411,-.8331547,.51491792],[.40354821,-.55543646,.72707577],[.20177411,-.27771823,.93923362],[-.32647736,.10607893,.93923362],[-.65295472,.21215785,.72707577],[-.85472883,-.06556038,.51491792],[-.73002557,-.44935754,.51491792],[-.73002557,-.66151539,.17163931],[-.40354821,-.89871508,.17163931],[-.20177411,-.96427546,-.17163931],[.20177411,-.96427546,-.17163931],[.40354821,-.89871508,.17163931],[.73002557,-.66151539,.17163931],[.73002557,-.44935754,.51491792],[.85472883,-.06556038,.51491792],[.65295472,.21215785,.72707577],[.32647736,.10607893,.93923362],[-0,.34327861,.93923362],[-.65295472,.55543646,.51491792],[-.85472883,.48987608,.17163931],[-.97943209,.10607893,.17163931],[-.97943209,-.10607892,-.17163931],[-.85472883,-.48987608,-.17163931],[-.65295472,-.55543646,-.51491792],[-.32647736,-.79263615,-.51491792],[-0,-.68655723,-.72707577],[.32647736,-.79263615,-.51491792],[.65295472,-.55543646,-.51491792],[.85472883,-.48987608,-.17163931],[.97943209,-.10607893,-.17163931],[.97943209,.10607893,.17163931],[.85472883,.48987608,.17163931],[.65295472,.55543646,.51491792],[.32647736,.79263615,.51491792],[0,.68655723,.72707577],[-.32647736,.79263615,.51491792],[-.73002557,.66151539,-.17163931],[-.73002557,.44935754,-.51491792],[-.85472883,.06556038,-.51491792],[-.65295472,-.21215785,-.72707577],[-.32647736,-.10607892,-.93923362],[0,-.34327861,-.93923362],[.32647736,-.10607892,-.93923362],[.65295472,-.21215785,-.72707577],[.85472883,.06556038,-.51491792],[.73002557,.44935754,-.51491792],[.73002557,.66151539,-.17163931],[.40354821,.89871508,-.17163931],[.20177411,.96427546,.17163931],[-.20177411,.96427546,.17163931],[-.40354821,.89871508,-.17163931],[-.20177411,.83315469,-.51491792],[-.40354821,.55543646,-.72707577],[-.20177411,.27771823,-.93923362],[.2017741,.27771823,-.93923362],[.40354821,.55543646,-.72707577],[.20177411,.83315469,-.51491792]],s:[[0,5,19,20,6],[0,6,7,8,9,1],[0,1,2,3,4,5],[1,9,10,11,2],[2,11,12,13,14,3],[3,14,15,16,4],[4,16,17,18,19,5],[6,20,37,38,21,7],[7,21,22,23,8],[8,23,24,25,10,9],[10,25,26,27,12,11],[12,27,28,29,13],[13,29,30,31,15,14],[15,31,32,33,17,16],[17,33,34,35,18],[18,35,36,37,20,19],[21,38,52,53,39,22],[22,39,40,41,24,23],[24,41,42,26,25],[26,42,43,44,28,27],[28,44,45,46,30,29],[30,46,47,32,31],[32,47,48,49,34,33],[34,49,50,51,36,35],[36,51,52,38,37],[39,53,54,55,40],[40,55,56,43,42,41],[43,56,57,45,44],[45,57,58,48,47,46],[48,58,59,50,49],[50,59,54,53,52,51],[54,59,58,57,56,55]]}};switch(t){case"sphere":for(let t=0;t<=n;++t){let e=t/(0+n),i=Math.cos(Math.PI*e),h=Math.sin(Math.PI*e);for(let t=0;t<=2*n;++t){let o=t/(0+2*n),u=Math.cos(d*o)*h,m=Math.sin(d*o)*h;f.push([u*s,i*r,m*a]),l.push([u*c,i*c,m*c]),p.push([c>0?1-o:o,1-e])}}let e=2*n+1;for(let t=0;t<n;++t){let i=t*e;for(let t=0;t<2*n;++t)c>0?m.push([i+t,i+t+1,i+t+e],[i+t+e,i+t+1,i+t+1+e]):m.push([i+t+e,i+t+1,i+t],[i+t+1+e,i+t+1,i+t+e])}break;case"sphere2":const x=i.div?i.div:6,y=Math.PI/2;for(let t=0;t<x;t++){let e=Math.sin(y*t/x),i=Math.cos(y*t/x),n=x-t;for(let h=0;h<=n;h++){let o=Math.cos(y*h/n)*i,u=Math.sin(y*h/n)*i;f.push([o*s,e*r,u*a]),l.push([o,e,u]),p.push([1-h/n/4,.5+t/x/2])}}f.push([0,r,0]),l.push([0,1,0]),p.push([.75,1]);let _=0;for(let t=0;t<x;t++){let e=2*(x-t)-1,i=x-t+1;for(let t=0;t<e;t++){let e=Math.floor(t/2);t%2==0?c>0?m.push([e+_,e+_+i,e+_+1]):m.push([e+_,e+_+1,e+_+i]):c>0?m.push([e+1+_,e+_+i,e+_+i+1]):m.push([e+1+_,e+_+i+1,e+_+i])}_+=i}let R=f.length,w=m.length;for(let t=0;t<R;t++)f.push([f[t][0],-f[t][1],f[t][2]]),l.push([f[t][0],-f[t][1],f[t][2]]),p.push([p[t][0],1-p[t][1]]);for(let t=0;t<w;t++)m.push([m[t][0]+R,m[t][2]+R,m[t][1]+R]);R=f.length,w=m.length;for(let t=0;t<R;t++)f.push([-f[t][0],f[t][1],f[t][2]]),l.push([-f[t][0],f[t][1],f[t][2]]),p.push([1-p[t][0]+.5,p[t][1]]);for(let t=0;t<w;t++)m.push([m[t][0]+R,m[t][2]+R,m[t][1]+R]);R=f.length,w=m.length;for(let t=0;t<R;t++)f.push([f[t][0],f[t][1],-f[t][2]]),l.push([f[t][0],f[t][1],-f[t][2]]),p.push([1-p[t][0],p[t][1]]);for(let t=0;t<w;t++)m.push([m[t][0]+R,m[t][2]+R,m[t][1]+R]);break;case"cylinder":o=i.divy?i.divy:1;for(let t=0;t<=n;++t){let e=t/(0+n),i=Math.sin(d*e)*a,h=Math.cos(d*e)*s,u=2*r/o;for(let t=0;t<=o;t++)f.push([h,t*u-r,i]),l.push([h*c,0,i*c]),p.push([c>0?1-e:e,t/o])}for(let t=0;t<n;t++)for(let e=0;e<o;e++){let i=t*(o+1)+e;c<0?m.push([i,i+(o+1),i+(o+1)+1,i+1]):m.push([i,i+1,i+3,i+2])}i.cap;break;case"ring":o=i.divy?i.divy:1;for(let t=0;t<=n;++t){let e=t/(0+n),i=Math.sin(d*e)*a,h=Math.cos(d*e)*s;for(let t=0;t<o;t++)f.push([h,r,i]),l.push([h*c,0,i*c]),p.push([c>0?1-e:e,1]),f.push([h,-r,i]),l.push([h*c,0,i*c,0]),p.push([c>0?1-e:e,0])}for(let t=0;t<n;t++)c>0?m.push([2*t,2*t+2,2*t+3,2*t+1]):m.push([2*t,2*t+1,2*t+3,2*t+2]);i.cap;break;case"cone":for(let t=0;t<=n;++t){let e=t/(0+n),i=Math.sin(d*e)*a,h=Math.cos(d*e)*s;f.push([0,r,0]),l.push([h*c,0,i*c]),p.push([c>0?1-e:e,1]),f.push([h,-r,i]),l.push([h*c,0,i*c,0]),p.push([c>0?1-e:e,0])}for(let t=0;t<n;t++)c>0?m.push([2*t,2*t+2,2*t+3,2*t+1]):m.push([2*t,2*t+1,2*t+3,2*t+2]);break;case"disc":for(let t=0;t<n;++t){let e=t/(0+n),i=Math.cos(d*e)*a,r=Math.sin(d*e)*s;f.push([r,0,i]),l.push([0,1,0]),p.push([(r/s+1)/2,(i/a+1)/2])}f.push([0,0,0]),l.push([0,1,0]),p.push([.5,.5]);for(let t=0;t<n-1;t++)m.push([t,t+1,n]);m.push([n-1,0,n]);break;case"plane":i.wz?i.wx?(f=[[s,0,a],[s,0,-a],[-s,0,-a],[-s,0,a]],l=[[0,c,0],[0,c,0],[0,c,0],[0,c,0]]):(f=[[0,-r,-a],[0,r,-a],[0,r,a],[0,-r,a]],l=[[c,0,0],[c,0,0],[c,0,0],[c,0,0]]):(f=[[s,-r,0],[s,r,0],[-s,r,0],[-s,-r,0]],l=[[0,0,c],[0,0,c],[0,0,c],[0,0,c]]),p=c>0?[[1,0],[1,1],[0,1],[0,0]]:[[-1,0],[-1,1],[0,1],[0,0]],m=c>0?[[0,1,2],[2,3,0]]:[[2,1,0],[0,3,2]];break;case"box":f=[[s,r,a],[s,-r,a],[-s,-r,a],[-s,r,a],[s,r,-a],[s,-r,-a],[-s,-r,-a],[-s,r,-a],[s,r,a],[s,-r,a],[s,-r,-a],[s,r,-a],[-s,r,a],[-s,-r,a],[-s,-r,-a],[-s,r,-a],[s,r,a],[s,r,-a],[-s,r,-a],[-s,r,a],[s,-r,a],[s,-r,-a],[-s,-r,-a],[-s,-r,a]],l=[[0,0,c],[0,0,c],[0,0,c],[0,0,c],[0,0,-c],[0,0,-c],[0,0,-c],[0,0,-c],[c,0,0],[c,0,0],[c,0,0],[c,0,0],[-c,0,0],[-c,0,0],[-c,0,0],[-c,0,0],[0,c,0],[0,c,0],[0,c,0],[0,c,0],[0,-c,0],[0,-c,0],[0,-c,0],[0,-c,0]],p=1==i.cubemap?[[.75,2/3],[.75,1/3],[1,1/3],[1,2/3],[.5,2/3],[.5,1/3],[.25,1/3],[.25,2/3],[.75,2/3],[.75,1/3],[.5,1/3],[.5,2/3],[0,2/3],[0,1/3],[.25,1/3],[.25,2/3],[.5,1],[.5,2/3],[.25,2/3],[.25,1],[.5,0],[.5,1/3],[.25,1/3],[.25,0]]:[[1,1],[1,0],[0,0],[0,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[1,1],[1,0],[0,0],[0,1],[1,0],[1,1],[0,1],[0,0],[1,1],[1,0],[0,0],[0,1]],m=c>0?[[3,1,0],[2,1,3],[4,5,7],[7,5,6],[8,9,11],[11,9,10],[15,13,12],[14,13,15],[16,17,19],[19,17,18],[23,21,20],[22,21,23]]:[[0,1,3],[3,1,2],[7,5,4],[6,5,7],[11,9,8],[10,9,11],[12,13,15],[15,13,14],[19,17,16],[18,17,19],[20,21,23],[23,21,22]];break;case"mesh":return this.parametricModel(function(t,e){let i={px:(t-.5)*s,py:0,pz:(e-.5)*a,nx:0,ny:1,nz:0,mu:t,mv:e};return i},{start:1,end:0,div:h},{start:0,end:1,div:u},{ninv:i.ninv}),this;case"torus":return this.parametricModel(function(t,e){let n=i.sr?i.sr:.5,h=t,o=-e,u=Math.sin(h*d),c=Math.cos(h*d),f=Math.sin(o*d),l=Math.cos(o*d),p=n*f*u,m=n*f*c,b=n*l,g=(Math.hypot(p,b,m),1*u+1*p),v=1*c+1*m,x=1*b,y={px:g*s,py:x*r,pz:v*a,nx:0,ny:0,nz:0,mu:t,mv:e};return y},{start:0,end:1,div:2*h},{start:0,end:1,div:o},{ninv:i.ninv}),this;case"polyhedron":if(!b[i.shape])return null;let E=b[i.shape].v,A=b[i.shape].s,T=0;for(let t=0;t<A.length;t++){let e=0,i=0,s=0,r=[];for(let a=A[t].length-1;a>=0;a--){let n=E[A[t][a]];f.push([n[0],n[2],n[1]]),e+=n[0],i+=n[2],s+=n[1],r.push(T),T++}let a=Math.hypot(e,i,s);for(let r=0;r<A[t].length;r++)l.push([e/a,i/a,s/a]);m.push(r)}p=null;break;case"icosa":E=b.r05.v,A=b.r05.s;for(let t=0;t<E.length;t++){let e=[E[t][0],E[t][2],E[t][1]];f.push(e),l.push(e),g(e)}for(let t=0;t<A.length;t++)c<0?m.push([A[t][0],A[t][1],A[t][2]]):m.push([A[t][0],A[t][2],A[t][1]]);const M=void 0!==i.div?i.div:2;for(let t=0;t<M;t++)v(f,m);for(let t=0;t<f.length;t++)f[t][0]*=s,f[t][1]*=r,f[t][2]*=a}function g(t){let e=Math.atan2(t[2],t[0])/Math.PI/2;p.push([(1-e)%1,1-Math.acos(t[1])/Math.PI])}function v(t,i){let s=t.length,r=i.length;for(let a=0;a<r;a++){let r=i[a][0],n=i[a][1],h=i[a][2],o=t[r],u=t[n],c=t[h],f=e.V3norm(e.V3add(o,u)),p=e.V3norm(e.V3add(u,c)),m=e.V3norm(e.V3add(c,o));t.push(f),t.push(p),t.push(m),l.push(f),l.push(p),l.push(m),g(f),g(p),g(m),i[a]=[r,s,s+2],i.push([s,s+1,s+2]),i.push([n,s+1,s]),i.push([h,s+2,s+1]),s+=3}}return this.obj_v=f,this.obj_n=l,this.obj_t=p,this.obj_i=m,this}parametricModel(t,e,i,s){let r=[],a=[],n=[],h=[],o=s&&s.ninv?-1:1,u=(e.end-e.start)/e.div,c=(i.end-i.start)/i.div;for(let s=0;s<=e.div;s++)for(let h=0;h<=i.div;h++){let f=e.start+u*s,l=i.start+c*h,p=t(f,l);if(r.push([p.px,p.py,p.pz]),void 0!=p.mu&&n.push([p.mu,p.mv]),0==p.nx&&0==p.ny&&0==p.nz){let e=u/10,i=c/10,s=t(f-e,l),r=t(f+e,l),a=(r.px-s.px)/(2*e),n=(r.py-s.py)/(2*e),h=(r.pz-s.pz)/(2*e),o=t(f,l-i),m=t(f,l+i),d=(m.px-o.px)/(2*i),b=(m.py-o.py)/(2*i),g=(m.pz-o.pz)/(2*i),v=n*g-h*b,x=h*d-a*g,y=a*b-n*d,_=Math.hypot(v,x,y);p.nx=v/_,p.ny=x/_,p.nz=y/_}a.push([p.nx*o,p.ny*o,p.nz*o])}let f=i.div+1;for(let t=0;t<e.div;++t){let e=t*f;for(let t=0;t<i.div;++t)o>0?h.push([e+t,e+t+f,e+t+f+1,e+t+1]):h.push([e+t+1,e+t+f+1,e+t+f,e+t])}return this.obj_v=r,this.obj_n=a,n.length>0&&(this.obj_t=n),this.obj_i=h,this}objModel(t,e){let i=this.obj_v,s=this.obj_i,r=this.obj_n,a=this.obj_t,n=this.obj_c,h=[],o=[],u=[],c=[],f=0;r||(this.obj_n=[]);for(let t=0,e=s.length;t<e;t++){let e=s[t];if(!r){let s=[];for(let t=0;t<3;t++)s[t]=i[e[t]];let r=s[1][0]-s[0][0],a=s[1][1]-s[0][1],n=s[1][2]-s[0][2],h=s[2][0]-s[0][0],o=s[2][1]-s[0][1],f=s[2][2]-s[0][2],l=a*f-n*o,p=-r*f+n*h,m=r*o-a*h,d=Math.hypot(l,p,m);l/=d,p/=d,m/=d,u.push([l,p,m]);for(let i=0,s=e.length;i<s;i++)c[e[i]]||(c[e[i]]=[]),c[e[i]].push(t)}for(let t=1,i=e.length-1;t<i;t++)o.push(e[0]),o.push(e[t]),o.push(e[t+1]);f+=e.length}console.log(" vert:"+i.length),console.log(" poly:"+o.length/3);for(let e=0,s=i.length;e<s;e++){h.push(parseFloat(i[e][0])),h.push(parseFloat(i[e][1])),h.push(parseFloat(i[e][2]));let s=0,o=0,f=0;if(r)s=r[e][0],o=r[e][1],f=r[e][2];else for(let t=0;t<c[e].length;t++){let i=c[e][t];s+=u[i][0],o+=u[i][1],f+=u[i][2]}let l=Math.hypot(s,o,f);if(0==l?(h.push(0),h.push(0),h.push(0)):(h.push(s/l),h.push(o/l),h.push(f/l)),r||this.obj_n.push([s/l,o/l,f/l]),a&&(h.push(parseFloat(a[e][0])),h.push(parseFloat(a[e][1]))),n&&(h.push(parseFloat(n[e][0])),h.push(parseFloat(n[e][1])),h.push(parseFloat(n[e][2]))),t)for(av=0;av<t.length;av++)h=h.concat(t[av].data[e])}this.ibuf=o,this.vbuf=h;let l={mode:"tri",vtx_at:["position","norm"],vtx:h,idx:o};if(a&&l.vtx_at.push("uv"),n&&l.vtx_at.push("color"),t)for(av=0;av<t.length;av++)l.vtx_at.push(t[av].attr);return l}normLines(t){let e=[],i=this.obj_v,s=this.obj_n;void 0==t&&(t=.1);for(let r=0,a=i.length;r<a;r++)e.push(i[r][0]),e.push(i[r][1]),e.push(i[r][2]),e.push(i[r][0]+s[r][0]*t),e.push(i[r][1]+s[r][1]*t),e.push(i[r][2]+s[r][2]*t);return{mode:"lines",vtx_at:["position"],vtx:e}}wireframe(){let t=[],e=this.obj_v,i=this.obj_i;for(let s=0,r=i.length;s<r;s++){let r,a=i[s];for(r=1;r<a.length;r++)t.push(e[a[r-1]][0]),t.push(e[a[r-1]][1]),t.push(e[a[r-1]][2]),t.push(e[a[r]][0]),t.push(e[a[r]][1]),t.push(e[a[r]][2]);t.push(e[a[r-1]][0]),t.push(e[a[r-1]][1]),t.push(e[a[r-1]][2]),t.push(e[a[0]][0]),t.push(e[a[0]][1]),t.push(e[a[0]][2])}return{mode:"lines",vtx_at:["position"],vtx:t}}multMatrix4(t){let i=new e(t).invert().transpose(),s=t.getAsArray();for(let t=0;t<this.obj_v.length;t++){let e=this.obj_v[t],i=s[0]*e[0]+s[4]*e[1]+s[8]*e[2]+s[12],r=s[1]*e[0]+s[5]*e[1]+s[9]*e[2]+s[13],a=s[2]*e[0]+s[6]*e[1]+s[10]*e[2]+s[14];this.obj_v[t]=[i,r,a]}s=i.getAsArray();for(let t=0;t<this.obj_n.length;t++){let e=this.obj_n[t],i=s[0]*e[0]+s[4]*e[1]+s[8]*e[2]+s[12],r=s[1]*e[0]+s[5]*e[1]+s[9]*e[2]+s[13],a=s[2]*e[0]+s[6]*e[1]+s[10]*e[2]+s[14];this.obj_n[t]=[i,r,a]}}mergeModels(t){let e=this,i=0;for(let s=0;s<t.length;s++){e.obj_v=e.obj_v.concat(t[s].obj_v),e.obj_n=e.obj_n.concat(t[s].obj_n),e.obj_t=e.obj_t.concat(t[s].obj_t);for(let r=0;r<t[s].obj_i.length;r++){let a=t[s].obj_i[r],h=[];for(n=0;n<a.length;n++)h.push(a[n]+i);e.obj_i.push(h)}i+=t[s].obj_v.length}return e}boundbox(){let t=Number.MAX_VALUE,e=t,i=t,s=Number.MIN_VALUE,r=s,a=s;for(let n=0;n<this.obj_v.length;n++){let h=this.obj_v[n];h[0]<t&&(t=h[0]),h[1]<e&&(e=h[1]),h[2]<i&&(i=h[2]),h[0]>s&&(s=h[0]),h[1]>r&&(r=h[1]),h[2]>a&&(a=h[2])}return[[t,e,i],[s,r,a]]}loadAjax(t){return new Promise(function(e,i){let s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="text",s.onload=function(){200==this.status?e(this.response):i("Ajax error:"+this.statusText)},s.onerror=function(){i("Ajax error:"+this.statusText)},s.send()})}static loadLines(t,e,i){i||(i=1e4);const s=new TextDecoder;return new Promise((r,a)=>{fetch(t,{method:"GET"}).then(async t=>{if(t.ok){const a=t.body.getReader(),n=new Uint8Array(i);let h=0;for(;;){const{done:i,value:o}=await a.read();if(i){e(s.decode(n.slice(0,h))),r(t);break}for(const t of o)n[h++]=t,10==t&&(e(s.decode(n.slice(0,h-1))),h=0)}}else a(t)})})}async loadObj(t,e){return e||(e=1),new Promise((i,s)=>{this.loadAjax(t).then(s=>{let r=s.split("\n"),a=[],n=[],h=[],o=[],u=[],c={},f=0;for(let t=0,i=r.length;t<i;t++){if(r[t].match(/^#/))continue;if(r[t].match(/^eof/))break;let i=r[t].split(/\s+/);if("v"==i[0]&&(a.push([i[1]*e,i[2]*e,i[3]*e]),7==i.length&&u.push([i[4],i[5],i[6]])),"vt"==i[0]&&o.push([i[1],i[2]]),"vn"==i[0]&&n.push([i[1],i[2],i[3]]),"f"==i[0]){let t=[];for(let e=1;e<i.length;e++)""!=i[e]&&(i[e]in c||(c[i[e]]=f++),t.push(c[i[e]]));h.push(t)}}if(this.obj_v=[],u.length>0&&(this.obj_c=[]),this.obj_i=h,n.length>0&&(this.obj_n=[]),o.length>0&&(this.obj_t=[]),h.length>0)for(let t in c){let e=t.split("/"),i=c[t];this.obj_v[i]=a[e[0]-1],u.length>0&&(this.obj_c[i]=u[e[0]-1]),o.length>0&&(this.obj_t[i]=o[e[1]-1]),n.length>0&&(this.obj_n[i]=n[e[2]-1])}else this.obj_v=a,u.length>0&&(this.obj_c=u),n.length>0&&(this.obj_n=n);console.log("loadobj "+t+" vtx:"+a.length+" norm:"+n.length+" tex:"+o.length+" idx:"+h.length+" vbuf:"+this.obj_v.length),i(this)}).catch(function(t){s(t)})})}static async loadObj2(t,e){let s=1,r=!1,a=!1,n=!1;return e&&(e.scale&&(s=e.scale),e.zup&&(r=e.zup),e.nogroup&&(a=e.nogroup),e.nomtl&&(n=e.nomtl)),new Promise((e,h)=>{const o=[],u=[],c={},f=[],l=[],p={},m=[];let d=0,b="",g="";const v=[],x=[];i.loadLines(t,async e=>{if(e.match(/^#/))return;if(e.match(/^eof/))return;const h=e.split(/\s+/),y=h[0];if("v"==y&&(r?o.push([h[1]*s,h[3]*s,-h[2]*s]):o.push([h[1]*s,h[2]*s,h[3]*s]),7==h.length&&l.push([h[4],h[5],h[6]])),"vt"==y&&f.push([h[1],h[2]]),"vn"==y&&(r?u.push([h[1],h[3],-h[2]]):u.push([h[1],h[2],h[3]])),"f"==y){let t=[];for(let e=1;e<h.length;e++)""!=h[e]&&(h[e]in p||(p[h[e]]=d++,m[p[h[e]]]=h[e]),t.push(p[h[e]]));c[g]||(c[g]={}),c[g][b]||(c[g][b]=[]),c[g][b].push(t)}if("mtllib"==y){let e=t.split("/");e[e.length-1]=h[1],v.push(i.loadMtl(e.join("/"))),x.push(e)}"usemtl"==y&&(n||(b=h[1])),"g"==y&&(a||(g=h[1]))}).then(s=>{const r=[];let n;console.log(c),console.log(m);for(let e in c){n=[];for(let s in c[e]){let r=c[e][s];const a=new i;if(a.obj_v=[],l.length>0&&(a.obj_c=[]),u.length>0&&(a.obj_n=[]),f.length>0&&(a.obj_t=[]),a.obj_i=r,r.length>0)for(let t in p){let e=t.split("/"),i=p[t];a.obj_v[i]=o[e[0]-1],l.length>0&&(a.obj_c[i]=l[e[0]-1]),f.length>0&&(a.obj_t[i]=f[e[1]-1]),u.length>0&&(a.obj_n[i]=u[e[2]-1])}else a.obj_v=o,l.length>0&&(a.obj_c=l),u.length>0&&(a.obj_n=u);n.push({obj:a,mtlname:s}),console.log("loadobj "+t+" vtx:"+o.length+" norm:"+u.length+" tex:"+f.length+" idx:"+r.length+" vbuf:"+a.obj_v.length)}r.push({objs:n,group:e})}v.length>0?Promise.all(v).then(t=>{let i={};for(let e in t)i=Object.assign(i,t[e]);e(a?{objs:n,mtls:i}:{groups:r,mtls:i})}):e(a?{objs:n}:{groups:r})}).catch(t=>{h(t)})})}static async loadMtl(t){const e=[];let s="";return new Promise((r,a)=>{i.loadLines(t,t=>{if(t.match(/^#/))return;if(t.match(/^eof/))return;const i=t.split(/\s+/),r=i[0];if("newmtl"==r)return s=i[1],void(e[s]={});switch(r){case"Kd":case"Ks":case"Ka":case"Tf":e[s][r]=[parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])];break;case"Ni":case"d":case"Ns":e[s][r]=parseFloat(i[1]);break;case"illum":e[s][r]=parseInt(i[1]);break;case"map_Kd":case"map_Ka":case"map_Ks":e[s][r]=i[1]}}).then(t=>{r(e)}).catch(t=>{a(t)})})}static HSV2RGB(t,e,i,s){let r,a,n,h,o,u,c;switch(t*=6,r=Math.floor(t),a=t-r,1&r||(a=1-a),n=i*(1-e),h=i*(1-e*a),r){case 0:case 6:o=i,u=h,c=n;break;case 1:o=h,u=i,c=n;break;case 2:o=n,u=i,c=h;break;case 3:o=n,u=h,c=i;break;case 4:o=h,u=n,c=i;break;case 5:o=i,u=n,c=h}return[o,u,c,void 0===s?1:s]}static snormal(t){let e=t[1][0]-t[0][0],i=t[1][1]-t[0][1],s=t[1][2]-t[0][2],r=t[2][0]-t[0][0],a=t[2][1]-t[0][1],n=t[2][2]-t[0][2],h=i*n-s*a,o=-e*n+s*r,u=e*a-i*r,c=Math.hypot(h,o,u);return[h/=c,o/=c,u/=c]}}return t.WWModel=i}),t("skylark-pox/Player",["./pox","./CanvasMatrix4","./GPad","./Pointer","./Camera","./Device","./WBind","./WWG","./WWModel"],function(t,e,i,s,r,a,n,h,o){"use strict";t.$;const u=e;t.RAD;class c{constructor(t,s){if(this.version="2.2.0",!Promise)throw"This browser is not supported!!";s||(s={}),this.can=t instanceof HTMLElement?t:document.querySelector(t);const r=new h,u={preserveDrawingBuffer:s.capture,antialias:!0,xrCompatible:!0},c=!s.noWebGL2;if(!(c&&r.init2(this.can,u)||r.init(this.can,u)))throw"wgl not supported!";if(s.needWebGL2&&2!=r.version)throw"needs wgl2";this.wwg=r;const f=n.create();this.param=f,f.bindInput("isStereo",s.ui&&s.ui.isStereo?s.ui.isStereo:"#isstereo"),f.bindInput("autorot",s.ui&&s.ui.autorot?s.ui.autorot:"#autorot"),f.bindInput("pause",s.ui&&s.ui.pause?s.ui.pause:"#pause"),f.bindHtml("fps",s.ui&&s.ui.fps?s.ui.fps:"#fps"),f.bindInput("camselect",s.ui&&s.ui.camselect?s.ui.camselect:"#camselect"),this.pixRatio=1,this.pox={can:this.can,wwg:this.wwg,WWModel:o,CanvasMatrix4:e,Mat4:e,synth:this.synth,poxp:this},this.eventListener={},i&&(this.pox.gPad=new i,this.pox.gPad.name="1",this.pox.gPad2=new i,this.pox.gPad2.name="2",this.pox.gPad.init(0,(t,e)=>{e&&this.pox.log("set 1"+t.gp.hand)})||this.pox.gPad2.init(1,(t,e)=>{e&&this.pox.log("set 2"+t.gp.hand)})||(this.pox.gPad.ev=(t=>{ret=this.callEvent("gpad",t)})),this.pox.gPad2.ev=((t,e,i)=>{ret=this.callEvent("gpad",t)})),this.resize(),window.addEventListener("resize",()=>{this.resize()}),this.pause=!0;const l=document.createElement("input");l.setAttribute("type","checkbox"),l.style.position="absolute",l.style.zIndex=-100,l.style.top=0,l.style.left="-20px",l.style.width="10px",l.style.height="10px",l.style.padding=0,l.style.border="none",l.style.opacity=0,this.can.parentNode.appendChild(l),this.keyElelment=l,this.keyElelment.focus(),this.setEvent(),a.checkVR(this).then(t=>{t&&console.log(a.vrDisplay?"WebVR":"WebXR supported"),this.vrReady=t}),this.cam0=this.createCamera(),this.cam0.setCam({camFar:1e4}),this.cam1=this.createCamera(),this.ccam=this.cam1}addEvent(t,e){let i=null;switch(t){case"frame":i={cb:e,active:!0},this.eventListener.frame.push(i);break;case"gpad":i={cb:e,active:!0},this.eventListener.gpad.push(i);break;case"vrchange":i={cb:e,active:!0},this.eventListener.vrchange.push(i)}return i}removeEvent(t){this.eventListener.frame=this.eventListener.frame.filter(e=>e!==t),this.eventListener.gpad=this.eventListener.gpad.filter(e=>e!==t),this.eventListener.vrchange=this.eventListener.vrchange.filter(e=>e!==t)}clearEvent(){this.eventListener.frame=[],this.eventListener.gpad=[],this.eventListener.vrchange=[]}enterVR(){let t=!0;if(a.VRReady)console.log("enter VR"),a.presentVR(this);else if(document.body.webkitRequestFullscreen){console.log("fullscreen");const t=this.can.parentNode;this.ssize={width:t.offsetWidth,height:t.offsetHeight},document.addEventListener("webkitfullscreenchange",e=>{document.webkitFullscreenElement?(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px"):(t.style.width=this.ssize.width+"px",t.style.height=this.ssize.height+"px")}),t.webkitRequestFullscreen()}else t=!1;return t}exitVR(){a.VRReady&&a.closeVR(this)}setEvent(){let t=!1;const e=this.param,i=this.can;new s(i,{down:i=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("down",{x:i.x*this.pixRatio,y:i.y*this.pixRatio,sx:i.sx*this.pixRatio,sy:i.sy*this.pixRatio}))&&this.ccam.event("down",i),t=!0,"walk"==this.ccam.cam.camMode&&this.keyElelment.focus(),!1},move:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("move",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,ox:t.ox*this.pixRatio,oy:t.oy*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio}))&&this.ccam.event("move",t),!1},up:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("up",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio,ex:e.ex*this.pixRatio,ey:e.ey*this.pixRatio}))&&this.ccam.event("up",e),!1},out:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("out",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio}))&&this.ccam.event("out",e),!1},wheel:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("wheel",t))&&this.ccam.event("wheel",t),!1},gesture:(t,i)=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("gesture",{z:t,r:i}))&&this.ccam.event("gesture",{z:t,r:i}),!1},gyro:i=>{if(!this.ccam||e.pause||a.VRReady)return!0;if(t)return!0;let s=!0;return(s=this.callEvent("gyro",i))&&this.ccam.event("gyro",i),!1}});n.addev(this.keyElelment,"keydown",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keydown",t))||(this.ccam&&this.ccam.event("keydown",t),!1))),n.addev(this.keyElelment,"keyup",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keyup",t))||(this.ccam&&this.ccam.event("keyup",t),!1))),document.querySelectorAll("#bc button").forEach(t=>{t.addEventListener("mousedown",t=>{this.callEvent("btndown",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("touchstart",t=>{this.callEvent("touchstart",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("mouseup",t=>{this.callEvent("btnup",t.target.id),this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),this.keyElelment.focus(),t.preventDefault()}),t.addEventListener("touchend",t=>{ret=!0,ret=this.callEvent("touchend",t.target.id),ret&&this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),t.preventDefault()})})}resize(){this.can.offsetWidth<300||a.isPresenting||(this.can.width=this.can.offsetWidth*this.pixRatio*window.devicePixelRatio,this.can.height=this.can.offsetHeight*this.pixRatio*window.devicePixelRatio,console.log("canvas:"+this.can.width+" x "+this.can.height))}async load(t){return new Promise((e,i)=>{if("string"==typeof t){const s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="json",s.onload=(()=>{200==s.status?e(s.response):i("Ajax error:"+s.statusText)}),s.onerror=(()=>{i("Ajax error:"+s.statusText)}),s.send()}else e(t)})}loadImage(t){return t.match(/^https?:/)?this.wwg.loadImageAjax(t):new Promise((e,i)=>{const s=new Image;s.onload=(()=>{e(s)}),s.onerror=(()=>{i("cannot load image")}),s.src=t})}async set(t,e={},i){t.vs,t.fs;this.pox.src=t,this.pox.param=e;const s=this.pox;if(s.loadImage=this.loadImage,s.loadAjax=this.wwg.loadAjax,s.addEvent=((t,e)=>this.addEvent(t,e)),s.exitVR=this.exitVR,s.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},s.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},s.V3norm=function(t,e){const i=V3len(t);return void 0===e&&(e=1),0==i?[0,0,0]:[t[0]*e/i,t[1]*e/i,t[2]*e/i]},s.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},s.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.Vdistance=function(t,e){return Math.hypot(...t.map((t,i)=>t-e[i]))},s.setScene=(async t=>new Promise((e,i)=>{this.setScene(t).then(()=>{e()}).catch(t=>{console.log("render err"+t.stack)})})),s.log=(t=>{this.errCb&&this.errCb(t)}),s.addModel=(t=>{if(this.render)return this.render.addModel(t)}),s.removeModel=(t=>{if(this.render)return this.render.removeModel(t)}),s.getModelData=(t=>{if(this.render)return this.render.getModelData(t)}),"string"==typeof t.m){const e=await this.parseJS(t.m);try{s.eval=new Function("POX",'"use strict";'+e)}catch(t){return console.log(t),this.emsg="parse error "+t.stack,null}try{s.eval(s)}catch(t){return this.emsg="eval error "+t.stack,null}}else if(t.m.constructor===Function)try{t.m(s)}catch(t){return this.emsg="eval error "+t.stack,null}if(s.setting.needWGL2&&2!=this.wwg.version)return this.emsg="needs WebGL 2.0",null;if(i&&this.setParam(i),s.init)try{await s.init()}catch(t){return this.emsg="init error "+t.stack,null}return s}parseJS(t){return new Promise((e,i)=>{const s=t.split("\n"),r=[];for(let t of s)t.match(/^\/\/\@INCLUDE\("(.+)"\)/)&&r.push(this.wwg.loadAjax(RegExp.$1));Promise.all(r).then(t=>{let i=[],r=0;for(let e of s)e.match(/^\/\/\@INCLUDE\("(.+)"\)/)?i=i.concat(t[r++].split("\n")):i.push(e);e(i.join("\n"))})})}stop(){window.cancelAnimationFrame(this.loop),this.pox.unload&&this.pox.unload()}cls(){this.render&&this.render.clear()}setError(t){this.errCb=t}callEvent(t,e,i){"object"==typeof e&&(e.rtime=this.rtime);let s=!0;if(this.pox.event)try{s=this.pox.event(t,e,i)}catch(t){this.errCb(t.stack)}if("vrchange"==t){this.ccam.vrchange(e);for(let t=0;t<this.eventListener.vrchange.length;t++){const i=this.eventListener.vrchange[t];i.active&&i.cb({vrmode:e})}}if("gpad"==t){-1==e.dbtn[5]&&a.closeVR();for(let t=0;t<this.eventListener.gpad.length;t++){const i=this.eventListener.gpad[t];if(i.active){let t={gpad:e};"left"==e.hand&&(t.leftPad=e),"right"==e.hand&&(t.rightPad=e),this.pox.setting.primaryPad==e.hand?t.primaryPad=e:t.secondaryPad=e,i.cb(t)}}}return s}setParam(t){const e=this.pox.setting.param;if(void 0===e)return;this.uparam=n.create();const i=[];for(let t in e){const s=e[t],r=s.name?s.name:t;s.type||(s.type="range"),s.step||(s.step=100);let a=`<div class=t>${r}</div> <input type=${s.type} id="_p_${t}" min=0 max=${s.step} style="${"disp"==s.type?"display:none":""}"  /><span id=${"_p_d_"+t}></span><br/>`;i.push(a)}function s(t){let e=(255*t).toString(16);return 1==e.length&&(e="0"+e),e}function r(t,i){"color"==e[t].type&&i?document.getElementById("_p_d_"+t).innerHTML=i.map(t=>t.toString().substr(0,5)):"range"==e[t].type?document.getElementById("_p_d_"+t).innerHTML=i.toString().substr(0,5):document.getElementById("_p_d_"+t).innerHTML=i}t.innerHTML=i.join("");for(let t in e)this.uparam.bindInput(t,"#_p_"+t),this.uparam.setFunc(t,{set:i=>{let a=i;return a="color"==e[t].type?"#"+s(i[0])+s(i[1])+s(i[2]):"range"==e[t].type?(i-e[t].min)*e[t].step/(e[t].max-e[t].min):i,r(t,i),a},get:i=>{let s;return s="color"==e[t].type?"string"==typeof i&&i.match(/#[0-9A-F]+/i)?[parseInt(i.substr(1,2),16)/255,parseInt(i.substr(3,2),16)/255,parseInt(i.substr(5,2),16)/255]:i:"range"==e[t].type?i*(e[t].max-e[t].min)/e[t].step+e[t].min:i},input:e=>{r(t,this.uparam[t])}}),this.uparam[t]=e[t].value;this.pox.param=this.uparam}setScene(t){const i=this.wwg,s=this.pox,r=this.can,n=(this.pixRatio,this.param),h=s.setting||{};h.scale||(h.scale=1),h.primaryPad||(h.primaryPad="right"),t.vshader={text:s.src.vs},t.fshader={text:s.src.fs},s.scene=t;const o=i.createRender();this.render=o,s.render=o;let c=this.ccam;this.isVR=!1;const f=this,l=new e,p=[],m=[],d=[],b=[],g=[];return new Promise((e,i)=>{o.setRender(t).then(()=>{this.errCb&&this.errCb("scene set ok"),this.renderStart&&this.renderStart(),s.setting&&s.setting.pixRatio?this.pixRatio=s.setting.pixRatio:this.pixRatio=1,this.resize(),s.setting.cam&&this.cam1.setCam(s.setting.cam),this.keyElelment.value="",this.clearEvent(),e();let t=(new Date).getTime();this.ctime=t,this.ltime=t;let i=0,u=0,l=t,p=0;const m=(e,d)=>{a.animationFrame(this,m,d);const b=(new Date).getTime();if(this.ctime=b,n.pause)return n.fps=0,i=u,void(t=b);u=i+b-t,p++,b-l>=500&&(n.fps=Math.floor(1e3*p/(b-l)+.5),p=0,l=b),this.ccam=n.camselect?this.cam0:this.cam1,c=this.ccam,s.cam=c.cam,n.autorot&&c.setCam({camRY:u/100%360});let g=null,v=null,y=null,_=null;if(s.gPad){let t=s.gPad.get(),e=s.gPad2.get();this.isVR?(t.emu||"right"!=t.hand||(g=t),t.emu||"left"!=t.hand||(v=t),e.emu||"right"!=e.hand||(g=e),e.emu||"left"!=e.hand||(v=e)):("right"==t.hand&&(g=t),"right"==e.hand&&(g=e),"left"==t.hand&&(v=t),"left"==e.hand&&(v=e)),"left"==h.primaryPad?(y=v,_=g):(y=g,_=v),y&&y.conn||(y=_,_=null),c.cam.gPad&&c.setPad(y,_)}c.update();let R=c.getMtx(h.scale,n.isStereo||f.isVR?1:0);for(let t=0;t<this.eventListener.frame.length;t++){const e=this.eventListener.frame[t];e.active&&e.cb({render:o,pox:s,ccam:c,cam:c.cam,rtime:u,rightPad:g,leftPad:v,primaryPad:y,secondaryPad:_})}let w={};s.update&&(w=s.update(o,c.cam,u,-1)),n.updateTimer(),function(t,e,i,s,h){if(t.data.model.sort((t,e)=>{if(null===t)return-1;if(null===e)return 1;let i=t.layer,s=e.layer;return void 0===i&&(i=0),void 0===s&&(s=0),i-s}),n.isStereo||f.isVR){let e=a.getViewport(r);a.WebXR&&a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,a.webGLLayer.framebuffer);let n=x(t,i);void 0===h.vs_uni&&(h.vs_uni={}),void 0===h.fs_uni&&(h.fs_uni={}),h.fs_uni.time=s/1e3,h.vs_uni.time=s/1e3,t.gl.viewport(e.leftViewport.x,e.leftViewport.y,e.leftViewport.width,e.leftViewport.height),t.draw([h,n[0]],!1),t.gl.viewport(e.rightViewport.x,e.rightViewport.y,e.rightViewport.width,e.rightViewport.height),t.draw([h,n[1]],!0),a.WebXR&&a.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null)}else{let e=x(t,i);void 0===h.vs_uni&&(h.vs_uni={}),void 0===h.fs_uni&&(h.fs_uni={}),e[0].vs_uni.stereo=0,h.fs_uni.time=s/1e3,h.vs_uni.time=s/1e3,t.gl.viewport(0,0,r.width,r.height),t.draw([h,e[0]],!1)}}(o,0,R,u,w),a.submitFrame(this),this.ltime=b,this.rtime=u};m()}).catch(t=>{console.log(t),this.errCb&&this.errCb(t.stack?t.stack:t),i(t)})});function v(t,e){let i=t.getModelData(e);if(!i)return new u;let s=new u(i.bm);return s||(s=new u),i.mm&&s.multRight(i.mm),void 0!==i.parent&&s.multRight(v(t,i.parent)),s}function x(t,i){const s=[[],[]],a=t.data.model;for(let r=0;r<a.length;r++){let n=a[r];if(!n)continue;if(l.load(n.bm),n.mm&&l.multRight(n.mm),void 0!==n.parent&&l.multRight(v(t,n.parent)),t.data.group){let e=t.data.group;for(let i=0;i<e.length;i++){let s=e[i];if(s.bm)for(let e=0;e<s.model.length;e++)t.getModelIdx(s.model[e])==r&&l.multRight(s.bm)}}p[r]||(p[r]=new e),b[r]||(b[r]=new e),g[r]||(g[r]=new e),m[r]||(m[r]=[new e,new e]),d[r]||(d[r]=[new e,new e]);const h={vs_uni:{modelMatrix:p[r].load(l).getAsWebGLFloatArray(),vpMatrix:d[r][0].load(n.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),mvpMatrix:m[r][0].load(l).multRight(n.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),invMatrix:b[r].load(l).invert().transpose().getAsWebGLFloatArray(),minvMatrix:g[r].load(l).invert().getAsWebGLFloatArray()}},o={vs_uni:{modelMatrix:p[r].load(l).getAsWebGLFloatArray(),vpMatrix:d[r][1].load(n.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),mvpMatrix:m[r][1].load(l).multRight(n.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),invMatrix:b[r].load(l).invert().transpose().getAsWebGLFloatArray(),minvMatrix:g[r].load(l).invert().getAsWebGLFloatArray()}};h.fs_uni=h.vs_uni,o.fs_uni=o.vs_uni,h.fs_uni.vpMatrix_l=h.fs_uni.vpMatrix,h.fs_uni.vpMatrix_r=o.fs_uni.vpMatrix,o.fs_uni.vpMatrix_l=h.fs_uni.vpMatrix,o.fs_uni.vpMatrix_r=o.fs_uni.vpMatrix,s[0][r]=h,s[1][r]=o}let n=[{model:s[0],fs_uni:{},vs_uni:{}},{model:s[1],fs_uni:{},vs_uni:{}}];return n[0].fs_uni.stereo=1,n[0].fs_uni.resolution=[r.width,r.height],n[0].fs_uni.camMatirx=i[0].camV.getAsWebGLFloatArray(),n[0].fs_uni.eyevec=[i[0].camX,i[0].camY,i[0].camZ],n[0].vs_uni.stereo=1,n[0].vs_uni.camMatirx=n[0].fs_uni.camMatirx,n[0].vs_uni.eyevec=n[0].fs_uni.eyevec,n[1].fs_uni.stereo=2,n[1].fs_uni.resolution=n[0].fs_uni.resolution,n[1].fs_uni.camMatirx=i[1].camV.getAsWebGLFloatArray(),n[1].fs_uni.eyevec=[i[1].camX,i[1].camY,i[1].camZ],n[1].vs_uni.stereo=2,n[1].vs_uni.camMatirx=n[1].fs_uni.camMatirx,n[1].vs_uni.eyevec=n[1].fs_uni.eyevec,n}}}return c.prototype.createCamera=function(t){return new this.Camera(this,t)},c.prototype.Camera=r,t.Player=c}),t("skylark-pox/main",["./pox","./Player"],function(t,e){return t}),t("skylark-pox",["skylark-pox/main"],function(t){return t})}(r),!a){var u=require("skylark-langx-ns");h?module.exports=u:e.skylarkjs=u}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-pox.js.map
